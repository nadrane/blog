{"version":3,"sources":["../../../src/internal-plugins/query-runner/redirects-writer.js"],"names":["lastHash","writeRedirects","bootstrapFinished","store","getState","program","redirects","browserRedirects","filter","r","redirectInBrowser","newHash","crypto","createHash","update","JSON","stringify","digest","Promise","resolve","fs","writeFile","directory","exports","oldRedirects","debouncedWriteRedirects","_","debounce","isEqual","Redirects","emitter","on"],"mappings":";;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AAEA,IAAIA,QAAQ,GAAG,IAAf;;AAEA,MAAMC,cAAc;AAAA;AAAA;AAAA,6CAAG,aAAY;AACjCC,IAAAA,iBAAiB,GAAG,IAApB;;AADiC,0BAGJC,aAAMC,QAAN,EAHI;AAAA,QAG3BC,OAH2B,mBAG3BA,OAH2B;AAAA,QAGlBC,SAHkB,mBAGlBA,SAHkB,EAKjC;;;AACA,UAAMC,gBAAgB,GAAGD,SAAS,CAACE,MAAV,CAAiBC,CAAC,IAAIA,CAAC,CAACC,iBAAxB,CAAzB;;AAEA,UAAMC,OAAO,GAAGC,gBACbC,UADa,CACD,KADC,EAEbC,MAFa,CAENC,IAAI,CAACC,SAAL,CAAeT,gBAAf,CAFM,EAGbU,MAHa,CAGL,KAHK,CAAhB;;AAKA,QAAIN,OAAO,KAAKX,QAAhB,EAA0B;AACxB,aAAOkB,OAAO,CAACC,OAAR,EAAP;AACD;;AAEDnB,IAAAA,QAAQ,GAAGW,OAAX;AAEA,iBAAaS,iBAAGC,SAAH,CACX,oBAAShB,OAAO,CAACiB,SAAjB,EAA6B,uBAA7B,CADW,EAEXP,IAAI,CAACC,SAAL,CAAeT,gBAAf,EAAiC,IAAjC,EAAuC,CAAvC,CAFW,CAAb;AAID,GAvBmB;;AAAA,kBAAdN,cAAc;AAAA;AAAA;AAAA,GAApB;;AAyBAsB,OAAO,CAACtB,cAAR,GAAyBA,cAAzB;AAEA,IAAIC,iBAAiB,GAAG,KAAxB;AACA,IAAIsB,YAAJ;;AACA,MAAMC,uBAAuB,GAAGC,gBAAEC,QAAF,CAAW,MAAM;AAC/C;AACA,MACEzB,iBAAiB,IACjB,CAACwB,gBAAEE,OAAF,CAAUJ,YAAV,EAAwBrB,aAAMC,QAAN,GAAiBE,SAAzC,CAFH,EAGE;AACAL,IAAAA,cAAc;AACduB,IAAAA,YAAY,GAAGrB,aAAMC,QAAN,GAAiByB,SAAhC;AACD;AACF,CAT+B,EAS7B,GAT6B,CAAhC;;AAWAC,eAAQC,EAAR,CAAY,iBAAZ,EAA8B,MAAM;AAClCN,EAAAA,uBAAuB;AACxB,CAFD","sourcesContent":["import _ from \"lodash\"\nimport crypto from \"crypto\"\nimport fs from \"fs-extra\"\nimport { store, emitter } from \"../../redux/\"\nimport { joinPath } from \"../../utils/path\"\n\nlet lastHash = null\n\nconst writeRedirects = async () => {\n  bootstrapFinished = true\n\n  let { program, redirects } = store.getState()\n\n  // Filter for redirects that are meant for the browser.\n  const browserRedirects = redirects.filter(r => r.redirectInBrowser)\n\n  const newHash = crypto\n    .createHash(`md5`)\n    .update(JSON.stringify(browserRedirects))\n    .digest(`hex`)\n\n  if (newHash === lastHash) {\n    return Promise.resolve()\n  }\n\n  lastHash = newHash\n\n  return await fs.writeFile(\n    joinPath(program.directory, `.cache/redirects.json`),\n    JSON.stringify(browserRedirects, null, 2)\n  )\n}\n\nexports.writeRedirects = writeRedirects\n\nlet bootstrapFinished = false\nlet oldRedirects\nconst debouncedWriteRedirects = _.debounce(() => {\n  // Don't write redirects again until bootstrap has finished.\n  if (\n    bootstrapFinished &&\n    !_.isEqual(oldRedirects, store.getState().redirects)\n  ) {\n    writeRedirects()\n    oldRedirects = store.getState().Redirects\n  }\n}, 250)\n\nemitter.on(`CREATE_REDIRECT`, () => {\n  debouncedWriteRedirects()\n})\n"],"file":"redirects-writer.js"}