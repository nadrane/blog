{"version":3,"sources":["../../../src/internal-plugins/query-runner/query-compiler.js"],"names":["normalize","require","_","printTransforms","IRTransforms","ValuesOfCorrectTypeRule","VariablesDefaultValueAllowedRule","FragmentsOnCompositeTypesRule","KnownTypeNamesRule","LoneAnonymousOperationRule","PossibleFragmentSpreadsRule","ScalarLeafsRule","VariablesAreInputTypesRule","VariablesInAllowedPositionRule","validationRules","Runner","constructor","baseDir","fragmentsDir","schema","reportError","message","process","env","NODE_ENV","report","panic","format","red","log","compileAll","nodes","parseEverything","write","files","glob","sync","nodir","concat","filter","d","match","map","Array","from","store","getState","components","keys","c","uniq","parser","FileParser","parseFiles","compiledNodes","Map","namePathMap","nameDefMap","documents","entries","filePath","doc","errors","length","push","definitions","forEach","def","name","value","set","compilerContext","GraphQLCompilerContext","addAll","ASTConvert","convertASTDocuments","RelayParser","transform","bind","error","printContext","slice","reduce","ctx","node","kind","get","has","otherNode","text","getRoot","GraphQLIRPrinter","print","join","query","originalText","path","isStaticQuery","hash","jsonName","kebabCase","relative","program","directory","compile","runner","queries"],"mappings":"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","sourcesContent":["// @flow\nimport path from \"path\"\nconst normalize = require(`normalize-path`)\nimport glob from \"glob\"\n\nimport { validate } from \"graphql\"\nimport { IRTransforms } from \"relay-compiler\"\nimport RelayParser from \"relay-compiler/lib/RelayParser\"\nimport ASTConvert from \"relay-compiler/lib/ASTConvert\"\nimport GraphQLCompilerContext from \"relay-compiler/lib/GraphQLCompilerContext\"\nimport filterContextForNode from \"relay-compiler/lib/filterContextForNode\"\nconst _ = require(`lodash`)\n\nimport { store } from \"../../redux\"\nimport FileParser from \"./file-parser\"\nimport GraphQLIRPrinter from \"relay-compiler/lib/GraphQLIRPrinter\"\nimport {\n  graphqlError,\n  graphqlValidationError,\n  multipleRootQueriesError,\n} from \"./graphql-errors\"\nimport report from \"gatsby-cli/lib/reporter\"\n\nimport type { DocumentNode, GraphQLSchema } from \"graphql\"\n\nconst { printTransforms } = IRTransforms\n\nconst {\n  ValuesOfCorrectTypeRule,\n  VariablesDefaultValueAllowedRule,\n  FragmentsOnCompositeTypesRule,\n  KnownTypeNamesRule,\n  LoneAnonymousOperationRule,\n  PossibleFragmentSpreadsRule,\n  ScalarLeafsRule,\n  VariablesAreInputTypesRule,\n  VariablesInAllowedPositionRule,\n} = require(`graphql`)\n\ntype RootQuery = {\n  name: string,\n  path: string,\n  text: string,\n  originalText: string,\n  isStaticQuery: boolean,\n  hash: string,\n}\n\ntype Queries = Map<string, RootQuery>\n\nconst validationRules = [\n  ValuesOfCorrectTypeRule,\n  VariablesDefaultValueAllowedRule,\n  FragmentsOnCompositeTypesRule,\n  KnownTypeNamesRule,\n  LoneAnonymousOperationRule,\n  PossibleFragmentSpreadsRule,\n  ScalarLeafsRule,\n  VariablesAreInputTypesRule,\n  VariablesInAllowedPositionRule,\n]\n\nclass Runner {\n  baseDir: string\n  schema: GraphQLSchema\n  fragmentsDir: string\n\n  constructor(baseDir: string, fragmentsDir: string, schema: GraphQLSchema) {\n    this.baseDir = baseDir\n    this.fragmentsDir = fragmentsDir\n    this.schema = schema\n  }\n\n  reportError(message) {\n    if (process.env.NODE_ENV === `production`) {\n      report.panic(`${report.format.red(`GraphQL Error`)} ${message}`)\n    } else {\n      report.log(`${report.format.red(`GraphQL Error`)} ${message}`)\n    }\n  }\n\n  async compileAll() {\n    let nodes = await this.parseEverything()\n    return await this.write(nodes)\n  }\n\n  async parseEverything() {\n    // FIXME: this should all use gatsby's configuration to determine parsable\n    // files (and how to parse them)\n    let files = glob.sync(`${this.fragmentsDir}/**/*.+(t|j)s?(x)`, {\n      nodir: true,\n    })\n    files = files.concat(\n      glob.sync(`${this.baseDir}/**/*.+(t|j)s?(x)`, { nodir: true })\n    )\n    files = files.filter(d => !d.match(/\\.d\\.ts$/))\n    files = files.map(normalize)\n\n    // Ensure all page components added as they're not necessarily in the\n    // pages directory e.g. a plugin could add a page component.  Plugins\n    // *should* copy their components (if they add a query) to .cache so that\n    // our babel plugin to remove the query on building is active (we don't\n    // run babel on code in node_modules). Otherwise the component will throw\n    // an error in the browser of \"graphql is not defined\".\n    files = files.concat(\n      Array.from(store.getState().components.keys(), c => normalize(c))\n    )\n    files = _.uniq(files)\n\n    let parser = new FileParser()\n\n    return await parser.parseFiles(files)\n  }\n\n  async write(nodes: Map<string, DocumentNode>): Promise<Queries> {\n    const compiledNodes: Queries = new Map()\n    const namePathMap = new Map()\n    const nameDefMap = new Map()\n    const documents = []\n\n    for (let [filePath, doc] of nodes.entries()) {\n      let errors = validate(this.schema, doc, validationRules)\n\n      if (errors && errors.length) {\n        this.reportError(graphqlValidationError(errors, filePath))\n        return compiledNodes\n      }\n\n      documents.push(doc)\n      doc.definitions.forEach((def: any) => {\n        const name: string = def.name.value\n        namePathMap.set(name, filePath)\n        nameDefMap.set(name, def)\n      })\n    }\n\n    let compilerContext = new GraphQLCompilerContext(this.schema)\n    try {\n      compilerContext = compilerContext.addAll(\n        ASTConvert.convertASTDocuments(\n          this.schema,\n          documents,\n          validationRules,\n          RelayParser.transform.bind(RelayParser)\n        )\n      )\n    } catch (error) {\n      this.reportError(graphqlError(namePathMap, nameDefMap, error))\n      return compiledNodes\n    }\n\n    // relay-compiler v1.5.0 added \"StripUnusedVariablesTransform\" to\n    // printTransforms. Unfortunately it currently doesn't detect variables\n    // in input objects widely used in gatsby, and therefore removing\n    // variable declaration from queries.\n    // As a temporary workaround remove that transform by slicing printTransforms.\n    const printContext = printTransforms\n      .slice(0, -1)\n      .reduce((ctx, transform) => transform(ctx, this.schema), compilerContext)\n\n    compilerContext.documents().forEach((node: { name: string }) => {\n      if (node.kind !== `Root`) return\n\n      const { name } = node\n      let filePath = namePathMap.get(name) || ``\n\n      if (compiledNodes.has(filePath)) {\n        let otherNode = compiledNodes.get(filePath)\n        this.reportError(\n          multipleRootQueriesError(\n            filePath,\n            nameDefMap.get(name),\n            otherNode && nameDefMap.get(otherNode.name)\n          )\n        )\n        return\n      }\n\n      let text = filterContextForNode(printContext.getRoot(name), printContext)\n        .documents()\n        .map(GraphQLIRPrinter.print)\n        .join(`\\n`)\n\n      const query = {\n        name,\n        text,\n        originalText: nameDefMap.get(name).text,\n        path: filePath,\n        isStaticQuery: nameDefMap.get(name).isStaticQuery,\n        hash: nameDefMap.get(name).hash,\n      }\n\n      if (query.isStaticQuery) {\n        query.jsonName =\n          `sq--` +\n          _.kebabCase(\n            `${path.relative(store.getState().program.directory, filePath)}`\n          )\n      }\n      compiledNodes.set(filePath, query)\n    })\n\n    return compiledNodes\n  }\n}\nexport { Runner }\n\nexport default async function compile(): Promise<Map<string, RootQuery>> {\n  const { program, schema } = store.getState()\n\n  const runner = new Runner(\n    `${program.directory}/src`,\n    `${program.directory}/.cache/fragments`,\n    schema\n  )\n\n  const queries = await runner.compileAll()\n\n  return queries\n}\n"],"file":"query-compiler.js"}