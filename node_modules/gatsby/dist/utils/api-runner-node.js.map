{"version":3,"sources":["../../src/utils/api-runner-node.js"],"names":["Promise","require","glob","_","tracer","globalTracer","reporter","Cache","apiList","createNodeId","createContentDigest","caches","Map","boundPluginActionCreators","doubleBind","boundActionCreators","api","plugin","actionOptions","traceId","name","keys","Object","doubleBoundActionCreators","i","length","key","boundActionCreator","args","initAPICallTracing","parentSpan","startSpan","spanName","spanArgs","defaultSpanArgs","childOf","merge","runAPI","gatsbyNode","resolve","spanOptions","pluginSpan","setTag","pathPrefix","store","emitter","loadNodeContent","getNodes","getNode","getNodesByType","hasNodeChanged","getNodeAndSavePathDependency","getState","program","prefixPaths","config","namespacedCreateNodeId","id","tracing","cache","get","init","set","apiCallArgs","actions","pluginOptions","fromCallback","callback","cb","err","val","finish","result","filteredPlugins","hasAPIFile","sync","apisRunningById","apisRunningByTraceId","waitingForCasacadeToFinish","module","exports","pluginSource","apiSpanArgs","apiSpan","forEach","traceTags","value","panic","plugins","flattenedPlugins","filter","noSourcePluginPlugins","p","apiRunInstance","span","startTime","Date","toJSON","type","node","internal","contentDigest","filename","page","path","JSON","stringify","waitForCascadingActions","push","has","currentCount","mapSeries","pluginName","catch","panicOnBuild","then","results","delete","size","emit","isEmpty","instance","apisByTraceIdCount"],"mappings":"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","sourcesContent":["const Promise = require(`bluebird`)\nconst glob = require(`glob`)\nconst _ = require(`lodash`)\n\nconst tracer = require(`opentracing`).globalTracer()\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst Cache = require(`./cache`)\nconst apiList = require(`./api-node-docs`)\nconst createNodeId = require(`./create-node-id`)\nconst createContentDigest = require(`./create-content-digest`)\n\nlet caches = new Map()\n\n// Bind action creators per plugin so we can auto-add\n// metadata to actions they create.\nconst boundPluginActionCreators = {}\nconst doubleBind = (boundActionCreators, api, plugin, actionOptions) => {\n  const { traceId } = actionOptions\n  if (boundPluginActionCreators[plugin.name + api + traceId]) {\n    return boundPluginActionCreators[plugin.name + api + traceId]\n  } else {\n    const keys = Object.keys(boundActionCreators)\n    const doubleBoundActionCreators = {}\n    for (let i = 0; i < keys.length; i++) {\n      const key = keys[i]\n      const boundActionCreator = boundActionCreators[key]\n      if (typeof boundActionCreator === `function`) {\n        doubleBoundActionCreators[key] = (...args) => {\n          // Let action callers override who the plugin is. Shouldn't be\n          // used that often.\n          if (args.length === 1) {\n            boundActionCreator(args[0], plugin, actionOptions)\n          } else if (args.length === 2) {\n            boundActionCreator(args[0], args[1], actionOptions)\n          }\n        }\n      }\n    }\n    boundPluginActionCreators[\n      plugin.name + api + traceId\n    ] = doubleBoundActionCreators\n    return doubleBoundActionCreators\n  }\n}\n\nconst initAPICallTracing = parentSpan => {\n  const startSpan = (spanName, spanArgs = {}) => {\n    const defaultSpanArgs = { childOf: parentSpan }\n\n    return tracer.startSpan(spanName, _.merge(defaultSpanArgs, spanArgs))\n  }\n\n  return {\n    tracer,\n    parentSpan,\n    startSpan,\n  }\n}\n\nconst runAPI = (plugin, api, args) => {\n  const gatsbyNode = require(`${plugin.resolve}/gatsby-node`)\n  if (gatsbyNode[api]) {\n    const parentSpan = args && args.parentSpan\n    const spanOptions = parentSpan ? { childOf: parentSpan } : {}\n    const pluginSpan = tracer.startSpan(`run-plugin`, spanOptions)\n\n    pluginSpan.setTag(`api`, api)\n    pluginSpan.setTag(`plugin`, plugin.name)\n\n    let pathPrefix = ``\n    const { store, emitter } = require(`../redux`)\n    const {\n      loadNodeContent,\n      getNodes,\n      getNode,\n      getNodesByType,\n      hasNodeChanged,\n      getNodeAndSavePathDependency,\n    } = require(`../db/nodes`)\n    const { boundActionCreators } = require(`../redux/actions`)\n\n    const doubleBoundActionCreators = doubleBind(\n      boundActionCreators,\n      api,\n      plugin,\n      { ...args, parentSpan: pluginSpan }\n    )\n\n    if (store.getState().program.prefixPaths) {\n      pathPrefix = store.getState().config.pathPrefix\n    }\n\n    const namespacedCreateNodeId = id => createNodeId(id, plugin.name)\n\n    const tracing = initAPICallTracing(pluginSpan)\n\n    let cache = caches.get(plugin.name)\n    if (!cache) {\n      cache = new Cache({ name: plugin.name }).init()\n      caches.set(plugin.name, cache)\n    }\n\n    const apiCallArgs = [\n      {\n        ...args,\n        pathPrefix,\n        boundActionCreators: doubleBoundActionCreators,\n        actions: doubleBoundActionCreators,\n        loadNodeContent,\n        store,\n        emitter,\n        getNodes,\n        getNode,\n        getNodesByType,\n        hasNodeChanged,\n        reporter,\n        getNodeAndSavePathDependency,\n        cache,\n        createNodeId: namespacedCreateNodeId,\n        createContentDigest,\n        tracing,\n      },\n      plugin.pluginOptions,\n    ]\n\n    // If the plugin is using a callback use that otherwise\n    // expect a Promise to be returned.\n    if (gatsbyNode[api].length === 3) {\n      return Promise.fromCallback(callback => {\n        const cb = (err, val) => {\n          pluginSpan.finish()\n          callback(err, val)\n        }\n        gatsbyNode[api](...apiCallArgs, cb)\n      })\n    } else {\n      const result = gatsbyNode[api](...apiCallArgs)\n      pluginSpan.finish()\n      return Promise.resolve(result)\n    }\n  }\n\n  return null\n}\n\nlet filteredPlugins\nconst hasAPIFile = plugin => glob.sync(`${plugin.resolve}/gatsby-node*`)[0]\n\nlet apisRunningById = new Map()\nlet apisRunningByTraceId = new Map()\nlet waitingForCasacadeToFinish = []\n\nmodule.exports = async (api, args = {}, pluginSource) =>\n  new Promise(resolve => {\n    const { parentSpan } = args\n    const apiSpanArgs = parentSpan ? { childOf: parentSpan } : {}\n    const apiSpan = tracer.startSpan(`run-api`, apiSpanArgs)\n\n    apiSpan.setTag(`api`, api)\n    _.forEach(args.traceTags, (value, key) => {\n      apiSpan.setTag(key, value)\n    })\n\n    // Check that the API is documented.\n    if (!apiList[api]) {\n      reporter.panic(`api: \"${api}\" is not a valid Gatsby api`)\n    }\n\n    const { store } = require(`../redux`)\n    const plugins = store.getState().flattenedPlugins\n    // Get the list of plugins that implement gatsby-node\n    if (!filteredPlugins) {\n      filteredPlugins = plugins.filter(plugin => hasAPIFile(plugin))\n    }\n\n    // Break infinite loops.\n    // Sometimes a plugin will implement an API and call an\n    // action which will trigger the same API being called.\n    // \"onCreatePage\" is the only example right now.\n    // In these cases, we should avoid calling the originating plugin\n    // again.\n    let noSourcePluginPlugins = filteredPlugins\n    if (pluginSource) {\n      noSourcePluginPlugins = filteredPlugins.filter(\n        p => p.name !== pluginSource\n      )\n    }\n\n    const apiRunInstance = {\n      api,\n      args,\n      pluginSource,\n      resolve,\n      span: apiSpan,\n      startTime: new Date().toJSON(),\n      traceId: args.traceId,\n    }\n\n    // Generate IDs for api runs. Most IDs we generate from the args\n    // but some API calls can have very large argument objects so we\n    // have special ways of generating IDs for those to avoid stringifying\n    // large objects.\n    let id\n    if (api === `setFieldsOnGraphQLNodeType`) {\n      id = `${api}${apiRunInstance.startTime}${args.type.name}${args.traceId}`\n    } else if (api === `onCreateNode`) {\n      id = `${api}${apiRunInstance.startTime}${\n        args.node.internal.contentDigest\n      }${args.traceId}`\n    } else if (api === `preprocessSource`) {\n      id = `${api}${apiRunInstance.startTime}${args.filename}${args.traceId}`\n    } else if (api === `onCreatePage`) {\n      id = `${api}${apiRunInstance.startTime}${args.page.path}${args.traceId}`\n    } else {\n      id = `${api}|${apiRunInstance.startTime}|${\n        apiRunInstance.traceId\n      }|${JSON.stringify(args)}`\n    }\n    apiRunInstance.id = id\n\n    if (args.waitForCascadingActions) {\n      waitingForCasacadeToFinish.push(apiRunInstance)\n    }\n\n    apisRunningById.set(apiRunInstance.id, apiRunInstance)\n    if (apisRunningByTraceId.has(apiRunInstance.traceId)) {\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount + 1)\n    } else {\n      apisRunningByTraceId.set(apiRunInstance.traceId, 1)\n    }\n\n    Promise.mapSeries(noSourcePluginPlugins, plugin => {\n      let pluginName =\n        plugin.name === `default-site-plugin`\n          ? `gatsby-node.js`\n          : `Plugin ${plugin.name}`\n\n      return new Promise(resolve => {\n        resolve(runAPI(plugin, api, { ...args, parentSpan: apiSpan }))\n      }).catch(err => {\n        reporter.panicOnBuild(`${pluginName} returned an error`, err)\n        return null\n      })\n    }).then(results => {\n      // Remove runner instance\n      apisRunningById.delete(apiRunInstance.id)\n      const currentCount = apisRunningByTraceId.get(apiRunInstance.traceId)\n      apisRunningByTraceId.set(apiRunInstance.traceId, currentCount - 1)\n\n      if (apisRunningById.size === 0) {\n        const { emitter } = require(`../redux`)\n        emitter.emit(`API_RUNNING_QUEUE_EMPTY`)\n      }\n\n      // Filter empty results\n      apiRunInstance.results = results.filter(result => !_.isEmpty(result))\n\n      // Filter out empty responses and return if the\n      // api caller isn't waiting for cascading actions to finish.\n      if (!args.waitForCascadingActions) {\n        apiSpan.finish()\n        resolve(apiRunInstance.results)\n      }\n\n      // Check if any of our waiters are done.\n      waitingForCasacadeToFinish = waitingForCasacadeToFinish.filter(\n        instance => {\n          // If none of its trace IDs are running, it's done.\n          const apisByTraceIdCount = apisRunningByTraceId.get(instance.traceId)\n          if (apisByTraceIdCount === 0) {\n            instance.span.finish()\n            instance.resolve(instance.results)\n            return false\n          } else {\n            return true\n          }\n        }\n      )\n      return\n    })\n  })\n"],"file":"api-runner-node.js"}