{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<p>At Fraight, we have an <a href=\"https://www.elastic.co/\">Elasticsearch</a> backed search interface that allows users to type a freetext query and get a list of database records sorted by relevancy. At it's core, this is a simple problem: if the user types in <code class=\"language-text\">Joe</code>, return all partners whose name contains the word <code class=\"language-text\">Joe</code>. And indeed, returning all the <code class=\"language-text\">Joe</code>s in the system is trivial; the problem is that we work with hundreds of <code class=\"language-text\">Joe</code>s. We needed a way to return the particular <code class=\"language-text\">Joe</code> that the user cares about.</p>\n<!-- more -->\n<h2>A Poor Solution</h2>\n<p>When I worked at <a href=\"https://www.epic.com/\">Epic</a>, we had a search interface that allowed us to look up patients by name, and it suffered the same problem described above. Epic solved this problem by providing additional fields like birthdate or address and used this additional identifying information to pare down the search results. This solution slows down the user's workflow and can be improved.</p>\n<h2>Our Solution</h2>\n<p>At Fraight, we created a solution that just works. The user enters a name, and the system returns 5-10 results, and more often than not, the first two results contain the record the user is looking for. Here's how we did it.</p>\n<p>We needed to customize the score that Elasticsearch calculates for each matched record. For the uninitiated, Elasticsearch's score is an indicator of the relevancy of a particular search result. Prior to our scoring customizations, given a query for a name, our Elasticsearch query for <code class=\"language-text\">Joe</code> would pare down a dataset of ~10,000,000 records to ~100 results, but each of the 100 search results would have the same score (since they were all named Joe)! Here's how we customized our the Elasticsearch scoring system so that we could more accurately sort the 100 results based on relevancy.</p>\n<h2>Custom Scoring</h2>\n<p>We settled on two attributes that should influence the score of a particular partner:</p>\n<ol>\n<li>How often we interact with a partner</li>\n<li>How recently we've interacted with a partner</li>\n</ol>\n<p>It's important to know that we have worked with most of the partners in our system minimally. We needed to remove this noise from the search results. Phrased differently, if we regularly work with a particular <code class=\"language-text\">John Doe</code>, we want that partner to appear above all the other <code class=\"language-text\">John Doe</code>s in the search results.</p>\n<p>Similarly, if we have recently interacted with a particular partner, there's a good chance we will interact with them again soon. These partners should rank higher.</p>\n<p>It's important, however, to consider the time since our last interaction. If we interacted with someone yesterday, it's important to rank them higher than an a partner we interacted with 10 days ago.</p>\n<h2>Getting the Data</h2>\n<p>Both of these scoring strategies required us to populate Elasticsearch with information detailing the recency and volume of our interactions with each partner. We were lucky to that we already tracked these data points using a change <a href=\"https://en.wikipedia.org/wiki/Change_data_capture\">data capture system</a>. All we needed to do was ensure that any changes to the primary datastore would sync with Elasticsearch.</p>\n<h2>Elasticsearch Custom Scores</h2>\n<p>Elasticsearch provides [function score queries]<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-field-value-factor\">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-field-value-factor</a>), a syntax that allows the user to modify Elasticsearch's calculated store.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/1dabe/simple-score-query.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 680px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 77.62237762237763%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAABx0lEQVQ4y6VUXW+jMBDk//+xtLlCSAhtxUcMBAgm2NhpTvc4t96oEbSJTuk9rAysPTsz68VL4i1EUaDvD0iSFFmeQwgBay2MMQ+H97oJUDcN2qbGNoqRpRkKKuAAx3F8OLzz2MPYE6TqoayCMgqj0dBKcUW36TuT8Zr7mvd+WwNFH4Nihed8iRfhozlUxFpAj5oPuHXQA4fWesboa1ECdAkDay4S430MXwRYlSGDv9Xv+CVeEFURF+plgxMpMqOZgX2uDKgn1RywHCTCcoWn/Blhscam3BB4wMVWRYg1vadtiq6rIWV79XsCaL554uSJThBb/8KYQhx2CEofi3yBuIoxDD3t17cYzk13ScdUEWhQ+Cz5naQ7gNdyh0i8ce5k7G0P9R0/2mOD5W7JDMNyjbROUB1aJPuU2VdyT16SqnsMr92jZ2d8KUsssifybcUNisi7ru/Yv2i/RdWVUOp4W/KUttaKvXHNWRMz1wwHmDUJmk5S3uB8Ol+6fVvyVKqlMWw5TvaDD32G89W6fWa8exevgJYOuHnuZM3P/xqxe1Pk/fkgoKPkO2X4cuu5n4/Osu5rZqjUMLs2P/nTMEOrJHli/4vVNP4CwrWuh1ya48UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <picture>\n        <source\n          srcset=\"/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/4ca7d/simple-score-query.webp 170w,\n/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/515c8/simple-score-query.webp 340w,\n/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/d6460/simple-score-query.webp 680w,\n/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/0d7ed/simple-score-query.webp 858w\"\n          sizes=\"(max-width: 680px) 100vw, 680px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/f4d37/simple-score-query.png 170w,\n/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/dee79/simple-score-query.png 340w,\n/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/7ef4c/simple-score-query.png 680w,\n/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/1dabe/simple-score-query.png 858w\"\n          sizes=\"(max-width: 680px) 100vw, 680px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n          src=\"/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/7ef4c/simple-score-query.png\"\n          alt=\"simple score query\"\n          title=\"\"\n          src=\"/static/32332fb7bb6c584ff6f0d9bb24c0ae7f/7ef4c/simple-score-query.png\"\n        />\n      </picture>\n      </span>\n  </span>\n  \n  </a>\n    </p>\n<p>The above function score query tells Elasticsearch to multiply the calcualted score by 1.2 times the square root of the likes field. This query effectively gives documents with more likes preference over documents with fewer likes.</p>\n<p>We need a little more customization and opted to use Elasticsearch's <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score\">script score</a> functionality to write our own scoring function.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2ef00167faf31c6eb064368b3113ea79/e03dd/script-score.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 680px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 52.90780141843972%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABW0lEQVQoz51Ty3LCMAzM//9aHxemLRBCiBPnZcdPyHUrC8KEaS9w2JEs2+tdKcmaqoSoBPL8AGMMnHOw1nJ8BdmkB5RtBdlJWCIMziP4AE/R3sifQRacwa7dYyM2+BZfKPsSeXtA0ws4OhB9ZHJ/e2hBWv/nJove8QFjDbZyh4/yE3m9xah69KpDMzboKKpphFQtWkKKAzkzZvpDmkVniSzJNTCTRk0Ep/6EKeWDwI/comgLtKNk5UV35FgPNZ1R1BZ7J2TLkQuOCQuZYyf32BMOdFGrERcXMceZrJ9xCRfGHGacw5mcRXa3VkmEq8ZTntS9Hd+RE3nTnVANFQSpYev62oKkTioJSarrkZSurN8VcoGmrPVIBIIu1uiJ4EhK0yOplki4JfRIiqnG7Xkg9NdEa8Vky2SXSaZ8WS9Yr1P+YNkbDU0DSEPgDWef/vYehpIIzaqw3nzlT/kFJFA78hKsw4sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <picture>\n        <source\n          srcset=\"/static/2ef00167faf31c6eb064368b3113ea79/4ca7d/script-score.webp 170w,\n/static/2ef00167faf31c6eb064368b3113ea79/515c8/script-score.webp 340w,\n/static/2ef00167faf31c6eb064368b3113ea79/d6460/script-score.webp 680w,\n/static/2ef00167faf31c6eb064368b3113ea79/c4056/script-score.webp 1020w,\n/static/2ef00167faf31c6eb064368b3113ea79/862d7/script-score.webp 1360w,\n/static/2ef00167faf31c6eb064368b3113ea79/87d38/script-score.webp 1410w\"\n          sizes=\"(max-width: 680px) 100vw, 680px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/2ef00167faf31c6eb064368b3113ea79/f4d37/script-score.png 170w,\n/static/2ef00167faf31c6eb064368b3113ea79/dee79/script-score.png 340w,\n/static/2ef00167faf31c6eb064368b3113ea79/7ef4c/script-score.png 680w,\n/static/2ef00167faf31c6eb064368b3113ea79/7236f/script-score.png 1020w,\n/static/2ef00167faf31c6eb064368b3113ea79/1cc92/script-score.png 1360w,\n/static/2ef00167faf31c6eb064368b3113ea79/e03dd/script-score.png 1410w\"\n          sizes=\"(max-width: 680px) 100vw, 680px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n          src=\"/static/2ef00167faf31c6eb064368b3113ea79/7ef4c/script-score.png\"\n          alt=\"script score\"\n          title=\"\"\n          src=\"/static/2ef00167faf31c6eb064368b3113ea79/7ef4c/script-score.png\"\n        />\n      </picture>\n      </span>\n  </span>\n  \n  </a>\n    </p>\n<p>The above function specifies a query that searches for the word <code class=\"language-text\">elasticsearch</code> inside the <code class=\"language-text\">message</code> field.</p>\n<p>It then multiplies the score of every matching result by the <code class=\"language-text\">script_score</code>: <code class=\"language-text\">params.a / Math.pow(params.b, doc[&#39;likes&#39;].value)</code></p>\n<p>This particular script score divides 5 by 1.2 to the power of the number of likes on each matching document. This script score allows for limitless flexibility in term of score modification.</p>\n<h2>Custom Scoring Implementation</h2>\n<p>We wanted our ultimate score to be a function of three values:</p>\n<ol>\n<li>The score returned from elasticsearch</li>\n<li>Our total interactions with a partner</li>\n<li>The number of days since our last interaction with a partner</li>\n</ol>\n<h3>Initial Attempt</h3>\n<p>In our first iteration, however, we only considered the first data points. Our scoring function looked like this.</p>\n<p><code class=\"language-text\">newScore = _score * sqrt(numInteractions + 1)</code></p>\n<p>Here was our thought process. We wanted partners we worked with a lot of interactions to rise to the top of the search results. The square root tempers the affect of the <code class=\"language-text\">numInteractions</code> on the score, and the <code class=\"language-text\">+1</code> was to ensure that for partner where <code class=\"language-text\">numInteractions</code> is 0 that we didn't make the <code class=\"language-text\">newScore</code> equal to 0.</p>\n<h3>Introducing an Upperbound</h3>\n<p>The above solution resulted in an overwhelming preference towards certain partners. In realty, we do not value more highly a partner with whom we've interacted 1000 times any more than a partner with whom we've interacted 100 times. Taking this feedback into account, our new scoring function looked like this:</p>\n<p><code class=\"language-text\">newScore = _score * (numInteractions &gt; 100 ? 2 : 1)</code></p>\n<p>We effectively created a step function where the original <code class=\"language-text\">elasticsearch</code> score is either doubled or left unchanged. This creates an upperbound of the amount that <code class=\"language-text\">numInteractions</code> can influence the resulting score. Originally, we had discussed more complicated techniques like <a href=\"https://en.wikipedia.org/wiki/Logistic_function\">logistic functions</a>, but this strategy has worked fine.</p>\n<h3>Incorporating Time</h3>\n<p>I mentioned above that when we form a new partnership, there's a good chance we will interact with that partner again soon. The above scoring strategy will push out these newer partners (since we've interacted with them fewer than 100 times), favoring those we've worked with frequently, even if we haven't talked to those partners in months.</p>\n<p>Ultimately, we wanted our function to double the original score if we've interacted with a partner in the past 3 days. Afterwards, we wanted the score contribution to decay, such that the original score would be unchanged after 45 days of not interacting with a partner.</p>\n<p>Let's take a detour to highschool math to derive this function. We want a function that passes through following points:</p>\n<p><code class=\"language-text\">(45, 1)</code> and <code class=\"language-text\">(3, 2)</code></p>\n<p>Using the point slope formula, we get</p>\n<p><code class=\"language-text\">2 - 1</code>\n/\n<code class=\"language-text\">3 - 45</code></p>\n<p>(could be some density/decay function that looks at density of interactions over time)</p>\n<h3>Other Domains</h3>\n<p>You can apply these techniques to many other domains.</p>\n<p>For example, I suspect that hospital staff are more likely to look up patients who have upcoming appointments, a same-day appointment, or who have recently finished an appointment. You could write a function like the one we used to factor in the recency of interaction with our partners</p>\n<p>Or suppose you run an event website or Ticketmaster Eventbrite. I'm sure there's a correlation between the how soon an event is and how much user's care about it. You could write a scoring function that leverages this knowledge.</p>\n<p><em>If you have search problems, I do <a href=\"/hire-me\">consulting</a> work and am currently looking for new clients. Please <a href=\"mailto:nick@nickdrane.com\">contact me</a> for more details.</em></p>","fields":{"slug":"index"},"frontmatter":{"title":"Optimizing Elasticsearch Score: How to Rank Similar Documents","date":"2018-12-17T00:00:00.000Z"}}}]}},"pageContext":{"category":"Elasticsearch"}}