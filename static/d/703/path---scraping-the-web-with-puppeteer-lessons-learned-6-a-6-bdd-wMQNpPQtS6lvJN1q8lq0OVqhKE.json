{"data":{"markdownRemark":{"html":"<h2>Table of Contents</h2>\n<ul>\n<li><a href=\"#what-is-puppeteer\">What is Puppeteer?</a></li>\n<li><a href=\"#a-simple-example\">A Simple Example</a></li>\n<li><a href=\"#a-more-complicated-example\">A More Complicated Example</a></li>\n<li><a href=\"#brace-yourself-for-flaky-behavior\">Brace Yourself for Flaky Behavior</a></li>\n<li><a href=\"#puppeteer-was-completely-unnecessary\">Puppeteer Was Completely Unnecessary</a></li>\n<li>\n<p><a href=\"#when-is-puppeteer-the-right-solution\">When is Puppeteer the Right Solution</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"#footnotes\">Footnotes</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p>I'm currently contracted to create a web service using some data from a third party Angular application. I worked off a proof of concept codebase that used Chrome's new <a href=\"https://github.com/GoogleChrome/puppeteer\">Puppeteer</a> API to scrape this site. I strongly regret not starting from scratch.</p>\n<!-- more -->\n<h2>What is Puppeteer?</h2>\n<p>Puppeteer is a Node API that allows you to control Google's headless Chrome browser. Imagine a version of your browser that can send and receive requests but has no GUI. It works in the background, performing actions as instructed by an API. This makes Puppeteer great for end to end testing a web application. You can truly simulate the user experience, typing where they type and clicking where they click. Another use case for Puppeteer is web scraping a single page web application. Let's explore how this might work.</p>\n<h2>A Simple Example</h2>\n<p>For any Puppeteer project, the first task is to create an instance of the headless browser.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> browser <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// We will use this page instance and it's API frequently</span>\n<span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>browser<span class=\"token punctuation\">.</span><span class=\"token function\">newPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>After that's done, it's trivial to navigate to and begin interacting with a webpage. Let's suppose I want to fill out a login form and submit an authentication request to a website. In an ideal situation, it looks like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Navigate to the website</span>\n<span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">goto</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://website/login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Provide the selector of an input box and the content to type</span>\n<span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">'input#username'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CREDENTIALS</span><span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span><span class=\"token string\">'input#password'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CREDENTIALS</span><span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token string\">'button#login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Click the login button</span>\n\n<span class=\"token comment\">// Wait until the screen changes and a node matching</span>\n<span class=\"token comment\">// the selector #logged-in-successfully appears,</span>\n<span class=\"token comment\">// at which point we know the login was successful</span>\n<span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">waitForSelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#logged-in-successfully'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We just successfully filled out a form, submitted an HTTP request containing our form data, and waited for the page to change upon successful login. This is where Puppeteer shines. Let's look at a more complicated example.</p>\n<h2>A More Complicated Example</h2>\n<p>Today's web uses a mix of simple html driven forms as well as more complicated, javascript-driven forms, rich with functionality like autocomplete and dynamic dropdown menus. I'm sure you've used a calendar date picker. These components each need to be treated differently.</p>\n<p>Here is a modified version of some code I wrote for my client:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// The form inputs I want to fill out</span>\n<span class=\"token comment\">// and their corresponding selectors</span>\n<span class=\"token keyword\">const</span> fields <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token punctuation\">:</span> <span class=\"token string\">'input[ng-model=\"type\"]'</span><span class=\"token punctuation\">,</span>\n  origin<span class=\"token punctuation\">:</span> <span class=\"token string\">'input[ng-model=\"origin\"]'</span><span class=\"token punctuation\">,</span>\n  destination<span class=\"token punctuation\">:</span> <span class=\"token string\">'input[ng-model=\"destination\"]'</span><span class=\"token punctuation\">,</span>\n  date<span class=\"token punctuation\">:</span> <span class=\"token string\">'input[ng-model=\"date\"]'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">search</span><span class=\"token punctuation\">(</span>searchParams<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> page <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>browser<span class=\"token punctuation\">.</span><span class=\"token function\">newPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">goto</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://website/search\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// We need to click a button to make the search form</span>\n  <span class=\"token comment\">// appear, but first make sure that button has rendered</span>\n  <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">waitForSelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".new-search\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".new-search\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Fill out the form</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> field <span class=\"token keyword\">of</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>fields<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>searchParams<span class=\"token punctuation\">[</span>field<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> selector <span class=\"token operator\">=</span> fields<span class=\"token punctuation\">[</span>field<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// We want to make sure each DOM node is rendered</span>\n      <span class=\"token comment\">// before we try to do anything to it.</span>\n      <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">waitForSelector</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Some inputs need to be focused first for page.type to work</span>\n      <span class=\"token comment\">// Might as well focus on all of them</span>\n      <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Some inputs have defaults that need to be</span>\n      <span class=\"token comment\">// erased before typing your own input</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>field <span class=\"token operator\">===</span> <span class=\"token string\">\"date\"</span> <span class=\"token operator\">||</span> field <span class=\"token operator\">===</span> <span class=\"token string\">\"type\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// This is a helper function I wrote</span>\n        <span class=\"token keyword\">await</span> <span class=\"token function\">deleteInput</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">,</span> selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">,</span> searchParams<span class=\"token punctuation\">[</span>field<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// This field won't register the typed data</span>\n      <span class=\"token comment\">// until Enter is pressed.</span>\n      <span class=\"token comment\">// This is because the 'type' field is a dropdown</span>\n      <span class=\"token comment\">// where one of a specific set of inputs must be clicked.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>field <span class=\"token operator\">===</span> <span class=\"token string\">\"type\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span>keyboard<span class=\"token punctuation\">.</span><span class=\"token function\">press</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Enter\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The first thing to notice is that the code is messy and full of weird exceptions. To make matters worse, it doesn't always work.</p>\n<h2>Brace Yourself for Flaky Behavior</h2>\n<p>Working with Puppeteer was an exercise in guesswork. Given the same inputs, Puppeteer did not always produce the same outputs<sup><a href=\"#footnote1\">1</a></sup>. This flaky behavior made the project unnecessarily challenging and required me to do additional engineering to increase reliability, which was frustrating considering the alternative.</p>\n<h2>Puppeteer Was Completely Unnecessary</h2>\n<p>Puppeteer has a API that allows you to execute arbitrary code against the DOM. After scraping form results with this API and getting the same flaky behavior described above, I ditched the approach and started grabbing data from the HTTP response objects themselves. Below is a primitive version of some code I wrote to do this.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">waitForUrl</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">,</span> urlPrefix<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span>resolve <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    page<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"response\"</span><span class=\"token punctuation\">,</span> res <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span>urlPrefix<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The page passed into this function is the same page object created above by the Puppeteer API. Among other things, it is an event emitter that allows me to listen for any HTTP responses. I've essentially created a promise that resolves to the response body of a particular ajax request. This allowed me interact with the server API directly and removed the DOM from the data retrieval process, greatly reducing the chance for flaky behavior. But that begs the question, why use Puppeteer at all? Why not simply send http requests to the server API manually and ditch the complicated form submission code above That's how I should have started all along.</p>\n<h2>When is Puppeteer the Right Solution</h2>\n<p>I can only think of a single scenario where using Puppeteer for scraping is superior to the alternative: if the information you want is generated using a combination of API data and javascript code. After all, you would have no other way to simulate the javascript code without rewriting it.</p>\n<p>If, however, all you need is data from the server, go the simple route and hit the API with an HTTP library like <a href=\"https://github.com/axios/axios\">axios</a> or <a href=\"https://github.com/request/request\">request</a>. If you are scraping a server side rendered application, you can combine one of the aforementioned tools with <a href=\"https://github.com/cheeriojs/cheerio\">Cheerio</a>, giving you a far more user friendly DOM manipulation API than that offered my Puppeteer.</p>\n<p><em>If you need help with webscraping or puppeteer, I do <a href=\"/hire-me\">consulting</a> work and am currently looking for new clients. Please contact me for more details.</em></p>\n<h4>Footnotes</h4>\n<p><a name=\"footnote1\">1</a>: You might be curious why Puppeteer exhibited flaky behavior. One issue that I ran into was animations. I might attempt to click a DOM node, but if the animation had not finished, the click would not register. In essence, it would appear as if the click had worked, but once the animation finished, the DOM would reset itself, undoing my click. I think this is simply how Angular's digest loop reacted to a click at an unexpected time. Unfortunately, Puppeteer provides no functionality to determine when an animation has finished (after all, how would it!). I tried a couple solutions. One entailed a sleep function to wait a couple hundred milliseconds for the animation to finish, but it simply exacerbated the flaky behavior. A second involved executing the click only once the DOM node had a particular class that indicated the animation had finished. At one point, I even tried to disable all animations across the website. All these solutions were half-baked.</p>","slug":"scraping-the-web-with-puppeteer-lessons-learned","frontmatter":{"title":"Scraping the Web with Puppeteer: Lessons Learned","date":"2017-12-09T15:35:13.000Z"}}},"pageContext":{"slug":"scraping-the-web-with-puppeteer-lessons-learned"}}