<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  
    <title>
      Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL › Nick Drane
    </title>
    
      <meta name="author" content="Nick Drane">
      
        
            <meta name="description" content="Nick Drane&#39;s blog about programming and modern web development, particularly Node.js and React.">
            
                  
                      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

                      
                        <meta property="og:title" content="Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL" />
                        
                          <meta property="og:site_name" content="Nick Drane" />

                          
                              <meta property="og:image" content="" />
                              
                                <meta name="google-site-verification" content="0iahwlYFOHM2sYjk4TF5_lP0DqzgOgkXnZcKV-Qci8A" />

                                <link href="/favicon.png" rel="icon">
                                <link rel="alternate" href="/atom.xml" title="Nick Drane"
                                  type="application/atom+xml">
                                <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
                                <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
                                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-107252357-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-107252357-1');
</script>
</head>

<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">Nick Drane</a></h1>
  <nav id="main-nav">
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/hire-me">Hire Me</a></li>
      <li><a href="/projects">Projects</a></li>
      <li><a href="/archives">Archives</a></li>
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
  
    <div class="social">
      <ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnickdrane.com%2Fusing-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres%2F&quote=Using%20jq%20to%20Effortlessly%20Ingest%20Line-delimited%20JSON%20into%20PostgreSQL" title="Share on Facebook" target="_blank"><img alt="Share on Facebook" src="/images/social/Facebook.png" /></a></li>
  <li><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnickdrane.com%2Fusing-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres%2F&text=Using%20jq%20to%20Effortlessly%20Ingest%20Line-delimited%20JSON%20into%20PostgreSQL" target="_blank" title="Tweet"><img alt="Tweet" src="/images/social/Twitter.png" /></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fnickdrane.com%2Fusing-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres%2F&title=Using%20jq%20to%20Effortlessly%20Ingest%20Line-delimited%20JSON%20into%20PostgreSQL" target="_blank" title="Share on LinkedIn"><img alt="Share on LinkedIn" src="/images/social/LinkedIn.png" /></a></li>
  <li><a href="mailto:?subject=Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL&body=Check this out: http://nickdrane.com/using-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres/" target="_blank" title="Send email"><img alt="Send email" src="/images/social/Email.png" /></a></li>
</ul>
    </div class="social">
  
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title">Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL</h1>
  

      
        <time datetime="2018-10-18T05:00:00.000Z">2018-10-18</time>
      
    </header>
    <div class="entry">
      <p>I recently wanted to ingest a <a href="https://en.wikipedia.org/wiki/JSON_streaming#Line-delimited_JSON" target="_blank" rel="noopener">line-delimited</a> JSON file into <a href="https://www.postgresql.org/" target="_blank" rel="noopener">Postgres</a> for some quick data exploration. I was surprised when I couldn’t find a simple solution online. Here is my approach.</p>
<a id="more"></a>
<h2 id="Downloading-250000-Hacker-News-Comments"><a href="#Downloading-250000-Hacker-News-Comments" class="headerlink" title="Downloading 250000 Hacker News Comments"></a>Downloading 250000 Hacker News Comments</h2><p>Let’s say we want to download all of the <a href="https://news.ycombinator.com/" target="_blank" rel="noopener">Hacker News</a> comments from the month of May. A line-delimited JSON file is available from <a href="https://files.pushshift.io/hackernews/HNI_2018-05.bz2" target="_blank" rel="noopener">pushshift</a>. Fetching and decompressing the file is simple:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 | bzip2 -d</span><br></pre></td></tr></table></figure>
<p>Here is what the dataset looks like:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"by"</span>: <span class="string">"criddell"</span>,</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">16966059</span>,</span><br><span class="line">  <span class="attr">"kids"</span>: [</span><br><span class="line">    <span class="number">16966312</span>,</span><br><span class="line">    <span class="number">16966776</span>,</span><br><span class="line">    <span class="number">16969455</span>,</span><br><span class="line">    <span class="number">16966323</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"parent"</span>: <span class="number">16965363</span>,</span><br><span class="line">  <span class="attr">"retrieved_on"</span>: <span class="number">1528401399</span>,</span><br><span class="line">  <span class="attr">"text"</span>: <span class="string">"Yeah - there's always a HATEOAS comment somewhere and..."</span>,</span><br><span class="line">  <span class="attr">"time"</span>: <span class="number">1525173078</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"comment"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Formatting-the-Data"><a href="#Formatting-the-Data" class="headerlink" title="Formatting the Data"></a>Formatting the Data</h2><p>You might think that Postgres has a simple utility for loading line-delimited JSON. Like me, you’d be wrong. It’s all the more surprising given that it has a <a href="https://www.postgresql.org/docs/current/static/sql-copy.html" target="_blank" rel="noopener">COPY</a> utility that’s designed to load data from files. Unfortunately, that utility only supports <code>text</code>, <code>csv</code>, and <code>binary</code> formats.</p>
<p>Transforming our data into a CSV is a breeze with <a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener">jq</a>. We can pipe the JSON stream into the following command to extract the <code>id</code>, <code>by</code>, <code>parent</code>, and <code>text</code> fields. You can customize the command to extract whatever fields you like.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jq -r <span class="string">'[.id, .by, .parent, .text] | @csv'</span></span><br></pre></td></tr></table></figure>
<p>The <code>-r</code> option indicates that we would like a raw string output, as opposed to JSON formatted with quotes. The <code>[.id, .by, .parent, .text]</code> part produces an array containing the desired fields and the pipe into <code>@csv</code> specifies the format. All that’s left is to load the data into Postgres.</p>
<h2 id="Ingesting-the-Data"><a href="#Ingesting-the-Data" class="headerlink" title="Ingesting the Data"></a>Ingesting the Data</h2><p>After creating the database</p>
<p><code>createdb comment_db</code></p>
<p>and applying the schema</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">comment</span> (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    <span class="keyword">by</span> <span class="built_in">VARCHAR</span>,</span><br><span class="line">    <span class="keyword">parent</span> <span class="built_in">INTEGER</span>,</span><br><span class="line">    <span class="built_in">text</span> <span class="built_in">TEXT</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>we can hydrate our comments into <code>comment_db</code> using <a href="https://www.postgresql.org/docs/current/static/app-psql.html" target="_blank" rel="noopener">psql</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql comment_db -c <span class="string">"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)"</span></span><br></pre></td></tr></table></figure>
<p>Note that the fields specified above need to be in the same order as the fields in the CSV stream generated by <code>jq</code>.</p>
<p>Here is the final command</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 \</span><br><span class="line">  | bzip2 -d \</span><br><span class="line">  | jq -r <span class="string">'[.id, .by, .parent, .text] | @csv'</span> \</span><br><span class="line">  | psql comment_db -c <span class="string">"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)"</span></span><br></pre></td></tr></table></figure>
<p>One final caveat. You might notice that even though the <code>parent</code> column references a comment id, I’ve neglected to specify the foreign key constraint. This is because our command does not control for the order that comments are loaded. We would get a constraint error if a comment references a parent comment that has not yet been inserted. It would probably be easiest to apply these constraints after ingesting the data.</p>
<p>My name is Nick Drane. I do <a href="/hire-me">consulting</a> out of Chicago area and am looking for new opportunities.</p>

    </div>
    <footer>
      <ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnickdrane.com%2Fusing-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres%2F&quote=Using%20jq%20to%20Effortlessly%20Ingest%20Line-delimited%20JSON%20into%20PostgreSQL" title="Share on Facebook" target="_blank"><img alt="Share on Facebook" src="/images/social/Facebook.png" /></a></li>
  <li><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnickdrane.com%2Fusing-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres%2F&text=Using%20jq%20to%20Effortlessly%20Ingest%20Line-delimited%20JSON%20into%20PostgreSQL" target="_blank" title="Tweet"><img alt="Tweet" src="/images/social/Twitter.png" /></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fnickdrane.com%2Fusing-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres%2F&title=Using%20jq%20to%20Effortlessly%20Ingest%20Line-delimited%20JSON%20into%20PostgreSQL" target="_blank" title="Share on LinkedIn"><img alt="Share on LinkedIn" src="/images/social/LinkedIn.png" /></a></li>
  <li><a href="mailto:?subject=Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL&body=Check this out: http://nickdrane.com/using-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres/" target="_blank" title="Send email"><img alt="Send email" src="/images/social/Email.png" /></a></li>
</ul>
      <div class="clearfix"></div>
    </footer>
  </div>
</article></div></div>
    <aside id="sidebar" class="alignright">  <div class="widget tag about">
  <ul class="entry">
    <div>
      <img class="about-photo" src="/images/about-photo.jpg" alt="photo of Nick Drane" />
    </div>
    <p class="about-photo-text">My name is Nick Drane. I'm a programmer and consultant</p>

  </ul>
</div>
  <div class="widget tag recent-posts">
  <h3 class="title">Most Popular Posts</h3>
  <ul class="entry">
    <li>
      <a href="/build-your-own-regex/">Build a Regex Engine in Less than 40 Lines of Code</a>
    </li>
    <li>
      <a href="/scraping-the-web-with-puppeteer-lessons-learned/">Scraping the Web with Puppeteer: Lessons Learned</a>
    </li>
    <li>
      <a href="/write-your-own-redux-connect/">Write Your Own React-Redux Connect</a>
    </li>
    <li>
      <a href="/build-your-own-nested-query-string-encoder/">Build Your Own Nested Query String Encoder/Decoder</a>
    </li>
  </ul>
</div>
  <div class="widget tag recent-posts">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/using-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres/">Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL</a>
      </li>
    
      <li>
        <a href="/hidden-costs-of-postgresql-jsonb/">The Hidden Costs of PostgreSQL&#39;s JSONB Datatype</a>
      </li>
    
      <li>
        <a href="/ethical-engineering-for-the-average-engineer/">Ethical Engineering for the Average Engineer</a>
      </li>
    
      <li>
        <a href="/build-your-own-nested-query-string-encoder/">Build Your Own Nested Query String Encoder/Decoder</a>
      </li>
    
      <li>
        <a href="/you&#39;re-hiring-programmers-wrong-a-case-for-interview-standardization/">You&#39;re Hiring Programmers Wrong: A Case for Interview Standardization</a>
      </li>
    
  </ul>
</div>
  
<div class="widget tag category">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Architecture/">Architecture</a><small>1</small></li>
  
    <li><a href="/categories/Build-Your-Own/">Build Your Own</a><small>3</small></li>
  
    <li><a href="/categories/Command-Line/">Command Line</a><small>1</small></li>
  
    <li><a href="/categories/Elasticsearch/">Elasticsearch</a><small>1</small></li>
  
    <li><a href="/categories/Failures/">Failures</a><small>1</small></li>
  
    <li><a href="/categories/Functional-Programming/">Functional Programming</a><small>1</small></li>
  
    <li><a href="/categories/Immutability/">Immutability</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>4</small></li>
  
    <li><a href="/categories/Postgres/">Postgres</a><small>2</small></li>
  
    <li><a href="/categories/React/">React</a><small>2</small></li>
  
    <li><a href="/categories/Recursion/">Recursion</a><small>2</small></li>
  
    <li><a href="/categories/Redux/">Redux</a><small>1</small></li>
  
    <li><a href="/categories/Regular-Expressions/">Regular Expressions</a><small>2</small></li>
  
    <li><a href="/categories/Software-Ethics/">Software Ethics</a><small>1</small></li>
  
    <li><a href="/categories/Technical-Hiring/">Technical Hiring</a><small>1</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>1</small></li>
  
    <li><a href="/categories/Web-Scraping/">Web Scraping</a><small>1</small></li>
  
  </ul>
</div>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
    &copy; 2018 Nick Drane
  
</div>
<div class="clearfix"></div></footer>
</body>
</html>

