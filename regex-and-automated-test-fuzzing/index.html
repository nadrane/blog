<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  
    <title>
      Regex And Automated Test Fuzzing › Nick Drane
    </title>
    
      <meta name="author" content="Nick Drane">
      
        
            <meta name="description" content="Nick Drane&#39;s blog about programming and modern web development, particularly Node.js and React.">
            
                  
                      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

                      
                        <meta property="og:title" content="Regex And Automated Test Fuzzing" />
                        
                          <meta property="og:site_name" content="Nick Drane" />

                          
                              <meta property="og:image" content="" />
                              
                                <meta name="google-site-verification" content="0iahwlYFOHM2sYjk4TF5_lP0DqzgOgkXnZcKV-Qci8A" />

                                <link href="/favicon.png" rel="icon">
                                <link rel="alternate" href="/atom.xml" title="Nick Drane"
                                  type="application/atom+xml">
                                <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
                                <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
                                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-107252357-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-107252357-1');
</script>
</head>

<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">Nick Drane</a></h1>
  <nav id="main-nav">
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/hire-me">Hire Me</a></li>
      <li><a href="/projects">Projects</a></li>
      <li><a href="/archives">Archives</a></li>
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
  
    <div class="social">
      <ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnickdrane.com%2Fregex-and-automated-test-fuzzing%2F&quote=Regex%20And%20Automated%20Test%20Fuzzing" title="Share on Facebook" target="_blank"><img alt="Share on Facebook" src="/images/social/Facebook.png" /></a></li>
  <li><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnickdrane.com%2Fregex-and-automated-test-fuzzing%2F&text=Regex%20And%20Automated%20Test%20Fuzzing" target="_blank" title="Tweet"><img alt="Tweet" src="/images/social/Twitter.png" /></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fnickdrane.com%2Fregex-and-automated-test-fuzzing%2F&title=Regex%20And%20Automated%20Test%20Fuzzing" target="_blank" title="Share on LinkedIn"><img alt="Share on LinkedIn" src="/images/social/LinkedIn.png" /></a></li>
  <li><a href="mailto:?subject=Regex And Automated Test Fuzzing&body=Check this out: http://nickdrane.com/regex-and-automated-test-fuzzing/" target="_blank" title="Send email"><img alt="Send email" src="/images/social/Email.png" /></a></li>
</ul>
    </div class="social">
  
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title">Regex And Automated Test Fuzzing</h1>
  

      
        <time datetime="2017-12-06T06:00:00.000Z">2017-12-06</time>
      
    </header>
    <div class="entry">
      <p>I posted my article <a href="https://nickdrane.com/build-your-own-regex/">Build Your Own Regex Engine</a> on Reddit the other day, and one of the commenters claimed that the implementation should be trivial to break. Since I had already tested my program against a customized suite of tests, the remark got me thinking about how I could further increase my confidence in the correctness of my program. One extremely low cost however effective strategy for identifying faults in software is known as fuzzing.</p>
<a id="more"></a>
<h2 id="What-is-Fuzzing"><a href="#What-is-Fuzzing" class="headerlink" title="What is Fuzzing?"></a>What is Fuzzing?</h2><p>Fuzzing is a automated testing technique where a program is provided a series of invalid or randomly generated inputs. If we were testing an HTTP API, we might send randomized combinations of query parameters and ensure that our server always returns a 2xx status code. Since Javascript comes with a regular expression engine, my fuzzer asserts that given the same random input, both engine’s return the same output.</p>
<h2 id="Specifying-the-Grammar"><a href="#Specifying-the-Grammar" class="headerlink" title="Specifying the Grammar"></a>Specifying the Grammar</h2><p>The first step is to specify the grammar that our regex engine supports.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> lowercase = <span class="string">"abcdefghijklmnopqrstuvwxyz"</span>.split(<span class="string">""</span>);</span><br><span class="line"><span class="keyword">const</span> uppercase = lowercase.map(<span class="function"><span class="params">letter</span> =&gt;</span> letter.toUpperCase());</span><br><span class="line"><span class="keyword">const</span> special = [<span class="string">"?"</span>, <span class="string">"*"</span>, <span class="string">"."</span>];</span><br><span class="line"><span class="keyword">const</span> regexGrammar = special.concat(lowercase, uppercase);</span><br></pre></td></tr></table></figure>
<p>You might notice we skipped the <code>^</code> and <code>$</code> characters. More on these in a little bit.</p>
<h2 id="Generated-Valid-Regular-Expressions"><a href="#Generated-Valid-Regular-Expressions" class="headerlink" title="Generated Valid Regular Expressions"></a>Generated Valid Regular Expressions</h2><p>We want to write a function <code>generateRegex</code> that will select <code>n</code> random characters from the <code>regexGrammar</code> and concatenate them together into a string. This string will be used to create a test regex.</p>
<p>Here are three possible returns values of <code>generateRegex</code>:</p>
<ol>
<li><code>.AnrQ?QNLQX.syBsOcJlbJZd</code></li>
<li><code>.LkuZ?Ynj</code></li>
<li><code>.UN?eiyddhXvyNj</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRegex</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> regexString = <span class="keyword">new</span> <span class="built_in">Array</span>(n)</span><br><span class="line">    .fill(<span class="number">0</span>)</span><br><span class="line">    .map(chooseOne)</span><br><span class="line">    .join(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> regexString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pick one element randomly from the grammar and return it</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">chooseOne</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> regexGrammar[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * regexGrammar.length)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Removing-Invalid-Regex-Strings"><a href="#Removing-Invalid-Regex-Strings" class="headerlink" title="Removing Invalid Regex Strings"></a>Removing Invalid Regex Strings</h2><p>My regex engine only deals with a very small subset of available regex syntax, and furthermore, it does not contain any error handling. What happens if <code>generateRegex</code> returns the pattern <code>**</code> or <code>^*</code>? My regex engine was never designed to handle these inputs, though they are possible outputs of <code>generateRegex</code>. We need to make a choice about how to handle these expressions. Since the primary goal of my regex engine is accessibility and simplicity of implementation, I’m not about to begin supporting these edge cases. That means my fuzzer should not generate them either.</p>
<p>One solution to determine if a given regex string is valid is to specify my regex engine’s allowable grammar in <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form" target="_blank" rel="noopener">BNF</a>. BNF is a formal notation for specifying the syntax of a language. Given this BNF notation, I could ask another program if the randomly generated regex string can be created using my BNF specification. This sounds like a little more work than I want, however, since the invalid cases can simply be manually enumerated and filtered.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validRegex</span>(<span class="params">regexString</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="comment">// None of the following sequences are properly</span></span><br><span class="line">    <span class="comment">// defined by my regex engine</span></span><br><span class="line">    regexString.indexOf(<span class="string">"**"</span>) === <span class="number">-1</span> &amp;&amp;</span><br><span class="line">    regexString.indexOf(<span class="string">"??"</span>) === <span class="number">-1</span> &amp;&amp;</span><br><span class="line">    regexString.indexOf(<span class="string">"*?"</span>) === <span class="number">-1</span> &amp;&amp;</span><br><span class="line">    regexString.indexOf(<span class="string">"?*"</span>) === <span class="number">-1</span> &amp;&amp;</span><br><span class="line">    regexString.indexOf(<span class="string">"^?"</span>) === <span class="number">-1</span> &amp;&amp;</span><br><span class="line">    regexString.indexOf(<span class="string">"^*"</span>) === <span class="number">-1</span> &amp;&amp;</span><br><span class="line">    !regexString.startsWith(<span class="string">"*"</span>) &amp;&amp;</span><br><span class="line">    !regexString.startsWith(<span class="string">"?"</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRegex</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> regexString = <span class="keyword">new</span> <span class="built_in">Array</span>(n)</span><br><span class="line">    .fill(<span class="number">0</span>)</span><br><span class="line">    .map(chooseOne)</span><br><span class="line">    .join(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the generated string is valid, return it</span></span><br><span class="line">  <span class="keyword">if</span> (validRegex(regexString)) &#123;</span><br><span class="line">    <span class="keyword">return</span> regexString;</span><br><span class="line">  <span class="comment">// Otherwise generate a new string and return that</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> generateRegexString(n);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>One more modification to <code>generateRegex</code> is necessary to support <code>^</code> and <code>$</code>, and then we are basically done.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRegex</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// We need to ensure that '^' and '$' only go at the beginning</span></span><br><span class="line">  <span class="comment">// and the end of the string, respectively.</span></span><br><span class="line">  <span class="comment">// Give each a 10% probability of appearing in a string</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Math</span>.random() &lt; <span class="number">0.1</span>) regexString = <span class="string">"^"</span> + regexString;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Math</span>.random() &lt; <span class="number">0.1</span>) regexString = regexString + <span class="string">"$"</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Comparing-Regex-Implementations"><a href="#Comparing-Regex-Implementations" class="headerlink" title="Comparing Regex Implementations"></a>Comparing Regex Implementations</h2><p>All that is required now is to repeatedly invoke <code>generateRegex</code> a fixed number of times and then compare the output of the native JS implementation with the output of my implementation.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The corpus is the string of text we are matching the pattern against.</span></span><br><span class="line"><span class="comment">// I used a segment of Gulliver's Travels from Project Gutenberg.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fuzzer</span>(<span class="params">totalTests, corpus</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> maxRegexLength = <span class="number">50</span>; <span class="comment">// max will actually be 50 - 1</span></span><br><span class="line">  <span class="keyword">let</span> testsRun = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (testsRun &lt; totalTests) &#123;</span><br><span class="line">    <span class="keyword">const</span> regexLength = getRandomInt(<span class="number">1</span>, maxRegexLength);</span><br><span class="line">    <span class="keyword">const</span> regexString = generateRegexString(regexLength);</span><br><span class="line">    <span class="keyword">const</span> testRegex = <span class="keyword">new</span> <span class="built_in">RegExp</span>(regexString);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      assert.equal(testRegex.test(corpus), myRegexEngine(regexString, corpus));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(testRegex);</span><br><span class="line">    &#125;</span><br><span class="line">    testsRun++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Thank you Mozzila :)</span></span><br><span class="line"><span class="comment">// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRandomInt</span>(<span class="params">min, max</span>) </span>&#123;</span><br><span class="line">  min = <span class="built_in">Math</span>.ceil(min);</span><br><span class="line">  max = <span class="built_in">Math</span>.floor(max);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * (max - min)) + min;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h2><p>I ran my fuzzer for a couple million randomly generated cases and ended up learning two things about my regex engine.</p>
<ol>
<li><p>My implementation fails extraordinarily with longer texts. I knew recursion would be a problem for any practical regex implementation (at least without <a href="https://en.wikipedia.org/wiki/Tail_call" target="_blank" rel="noopener">tail calls</a>) and would cause stack overflows, but I didn’t expect it to fail with texts that were only a couple thousand words. I think this is because I make liberal use of backtracking algorithms in <code>matchQuestion</code> and <code>matchStar</code>. Since I was forced to test with a relatively short input text, it makes sense to use multiple text inputs to increase the probability of discovering an error.</p>
</li>
<li><p>My implementation treats the <code>.</code> character differently than the native implementation. In the RegExp implementation, <code>.</code> will not match various line terminators (<code>\n</code>, <code>\r</code>, <code>\u2028</code> or <code>\u2029</code>). My implementation does.</p>
</li>
</ol>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The biggest takeaway is that fuzzing is an simple and inexpensive way to enumerate enormous sets of inputs and identify bugs in your software. This fuzzer took less than an hour to write.</p>
<p>But remember, this fuzzer’s blessing of a couple million input combinations <strong>does not</strong> verify the correctness of my program. Not even close. A fuzzer is a tool to identify potential errors. Unless you enumerate all possible inputs (completely impossible in this case where they are infinite), you are not guaranteed your program is error free.</p>

    </div>
    <footer>
      <ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnickdrane.com%2Fregex-and-automated-test-fuzzing%2F&quote=Regex%20And%20Automated%20Test%20Fuzzing" title="Share on Facebook" target="_blank"><img alt="Share on Facebook" src="/images/social/Facebook.png" /></a></li>
  <li><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnickdrane.com%2Fregex-and-automated-test-fuzzing%2F&text=Regex%20And%20Automated%20Test%20Fuzzing" target="_blank" title="Tweet"><img alt="Tweet" src="/images/social/Twitter.png" /></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fnickdrane.com%2Fregex-and-automated-test-fuzzing%2F&title=Regex%20And%20Automated%20Test%20Fuzzing" target="_blank" title="Share on LinkedIn"><img alt="Share on LinkedIn" src="/images/social/LinkedIn.png" /></a></li>
  <li><a href="mailto:?subject=Regex And Automated Test Fuzzing&body=Check this out: http://nickdrane.com/regex-and-automated-test-fuzzing/" target="_blank" title="Send email"><img alt="Send email" src="/images/social/Email.png" /></a></li>
</ul>
      <div class="clearfix"></div>
    </footer>
  </div>
</article></div></div>
    <aside id="sidebar" class="alignright">  <div class="widget tag about">
  <ul class="entry">
    <div>
      <img class="about-photo" src="/images/about-photo.jpg" alt="photo of Nick Drane" />
    </div>
    <p class="about-photo-text"> Nick Drane's blog about programming, hacking, software, computer security, and compute science.</p>

  </ul>
</div>
  <div class="widget tag recent-posts">
  <h3 class="title">Most Popular Posts</h3>
  <ul class="entry">
    <li>
      <a href="/build-your-own-regex/">Build a Regex Engine in Less than 40 Lines of Code</a>
    </li>
    <li>
      <a href="/scraping-the-web-with-puppeteer-lessons-learned/">Scraping the Web with Puppeteer: Lessons Learned</a>
    </li>
    <li>
      <a href="/write-your-own-redux-connect/">Write Your Own React-Redux Connect</a>
    </li>
    <li>
      <a href="/build-your-own-nested-query-string-encoder/">Build Your Own Nested Query String Encoder/Decoder</a>
    </li>
  </ul>
</div>
  <div class="widget tag recent-posts">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/hidden-costs-of-postgresql-jsonb/">The Hidden Costs of PostgreSQL&#39;s JSONB Datatype</a>
      </li>
    
      <li>
        <a href="/ethical-engineering-for-the-average-engineer/">Ethical Engineering for the Average Engineer</a>
      </li>
    
      <li>
        <a href="/build-your-own-nested-query-string-encoder/">Build Your Own Nested Query String Encoder/Decoder</a>
      </li>
    
      <li>
        <a href="/you&#39;re-hiring-programmers-wrong-a-case-for-interview-standardization/">You&#39;re Hiring Programmers Wrong: A Case for Interview Standardization</a>
      </li>
    
      <li>
        <a href="/scraping-the-web-with-puppeteer-lessons-learned/">Scraping the Web with Puppeteer: Lessons Learned</a>
      </li>
    
  </ul>
</div>
  
<div class="widget tag category">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Architecture/">Architecture</a><small>1</small></li>
  
    <li><a href="/categories/Build-Your-Own/">Build Your Own</a><small>3</small></li>
  
    <li><a href="/categories/Elasticsearch/">Elasticsearch</a><small>1</small></li>
  
    <li><a href="/categories/Failures/">Failures</a><small>1</small></li>
  
    <li><a href="/categories/Functional-Programming/">Functional Programming</a><small>1</small></li>
  
    <li><a href="/categories/Immutability/">Immutability</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>4</small></li>
  
    <li><a href="/categories/Postgres/">Postgres</a><small>1</small></li>
  
    <li><a href="/categories/React/">React</a><small>2</small></li>
  
    <li><a href="/categories/Recursion/">Recursion</a><small>2</small></li>
  
    <li><a href="/categories/Redux/">Redux</a><small>1</small></li>
  
    <li><a href="/categories/Regular-Expressions/">Regular Expressions</a><small>2</small></li>
  
    <li><a href="/categories/Software-Ethics/">Software Ethics</a><small>1</small></li>
  
    <li><a href="/categories/Technical-Hiring/">Technical Hiring</a><small>1</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>1</small></li>
  
    <li><a href="/categories/Web-Scraping/">Web Scraping</a><small>1</small></li>
  
  </ul>
</div>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
    &copy; 2018 Nick Drane
  
</div>
<div class="clearfix"></div></footer>
</body>
</html>

