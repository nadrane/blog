{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/images/about-photo.jpg","path":"images/about-photo.jpg","modified":1,"renderable":0},{"_id":"source/images/spot-marketing-material.png","path":"images/spot-marketing-material.png","modified":1,"renderable":0},{"_id":"source/images/social/Facebook.png","path":"images/social/Facebook.png","modified":1,"renderable":0},{"_id":"source/images/social/Email.png","path":"images/social/Email.png","modified":1,"renderable":0},{"_id":"source/images/social/LinkedIn.png","path":"images/social/LinkedIn.png","modified":1,"renderable":0},{"_id":"source/images/social/Twitter.png","path":"images/social/Twitter.png","modified":1,"renderable":0},{"_id":"themes/concise/source/css/style.styl","path":"css/style.styl","modified":1,"renderable":1},{"_id":"source/images/original-about-photo.jpg","path":"images/original-about-photo.jpg","modified":1,"renderable":0}],"Cache":[{"_id":"themes/concise/LICENSE","hash":"e60dbb857cb3594b97fe2182e08e844a97f6f584","modified":1537045149610},{"_id":"themes/concise/README.md","hash":"b13b6e0f6f3f631b69cf251e0252cb9d5adc55be","modified":1537717031342},{"_id":"themes/concise/npm-debug.log","hash":"6df346548140cc92068a0478023c3e859bd6231f","modified":1537045149616},{"_id":"source/.DS_Store","hash":"ed01a06d1fea8a9217f5ded5c1a17a6196faca2d","modified":1537045864151},{"_id":"source/testimonials/index.md","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1538275687816},{"_id":"themes/concise/layout/index.ejs","hash":"ab6e9236d5c80382f8f81373c3ea602c85dce1d1","modified":1538341077311},{"_id":"themes/concise/layout/category.ejs","hash":"9b740fc33f6f028df60f0bc4312bf3ebd03aa8ea","modified":1537045149615},{"_id":"themes/concise/layout/archive.ejs","hash":"a18842e3d719fe3ca9b977a6995f8facc75c8673","modified":1537045149615},{"_id":"themes/concise/layout/page.ejs","hash":"70cbc9854655773cc6ba84eecaaf330fed430465","modified":1537045149615},{"_id":"themes/concise/layout/post.ejs","hash":"70cbc9854655773cc6ba84eecaaf330fed430465","modified":1537045149615},{"_id":"themes/concise/layout/layout.ejs","hash":"5cfa2912d387016d74c5dd55ad8168415fa59ba4","modified":1539825505094},{"_id":"source/_drafts/build-your-own-lisp-interpreter.md","hash":"bb74dba64eb8775cfcb73cd5e2bd219e1462676a","modified":1537045149599},{"_id":"source/_drafts/build-your-own-regex-engine-grouping.md","hash":"7b71b267c8b5cdc903623c499ba3492164c8bf0a","modified":1537045149599},{"_id":"source/_drafts/microservices-failure.md","hash":"39cfd80a0304408f5cf7caeb22bc7ead5dfc305f","modified":1537045149600},{"_id":"source/_drafts/write-your-own-promise-library.md","hash":"fe05ee8349f2948e9a33012422f774b9645d9ddb","modified":1537045149600},{"_id":"source/about/index.md","hash":"bef33c2400f4ab8826539743ddcb56072d8bf8d2","modified":1539831418242},{"_id":"source/_posts/build-your-own-nested-query-string-encoder.md","hash":"c38d1913dd554fbd3351420aec526a16778eb043","modified":1538341529859},{"_id":"source/_posts/build-your-own-regex.md","hash":"307b69e74b7349991fadf3d8fd42505fcaff56bf","modified":1539832823620},{"_id":"source/_drafts/hidden-costs-of-postgresql-jsonb-partII.md","hash":"7cd61e4556f93a9a359c1287171cc69418520ca7","modified":1539832823626},{"_id":"source/_posts/leveraging-immutability-in-react.md","hash":"3ef522a0b4032d91e59f7523a5c60434cf0d8b77","modified":1538340756447},{"_id":"source/_posts/hidden-costs-of-postgresql-jsonb.md","hash":"4ba6f4d83c6f9c914aca8fe3bb77af0d3732702d","modified":1539919597843},{"_id":"source/_posts/ethical-engineering-for-the-average-engineer.md","hash":"ce25fa21033a13412c7db2c3287437f796ba6eea","modified":1538340747477},{"_id":"source/_posts/scraping-the-web-with-puppeteer-lessons-learned.md","hash":"2a91fe946b2ab795592984ce8ad08855bf059d60","modified":1538340765834},{"_id":"source/_posts/regex-and-automated-test-fuzzing.md","hash":"b83b22205095147078cb1ed771f68389ed0c0c46","modified":1539832823622},{"_id":"source/_posts/using-reduce.md","hash":"2e4c2280f69612451fb5e57d0b49ec59326fa38f","modified":1538340774462},{"_id":"source/_posts/optimizing-elasticsearch-score.md","hash":"df191bc0c40a79a688ce3cc7c24d41776f723bde","modified":1539314468438},{"_id":"source/_posts/write-your-own-redux-connect.md","hash":"90872b0db956f8fbbb1d0dae356b7e07bb4033f4","modified":1538340787513},{"_id":"source/crawler/index.md","hash":"2c2c05e6594f44be1e82b65479d1f6777ab525e4","modified":1539831423122},{"_id":"source/_posts/you're-hiring-programmers-wrong-a-case-for-interview-standardization.md","hash":"d0b82ac8421d788bdfdf9f3f7676dd79b97cff90","modified":1538340791209},{"_id":"source/_posts/using-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres.md","hash":"0326fd6a30ebd87dfabf5ffd31c163c4f2ece841","modified":1540006320071},{"_id":"source/hire-me/index.md","hash":"77d381e2070ad92e28d27de1677c698c7184a833","modified":1539831414209},{"_id":"source/images/about-photo.jpg","hash":"fca1492be26d0ebe438b03fce2641592827eccdb","modified":1537045149603},{"_id":"source/projects/index.md","hash":"da111e7c3199a4a409e8b80479dd96266f2edb2b","modified":1539831467598},{"_id":"themes/concise/layout/_partial/archive.ejs","hash":"ae88920c7d6e1ec0c29cac383a0219373ae9e25d","modified":1539832087558},{"_id":"themes/concise/layout/_partial/footer.ejs","hash":"e9df3332146fe1d4d3b878b6631cf812bef65b18","modified":1538341610684},{"_id":"themes/concise/layout/_partial/article.ejs","hash":"64275936472bdab1f83731cbb512a391038f7c1e","modified":1539827605233},{"_id":"themes/concise/layout/_partial/google_analytics.ejs","hash":"caa6294e4e45fccb385d9877b011e1062d631462","modified":1538334380292},{"_id":"themes/concise/layout/_partial/head.ejs","hash":"b0d81a79df472b675a4305d193a6a14352975566","modified":1538322391440},{"_id":"themes/concise/layout/_partial/header.ejs","hash":"858247a8631820025bc180dbf4d4b7acbf15390e","modified":1539829347985},{"_id":"themes/concise/layout/_partial/pagination.ejs","hash":"1206b630a07444e8744365f14ddb26095c925ae1","modified":1537717031346},{"_id":"themes/concise/layout/_partial/sidebar.ejs","hash":"810eedeb03e82a3a478198ecdac42473257bc75b","modified":1538320670950},{"_id":"source/images/spot-marketing-material.png","hash":"d2c598f9355691d050ebb1d21f0f30ec7766cf4f","modified":1537130743840},{"_id":"themes/concise/layout/_widget/about.ejs","hash":"e36e873a82bf138dba9cfa001c95767ecbe72dec","modified":1539919925029},{"_id":"themes/concise/layout/_partial/social.ejs","hash":"f274f30e9e3addcccfc28417817fbd885ee25d0e","modified":1539828864819},{"_id":"themes/concise/layout/_widget/category.ejs","hash":"700ffca93e259d06734225efcfe740353048545d","modified":1538317277219},{"_id":"themes/concise/layout/_widget/recent_posts.ejs","hash":"6a15ba3dd9dd410a74588560cebd38976b14c05d","modified":1538320562582},{"_id":"themes/concise/layout/_widget/most_popular_posts.ejs","hash":"13673a181df6620847f4f4620e22a7a20a6b5eda","modified":1538321111852},{"_id":"themes/concise/source/css/style.styl","hash":"c03b2520e4a85b981e29516cadc0a365e6500e3d","modified":1537045149618},{"_id":"source/images/social/Facebook.png","hash":"fc41487162066a824c10eb4f8e75a1481292b735","modified":1539823082133},{"_id":"source/images/social/Email.png","hash":"8dad4c4e0c65d405117f006a9ac86b44dfee9635","modified":1539823082084},{"_id":"source/images/social/LinkedIn.png","hash":"68e17626623a67ccc1ae2e83cdac513dbdc1a583","modified":1539823082109},{"_id":"source/images/social/Twitter.png","hash":"71a0b4283e45e7d7fb3e74450b665557a8ac9fde","modified":1539823082096},{"_id":"themes/concise/source/css/_base/utils.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1537045149616},{"_id":"themes/concise/layout/_partial/post/tag.ejs","hash":"095418df66a27a28cbab16d7cb0d16001b0e23f1","modified":1537045149613},{"_id":"themes/concise/layout/_partial/post/gallery.ejs","hash":"fafc2501d7e65983b0f5c2b58151ca12e57c0574","modified":1537045149613},{"_id":"themes/concise/layout/_partial/post/title.ejs","hash":"d7fbc575d35ae68f9045a382c651450e4131f335","modified":1537045149614},{"_id":"themes/concise/layout/_partial/post/category.ejs","hash":"be740939c5c2d4ffdbed9557b4e63a590058b476","modified":1538342607221},{"_id":"themes/concise/layout/_partial/post/signup.ejs","hash":"dc83e532b31c45a73fb50569f35c55c8ca51ddc5","modified":1539826153473},{"_id":"themes/concise/source/css/_base/variable.styl","hash":"f5a66b4cb5dd3c1da787796ed86f4a9466ff5089","modified":1537045149616},{"_id":"themes/concise/source/css/_partial/comment.styl","hash":"e7f8c085bfa8c26afc4b2fbc9f2092f4f07aef34","modified":1537045149617},{"_id":"themes/concise/source/css/_base/layout.styl","hash":"740bb963e130b32e3f768247ecdaecd2ee2642cd","modified":1539833277884},{"_id":"themes/concise/source/css/_partial/footer.styl","hash":"1757872dbdbd09295a625f13e356aa798a8bb308","modified":1537045149617},{"_id":"themes/concise/source/css/_partial/archive.styl","hash":"2363f009e5c0449f943336038d58aa608cdc5cfd","modified":1539832481921},{"_id":"themes/concise/source/css/_partial/index.styl","hash":"b4cffb56b4ec4b7987d9682b48dec4e1ab3ca0c1","modified":1537045149617},{"_id":"themes/concise/source/css/_partial/article.styl","hash":"60341aada6dfd5f5da823e57296cfff268b2b013","modified":1537045149617},{"_id":"themes/concise/source/css/_partial/syntax.styl","hash":"400335f01229ed02e62110ba90312adb78b84ff5","modified":1537045149618},{"_id":"themes/concise/source/css/_partial/sidebar.styl","hash":"cf95c57e7d8bfc9452c7537f726eb56b16a51b5b","modified":1537045149617},{"_id":"themes/concise/source/css/_partial/header.styl","hash":"ae7d58c183647d31a5dd950dbd41be56f49e5dd7","modified":1539832672603},{"_id":"source/images/original-about-photo.jpg","hash":"7c41fb00f1a7c4ad0fcb9ba1fef735edd866c8c4","modified":1537045149609}],"Category":[{"name":"Javascript","_id":"cjngw0vnn000h67ozg84kysck"},{"name":"Architecture","_id":"cjngw0vns000l67ozzxk2go6s"},{"name":"Postgres","_id":"cjngw0vnt000n67ozvoavwzei"},{"name":"React","_id":"cjngw0vnu000o67ozly48xn7u"},{"name":"Software Ethics","_id":"cjngw0vnu000p67oz2ijk6evv"},{"name":"Regular Expressions","_id":"cjngw0vnv000r67ozxjp13ewn"},{"name":"Elasticsearch","_id":"cjngw0vnv000s67oz01p5vn6w"},{"name":"Technical Hiring","_id":"cjngw0vnv000t67oz3gdgp8aw"},{"name":"Command Line","_id":"cjngw0vnw000u67ozmy4j61we"},{"name":"Functional Programming","_id":"cjngw0vny000v67ozm41af976"},{"name":"Build Your Own","_id":"cjngw0vo0001067ozi20igrcb"},{"name":"Failures","_id":"cjngw0vo1001367oz6ktj27rm"},{"name":"Immutability","_id":"cjngw0vo1001667ozj5vusndi"},{"name":"Web Scraping","_id":"cjngw0vo1001867ozx49vie19"},{"name":"Recursion","_id":"cjngw0vo1001967ozckvdpt4r"},{"name":"Testing","_id":"cjngw0vo1001a67oz7587wvtd"},{"name":"Web","_id":"cjngw0vo6001d67ozao5sm39f"},{"name":"Redux","_id":"cjngw0vo6001g67ozyq4zpvnx"}],"Data":[],"Page":[{"_content":"","source":"testimonials/index.md","raw":"","date":"2018-09-30T02:48:07.816Z","updated":"2018-09-30T02:48:07.816Z","path":"testimonials/index.html","title":"","comments":1,"layout":"page","_id":"cjngw0vmq000067oz9axgkhhu","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"About","_content":"\nI've been working professionally as a software developer for 7 years and have been programming for 13. I've worked on small and enterprise systems spanning a variety of platforms and programming languages. I'm passionate about education, creating communities with tech, and solving hard problems.\n\nI live in Chicago. If you are in city, you should reach out and we should grab coffee (or tea, my favorite). You can reach me at [nick@nickdrane.com](mailto:nick@nickdrane.com).\n\nI also do [consulting work](/hire-me) for software companies and am happy to chat with your projects.\n","source":"about/index.md","raw":"---\ntitle: About\n---\n\nI've been working professionally as a software developer for 7 years and have been programming for 13. I've worked on small and enterprise systems spanning a variety of platforms and programming languages. I'm passionate about education, creating communities with tech, and solving hard problems.\n\nI live in Chicago. If you are in city, you should reach out and we should grab coffee (or tea, my favorite). You can reach me at [nick@nickdrane.com](mailto:nick@nickdrane.com).\n\nI also do [consulting work](/hire-me) for software companies and am happy to chat with your projects.\n","date":"2018-10-18T02:56:58.242Z","updated":"2018-10-18T02:56:58.242Z","path":"about/index.html","comments":1,"layout":"page","_id":"cjngw0vn1000167oz614bd1cx","content":"<p>I’ve been working professionally as a software developer for 7 years and have been programming for 13. I’ve worked on small and enterprise systems spanning a variety of platforms and programming languages. I’m passionate about education, creating communities with tech, and solving hard problems.</p>\n<p>I live in Chicago. If you are in city, you should reach out and we should grab coffee (or tea, my favorite). You can reach me at <a href=\"mailto:nick@nickdrane.com\">nick@nickdrane.com</a>.</p>\n<p>I also do <a href=\"/hire-me\">consulting work</a> for software companies and am happy to chat with your projects.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I’ve been working professionally as a software developer for 7 years and have been programming for 13. I’ve worked on small and enterprise systems spanning a variety of platforms and programming languages. I’m passionate about education, creating communities with tech, and solving hard problems.</p>\n<p>I live in Chicago. If you are in city, you should reach out and we should grab coffee (or tea, my favorite). You can reach me at <a href=\"mailto:nick@nickdrane.com\">nick@nickdrane.com</a>.</p>\n<p>I also do <a href=\"/hire-me\">consulting work</a> for software companies and am happy to chat with your projects.</p>\n"},{"title":"crawler","_content":"\nHi!\n\nYou probably found this page because my web crawler has been visiting your site. My web crawler is an educational project to help me learn to learn more about distributed systems. It's engineered to be as polite as possible, respecting robots.txt at the subdomain level and limiting requests to any one domain to once every 2 minutes.\n\nIf my crawler did anything impolite, please reach out to nick@nickdrane.com. I am happy to blacklist your site if you like.\n","source":"crawler/index.md","raw":"---\ntitle: crawler\n---\n\nHi!\n\nYou probably found this page because my web crawler has been visiting your site. My web crawler is an educational project to help me learn to learn more about distributed systems. It's engineered to be as polite as possible, respecting robots.txt at the subdomain level and limiting requests to any one domain to once every 2 minutes.\n\nIf my crawler did anything impolite, please reach out to nick@nickdrane.com. I am happy to blacklist your site if you like.\n","date":"2018-10-18T02:57:03.122Z","updated":"2018-10-18T02:57:03.122Z","path":"crawler/index.html","comments":1,"layout":"page","_id":"cjngw0vn4000367oz54yjjbve","content":"<p>Hi!</p>\n<p>You probably found this page because my web crawler has been visiting your site. My web crawler is an educational project to help me learn to learn more about distributed systems. It’s engineered to be as polite as possible, respecting robots.txt at the subdomain level and limiting requests to any one domain to once every 2 minutes.</p>\n<p>If my crawler did anything impolite, please reach out to nick@nickdrane.com. I am happy to blacklist your site if you like.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Hi!</p>\n<p>You probably found this page because my web crawler has been visiting your site. My web crawler is an educational project to help me learn to learn more about distributed systems. It’s engineered to be as polite as possible, respecting robots.txt at the subdomain level and limiting requests to any one domain to once every 2 minutes.</p>\n<p>If my crawler did anything impolite, please reach out to nick@nickdrane.com. I am happy to blacklist your site if you like.</p>\n"},{"title":"Hire Me","_content":"\nI do software consulting work. Here are some things you can hire me for\n\n* **Search**\n  Many clients have troves of data that are within grasp but inaccessible because of inadequate search systems. I can help you optimize your search systems using [Elasticsearch](https://www.elastic.co/products/elasticsearch).\n\n* **Application Development**\n  I have extensive experience in the Javascript/[Typescript](https://www.typescriptlang.org/)/[Nodejs](https://nodejs.org/en/) ecosystem and am an expert in [React](https://reactjs.org/).\n\n* **Cloud Architecture**\n  I have worked extensively with [AWS](https://aws.amazon.com/)'s broad range of offerings and even have experience  implementing completely serverless systems. I can help you navigate this complicated ecosystem.\n\n* **Training**\n  I developed curriculum for and taught at Fullstack Javascript at [Fullstack Academy](https://www.fullstackacademy.com/) for a year and specialize in [React](https://reactjs.org/), [NodeJS](https://nodejs.org/en/), and [Elasticsearch](https://www.elastic.co/products/elasticsearch) training for software companies.\n\n\nPlease reach out at me at [nick@nickdrane.com](mailto:nick@nickdrane.com) for rates and timelines.\n\n\n### Testimonials\n\n#### [Freshwater Advisors](http://freshwateradvisors.com/)\n\n*My consulting group hired Nick to supervise the rebuild of our core web application. The product had a history of difficulties, and Nick's efforts guiding the project - and working closely with my team to get us to the point of self-sufficiency - completely transformed our product and saved us a significant amount of money.*\n\n*It would be easy to be intimidated by Nick's impressive engineering acumen and depth of expertise, but his genuine curiosity, patience, gift for teaching, and commitment to thoroughness make him both a joy to work with and a rarity in tech consulting.*\n\n-David Machajewski, Technology Lead, Freshwater Advisors\n","source":"hire-me/index.md","raw":"---\ntitle: Hire Me\n---\n\nI do software consulting work. Here are some things you can hire me for\n\n* **Search**\n  Many clients have troves of data that are within grasp but inaccessible because of inadequate search systems. I can help you optimize your search systems using [Elasticsearch](https://www.elastic.co/products/elasticsearch).\n\n* **Application Development**\n  I have extensive experience in the Javascript/[Typescript](https://www.typescriptlang.org/)/[Nodejs](https://nodejs.org/en/) ecosystem and am an expert in [React](https://reactjs.org/).\n\n* **Cloud Architecture**\n  I have worked extensively with [AWS](https://aws.amazon.com/)'s broad range of offerings and even have experience  implementing completely serverless systems. I can help you navigate this complicated ecosystem.\n\n* **Training**\n  I developed curriculum for and taught at Fullstack Javascript at [Fullstack Academy](https://www.fullstackacademy.com/) for a year and specialize in [React](https://reactjs.org/), [NodeJS](https://nodejs.org/en/), and [Elasticsearch](https://www.elastic.co/products/elasticsearch) training for software companies.\n\n\nPlease reach out at me at [nick@nickdrane.com](mailto:nick@nickdrane.com) for rates and timelines.\n\n\n### Testimonials\n\n#### [Freshwater Advisors](http://freshwateradvisors.com/)\n\n*My consulting group hired Nick to supervise the rebuild of our core web application. The product had a history of difficulties, and Nick's efforts guiding the project - and working closely with my team to get us to the point of self-sufficiency - completely transformed our product and saved us a significant amount of money.*\n\n*It would be easy to be intimidated by Nick's impressive engineering acumen and depth of expertise, but his genuine curiosity, patience, gift for teaching, and commitment to thoroughness make him both a joy to work with and a rarity in tech consulting.*\n\n-David Machajewski, Technology Lead, Freshwater Advisors\n","date":"2018-10-18T02:56:54.209Z","updated":"2018-10-18T02:56:54.209Z","path":"hire-me/index.html","comments":1,"layout":"page","_id":"cjngw0vn6000567oz8sq0s48b","content":"<p>I do software consulting work. Here are some things you can hire me for</p>\n<ul>\n<li><p><strong>Search</strong><br>Many clients have troves of data that are within grasp but inaccessible because of inadequate search systems. I can help you optimize your search systems using <a href=\"https://www.elastic.co/products/elasticsearch\" target=\"_blank\" rel=\"noopener\">Elasticsearch</a>.</p>\n</li>\n<li><p><strong>Application Development</strong><br>I have extensive experience in the Javascript/<a href=\"https://www.typescriptlang.org/\" target=\"_blank\" rel=\"noopener\">Typescript</a>/<a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"noopener\">Nodejs</a> ecosystem and am an expert in <a href=\"https://reactjs.org/\" target=\"_blank\" rel=\"noopener\">React</a>.</p>\n</li>\n<li><p><strong>Cloud Architecture</strong><br>I have worked extensively with <a href=\"https://aws.amazon.com/\" target=\"_blank\" rel=\"noopener\">AWS</a>‘s broad range of offerings and even have experience  implementing completely serverless systems. I can help you navigate this complicated ecosystem.</p>\n</li>\n<li><p><strong>Training</strong><br>I developed curriculum for and taught at Fullstack Javascript at <a href=\"https://www.fullstackacademy.com/\" target=\"_blank\" rel=\"noopener\">Fullstack Academy</a> for a year and specialize in <a href=\"https://reactjs.org/\" target=\"_blank\" rel=\"noopener\">React</a>, <a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"noopener\">NodeJS</a>, and <a href=\"https://www.elastic.co/products/elasticsearch\" target=\"_blank\" rel=\"noopener\">Elasticsearch</a> training for software companies.</p>\n</li>\n</ul>\n<p>Please reach out at me at <a href=\"mailto:nick@nickdrane.com\">nick@nickdrane.com</a> for rates and timelines.</p>\n<h3 id=\"Testimonials\"><a href=\"#Testimonials\" class=\"headerlink\" title=\"Testimonials\"></a>Testimonials</h3><h4 id=\"Freshwater-Advisors\"><a href=\"#Freshwater-Advisors\" class=\"headerlink\" title=\"Freshwater Advisors\"></a><a href=\"http://freshwateradvisors.com/\" target=\"_blank\" rel=\"noopener\">Freshwater Advisors</a></h4><p><em>My consulting group hired Nick to supervise the rebuild of our core web application. The product had a history of difficulties, and Nick’s efforts guiding the project - and working closely with my team to get us to the point of self-sufficiency - completely transformed our product and saved us a significant amount of money.</em></p>\n<p><em>It would be easy to be intimidated by Nick’s impressive engineering acumen and depth of expertise, but his genuine curiosity, patience, gift for teaching, and commitment to thoroughness make him both a joy to work with and a rarity in tech consulting.</em></p>\n<p>-David Machajewski, Technology Lead, Freshwater Advisors</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I do software consulting work. Here are some things you can hire me for</p>\n<ul>\n<li><p><strong>Search</strong><br>Many clients have troves of data that are within grasp but inaccessible because of inadequate search systems. I can help you optimize your search systems using <a href=\"https://www.elastic.co/products/elasticsearch\" target=\"_blank\" rel=\"noopener\">Elasticsearch</a>.</p>\n</li>\n<li><p><strong>Application Development</strong><br>I have extensive experience in the Javascript/<a href=\"https://www.typescriptlang.org/\" target=\"_blank\" rel=\"noopener\">Typescript</a>/<a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"noopener\">Nodejs</a> ecosystem and am an expert in <a href=\"https://reactjs.org/\" target=\"_blank\" rel=\"noopener\">React</a>.</p>\n</li>\n<li><p><strong>Cloud Architecture</strong><br>I have worked extensively with <a href=\"https://aws.amazon.com/\" target=\"_blank\" rel=\"noopener\">AWS</a>‘s broad range of offerings and even have experience  implementing completely serverless systems. I can help you navigate this complicated ecosystem.</p>\n</li>\n<li><p><strong>Training</strong><br>I developed curriculum for and taught at Fullstack Javascript at <a href=\"https://www.fullstackacademy.com/\" target=\"_blank\" rel=\"noopener\">Fullstack Academy</a> for a year and specialize in <a href=\"https://reactjs.org/\" target=\"_blank\" rel=\"noopener\">React</a>, <a href=\"https://nodejs.org/en/\" target=\"_blank\" rel=\"noopener\">NodeJS</a>, and <a href=\"https://www.elastic.co/products/elasticsearch\" target=\"_blank\" rel=\"noopener\">Elasticsearch</a> training for software companies.</p>\n</li>\n</ul>\n<p>Please reach out at me at <a href=\"mailto:nick@nickdrane.com\">nick@nickdrane.com</a> for rates and timelines.</p>\n<h3 id=\"Testimonials\"><a href=\"#Testimonials\" class=\"headerlink\" title=\"Testimonials\"></a>Testimonials</h3><h4 id=\"Freshwater-Advisors\"><a href=\"#Freshwater-Advisors\" class=\"headerlink\" title=\"Freshwater Advisors\"></a><a href=\"http://freshwateradvisors.com/\" target=\"_blank\" rel=\"noopener\">Freshwater Advisors</a></h4><p><em>My consulting group hired Nick to supervise the rebuild of our core web application. The product had a history of difficulties, and Nick’s efforts guiding the project - and working closely with my team to get us to the point of self-sufficiency - completely transformed our product and saved us a significant amount of money.</em></p>\n<p><em>It would be easy to be intimidated by Nick’s impressive engineering acumen and depth of expertise, but his genuine curiosity, patience, gift for teaching, and commitment to thoroughness make him both a joy to work with and a rarity in tech consulting.</em></p>\n<p>-David Machajewski, Technology Lead, Freshwater Advisors</p>\n"},{"title":"Projects","_content":"\n[Web Crawler](https://github.com/nadrane/crawler)\nThis is my current project. I'm endeavoring to crawl 1 billion web pages for a couple hundred dollars. It is ~80% done.\n\n[Build Your Own Regex Engine](https://github.com/nadrane/build-your-own-regex)\nBuild a simple regular expression engine in less than 40 lines of code.\n\n[React Column Layout](https://github.com/nadrane/react-column-layout) | [npm package](https://www.npmjs.com/package/react-column-layout)\nA column based layout system (think Pinterest style) that works responsively without special configuration.\n\n### Other Major Open Source Contributions\n\n[Sequelize](https://github.com/sequelize/sequelize/commits/master?author=nadrane)\nThe popular Nodejs ORM.\n","source":"projects/index.md","raw":"---\ntitle: Projects\n---\n\n[Web Crawler](https://github.com/nadrane/crawler)\nThis is my current project. I'm endeavoring to crawl 1 billion web pages for a couple hundred dollars. It is ~80% done.\n\n[Build Your Own Regex Engine](https://github.com/nadrane/build-your-own-regex)\nBuild a simple regular expression engine in less than 40 lines of code.\n\n[React Column Layout](https://github.com/nadrane/react-column-layout) | [npm package](https://www.npmjs.com/package/react-column-layout)\nA column based layout system (think Pinterest style) that works responsively without special configuration.\n\n### Other Major Open Source Contributions\n\n[Sequelize](https://github.com/sequelize/sequelize/commits/master?author=nadrane)\nThe popular Nodejs ORM.\n","date":"2018-10-18T02:57:47.598Z","updated":"2018-10-18T02:57:47.598Z","path":"projects/index.html","comments":1,"layout":"page","_id":"cjngw0vn7000767ozsy0vony8","content":"<p><a href=\"https://github.com/nadrane/crawler\" target=\"_blank\" rel=\"noopener\">Web Crawler</a><br>This is my current project. I’m endeavoring to crawl 1 billion web pages for a couple hundred dollars. It is ~80% done.</p>\n<p><a href=\"https://github.com/nadrane/build-your-own-regex\" target=\"_blank\" rel=\"noopener\">Build Your Own Regex Engine</a><br>Build a simple regular expression engine in less than 40 lines of code.</p>\n<p><a href=\"https://github.com/nadrane/react-column-layout\" target=\"_blank\" rel=\"noopener\">React Column Layout</a> | <a href=\"https://www.npmjs.com/package/react-column-layout\" target=\"_blank\" rel=\"noopener\">npm package</a><br>A column based layout system (think Pinterest style) that works responsively without special configuration.</p>\n<h3 id=\"Other-Major-Open-Source-Contributions\"><a href=\"#Other-Major-Open-Source-Contributions\" class=\"headerlink\" title=\"Other Major Open Source Contributions\"></a>Other Major Open Source Contributions</h3><p><a href=\"https://github.com/sequelize/sequelize/commits/master?author=nadrane\" target=\"_blank\" rel=\"noopener\">Sequelize</a><br>The popular Nodejs ORM.</p>\n","site":{"data":{}},"excerpt":"","more":"<p><a href=\"https://github.com/nadrane/crawler\" target=\"_blank\" rel=\"noopener\">Web Crawler</a><br>This is my current project. I’m endeavoring to crawl 1 billion web pages for a couple hundred dollars. It is ~80% done.</p>\n<p><a href=\"https://github.com/nadrane/build-your-own-regex\" target=\"_blank\" rel=\"noopener\">Build Your Own Regex Engine</a><br>Build a simple regular expression engine in less than 40 lines of code.</p>\n<p><a href=\"https://github.com/nadrane/react-column-layout\" target=\"_blank\" rel=\"noopener\">React Column Layout</a> | <a href=\"https://www.npmjs.com/package/react-column-layout\" target=\"_blank\" rel=\"noopener\">npm package</a><br>A column based layout system (think Pinterest style) that works responsively without special configuration.</p>\n<h3 id=\"Other-Major-Open-Source-Contributions\"><a href=\"#Other-Major-Open-Source-Contributions\" class=\"headerlink\" title=\"Other Major Open Source Contributions\"></a>Other Major Open Source Contributions</h3><p><a href=\"https://github.com/sequelize/sequelize/commits/master?author=nadrane\" target=\"_blank\" rel=\"noopener\">Sequelize</a><br>The popular Nodejs ORM.</p>\n"}],"Post":[{"title":"Build Your Own Lisp Interpreter","_content":"\nI read Peter Norvig's [blog post](http://norvig.com/lispy.html) on creating a Lisp interpreter the other day, and it reminded how mind-blowing it was the first time I saw an interpreter implemented (in [SICP](https://mitpress.mit.edu/sicp/full-text/book/book.html)). This blog post walks through an interpreter I wrote in Javascript. I've modeled it after Norvig's implementation, however I've optimized optimized for accessibility, particularly for people without Lisp experience. Furthermore, I've added test specs so that someone can self-guide themselves through the creation of their own implementation. The specs and solution can be found in this [GitHub repository](https://github.com/nadrane/build-your-own-lisp-interpreter).\n\n## A Basic Calculator\n\nThe first step is to create a program that can take formatted text strings as input, parse them, and then perform the mathematical operations they specify. Lisp uses a notation called prefix notation. Here are some examples:\n\n| Lisp Syntax      | Value | Comment                                                                                                              |\n| ---------------- | ----- | -------------------------------------------------------------------------------------------------------------------- |\n| `(+ 3 4)`        | 7     | As you can see, the operator comes before the operands                                                               |\n| `(+ 3 4 100 2)`  | 109   | Prefix notation allows more than 2 operands!                                                                         |\n| `(* (+ 3 4) -3)` | -21   | Operations can be nested arbitrarily and are evaluated inside out                                                    |\n| `(* (+ 3 4) -3)` | -36   | Spacing is required after operators and between operands. Everywhere it can be used as little or as much as you like |\n\nParsing these expressions will involve two steps:\n\n1.  Tokenization - Dividing up the languages parts into it's smallest pieces, called tokens\n2.  Syntax analysis - Converting a sequence of tokens into a tree (called an Abstract Syntax Tree (or AST for short)) that is conducive for program execution\n\n## Tokenization\n\nThe first thing we want to do is identify the tokens: that is, the smallest possible strings that have meaning within our language. Looking at the above Lisp expressions, we can see that numbers and operators obviously have meaning. More subtely, the `(` and `)` also have meaning because they influence the order of operations. The whitespace, however, means far less, at least when you consider an an alternative data structure for representing the program.\n\nInstead of a large string (yes, that's all any program is), let's turn our program into an array of tokens. Here's how the the above programs would translate:\n\n| Lisp Syntax      | Tokenized Version                             | Comments                                                    |\n| ---------------- | --------------------------------------------- | ----------------------------------------------------------- |\n| `(+ 3 4)`        | `[ '(', '+', '3', '4', ')' ]`                 |\n| `(+ 3 4 100 2)`  | `[ '(', '+', '3', '4', '100', '2', ')' ]`     | Notice that 100 is a single token, not three separate ones. |\n| `(* (+ 3 4) -3)` | `[ '(', '*', '(', '+', '3', '4', ')', '-3' ]` | -3 is also a single token                                   |\n\nIt's important to recognize that absolutely no meaning was lost in this translation process. We could write a simple program to complete this conversion:\n\n```js\nfunction tokenize(program) {\n  return (\n    program\n      // Ensure that every '(' and ')' is surrounded by whitespace. The consequence of this is that every token will be surrounded by whitespace\n      .replace(/\\)/g, \" ) \")\n      .replace(/\\(/g, \" ( \")\n      // Transforms the string in an array split up spaces\n      .split(\" \")\n      // Remove empty tokens. These might appear for example when we have a string like '2)'. The replace operations translate this string into '2 ) '. Since there is a trailing space, split(\" \") will yield ['2', ')', ''].\n      .filter(token => token !== \"\")\n  );\n}\n```\n\nThis program is far simpler than it looks, and I honestly assembled through trial and error in the REPL.\n\n## Syntax Analysis\n\nThe next step is to transform our array of tokens into a a data structure conducive for execution. Generally, compilers and interpreters will represent the code as an in-memory tree called an Abstract Syntax Tree (AST for short).\n\nIn essence, we want to take\n\n`(* (+ 3 4) -3)`\n\nturn it into\n\n`[ '(', '*', '(', '+', '3', '4', ')', '-3' ]`\n\nand turn that into\n","source":"_drafts/build-your-own-lisp-interpreter.md","raw":"---\ntitle: Build Your Own Lisp Interpreter\ncategories:\n  - [Javascript]\n  - [Build Your Own]\n---\n\nI read Peter Norvig's [blog post](http://norvig.com/lispy.html) on creating a Lisp interpreter the other day, and it reminded how mind-blowing it was the first time I saw an interpreter implemented (in [SICP](https://mitpress.mit.edu/sicp/full-text/book/book.html)). This blog post walks through an interpreter I wrote in Javascript. I've modeled it after Norvig's implementation, however I've optimized optimized for accessibility, particularly for people without Lisp experience. Furthermore, I've added test specs so that someone can self-guide themselves through the creation of their own implementation. The specs and solution can be found in this [GitHub repository](https://github.com/nadrane/build-your-own-lisp-interpreter).\n\n## A Basic Calculator\n\nThe first step is to create a program that can take formatted text strings as input, parse them, and then perform the mathematical operations they specify. Lisp uses a notation called prefix notation. Here are some examples:\n\n| Lisp Syntax      | Value | Comment                                                                                                              |\n| ---------------- | ----- | -------------------------------------------------------------------------------------------------------------------- |\n| `(+ 3 4)`        | 7     | As you can see, the operator comes before the operands                                                               |\n| `(+ 3 4 100 2)`  | 109   | Prefix notation allows more than 2 operands!                                                                         |\n| `(* (+ 3 4) -3)` | -21   | Operations can be nested arbitrarily and are evaluated inside out                                                    |\n| `(* (+ 3 4) -3)` | -36   | Spacing is required after operators and between operands. Everywhere it can be used as little or as much as you like |\n\nParsing these expressions will involve two steps:\n\n1.  Tokenization - Dividing up the languages parts into it's smallest pieces, called tokens\n2.  Syntax analysis - Converting a sequence of tokens into a tree (called an Abstract Syntax Tree (or AST for short)) that is conducive for program execution\n\n## Tokenization\n\nThe first thing we want to do is identify the tokens: that is, the smallest possible strings that have meaning within our language. Looking at the above Lisp expressions, we can see that numbers and operators obviously have meaning. More subtely, the `(` and `)` also have meaning because they influence the order of operations. The whitespace, however, means far less, at least when you consider an an alternative data structure for representing the program.\n\nInstead of a large string (yes, that's all any program is), let's turn our program into an array of tokens. Here's how the the above programs would translate:\n\n| Lisp Syntax      | Tokenized Version                             | Comments                                                    |\n| ---------------- | --------------------------------------------- | ----------------------------------------------------------- |\n| `(+ 3 4)`        | `[ '(', '+', '3', '4', ')' ]`                 |\n| `(+ 3 4 100 2)`  | `[ '(', '+', '3', '4', '100', '2', ')' ]`     | Notice that 100 is a single token, not three separate ones. |\n| `(* (+ 3 4) -3)` | `[ '(', '*', '(', '+', '3', '4', ')', '-3' ]` | -3 is also a single token                                   |\n\nIt's important to recognize that absolutely no meaning was lost in this translation process. We could write a simple program to complete this conversion:\n\n```js\nfunction tokenize(program) {\n  return (\n    program\n      // Ensure that every '(' and ')' is surrounded by whitespace. The consequence of this is that every token will be surrounded by whitespace\n      .replace(/\\)/g, \" ) \")\n      .replace(/\\(/g, \" ( \")\n      // Transforms the string in an array split up spaces\n      .split(\" \")\n      // Remove empty tokens. These might appear for example when we have a string like '2)'. The replace operations translate this string into '2 ) '. Since there is a trailing space, split(\" \") will yield ['2', ')', ''].\n      .filter(token => token !== \"\")\n  );\n}\n```\n\nThis program is far simpler than it looks, and I honestly assembled through trial and error in the REPL.\n\n## Syntax Analysis\n\nThe next step is to transform our array of tokens into a a data structure conducive for execution. Generally, compilers and interpreters will represent the code as an in-memory tree called an Abstract Syntax Tree (AST for short).\n\nIn essence, we want to take\n\n`(* (+ 3 4) -3)`\n\nturn it into\n\n`[ '(', '*', '(', '+', '3', '4', ')', '-3' ]`\n\nand turn that into\n","slug":"build-your-own-lisp-interpreter","published":0,"date":"2018-09-15T20:59:09.599Z","updated":"2018-09-15T20:59:09.599Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vn2000267ozc7lqwrca","content":"<p>I read Peter Norvig’s <a href=\"http://norvig.com/lispy.html\" target=\"_blank\" rel=\"noopener\">blog post</a> on creating a Lisp interpreter the other day, and it reminded how mind-blowing it was the first time I saw an interpreter implemented (in <a href=\"https://mitpress.mit.edu/sicp/full-text/book/book.html\" target=\"_blank\" rel=\"noopener\">SICP</a>). This blog post walks through an interpreter I wrote in Javascript. I’ve modeled it after Norvig’s implementation, however I’ve optimized optimized for accessibility, particularly for people without Lisp experience. Furthermore, I’ve added test specs so that someone can self-guide themselves through the creation of their own implementation. The specs and solution can be found in this <a href=\"https://github.com/nadrane/build-your-own-lisp-interpreter\" target=\"_blank\" rel=\"noopener\">GitHub repository</a>.</p>\n<h2 id=\"A-Basic-Calculator\"><a href=\"#A-Basic-Calculator\" class=\"headerlink\" title=\"A Basic Calculator\"></a>A Basic Calculator</h2><p>The first step is to create a program that can take formatted text strings as input, parse them, and then perform the mathematical operations they specify. Lisp uses a notation called prefix notation. Here are some examples:</p>\n<table>\n<thead>\n<tr>\n<th>Lisp Syntax</th>\n<th>Value</th>\n<th>Comment</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>(+ 3 4)</code></td>\n<td>7</td>\n<td>As you can see, the operator comes before the operands</td>\n</tr>\n<tr>\n<td><code>(+ 3 4 100 2)</code></td>\n<td>109</td>\n<td>Prefix notation allows more than 2 operands!</td>\n</tr>\n<tr>\n<td><code>(* (+ 3 4) -3)</code></td>\n<td>-21</td>\n<td>Operations can be nested arbitrarily and are evaluated inside out</td>\n</tr>\n<tr>\n<td><code>(* (+ 3 4) -3)</code></td>\n<td>-36</td>\n<td>Spacing is required after operators and between operands. Everywhere it can be used as little or as much as you like</td>\n</tr>\n</tbody>\n</table>\n<p>Parsing these expressions will involve two steps:</p>\n<ol>\n<li>Tokenization - Dividing up the languages parts into it’s smallest pieces, called tokens</li>\n<li>Syntax analysis - Converting a sequence of tokens into a tree (called an Abstract Syntax Tree (or AST for short)) that is conducive for program execution</li>\n</ol>\n<h2 id=\"Tokenization\"><a href=\"#Tokenization\" class=\"headerlink\" title=\"Tokenization\"></a>Tokenization</h2><p>The first thing we want to do is identify the tokens: that is, the smallest possible strings that have meaning within our language. Looking at the above Lisp expressions, we can see that numbers and operators obviously have meaning. More subtely, the <code>(</code> and <code>)</code> also have meaning because they influence the order of operations. The whitespace, however, means far less, at least when you consider an an alternative data structure for representing the program.</p>\n<p>Instead of a large string (yes, that’s all any program is), let’s turn our program into an array of tokens. Here’s how the the above programs would translate:</p>\n<table>\n<thead>\n<tr>\n<th>Lisp Syntax</th>\n<th>Tokenized Version</th>\n<th>Comments</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>(+ 3 4)</code></td>\n<td><code>[ &#39;(&#39;, &#39;+&#39;, &#39;3&#39;, &#39;4&#39;, &#39;)&#39; ]</code></td>\n</tr>\n<tr>\n<td><code>(+ 3 4 100 2)</code></td>\n<td><code>[ &#39;(&#39;, &#39;+&#39;, &#39;3&#39;, &#39;4&#39;, &#39;100&#39;, &#39;2&#39;, &#39;)&#39; ]</code></td>\n<td>Notice that 100 is a single token, not three separate ones.</td>\n</tr>\n<tr>\n<td><code>(* (+ 3 4) -3)</code></td>\n<td><code>[ &#39;(&#39;, &#39;*&#39;, &#39;(&#39;, &#39;+&#39;, &#39;3&#39;, &#39;4&#39;, &#39;)&#39;, &#39;-3&#39; ]</code></td>\n<td>-3 is also a single token</td>\n</tr>\n</tbody>\n</table>\n<p>It’s important to recognize that absolutely no meaning was lost in this translation process. We could write a simple program to complete this conversion:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">tokenize</span>(<span class=\"params\">program</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (</span><br><span class=\"line\">    program</span><br><span class=\"line\">      <span class=\"comment\">// Ensure that every '(' and ')' is surrounded by whitespace. The consequence of this is that every token will be surrounded by whitespace</span></span><br><span class=\"line\">      .replace(<span class=\"regexp\">/\\)/g</span>, <span class=\"string\">\" ) \"</span>)</span><br><span class=\"line\">      .replace(<span class=\"regexp\">/\\(/g</span>, <span class=\"string\">\" ( \"</span>)</span><br><span class=\"line\">      <span class=\"comment\">// Transforms the string in an array split up spaces</span></span><br><span class=\"line\">      .split(<span class=\"string\">\" \"</span>)</span><br><span class=\"line\">      <span class=\"comment\">// Remove empty tokens. These might appear for example when we have a string like '2)'. The replace operations translate this string into '2 ) '. Since there is a trailing space, split(\" \") will yield ['2', ')', ''].</span></span><br><span class=\"line\">      .filter(<span class=\"function\"><span class=\"params\">token</span> =&gt;</span> token !== <span class=\"string\">\"\"</span>)</span><br><span class=\"line\">  );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>This program is far simpler than it looks, and I honestly assembled through trial and error in the REPL.</p>\n<h2 id=\"Syntax-Analysis\"><a href=\"#Syntax-Analysis\" class=\"headerlink\" title=\"Syntax Analysis\"></a>Syntax Analysis</h2><p>The next step is to transform our array of tokens into a a data structure conducive for execution. Generally, compilers and interpreters will represent the code as an in-memory tree called an Abstract Syntax Tree (AST for short).</p>\n<p>In essence, we want to take</p>\n<p><code>(* (+ 3 4) -3)</code></p>\n<p>turn it into</p>\n<p><code>[ &#39;(&#39;, &#39;*&#39;, &#39;(&#39;, &#39;+&#39;, &#39;3&#39;, &#39;4&#39;, &#39;)&#39;, &#39;-3&#39; ]</code></p>\n<p>and turn that into</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I read Peter Norvig’s <a href=\"http://norvig.com/lispy.html\" target=\"_blank\" rel=\"noopener\">blog post</a> on creating a Lisp interpreter the other day, and it reminded how mind-blowing it was the first time I saw an interpreter implemented (in <a href=\"https://mitpress.mit.edu/sicp/full-text/book/book.html\" target=\"_blank\" rel=\"noopener\">SICP</a>). This blog post walks through an interpreter I wrote in Javascript. I’ve modeled it after Norvig’s implementation, however I’ve optimized optimized for accessibility, particularly for people without Lisp experience. Furthermore, I’ve added test specs so that someone can self-guide themselves through the creation of their own implementation. The specs and solution can be found in this <a href=\"https://github.com/nadrane/build-your-own-lisp-interpreter\" target=\"_blank\" rel=\"noopener\">GitHub repository</a>.</p>\n<h2 id=\"A-Basic-Calculator\"><a href=\"#A-Basic-Calculator\" class=\"headerlink\" title=\"A Basic Calculator\"></a>A Basic Calculator</h2><p>The first step is to create a program that can take formatted text strings as input, parse them, and then perform the mathematical operations they specify. Lisp uses a notation called prefix notation. Here are some examples:</p>\n<table>\n<thead>\n<tr>\n<th>Lisp Syntax</th>\n<th>Value</th>\n<th>Comment</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>(+ 3 4)</code></td>\n<td>7</td>\n<td>As you can see, the operator comes before the operands</td>\n</tr>\n<tr>\n<td><code>(+ 3 4 100 2)</code></td>\n<td>109</td>\n<td>Prefix notation allows more than 2 operands!</td>\n</tr>\n<tr>\n<td><code>(* (+ 3 4) -3)</code></td>\n<td>-21</td>\n<td>Operations can be nested arbitrarily and are evaluated inside out</td>\n</tr>\n<tr>\n<td><code>(* (+ 3 4) -3)</code></td>\n<td>-36</td>\n<td>Spacing is required after operators and between operands. Everywhere it can be used as little or as much as you like</td>\n</tr>\n</tbody>\n</table>\n<p>Parsing these expressions will involve two steps:</p>\n<ol>\n<li>Tokenization - Dividing up the languages parts into it’s smallest pieces, called tokens</li>\n<li>Syntax analysis - Converting a sequence of tokens into a tree (called an Abstract Syntax Tree (or AST for short)) that is conducive for program execution</li>\n</ol>\n<h2 id=\"Tokenization\"><a href=\"#Tokenization\" class=\"headerlink\" title=\"Tokenization\"></a>Tokenization</h2><p>The first thing we want to do is identify the tokens: that is, the smallest possible strings that have meaning within our language. Looking at the above Lisp expressions, we can see that numbers and operators obviously have meaning. More subtely, the <code>(</code> and <code>)</code> also have meaning because they influence the order of operations. The whitespace, however, means far less, at least when you consider an an alternative data structure for representing the program.</p>\n<p>Instead of a large string (yes, that’s all any program is), let’s turn our program into an array of tokens. Here’s how the the above programs would translate:</p>\n<table>\n<thead>\n<tr>\n<th>Lisp Syntax</th>\n<th>Tokenized Version</th>\n<th>Comments</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>(+ 3 4)</code></td>\n<td><code>[ &#39;(&#39;, &#39;+&#39;, &#39;3&#39;, &#39;4&#39;, &#39;)&#39; ]</code></td>\n</tr>\n<tr>\n<td><code>(+ 3 4 100 2)</code></td>\n<td><code>[ &#39;(&#39;, &#39;+&#39;, &#39;3&#39;, &#39;4&#39;, &#39;100&#39;, &#39;2&#39;, &#39;)&#39; ]</code></td>\n<td>Notice that 100 is a single token, not three separate ones.</td>\n</tr>\n<tr>\n<td><code>(* (+ 3 4) -3)</code></td>\n<td><code>[ &#39;(&#39;, &#39;*&#39;, &#39;(&#39;, &#39;+&#39;, &#39;3&#39;, &#39;4&#39;, &#39;)&#39;, &#39;-3&#39; ]</code></td>\n<td>-3 is also a single token</td>\n</tr>\n</tbody>\n</table>\n<p>It’s important to recognize that absolutely no meaning was lost in this translation process. We could write a simple program to complete this conversion:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">tokenize</span>(<span class=\"params\">program</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (</span><br><span class=\"line\">    program</span><br><span class=\"line\">      <span class=\"comment\">// Ensure that every '(' and ')' is surrounded by whitespace. The consequence of this is that every token will be surrounded by whitespace</span></span><br><span class=\"line\">      .replace(<span class=\"regexp\">/\\)/g</span>, <span class=\"string\">\" ) \"</span>)</span><br><span class=\"line\">      .replace(<span class=\"regexp\">/\\(/g</span>, <span class=\"string\">\" ( \"</span>)</span><br><span class=\"line\">      <span class=\"comment\">// Transforms the string in an array split up spaces</span></span><br><span class=\"line\">      .split(<span class=\"string\">\" \"</span>)</span><br><span class=\"line\">      <span class=\"comment\">// Remove empty tokens. These might appear for example when we have a string like '2)'. The replace operations translate this string into '2 ) '. Since there is a trailing space, split(\" \") will yield ['2', ')', ''].</span></span><br><span class=\"line\">      .filter(<span class=\"function\"><span class=\"params\">token</span> =&gt;</span> token !== <span class=\"string\">\"\"</span>)</span><br><span class=\"line\">  );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>This program is far simpler than it looks, and I honestly assembled through trial and error in the REPL.</p>\n<h2 id=\"Syntax-Analysis\"><a href=\"#Syntax-Analysis\" class=\"headerlink\" title=\"Syntax Analysis\"></a>Syntax Analysis</h2><p>The next step is to transform our array of tokens into a a data structure conducive for execution. Generally, compilers and interpreters will represent the code as an in-memory tree called an Abstract Syntax Tree (AST for short).</p>\n<p>In essence, we want to take</p>\n<p><code>(* (+ 3 4) -3)</code></p>\n<p>turn it into</p>\n<p><code>[ &#39;(&#39;, &#39;*&#39;, &#39;(&#39;, &#39;+&#39;, &#39;3&#39;, &#39;4&#39;, &#39;)&#39;, &#39;-3&#39; ]</code></p>\n<p>and turn that into</p>\n"},{"title":"build-your-own-regex-engine-grouping","date":"2017-12-07T15:24:16.000Z","_content":"","source":"_drafts/build-your-own-regex-engine-grouping.md","raw":"---\ntitle: build-your-own-regex-engine-grouping\ndate: 2017-12-07 09:24:16\ncategories:\n---\n","slug":"build-your-own-regex-engine-grouping","published":0,"updated":"2018-09-15T20:59:09.599Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vn5000467ozvriqjxs6","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"microservices failure","_content":"\nProgramming is often about confronting failure: failed designs, faulty problem statements, poor management of time or requirements. Whenever I encounter a significant failure, I like to do a postmortem. Ultimately, I believe it's through this introspection that growth is maximized and that similar failures can be avoided in the future.\n\n6 weeks ago I started working on a client project to build a dialogue management system. The client is a Freight brokerage and wants to be able to coordinate all of its communication with truckers, dispatchers, warehouse operators etc with automated bots. My task is to build a framework that makes it easy to write bots and extract meaningful NLU information that can later be used to train an AI.\n\nThe first thing I did was come up with a prototype that would allow us to write bots and engage in conversations with them. This system was essentially a CLI tool, and the goal was to set in stone the API for writing bots before tackling to complexity of integrating the system with the greater application. I completed this task in short order, and one of the company's engineer's and I began to process of integrated this bot framework into the great web app. The problem was complicated by the fact that the web app already used a bot system that it outgrew months earlier.\n\nThe first bot system had 2 tables in a relational database that drove the majority of it's functionality. Our first major decision was whether our bot system should live on it's own machine in it's own repository. If we needed any data from the original system, we would simply ask for it. We made the choice to do this, and it turned out to be the wrong decision.\n","source":"_drafts/microservices-failure.md","raw":"---\ntitle: microservices failure\ncategories:\n- [Architecture]\n- [Failures]\n---\n\nProgramming is often about confronting failure: failed designs, faulty problem statements, poor management of time or requirements. Whenever I encounter a significant failure, I like to do a postmortem. Ultimately, I believe it's through this introspection that growth is maximized and that similar failures can be avoided in the future.\n\n6 weeks ago I started working on a client project to build a dialogue management system. The client is a Freight brokerage and wants to be able to coordinate all of its communication with truckers, dispatchers, warehouse operators etc with automated bots. My task is to build a framework that makes it easy to write bots and extract meaningful NLU information that can later be used to train an AI.\n\nThe first thing I did was come up with a prototype that would allow us to write bots and engage in conversations with them. This system was essentially a CLI tool, and the goal was to set in stone the API for writing bots before tackling to complexity of integrating the system with the greater application. I completed this task in short order, and one of the company's engineer's and I began to process of integrated this bot framework into the great web app. The problem was complicated by the fact that the web app already used a bot system that it outgrew months earlier.\n\nThe first bot system had 2 tables in a relational database that drove the majority of it's functionality. Our first major decision was whether our bot system should live on it's own machine in it's own repository. If we needed any data from the original system, we would simply ask for it. We made the choice to do this, and it turned out to be the wrong decision.\n","slug":"microservices-failure","published":0,"date":"2018-09-15T20:59:09.600Z","updated":"2018-09-15T20:59:09.600Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vn6000667ozwtqruv0k","content":"<p>Programming is often about confronting failure: failed designs, faulty problem statements, poor management of time or requirements. Whenever I encounter a significant failure, I like to do a postmortem. Ultimately, I believe it’s through this introspection that growth is maximized and that similar failures can be avoided in the future.</p>\n<p>6 weeks ago I started working on a client project to build a dialogue management system. The client is a Freight brokerage and wants to be able to coordinate all of its communication with truckers, dispatchers, warehouse operators etc with automated bots. My task is to build a framework that makes it easy to write bots and extract meaningful NLU information that can later be used to train an AI.</p>\n<p>The first thing I did was come up with a prototype that would allow us to write bots and engage in conversations with them. This system was essentially a CLI tool, and the goal was to set in stone the API for writing bots before tackling to complexity of integrating the system with the greater application. I completed this task in short order, and one of the company’s engineer’s and I began to process of integrated this bot framework into the great web app. The problem was complicated by the fact that the web app already used a bot system that it outgrew months earlier.</p>\n<p>The first bot system had 2 tables in a relational database that drove the majority of it’s functionality. Our first major decision was whether our bot system should live on it’s own machine in it’s own repository. If we needed any data from the original system, we would simply ask for it. We made the choice to do this, and it turned out to be the wrong decision.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Programming is often about confronting failure: failed designs, faulty problem statements, poor management of time or requirements. Whenever I encounter a significant failure, I like to do a postmortem. Ultimately, I believe it’s through this introspection that growth is maximized and that similar failures can be avoided in the future.</p>\n<p>6 weeks ago I started working on a client project to build a dialogue management system. The client is a Freight brokerage and wants to be able to coordinate all of its communication with truckers, dispatchers, warehouse operators etc with automated bots. My task is to build a framework that makes it easy to write bots and extract meaningful NLU information that can later be used to train an AI.</p>\n<p>The first thing I did was come up with a prototype that would allow us to write bots and engage in conversations with them. This system was essentially a CLI tool, and the goal was to set in stone the API for writing bots before tackling to complexity of integrating the system with the greater application. I completed this task in short order, and one of the company’s engineer’s and I began to process of integrated this bot framework into the great web app. The problem was complicated by the fact that the web app already used a bot system that it outgrew months earlier.</p>\n<p>The first bot system had 2 tables in a relational database that drove the majority of it’s functionality. Our first major decision was whether our bot system should live on it’s own machine in it’s own repository. If we needed any data from the original system, we would simply ask for it. We made the choice to do this, and it turned out to be the wrong decision.</p>\n"},{"title":"Write-Your-Own-Promise-Library","_content":"","source":"_drafts/write-your-own-promise-library.md","raw":"---\ntitle: Write-Your-Own-Promise-Library\ntags:\n---\n","slug":"write-your-own-promise-library","published":0,"date":"2018-09-15T20:59:09.600Z","updated":"2018-09-15T20:59:09.600Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vn7000867ozzgahr18y","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"The Hidden Costs of Large Columns in PostgreSQL's: The Dangers of TOAST","date":"2018-10-03T05:00:00.000Z","_content":"\nI recently wrote an [article](/https://nickdrane.com/hidden-costs-of-postgresql-jsonb/) on some hiccups I ran into while using [JSONB](https://www.postgresql.org/docs/current/static/datatype-json.html). This article is written from the perspective of the application developer and discusses architectural decisions made to overcome issues with JSONB.\n\nNow I want to shift focus to the perspective of the database engineer. I want to explore how I identified why JSONB was a problem and how I proved my fix solved the problem. This article does not require you have read the previous blog post.\n\n## Schema\n\nSuppose we have a `test` table with the following schema:\n\n| Column       | Type                   | Storage  |\n|--------------|------------------------|----------|\n| id           | integer                | plain    |\n| content      | text                   | extended |\n| meta         | jsonb                  | extended |\n| filter_index | integer                | plain    |\n\nFor now, you can ignore the `storage` column. It will become relevant later. Suppose that our `filter_index` column is indexed using a BTREE.\n\nWe can create this `test` table with the following SQL:\n\n```sql\nCREATE TABLE test (\n    id integer,\n    content text,\n    meta jsonb,\n    filter_index integer\n);\n\nCREATE INDEX filter_index ON test (filter_index);\n```\n\n## Seeding the Database\n\n```sql\nINSERT\nINTO\n\ttest (small, large, filter_index)\nSELECT\n\tarray_to_string(\n\t\tARRAY (SELECT chr((65 + round(random() * 25))::INT) FROM ROWS FROM (generate_series(1, 1000))),\n\t\t''\n\t)\n\t\tAS small,\n\tarray_to_string(\n\t\tARRAY (SELECT chr((65 + round(random() * 25))::INT) FROM ROWS FROM (generate_series(1, 1000000))),\n\t\t''\n\t)\n\t\tAS large,\n\tround(random() * 100) AS filter_index\nFROM\n\tgenerate_series(1, 100000);\n```\n that contains a JSONB `meta` column. We discovered that our queries drastically slowed down when this column was included in `SELECT` statements. Performance resumed to normal if it was omitted.\n\n## Specifics\n\nWe were making simple queries against the `message` table that looked like this:\n\n```sql\nSELECT id, content, subject, meta\nFROM message\nWHERE channel_id = 123\n```\n\nIn this case, the `channel_id` relates back to the `channel` table with a one-to-many relationship. The channel_id is indexed. Note that we are not ordering or grouping or doing anything interesting with `meta` at all.\n\n## Query Plan\n\nThe query plan is painfully uninteresting. As expected, we are indexing on the channel_id.\n\n```\nBitmap Heap Scan on message  (cost=69.84..6221.86 rows=3296 width=811) (actual time=0.600..2.230 rows=3166 loops=1)\n  Recheck Cond: (channel_id = 44789)\n  Heap Blocks: exact=1691\n  ->  Bitmap Index Scan on message_channel_id  (cost=0.00..69.01 rows=3296 width=0) (actual time=0.343..0.343 rows=3166 loops=1)\n        Index Cond: (channel_id = 44789)\nPlanning time: 0.113 ms\nExecution time: 2.517 ms\n```\n\nI had already had suspicions that the `meta` column was large and began to investigate further\n\n```sql\nSELECT octet_length(m.\"meta\"::text)\nFROM message as m\nWHERE octet_length(m.\"meta\"::text) IS NOT NULL\nORDER BY octet_length(m.\"meta\"::text) DESC;\n```\n\nThis query revealed that some `meta` columns were consuming up to 17mb of space, in the most extreme cases.\n\nKeep in mind that this data is random and uncompressible. We can validate this assumption by comparing the compressed and uncompressed average row size:\n\n```sql\nSELECT avg(octet_length(m.*::text)) as uncompressed, avg(pg_column_size(m.*::text)) as compressed\nFROM test as m;\n```\n\nThe results:\n\n| Compressed (bytes) | Uncompressed (bytes)   |\n|--------------------|------------------------|\n| 5511.9             | 5515.9                 |\n\n## TOAST\n\n\nWhen a column in a tuple (a single row) in Postgres becomes to large (by default exceeding 2kb), it is stored \"out-of-line\" in a TOAST table. This effectively means that in order to retrieve the entirety of the contents of a given tuple, it might be necessary to query not only the original table but also a secondary TOAST table. And if the column is large enough, the TOAST table might need to be queried many times.\n\nI suspected that the `meta` column was toasting and with a little help from the [Postgres docs](https://www.postgresql.org/docs/10/static/disk-usage.html), I was able to readily verify by theory.\n\n```sql\nSELECT relname, relpages\nFROM pg_class,\n     (SELECT reltoastrelid\n      FROM pg_class\n      WHERE relname = 'message') AS ss\nWHERE oid = ss.reltoastrelid OR\n      oid = (SELECT indexrelid\n             FROM pg_index\n             WHERE indrelid = ss.reltoastrelid)\nORDER BY relname;\n```\n\n```\npg_toast_1432460\t17731\npg_toast_1432460_index\t209\n```\n\nWe can see that the message table has 17731 disk pages of information storing the contents of the TOAST table and another 209 pages dedicated to storing the TOAST table's index.\n\nMaybe estimate how long this read would take from disk?\n\nWhen the migrations are applied, we can see that the TOAST table pages goes to 0.\n\nShow how the execution time of the query plan is affected\n\nLook up how to benchmark postgres properly.\n\nThink about whether it makes sense for the cache to be warm or not. Probably warm.\n\nThis a grand total of","source":"_drafts/hidden-costs-of-postgresql-jsonb-partII.md","raw":"---\ntitle: \"The Hidden Costs of Large Columns in PostgreSQL's: The Dangers of TOAST\"\ndate: 2018-10-03\ncategories:\n  - [Postgres]\n---\n\nI recently wrote an [article](/https://nickdrane.com/hidden-costs-of-postgresql-jsonb/) on some hiccups I ran into while using [JSONB](https://www.postgresql.org/docs/current/static/datatype-json.html). This article is written from the perspective of the application developer and discusses architectural decisions made to overcome issues with JSONB.\n\nNow I want to shift focus to the perspective of the database engineer. I want to explore how I identified why JSONB was a problem and how I proved my fix solved the problem. This article does not require you have read the previous blog post.\n\n## Schema\n\nSuppose we have a `test` table with the following schema:\n\n| Column       | Type                   | Storage  |\n|--------------|------------------------|----------|\n| id           | integer                | plain    |\n| content      | text                   | extended |\n| meta         | jsonb                  | extended |\n| filter_index | integer                | plain    |\n\nFor now, you can ignore the `storage` column. It will become relevant later. Suppose that our `filter_index` column is indexed using a BTREE.\n\nWe can create this `test` table with the following SQL:\n\n```sql\nCREATE TABLE test (\n    id integer,\n    content text,\n    meta jsonb,\n    filter_index integer\n);\n\nCREATE INDEX filter_index ON test (filter_index);\n```\n\n## Seeding the Database\n\n```sql\nINSERT\nINTO\n\ttest (small, large, filter_index)\nSELECT\n\tarray_to_string(\n\t\tARRAY (SELECT chr((65 + round(random() * 25))::INT) FROM ROWS FROM (generate_series(1, 1000))),\n\t\t''\n\t)\n\t\tAS small,\n\tarray_to_string(\n\t\tARRAY (SELECT chr((65 + round(random() * 25))::INT) FROM ROWS FROM (generate_series(1, 1000000))),\n\t\t''\n\t)\n\t\tAS large,\n\tround(random() * 100) AS filter_index\nFROM\n\tgenerate_series(1, 100000);\n```\n that contains a JSONB `meta` column. We discovered that our queries drastically slowed down when this column was included in `SELECT` statements. Performance resumed to normal if it was omitted.\n\n## Specifics\n\nWe were making simple queries against the `message` table that looked like this:\n\n```sql\nSELECT id, content, subject, meta\nFROM message\nWHERE channel_id = 123\n```\n\nIn this case, the `channel_id` relates back to the `channel` table with a one-to-many relationship. The channel_id is indexed. Note that we are not ordering or grouping or doing anything interesting with `meta` at all.\n\n## Query Plan\n\nThe query plan is painfully uninteresting. As expected, we are indexing on the channel_id.\n\n```\nBitmap Heap Scan on message  (cost=69.84..6221.86 rows=3296 width=811) (actual time=0.600..2.230 rows=3166 loops=1)\n  Recheck Cond: (channel_id = 44789)\n  Heap Blocks: exact=1691\n  ->  Bitmap Index Scan on message_channel_id  (cost=0.00..69.01 rows=3296 width=0) (actual time=0.343..0.343 rows=3166 loops=1)\n        Index Cond: (channel_id = 44789)\nPlanning time: 0.113 ms\nExecution time: 2.517 ms\n```\n\nI had already had suspicions that the `meta` column was large and began to investigate further\n\n```sql\nSELECT octet_length(m.\"meta\"::text)\nFROM message as m\nWHERE octet_length(m.\"meta\"::text) IS NOT NULL\nORDER BY octet_length(m.\"meta\"::text) DESC;\n```\n\nThis query revealed that some `meta` columns were consuming up to 17mb of space, in the most extreme cases.\n\nKeep in mind that this data is random and uncompressible. We can validate this assumption by comparing the compressed and uncompressed average row size:\n\n```sql\nSELECT avg(octet_length(m.*::text)) as uncompressed, avg(pg_column_size(m.*::text)) as compressed\nFROM test as m;\n```\n\nThe results:\n\n| Compressed (bytes) | Uncompressed (bytes)   |\n|--------------------|------------------------|\n| 5511.9             | 5515.9                 |\n\n## TOAST\n\n\nWhen a column in a tuple (a single row) in Postgres becomes to large (by default exceeding 2kb), it is stored \"out-of-line\" in a TOAST table. This effectively means that in order to retrieve the entirety of the contents of a given tuple, it might be necessary to query not only the original table but also a secondary TOAST table. And if the column is large enough, the TOAST table might need to be queried many times.\n\nI suspected that the `meta` column was toasting and with a little help from the [Postgres docs](https://www.postgresql.org/docs/10/static/disk-usage.html), I was able to readily verify by theory.\n\n```sql\nSELECT relname, relpages\nFROM pg_class,\n     (SELECT reltoastrelid\n      FROM pg_class\n      WHERE relname = 'message') AS ss\nWHERE oid = ss.reltoastrelid OR\n      oid = (SELECT indexrelid\n             FROM pg_index\n             WHERE indrelid = ss.reltoastrelid)\nORDER BY relname;\n```\n\n```\npg_toast_1432460\t17731\npg_toast_1432460_index\t209\n```\n\nWe can see that the message table has 17731 disk pages of information storing the contents of the TOAST table and another 209 pages dedicated to storing the TOAST table's index.\n\nMaybe estimate how long this read would take from disk?\n\nWhen the migrations are applied, we can see that the TOAST table pages goes to 0.\n\nShow how the execution time of the query plan is affected\n\nLook up how to benchmark postgres properly.\n\nThink about whether it makes sense for the cache to be warm or not. Probably warm.\n\nThis a grand total of","slug":"hidden-costs-of-postgresql-jsonb-partII","published":0,"updated":"2018-10-18T03:20:23.626Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vn8000967oz5tlogpwm","content":"<p>I recently wrote an <a href=\"/https://nickdrane.com/hidden-costs-of-postgresql-jsonb/\">article</a> on some hiccups I ran into while using <a href=\"https://www.postgresql.org/docs/current/static/datatype-json.html\" target=\"_blank\" rel=\"noopener\">JSONB</a>. This article is written from the perspective of the application developer and discusses architectural decisions made to overcome issues with JSONB.</p>\n<p>Now I want to shift focus to the perspective of the database engineer. I want to explore how I identified why JSONB was a problem and how I proved my fix solved the problem. This article does not require you have read the previous blog post.</p>\n<h2 id=\"Schema\"><a href=\"#Schema\" class=\"headerlink\" title=\"Schema\"></a>Schema</h2><p>Suppose we have a <code>test</code> table with the following schema:</p>\n<table>\n<thead>\n<tr>\n<th>Column</th>\n<th>Type</th>\n<th>Storage</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>integer</td>\n<td>plain</td>\n</tr>\n<tr>\n<td>content</td>\n<td>text</td>\n<td>extended</td>\n</tr>\n<tr>\n<td>meta</td>\n<td>jsonb</td>\n<td>extended</td>\n</tr>\n<tr>\n<td>filter_index</td>\n<td>integer</td>\n<td>plain</td>\n</tr>\n</tbody>\n</table>\n<p>For now, you can ignore the <code>storage</code> column. It will become relevant later. Suppose that our <code>filter_index</code> column is indexed using a BTREE.</p>\n<p>We can create this <code>test</code> table with the following SQL:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> <span class=\"keyword\">test</span> (</span><br><span class=\"line\">    <span class=\"keyword\">id</span> <span class=\"built_in\">integer</span>,</span><br><span class=\"line\">    <span class=\"keyword\">content</span> <span class=\"built_in\">text</span>,</span><br><span class=\"line\">    meta jsonb,</span><br><span class=\"line\">    filter_index <span class=\"built_in\">integer</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">INDEX</span> filter_index <span class=\"keyword\">ON</span> <span class=\"keyword\">test</span> (filter_index);</span><br></pre></td></tr></table></figure>\n<h2 id=\"Seeding-the-Database\"><a href=\"#Seeding-the-Database\" class=\"headerlink\" title=\"Seeding the Database\"></a>Seeding the Database</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">INSERT</span></span><br><span class=\"line\"><span class=\"keyword\">INTO</span></span><br><span class=\"line\">\t<span class=\"keyword\">test</span> (small, <span class=\"keyword\">large</span>, filter_index)</span><br><span class=\"line\"><span class=\"keyword\">SELECT</span></span><br><span class=\"line\">\tarray_to_string(</span><br><span class=\"line\">\t\t<span class=\"built_in\">ARRAY</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">chr</span>((<span class=\"number\">65</span> + <span class=\"keyword\">round</span>(random() * <span class=\"number\">25</span>))::<span class=\"built_in\">INT</span>) <span class=\"keyword\">FROM</span> <span class=\"keyword\">ROWS</span> <span class=\"keyword\">FROM</span> (generate_series(<span class=\"number\">1</span>, <span class=\"number\">1000</span>))),</span><br><span class=\"line\">\t\t<span class=\"string\">''</span></span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t\t<span class=\"keyword\">AS</span> small,</span><br><span class=\"line\">\tarray_to_string(</span><br><span class=\"line\">\t\t<span class=\"built_in\">ARRAY</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">chr</span>((<span class=\"number\">65</span> + <span class=\"keyword\">round</span>(random() * <span class=\"number\">25</span>))::<span class=\"built_in\">INT</span>) <span class=\"keyword\">FROM</span> <span class=\"keyword\">ROWS</span> <span class=\"keyword\">FROM</span> (generate_series(<span class=\"number\">1</span>, <span class=\"number\">1000000</span>))),</span><br><span class=\"line\">\t\t<span class=\"string\">''</span></span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t\t<span class=\"keyword\">AS</span> <span class=\"keyword\">large</span>,</span><br><span class=\"line\">\t<span class=\"keyword\">round</span>(random() * <span class=\"number\">100</span>) <span class=\"keyword\">AS</span> filter_index</span><br><span class=\"line\"><span class=\"keyword\">FROM</span></span><br><span class=\"line\">\tgenerate_series(<span class=\"number\">1</span>, <span class=\"number\">100000</span>);</span><br></pre></td></tr></table></figure>\n<p> that contains a JSONB <code>meta</code> column. We discovered that our queries drastically slowed down when this column was included in <code>SELECT</code> statements. Performance resumed to normal if it was omitted.</p>\n<h2 id=\"Specifics\"><a href=\"#Specifics\" class=\"headerlink\" title=\"Specifics\"></a>Specifics</h2><p>We were making simple queries against the <code>message</code> table that looked like this:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">id</span>, <span class=\"keyword\">content</span>, subject, meta</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> message</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> channel_id = <span class=\"number\">123</span></span><br></pre></td></tr></table></figure>\n<p>In this case, the <code>channel_id</code> relates back to the <code>channel</code> table with a one-to-many relationship. The channel_id is indexed. Note that we are not ordering or grouping or doing anything interesting with <code>meta</code> at all.</p>\n<h2 id=\"Query-Plan\"><a href=\"#Query-Plan\" class=\"headerlink\" title=\"Query Plan\"></a>Query Plan</h2><p>The query plan is painfully uninteresting. As expected, we are indexing on the channel_id.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Bitmap Heap Scan on message  (cost=69.84..6221.86 rows=3296 width=811) (actual time=0.600..2.230 rows=3166 loops=1)</span><br><span class=\"line\">  Recheck Cond: (channel_id = 44789)</span><br><span class=\"line\">  Heap Blocks: exact=1691</span><br><span class=\"line\">  -&gt;  Bitmap Index Scan on message_channel_id  (cost=0.00..69.01 rows=3296 width=0) (actual time=0.343..0.343 rows=3166 loops=1)</span><br><span class=\"line\">        Index Cond: (channel_id = 44789)</span><br><span class=\"line\">Planning time: 0.113 ms</span><br><span class=\"line\">Execution time: 2.517 ms</span><br></pre></td></tr></table></figure>\n<p>I had already had suspicions that the <code>meta</code> column was large and began to investigate further</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">octet_length</span>(m.<span class=\"string\">\"meta\"</span>::<span class=\"built_in\">text</span>)</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> message <span class=\"keyword\">as</span> m</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"keyword\">octet_length</span>(m.<span class=\"string\">\"meta\"</span>::<span class=\"built_in\">text</span>) <span class=\"keyword\">IS</span> <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> <span class=\"keyword\">octet_length</span>(m.<span class=\"string\">\"meta\"</span>::<span class=\"built_in\">text</span>) <span class=\"keyword\">DESC</span>;</span><br></pre></td></tr></table></figure>\n<p>This query revealed that some <code>meta</code> columns were consuming up to 17mb of space, in the most extreme cases.</p>\n<p>Keep in mind that this data is random and uncompressible. We can validate this assumption by comparing the compressed and uncompressed average row size:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">avg</span>(<span class=\"keyword\">octet_length</span>(m.*::<span class=\"built_in\">text</span>)) <span class=\"keyword\">as</span> uncompressed, <span class=\"keyword\">avg</span>(pg_column_size(m.*::<span class=\"built_in\">text</span>)) <span class=\"keyword\">as</span> compressed</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> <span class=\"keyword\">test</span> <span class=\"keyword\">as</span> m;</span><br></pre></td></tr></table></figure>\n<p>The results:</p>\n<table>\n<thead>\n<tr>\n<th>Compressed (bytes)</th>\n<th>Uncompressed (bytes)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>5511.9</td>\n<td>5515.9</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"TOAST\"><a href=\"#TOAST\" class=\"headerlink\" title=\"TOAST\"></a>TOAST</h2><p>When a column in a tuple (a single row) in Postgres becomes to large (by default exceeding 2kb), it is stored “out-of-line” in a TOAST table. This effectively means that in order to retrieve the entirety of the contents of a given tuple, it might be necessary to query not only the original table but also a secondary TOAST table. And if the column is large enough, the TOAST table might need to be queried many times.</p>\n<p>I suspected that the <code>meta</code> column was toasting and with a little help from the <a href=\"https://www.postgresql.org/docs/10/static/disk-usage.html\" target=\"_blank\" rel=\"noopener\">Postgres docs</a>, I was able to readily verify by theory.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> relname, relpages</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> pg_class,</span><br><span class=\"line\">     (<span class=\"keyword\">SELECT</span> reltoastrelid</span><br><span class=\"line\">      <span class=\"keyword\">FROM</span> pg_class</span><br><span class=\"line\">      <span class=\"keyword\">WHERE</span> relname = <span class=\"string\">'message'</span>) <span class=\"keyword\">AS</span> ss</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"keyword\">oid</span> = ss.reltoastrelid <span class=\"keyword\">OR</span></span><br><span class=\"line\">      <span class=\"keyword\">oid</span> = (<span class=\"keyword\">SELECT</span> indexrelid</span><br><span class=\"line\">             <span class=\"keyword\">FROM</span> pg_index</span><br><span class=\"line\">             <span class=\"keyword\">WHERE</span> indrelid = ss.reltoastrelid)</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> relname;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pg_toast_1432460\t17731</span><br><span class=\"line\">pg_toast_1432460_index\t209</span><br></pre></td></tr></table></figure>\n<p>We can see that the message table has 17731 disk pages of information storing the contents of the TOAST table and another 209 pages dedicated to storing the TOAST table’s index.</p>\n<p>Maybe estimate how long this read would take from disk?</p>\n<p>When the migrations are applied, we can see that the TOAST table pages goes to 0.</p>\n<p>Show how the execution time of the query plan is affected</p>\n<p>Look up how to benchmark postgres properly.</p>\n<p>Think about whether it makes sense for the cache to be warm or not. Probably warm.</p>\n<p>This a grand total of</p>\n","site":{"data":{}},"excerpt":"","more":"<p>I recently wrote an <a href=\"/https://nickdrane.com/hidden-costs-of-postgresql-jsonb/\">article</a> on some hiccups I ran into while using <a href=\"https://www.postgresql.org/docs/current/static/datatype-json.html\" target=\"_blank\" rel=\"noopener\">JSONB</a>. This article is written from the perspective of the application developer and discusses architectural decisions made to overcome issues with JSONB.</p>\n<p>Now I want to shift focus to the perspective of the database engineer. I want to explore how I identified why JSONB was a problem and how I proved my fix solved the problem. This article does not require you have read the previous blog post.</p>\n<h2 id=\"Schema\"><a href=\"#Schema\" class=\"headerlink\" title=\"Schema\"></a>Schema</h2><p>Suppose we have a <code>test</code> table with the following schema:</p>\n<table>\n<thead>\n<tr>\n<th>Column</th>\n<th>Type</th>\n<th>Storage</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>integer</td>\n<td>plain</td>\n</tr>\n<tr>\n<td>content</td>\n<td>text</td>\n<td>extended</td>\n</tr>\n<tr>\n<td>meta</td>\n<td>jsonb</td>\n<td>extended</td>\n</tr>\n<tr>\n<td>filter_index</td>\n<td>integer</td>\n<td>plain</td>\n</tr>\n</tbody>\n</table>\n<p>For now, you can ignore the <code>storage</code> column. It will become relevant later. Suppose that our <code>filter_index</code> column is indexed using a BTREE.</p>\n<p>We can create this <code>test</code> table with the following SQL:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> <span class=\"keyword\">test</span> (</span><br><span class=\"line\">    <span class=\"keyword\">id</span> <span class=\"built_in\">integer</span>,</span><br><span class=\"line\">    <span class=\"keyword\">content</span> <span class=\"built_in\">text</span>,</span><br><span class=\"line\">    meta jsonb,</span><br><span class=\"line\">    filter_index <span class=\"built_in\">integer</span></span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">INDEX</span> filter_index <span class=\"keyword\">ON</span> <span class=\"keyword\">test</span> (filter_index);</span><br></pre></td></tr></table></figure>\n<h2 id=\"Seeding-the-Database\"><a href=\"#Seeding-the-Database\" class=\"headerlink\" title=\"Seeding the Database\"></a>Seeding the Database</h2><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">INSERT</span></span><br><span class=\"line\"><span class=\"keyword\">INTO</span></span><br><span class=\"line\">\t<span class=\"keyword\">test</span> (small, <span class=\"keyword\">large</span>, filter_index)</span><br><span class=\"line\"><span class=\"keyword\">SELECT</span></span><br><span class=\"line\">\tarray_to_string(</span><br><span class=\"line\">\t\t<span class=\"built_in\">ARRAY</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">chr</span>((<span class=\"number\">65</span> + <span class=\"keyword\">round</span>(random() * <span class=\"number\">25</span>))::<span class=\"built_in\">INT</span>) <span class=\"keyword\">FROM</span> <span class=\"keyword\">ROWS</span> <span class=\"keyword\">FROM</span> (generate_series(<span class=\"number\">1</span>, <span class=\"number\">1000</span>))),</span><br><span class=\"line\">\t\t<span class=\"string\">''</span></span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t\t<span class=\"keyword\">AS</span> small,</span><br><span class=\"line\">\tarray_to_string(</span><br><span class=\"line\">\t\t<span class=\"built_in\">ARRAY</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">chr</span>((<span class=\"number\">65</span> + <span class=\"keyword\">round</span>(random() * <span class=\"number\">25</span>))::<span class=\"built_in\">INT</span>) <span class=\"keyword\">FROM</span> <span class=\"keyword\">ROWS</span> <span class=\"keyword\">FROM</span> (generate_series(<span class=\"number\">1</span>, <span class=\"number\">1000000</span>))),</span><br><span class=\"line\">\t\t<span class=\"string\">''</span></span><br><span class=\"line\">\t)</span><br><span class=\"line\">\t\t<span class=\"keyword\">AS</span> <span class=\"keyword\">large</span>,</span><br><span class=\"line\">\t<span class=\"keyword\">round</span>(random() * <span class=\"number\">100</span>) <span class=\"keyword\">AS</span> filter_index</span><br><span class=\"line\"><span class=\"keyword\">FROM</span></span><br><span class=\"line\">\tgenerate_series(<span class=\"number\">1</span>, <span class=\"number\">100000</span>);</span><br></pre></td></tr></table></figure>\n<p> that contains a JSONB <code>meta</code> column. We discovered that our queries drastically slowed down when this column was included in <code>SELECT</code> statements. Performance resumed to normal if it was omitted.</p>\n<h2 id=\"Specifics\"><a href=\"#Specifics\" class=\"headerlink\" title=\"Specifics\"></a>Specifics</h2><p>We were making simple queries against the <code>message</code> table that looked like this:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">id</span>, <span class=\"keyword\">content</span>, subject, meta</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> message</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> channel_id = <span class=\"number\">123</span></span><br></pre></td></tr></table></figure>\n<p>In this case, the <code>channel_id</code> relates back to the <code>channel</code> table with a one-to-many relationship. The channel_id is indexed. Note that we are not ordering or grouping or doing anything interesting with <code>meta</code> at all.</p>\n<h2 id=\"Query-Plan\"><a href=\"#Query-Plan\" class=\"headerlink\" title=\"Query Plan\"></a>Query Plan</h2><p>The query plan is painfully uninteresting. As expected, we are indexing on the channel_id.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Bitmap Heap Scan on message  (cost=69.84..6221.86 rows=3296 width=811) (actual time=0.600..2.230 rows=3166 loops=1)</span><br><span class=\"line\">  Recheck Cond: (channel_id = 44789)</span><br><span class=\"line\">  Heap Blocks: exact=1691</span><br><span class=\"line\">  -&gt;  Bitmap Index Scan on message_channel_id  (cost=0.00..69.01 rows=3296 width=0) (actual time=0.343..0.343 rows=3166 loops=1)</span><br><span class=\"line\">        Index Cond: (channel_id = 44789)</span><br><span class=\"line\">Planning time: 0.113 ms</span><br><span class=\"line\">Execution time: 2.517 ms</span><br></pre></td></tr></table></figure>\n<p>I had already had suspicions that the <code>meta</code> column was large and began to investigate further</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">octet_length</span>(m.<span class=\"string\">\"meta\"</span>::<span class=\"built_in\">text</span>)</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> message <span class=\"keyword\">as</span> m</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"keyword\">octet_length</span>(m.<span class=\"string\">\"meta\"</span>::<span class=\"built_in\">text</span>) <span class=\"keyword\">IS</span> <span class=\"keyword\">NOT</span> <span class=\"literal\">NULL</span></span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> <span class=\"keyword\">octet_length</span>(m.<span class=\"string\">\"meta\"</span>::<span class=\"built_in\">text</span>) <span class=\"keyword\">DESC</span>;</span><br></pre></td></tr></table></figure>\n<p>This query revealed that some <code>meta</code> columns were consuming up to 17mb of space, in the most extreme cases.</p>\n<p>Keep in mind that this data is random and uncompressible. We can validate this assumption by comparing the compressed and uncompressed average row size:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">avg</span>(<span class=\"keyword\">octet_length</span>(m.*::<span class=\"built_in\">text</span>)) <span class=\"keyword\">as</span> uncompressed, <span class=\"keyword\">avg</span>(pg_column_size(m.*::<span class=\"built_in\">text</span>)) <span class=\"keyword\">as</span> compressed</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> <span class=\"keyword\">test</span> <span class=\"keyword\">as</span> m;</span><br></pre></td></tr></table></figure>\n<p>The results:</p>\n<table>\n<thead>\n<tr>\n<th>Compressed (bytes)</th>\n<th>Uncompressed (bytes)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>5511.9</td>\n<td>5515.9</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"TOAST\"><a href=\"#TOAST\" class=\"headerlink\" title=\"TOAST\"></a>TOAST</h2><p>When a column in a tuple (a single row) in Postgres becomes to large (by default exceeding 2kb), it is stored “out-of-line” in a TOAST table. This effectively means that in order to retrieve the entirety of the contents of a given tuple, it might be necessary to query not only the original table but also a secondary TOAST table. And if the column is large enough, the TOAST table might need to be queried many times.</p>\n<p>I suspected that the <code>meta</code> column was toasting and with a little help from the <a href=\"https://www.postgresql.org/docs/10/static/disk-usage.html\" target=\"_blank\" rel=\"noopener\">Postgres docs</a>, I was able to readily verify by theory.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> relname, relpages</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> pg_class,</span><br><span class=\"line\">     (<span class=\"keyword\">SELECT</span> reltoastrelid</span><br><span class=\"line\">      <span class=\"keyword\">FROM</span> pg_class</span><br><span class=\"line\">      <span class=\"keyword\">WHERE</span> relname = <span class=\"string\">'message'</span>) <span class=\"keyword\">AS</span> ss</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"keyword\">oid</span> = ss.reltoastrelid <span class=\"keyword\">OR</span></span><br><span class=\"line\">      <span class=\"keyword\">oid</span> = (<span class=\"keyword\">SELECT</span> indexrelid</span><br><span class=\"line\">             <span class=\"keyword\">FROM</span> pg_index</span><br><span class=\"line\">             <span class=\"keyword\">WHERE</span> indrelid = ss.reltoastrelid)</span><br><span class=\"line\"><span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> relname;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pg_toast_1432460\t17731</span><br><span class=\"line\">pg_toast_1432460_index\t209</span><br></pre></td></tr></table></figure>\n<p>We can see that the message table has 17731 disk pages of information storing the contents of the TOAST table and another 209 pages dedicated to storing the TOAST table’s index.</p>\n<p>Maybe estimate how long this read would take from disk?</p>\n<p>When the migrations are applied, we can see that the TOAST table pages goes to 0.</p>\n<p>Show how the execution time of the query plan is affected</p>\n<p>Look up how to benchmark postgres properly.</p>\n<p>Think about whether it makes sense for the cache to be warm or not. Probably warm.</p>\n<p>This a grand total of</p>\n"},{"title":"Leveraging Immutability in React","date":"2017-09-27T14:30:27.000Z","_content":"\nReact has taken the web development community by a storm, and with it functional programming concepts have embedded themselves in the mainstream. One common statement you will often read is that all state in React should be immutable, and this practice is justified as necessary for performance reasons. This statement is entirely true, but it only tells half the truth. Immutability alone will not yield any performance gains in React (it'll actually make things slower).\n\n<!-- more -->\n\n## The Quick Answer\nYou can reap the gains from immutable state in React if you inherit from [React.PureComponent](https://reactjs.org/docs/react-api.html#reactpurecomponent) instead of `React.Component`\n\n```js\nclass MyComponent extends PureComponent {...}\n```\n\n## A Broader Perspective\nSo why does the above code work? That requires a little bit of knowledge about the rendering process.\n\n## Virtual DOM\nA component's `render` function returns a tree of React elements, also known as the virtual DOM. This data structure is a representation of the browser's DOM that React can manipulate in a performant way. In essence, it's a 1-1 mapping to the browser DOM.\n\nWhenever state or props change, instead of updating the browser DOM directly, React will call the `render` function of the updated component, getting its new virtual DOM, and it will compare that virtual DOM to the previous render tree (aka the old virtual DOM). This comparison process (known as reconciliation) allows it to identify the minimum set of changes that need to be made to the browser DOM, allowing for for massive performance gains. If the two trees are identical, then no changes need to be made to the UI.\n\n## Should a Component Re-render\nWhen `setState` is called on a component, that component (and all of the components it renders) go through a two step process for React determine if the UI should update.\n\nBefore the virtual DOM is rendered, React first runs a component's [shouldComponentUpdate](https://reactjs.org/docs/react-component.html#shouldcomponentupdate) lifecycle method\n\n## shouldComponentUpdate\n\nIt is your choice to implement this method. It takes as parameters the new state and props and should return a boolean indicating whether the component should re-render. React will only proceed with re-rendering if you return `true` from this function. By default, `shouldComponentUpdate` always returns `true`.\n\nLet's look at a simple example\n\n```js\nclass Counter extends React.Component() {\n  constructor() {\n    this.state = {\n      counter: 0\n    }\n  }\n\n  shouldComponentUpdate(nextProps, nextState) {\n    // We are comparing the state before setState\n    // is called to the state after it is called.\n    // This component will only re-render if\n    // state.counter changes\n    return this.state.counter !== nextState.counter\n  }\n\n  render() {\n    return <span>{this.state.counter}</span>\n  }\n}\n```\n\nCurrently `Counter` will only re-render if `state.counter` changes. Suppose we remove the `shouldComponentUpdate` above, is there another circumstance where `Counter`' re-renders? It would re-render if a component that renders `Counter` re-renders! It does not matter that `Counter`'s render function does not depend on props!\n\nSo, when `shouldComponentUpdate` returns `true`, React begins the second part of the re-render process, the part where it invokes the render function, generating its virtual DOM. It will then compare that render tree to the old virtual DOM. In the scenario above, these two trees will always be identical (after all, the component doesn't even have a way to change state), and the entire operation will a be waste CPU cycles.\n\nIf `shouldComponentUpdate` returns `false`, we inform React that a re-render will not be necessary, sparing it an unnecessary to call a component's render function and the comparison of the render trees.\n\n## React.pureComponent\nWriting `shouldComponentUpdate` is sometimes a tedious task, and React supplies a helper to handle a very common `shouldComponentUpdate` scenario. I mentioned `React.pureComponent` above.\n\n```js\nclass MyComponent extends PureComponent {...}\n```\n\n`React.pureComponent` is a handy class that we can inherit from that implements `shouldComponentUpdate` as a shallow comparison across the old props and new props (or the old state and new state). If there are no *shallow* differences between these objects, then `shouldComponentUpdate` will return false, and the virtual DOM's re-rendering process can be skipped entirely, resulting in potentially enormous performance savings.\n\n## Why Does Immutability Matter?\nImmutability matters because `React.pureComponent` is going to do shallow comparisons against the prop and state objects. And, as you hopefully know, a shallow comparison's referential equality checks will only yield the expected results if immutability is respected.\n\nIf you are not properly respecting immutability, then you are going to run into scenarios where your components fail to re-render when they actually should. A failure to respect immutability will cause a shallow comparison to return false (meaning `shouldComponentUpdate` returns false) because the old props and new props (or the old state and new state) reference the same object in memory, despite the fact that props/state changed.\n\nWhen used carefully however, `React.pureComponent` can yield enormous performance improvements at almost no cost. All you need to do is inherit your components from `React.pureComponent` instead of `React.Component` and respect immutability when changing state.\n\nI hope you found this article helpful. Please feel free to email me to reach out if you have questions.","source":"_posts/leveraging-immutability-in-react.md","raw":"---\ntitle: Leveraging Immutability in React\ndate: 2017-09-27 09:30:27\ncategories:\n  - [React]\n  - [Immutability]\n---\n\nReact has taken the web development community by a storm, and with it functional programming concepts have embedded themselves in the mainstream. One common statement you will often read is that all state in React should be immutable, and this practice is justified as necessary for performance reasons. This statement is entirely true, but it only tells half the truth. Immutability alone will not yield any performance gains in React (it'll actually make things slower).\n\n<!-- more -->\n\n## The Quick Answer\nYou can reap the gains from immutable state in React if you inherit from [React.PureComponent](https://reactjs.org/docs/react-api.html#reactpurecomponent) instead of `React.Component`\n\n```js\nclass MyComponent extends PureComponent {...}\n```\n\n## A Broader Perspective\nSo why does the above code work? That requires a little bit of knowledge about the rendering process.\n\n## Virtual DOM\nA component's `render` function returns a tree of React elements, also known as the virtual DOM. This data structure is a representation of the browser's DOM that React can manipulate in a performant way. In essence, it's a 1-1 mapping to the browser DOM.\n\nWhenever state or props change, instead of updating the browser DOM directly, React will call the `render` function of the updated component, getting its new virtual DOM, and it will compare that virtual DOM to the previous render tree (aka the old virtual DOM). This comparison process (known as reconciliation) allows it to identify the minimum set of changes that need to be made to the browser DOM, allowing for for massive performance gains. If the two trees are identical, then no changes need to be made to the UI.\n\n## Should a Component Re-render\nWhen `setState` is called on a component, that component (and all of the components it renders) go through a two step process for React determine if the UI should update.\n\nBefore the virtual DOM is rendered, React first runs a component's [shouldComponentUpdate](https://reactjs.org/docs/react-component.html#shouldcomponentupdate) lifecycle method\n\n## shouldComponentUpdate\n\nIt is your choice to implement this method. It takes as parameters the new state and props and should return a boolean indicating whether the component should re-render. React will only proceed with re-rendering if you return `true` from this function. By default, `shouldComponentUpdate` always returns `true`.\n\nLet's look at a simple example\n\n```js\nclass Counter extends React.Component() {\n  constructor() {\n    this.state = {\n      counter: 0\n    }\n  }\n\n  shouldComponentUpdate(nextProps, nextState) {\n    // We are comparing the state before setState\n    // is called to the state after it is called.\n    // This component will only re-render if\n    // state.counter changes\n    return this.state.counter !== nextState.counter\n  }\n\n  render() {\n    return <span>{this.state.counter}</span>\n  }\n}\n```\n\nCurrently `Counter` will only re-render if `state.counter` changes. Suppose we remove the `shouldComponentUpdate` above, is there another circumstance where `Counter`' re-renders? It would re-render if a component that renders `Counter` re-renders! It does not matter that `Counter`'s render function does not depend on props!\n\nSo, when `shouldComponentUpdate` returns `true`, React begins the second part of the re-render process, the part where it invokes the render function, generating its virtual DOM. It will then compare that render tree to the old virtual DOM. In the scenario above, these two trees will always be identical (after all, the component doesn't even have a way to change state), and the entire operation will a be waste CPU cycles.\n\nIf `shouldComponentUpdate` returns `false`, we inform React that a re-render will not be necessary, sparing it an unnecessary to call a component's render function and the comparison of the render trees.\n\n## React.pureComponent\nWriting `shouldComponentUpdate` is sometimes a tedious task, and React supplies a helper to handle a very common `shouldComponentUpdate` scenario. I mentioned `React.pureComponent` above.\n\n```js\nclass MyComponent extends PureComponent {...}\n```\n\n`React.pureComponent` is a handy class that we can inherit from that implements `shouldComponentUpdate` as a shallow comparison across the old props and new props (or the old state and new state). If there are no *shallow* differences between these objects, then `shouldComponentUpdate` will return false, and the virtual DOM's re-rendering process can be skipped entirely, resulting in potentially enormous performance savings.\n\n## Why Does Immutability Matter?\nImmutability matters because `React.pureComponent` is going to do shallow comparisons against the prop and state objects. And, as you hopefully know, a shallow comparison's referential equality checks will only yield the expected results if immutability is respected.\n\nIf you are not properly respecting immutability, then you are going to run into scenarios where your components fail to re-render when they actually should. A failure to respect immutability will cause a shallow comparison to return false (meaning `shouldComponentUpdate` returns false) because the old props and new props (or the old state and new state) reference the same object in memory, despite the fact that props/state changed.\n\nWhen used carefully however, `React.pureComponent` can yield enormous performance improvements at almost no cost. All you need to do is inherit your components from `React.pureComponent` instead of `React.Component` and respect immutability when changing state.\n\nI hope you found this article helpful. Please feel free to email me to reach out if you have questions.","slug":"leveraging-immutability-in-react","published":1,"updated":"2018-09-30T20:52:36.447Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vn9000a67ozerhp5pa6","content":"<p>React has taken the web development community by a storm, and with it functional programming concepts have embedded themselves in the mainstream. One common statement you will often read is that all state in React should be immutable, and this practice is justified as necessary for performance reasons. This statement is entirely true, but it only tells half the truth. Immutability alone will not yield any performance gains in React (it’ll actually make things slower).</p>\n<a id=\"more\"></a>\n<h2 id=\"The-Quick-Answer\"><a href=\"#The-Quick-Answer\" class=\"headerlink\" title=\"The Quick Answer\"></a>The Quick Answer</h2><p>You can reap the gains from immutable state in React if you inherit from <a href=\"https://reactjs.org/docs/react-api.html#reactpurecomponent\" target=\"_blank\" rel=\"noopener\">React.PureComponent</a> instead of <code>React.Component</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">PureComponent</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"A-Broader-Perspective\"><a href=\"#A-Broader-Perspective\" class=\"headerlink\" title=\"A Broader Perspective\"></a>A Broader Perspective</h2><p>So why does the above code work? That requires a little bit of knowledge about the rendering process.</p>\n<h2 id=\"Virtual-DOM\"><a href=\"#Virtual-DOM\" class=\"headerlink\" title=\"Virtual DOM\"></a>Virtual DOM</h2><p>A component’s <code>render</code> function returns a tree of React elements, also known as the virtual DOM. This data structure is a representation of the browser’s DOM that React can manipulate in a performant way. In essence, it’s a 1-1 mapping to the browser DOM.</p>\n<p>Whenever state or props change, instead of updating the browser DOM directly, React will call the <code>render</code> function of the updated component, getting its new virtual DOM, and it will compare that virtual DOM to the previous render tree (aka the old virtual DOM). This comparison process (known as reconciliation) allows it to identify the minimum set of changes that need to be made to the browser DOM, allowing for for massive performance gains. If the two trees are identical, then no changes need to be made to the UI.</p>\n<h2 id=\"Should-a-Component-Re-render\"><a href=\"#Should-a-Component-Re-render\" class=\"headerlink\" title=\"Should a Component Re-render\"></a>Should a Component Re-render</h2><p>When <code>setState</code> is called on a component, that component (and all of the components it renders) go through a two step process for React determine if the UI should update.</p>\n<p>Before the virtual DOM is rendered, React first runs a component’s <a href=\"https://reactjs.org/docs/react-component.html#shouldcomponentupdate\" target=\"_blank\" rel=\"noopener\">shouldComponentUpdate</a> lifecycle method</p>\n<h2 id=\"shouldComponentUpdate\"><a href=\"#shouldComponentUpdate\" class=\"headerlink\" title=\"shouldComponentUpdate\"></a>shouldComponentUpdate</h2><p>It is your choice to implement this method. It takes as parameters the new state and props and should return a boolean indicating whether the component should re-render. React will only proceed with re-rendering if you return <code>true</code> from this function. By default, <code>shouldComponentUpdate</code> always returns <code>true</code>.</p>\n<p>Let’s look at a simple example</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Counter</span> <span class=\"keyword\">extends</span> <span class=\"title\">React</span>.<span class=\"title\">Component</span>() </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.state = &#123;</span><br><span class=\"line\">      counter: <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  shouldComponentUpdate(nextProps, nextState) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// We are comparing the state before setState</span></span><br><span class=\"line\">    <span class=\"comment\">// is called to the state after it is called.</span></span><br><span class=\"line\">    <span class=\"comment\">// This component will only re-render if</span></span><br><span class=\"line\">    <span class=\"comment\">// state.counter changes</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.state.counter !== nextState.counter</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &lt;span&gt;&#123;this.state.counter&#125;&lt;/span&gt;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Currently <code>Counter</code> will only re-render if <code>state.counter</code> changes. Suppose we remove the <code>shouldComponentUpdate</code> above, is there another circumstance where <code>Counter</code>‘ re-renders? It would re-render if a component that renders <code>Counter</code> re-renders! It does not matter that <code>Counter</code>‘s render function does not depend on props!</p>\n<p>So, when <code>shouldComponentUpdate</code> returns <code>true</code>, React begins the second part of the re-render process, the part where it invokes the render function, generating its virtual DOM. It will then compare that render tree to the old virtual DOM. In the scenario above, these two trees will always be identical (after all, the component doesn’t even have a way to change state), and the entire operation will a be waste CPU cycles.</p>\n<p>If <code>shouldComponentUpdate</code> returns <code>false</code>, we inform React that a re-render will not be necessary, sparing it an unnecessary to call a component’s render function and the comparison of the render trees.</p>\n<h2 id=\"React-pureComponent\"><a href=\"#React-pureComponent\" class=\"headerlink\" title=\"React.pureComponent\"></a>React.pureComponent</h2><p>Writing <code>shouldComponentUpdate</code> is sometimes a tedious task, and React supplies a helper to handle a very common <code>shouldComponentUpdate</code> scenario. I mentioned <code>React.pureComponent</code> above.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">PureComponent</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>\n<p><code>React.pureComponent</code> is a handy class that we can inherit from that implements <code>shouldComponentUpdate</code> as a shallow comparison across the old props and new props (or the old state and new state). If there are no <em>shallow</em> differences between these objects, then <code>shouldComponentUpdate</code> will return false, and the virtual DOM’s re-rendering process can be skipped entirely, resulting in potentially enormous performance savings.</p>\n<h2 id=\"Why-Does-Immutability-Matter\"><a href=\"#Why-Does-Immutability-Matter\" class=\"headerlink\" title=\"Why Does Immutability Matter?\"></a>Why Does Immutability Matter?</h2><p>Immutability matters because <code>React.pureComponent</code> is going to do shallow comparisons against the prop and state objects. And, as you hopefully know, a shallow comparison’s referential equality checks will only yield the expected results if immutability is respected.</p>\n<p>If you are not properly respecting immutability, then you are going to run into scenarios where your components fail to re-render when they actually should. A failure to respect immutability will cause a shallow comparison to return false (meaning <code>shouldComponentUpdate</code> returns false) because the old props and new props (or the old state and new state) reference the same object in memory, despite the fact that props/state changed.</p>\n<p>When used carefully however, <code>React.pureComponent</code> can yield enormous performance improvements at almost no cost. All you need to do is inherit your components from <code>React.pureComponent</code> instead of <code>React.Component</code> and respect immutability when changing state.</p>\n<p>I hope you found this article helpful. Please feel free to email me to reach out if you have questions.</p>\n","site":{"data":{}},"excerpt":"<p>React has taken the web development community by a storm, and with it functional programming concepts have embedded themselves in the mainstream. One common statement you will often read is that all state in React should be immutable, and this practice is justified as necessary for performance reasons. This statement is entirely true, but it only tells half the truth. Immutability alone will not yield any performance gains in React (it’ll actually make things slower).</p>","more":"<h2 id=\"The-Quick-Answer\"><a href=\"#The-Quick-Answer\" class=\"headerlink\" title=\"The Quick Answer\"></a>The Quick Answer</h2><p>You can reap the gains from immutable state in React if you inherit from <a href=\"https://reactjs.org/docs/react-api.html#reactpurecomponent\" target=\"_blank\" rel=\"noopener\">React.PureComponent</a> instead of <code>React.Component</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">PureComponent</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"A-Broader-Perspective\"><a href=\"#A-Broader-Perspective\" class=\"headerlink\" title=\"A Broader Perspective\"></a>A Broader Perspective</h2><p>So why does the above code work? That requires a little bit of knowledge about the rendering process.</p>\n<h2 id=\"Virtual-DOM\"><a href=\"#Virtual-DOM\" class=\"headerlink\" title=\"Virtual DOM\"></a>Virtual DOM</h2><p>A component’s <code>render</code> function returns a tree of React elements, also known as the virtual DOM. This data structure is a representation of the browser’s DOM that React can manipulate in a performant way. In essence, it’s a 1-1 mapping to the browser DOM.</p>\n<p>Whenever state or props change, instead of updating the browser DOM directly, React will call the <code>render</code> function of the updated component, getting its new virtual DOM, and it will compare that virtual DOM to the previous render tree (aka the old virtual DOM). This comparison process (known as reconciliation) allows it to identify the minimum set of changes that need to be made to the browser DOM, allowing for for massive performance gains. If the two trees are identical, then no changes need to be made to the UI.</p>\n<h2 id=\"Should-a-Component-Re-render\"><a href=\"#Should-a-Component-Re-render\" class=\"headerlink\" title=\"Should a Component Re-render\"></a>Should a Component Re-render</h2><p>When <code>setState</code> is called on a component, that component (and all of the components it renders) go through a two step process for React determine if the UI should update.</p>\n<p>Before the virtual DOM is rendered, React first runs a component’s <a href=\"https://reactjs.org/docs/react-component.html#shouldcomponentupdate\" target=\"_blank\" rel=\"noopener\">shouldComponentUpdate</a> lifecycle method</p>\n<h2 id=\"shouldComponentUpdate\"><a href=\"#shouldComponentUpdate\" class=\"headerlink\" title=\"shouldComponentUpdate\"></a>shouldComponentUpdate</h2><p>It is your choice to implement this method. It takes as parameters the new state and props and should return a boolean indicating whether the component should re-render. React will only proceed with re-rendering if you return <code>true</code> from this function. By default, <code>shouldComponentUpdate</code> always returns <code>true</code>.</p>\n<p>Let’s look at a simple example</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Counter</span> <span class=\"keyword\">extends</span> <span class=\"title\">React</span>.<span class=\"title\">Component</span>() </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.state = &#123;</span><br><span class=\"line\">      counter: <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  shouldComponentUpdate(nextProps, nextState) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// We are comparing the state before setState</span></span><br><span class=\"line\">    <span class=\"comment\">// is called to the state after it is called.</span></span><br><span class=\"line\">    <span class=\"comment\">// This component will only re-render if</span></span><br><span class=\"line\">    <span class=\"comment\">// state.counter changes</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.state.counter !== nextState.counter</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  render() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &lt;span&gt;&#123;this.state.counter&#125;&lt;/span&gt;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Currently <code>Counter</code> will only re-render if <code>state.counter</code> changes. Suppose we remove the <code>shouldComponentUpdate</code> above, is there another circumstance where <code>Counter</code>‘ re-renders? It would re-render if a component that renders <code>Counter</code> re-renders! It does not matter that <code>Counter</code>‘s render function does not depend on props!</p>\n<p>So, when <code>shouldComponentUpdate</code> returns <code>true</code>, React begins the second part of the re-render process, the part where it invokes the render function, generating its virtual DOM. It will then compare that render tree to the old virtual DOM. In the scenario above, these two trees will always be identical (after all, the component doesn’t even have a way to change state), and the entire operation will a be waste CPU cycles.</p>\n<p>If <code>shouldComponentUpdate</code> returns <code>false</code>, we inform React that a re-render will not be necessary, sparing it an unnecessary to call a component’s render function and the comparison of the render trees.</p>\n<h2 id=\"React-pureComponent\"><a href=\"#React-pureComponent\" class=\"headerlink\" title=\"React.pureComponent\"></a>React.pureComponent</h2><p>Writing <code>shouldComponentUpdate</code> is sometimes a tedious task, and React supplies a helper to handle a very common <code>shouldComponentUpdate</code> scenario. I mentioned <code>React.pureComponent</code> above.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">PureComponent</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>\n<p><code>React.pureComponent</code> is a handy class that we can inherit from that implements <code>shouldComponentUpdate</code> as a shallow comparison across the old props and new props (or the old state and new state). If there are no <em>shallow</em> differences between these objects, then <code>shouldComponentUpdate</code> will return false, and the virtual DOM’s re-rendering process can be skipped entirely, resulting in potentially enormous performance savings.</p>\n<h2 id=\"Why-Does-Immutability-Matter\"><a href=\"#Why-Does-Immutability-Matter\" class=\"headerlink\" title=\"Why Does Immutability Matter?\"></a>Why Does Immutability Matter?</h2><p>Immutability matters because <code>React.pureComponent</code> is going to do shallow comparisons against the prop and state objects. And, as you hopefully know, a shallow comparison’s referential equality checks will only yield the expected results if immutability is respected.</p>\n<p>If you are not properly respecting immutability, then you are going to run into scenarios where your components fail to re-render when they actually should. A failure to respect immutability will cause a shallow comparison to return false (meaning <code>shouldComponentUpdate</code> returns false) because the old props and new props (or the old state and new state) reference the same object in memory, despite the fact that props/state changed.</p>\n<p>When used carefully however, <code>React.pureComponent</code> can yield enormous performance improvements at almost no cost. All you need to do is inherit your components from <code>React.pureComponent</code> instead of <code>React.Component</code> and respect immutability when changing state.</p>\n<p>I hope you found this article helpful. Please feel free to email me to reach out if you have questions.</p>"},{"title":"Ethical Engineering for the Average Engineer","date":"2018-09-16T20:41:16.000Z","_content":"\nTwo months ago I purchased a GPS device and associated service plan from [SPOT](https://www.findmespot.com/en/). Today, upon trying to cancel the service, the customer service representative informed me that I had accidentally enrolled myself into a 1 year, $250 contract and that I was unable to cancel. He told me that if I blocked the monthly charges against my credit card that they would report the debt to a collections agency. I was initially upset but soon realized it was a great opportunity to talk about ethics in software engineering.\n\n<!-- more -->\n\n## SPOT's Marketing Materials\n\nThe representative told me to look at their website where he claimed it would be very clear that I was signing up for a contract service. When I Googled \"spot service plan\", the first link I clicked on directed me to these marketing materials:\n\n![Spot Marketing Website](/images/spot-marketing-material.png)\n\nIf you look at the image above, it appears as if several deliberate decisions have been made to disguise the total cost of the month-to-month arrangement.\n\n1. The font of the month-to-month price is large, bold, and colorful. It's designed to stand out\n2. The 12 month contractual stipulation, on the other hand, is written in unnecessarily small font\n3. The contractual stipulation is low contrast and visually underwhelming, particularly when juxtaposed against the big, bright, and bold \"monthly cost\" header\n4. The terms of the contract are visually separated from the price\n\nNone of this could be chalked up to accident, except perhaps point 3. Ultimately, this page's content is designed to mislead the consumer, hurting them for the business's gain.<sup>[1](#footnote1)</sup>\n\n## Software Ethics and Mainstream Media\n\nThe software industry is rife with ethics scandals, and they are rarely cut and dry. Some examples\n\n1. [Dozens of iPhone applications selling user location data](https://techcrunch.com/2018/09/07/a-dozen-popular-iphone-apps-caught-quietly-sending-user-locations-to-monetization-firms/)\n2. [United States surveillance software (PRISMA)](https://en.wikipedia.org/wiki/PRISM_(surveillance_program)\n3. [DOD's Project Maven (drone imaging AI)](https://money.cnn.com/2018/06/01/technology/google-maven-contract/index.html)\n\nTwo arguments exist in each of these scenarios. iPhone application engineers might argue that they aren't hurting consumers by selling their location information. Governments argue that they protect their citizens through surveillance software, even if that's at the cost of citizen privacy. An engineer of that very software might believe that the code itself is not unethical, only improper use of it. A utilitarian might argue that software that facilitates accurate drone strikes is ethical if the cost of the deaths of its targets is outweighed by its net good. Ultimately, it's often unclear what constitutes unethical. But it raises a good question: as software engineers, what ethical code should we live by?\n\n## Ethics for the Average Engineer\n\nIt's easy to get consumed in the minutia. The media tends to focus on ethics scandals that have immense gravity, either in the scope of the number of people they affect or in the magnitude with which they affect their targets. But the majority of software engineers aren't writing software that necessitates answering the above questions. Most of us are writing simple e-commerce applications or iPhone apps -- boring software.\n\nThe case study with SPOT is interesting precisely because of how boring it is. It's true to life, and it serves as a reminder that the average engineer also faces ethical dilemmas. And fortunately for us, these \"ethical dilemmas\" are sometimes pretty cut and dry, provided we have the awareness to recognize them and the courage to speak up. In the case with SPOT, I think most people would agree that making an effort to mislead the consumer is dishonest and thus unethical.\n\n## The Takeaway\n\nJust because you work on boring software does not mean that it can't negatively impact your users in an unethical way. The first step towards protecting users is increased developer awareness. As a developer, it's essential to ask how your software affects your users. If it might hurt them, step back and consider the the greater picture. If you think your code might manipulate or mislead your users, it's time to speak up.\n\n#### Footnotes\n\n<a name=\"footnote1\">1</a>: I think it's important to be fair here. The marketing material across the site is inconsistent and ranges in the clarity of its term of service. [This page](https://www.findmespot.com/en/index.php?cid=131) makes the 12 month contract abundantly clear. [This one](https://www.findmespot.com/en/index.php?cid=130) falls somewhere in the middle.\n","source":"_posts/ethical-engineering-for-the-average-engineer.md","raw":"---\ntitle: Ethical Engineering for the Average Engineer\ndate: 2018-09-16 15:41:16\ncategories:\n  - [Software Ethics]\n---\n\nTwo months ago I purchased a GPS device and associated service plan from [SPOT](https://www.findmespot.com/en/). Today, upon trying to cancel the service, the customer service representative informed me that I had accidentally enrolled myself into a 1 year, $250 contract and that I was unable to cancel. He told me that if I blocked the monthly charges against my credit card that they would report the debt to a collections agency. I was initially upset but soon realized it was a great opportunity to talk about ethics in software engineering.\n\n<!-- more -->\n\n## SPOT's Marketing Materials\n\nThe representative told me to look at their website where he claimed it would be very clear that I was signing up for a contract service. When I Googled \"spot service plan\", the first link I clicked on directed me to these marketing materials:\n\n![Spot Marketing Website](/images/spot-marketing-material.png)\n\nIf you look at the image above, it appears as if several deliberate decisions have been made to disguise the total cost of the month-to-month arrangement.\n\n1. The font of the month-to-month price is large, bold, and colorful. It's designed to stand out\n2. The 12 month contractual stipulation, on the other hand, is written in unnecessarily small font\n3. The contractual stipulation is low contrast and visually underwhelming, particularly when juxtaposed against the big, bright, and bold \"monthly cost\" header\n4. The terms of the contract are visually separated from the price\n\nNone of this could be chalked up to accident, except perhaps point 3. Ultimately, this page's content is designed to mislead the consumer, hurting them for the business's gain.<sup>[1](#footnote1)</sup>\n\n## Software Ethics and Mainstream Media\n\nThe software industry is rife with ethics scandals, and they are rarely cut and dry. Some examples\n\n1. [Dozens of iPhone applications selling user location data](https://techcrunch.com/2018/09/07/a-dozen-popular-iphone-apps-caught-quietly-sending-user-locations-to-monetization-firms/)\n2. [United States surveillance software (PRISMA)](https://en.wikipedia.org/wiki/PRISM_(surveillance_program)\n3. [DOD's Project Maven (drone imaging AI)](https://money.cnn.com/2018/06/01/technology/google-maven-contract/index.html)\n\nTwo arguments exist in each of these scenarios. iPhone application engineers might argue that they aren't hurting consumers by selling their location information. Governments argue that they protect their citizens through surveillance software, even if that's at the cost of citizen privacy. An engineer of that very software might believe that the code itself is not unethical, only improper use of it. A utilitarian might argue that software that facilitates accurate drone strikes is ethical if the cost of the deaths of its targets is outweighed by its net good. Ultimately, it's often unclear what constitutes unethical. But it raises a good question: as software engineers, what ethical code should we live by?\n\n## Ethics for the Average Engineer\n\nIt's easy to get consumed in the minutia. The media tends to focus on ethics scandals that have immense gravity, either in the scope of the number of people they affect or in the magnitude with which they affect their targets. But the majority of software engineers aren't writing software that necessitates answering the above questions. Most of us are writing simple e-commerce applications or iPhone apps -- boring software.\n\nThe case study with SPOT is interesting precisely because of how boring it is. It's true to life, and it serves as a reminder that the average engineer also faces ethical dilemmas. And fortunately for us, these \"ethical dilemmas\" are sometimes pretty cut and dry, provided we have the awareness to recognize them and the courage to speak up. In the case with SPOT, I think most people would agree that making an effort to mislead the consumer is dishonest and thus unethical.\n\n## The Takeaway\n\nJust because you work on boring software does not mean that it can't negatively impact your users in an unethical way. The first step towards protecting users is increased developer awareness. As a developer, it's essential to ask how your software affects your users. If it might hurt them, step back and consider the the greater picture. If you think your code might manipulate or mislead your users, it's time to speak up.\n\n#### Footnotes\n\n<a name=\"footnote1\">1</a>: I think it's important to be fair here. The marketing material across the site is inconsistent and ranges in the clarity of its term of service. [This page](https://www.findmespot.com/en/index.php?cid=131) makes the 12 month contract abundantly clear. [This one](https://www.findmespot.com/en/index.php?cid=130) falls somewhere in the middle.\n","slug":"ethical-engineering-for-the-average-engineer","published":1,"updated":"2018-09-30T20:52:27.477Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vnc000b67ozp6j8pmf4","content":"<p>Two months ago I purchased a GPS device and associated service plan from <a href=\"https://www.findmespot.com/en/\" target=\"_blank\" rel=\"noopener\">SPOT</a>. Today, upon trying to cancel the service, the customer service representative informed me that I had accidentally enrolled myself into a 1 year, $250 contract and that I was unable to cancel. He told me that if I blocked the monthly charges against my credit card that they would report the debt to a collections agency. I was initially upset but soon realized it was a great opportunity to talk about ethics in software engineering.</p>\n<a id=\"more\"></a>\n<h2 id=\"SPOT’s-Marketing-Materials\"><a href=\"#SPOT’s-Marketing-Materials\" class=\"headerlink\" title=\"SPOT’s Marketing Materials\"></a>SPOT’s Marketing Materials</h2><p>The representative told me to look at their website where he claimed it would be very clear that I was signing up for a contract service. When I Googled “spot service plan”, the first link I clicked on directed me to these marketing materials:</p>\n<p><img src=\"/images/spot-marketing-material.png\" alt=\"Spot Marketing Website\"></p>\n<p>If you look at the image above, it appears as if several deliberate decisions have been made to disguise the total cost of the month-to-month arrangement.</p>\n<ol>\n<li>The font of the month-to-month price is large, bold, and colorful. It’s designed to stand out</li>\n<li>The 12 month contractual stipulation, on the other hand, is written in unnecessarily small font</li>\n<li>The contractual stipulation is low contrast and visually underwhelming, particularly when juxtaposed against the big, bright, and bold “monthly cost” header</li>\n<li>The terms of the contract are visually separated from the price</li>\n</ol>\n<p>None of this could be chalked up to accident, except perhaps point 3. Ultimately, this page’s content is designed to mislead the consumer, hurting them for the business’s gain.<sup><a href=\"#footnote1\">1</a></sup></p>\n<h2 id=\"Software-Ethics-and-Mainstream-Media\"><a href=\"#Software-Ethics-and-Mainstream-Media\" class=\"headerlink\" title=\"Software Ethics and Mainstream Media\"></a>Software Ethics and Mainstream Media</h2><p>The software industry is rife with ethics scandals, and they are rarely cut and dry. Some examples</p>\n<ol>\n<li><a href=\"https://techcrunch.com/2018/09/07/a-dozen-popular-iphone-apps-caught-quietly-sending-user-locations-to-monetization-firms/\" target=\"_blank\" rel=\"noopener\">Dozens of iPhone applications selling user location data</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/PRISM_(surveillance_program\" target=\"_blank\" rel=\"noopener\">United States surveillance software (PRISMA)</a></li>\n<li><a href=\"https://money.cnn.com/2018/06/01/technology/google-maven-contract/index.html\" target=\"_blank\" rel=\"noopener\">DOD’s Project Maven (drone imaging AI)</a></li>\n</ol>\n<p>Two arguments exist in each of these scenarios. iPhone application engineers might argue that they aren’t hurting consumers by selling their location information. Governments argue that they protect their citizens through surveillance software, even if that’s at the cost of citizen privacy. An engineer of that very software might believe that the code itself is not unethical, only improper use of it. A utilitarian might argue that software that facilitates accurate drone strikes is ethical if the cost of the deaths of its targets is outweighed by its net good. Ultimately, it’s often unclear what constitutes unethical. But it raises a good question: as software engineers, what ethical code should we live by?</p>\n<h2 id=\"Ethics-for-the-Average-Engineer\"><a href=\"#Ethics-for-the-Average-Engineer\" class=\"headerlink\" title=\"Ethics for the Average Engineer\"></a>Ethics for the Average Engineer</h2><p>It’s easy to get consumed in the minutia. The media tends to focus on ethics scandals that have immense gravity, either in the scope of the number of people they affect or in the magnitude with which they affect their targets. But the majority of software engineers aren’t writing software that necessitates answering the above questions. Most of us are writing simple e-commerce applications or iPhone apps – boring software.</p>\n<p>The case study with SPOT is interesting precisely because of how boring it is. It’s true to life, and it serves as a reminder that the average engineer also faces ethical dilemmas. And fortunately for us, these “ethical dilemmas” are sometimes pretty cut and dry, provided we have the awareness to recognize them and the courage to speak up. In the case with SPOT, I think most people would agree that making an effort to mislead the consumer is dishonest and thus unethical.</p>\n<h2 id=\"The-Takeaway\"><a href=\"#The-Takeaway\" class=\"headerlink\" title=\"The Takeaway\"></a>The Takeaway</h2><p>Just because you work on boring software does not mean that it can’t negatively impact your users in an unethical way. The first step towards protecting users is increased developer awareness. As a developer, it’s essential to ask how your software affects your users. If it might hurt them, step back and consider the the greater picture. If you think your code might manipulate or mislead your users, it’s time to speak up.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: I think it’s important to be fair here. The marketing material across the site is inconsistent and ranges in the clarity of its term of service. <a href=\"https://www.findmespot.com/en/index.php?cid=131\" target=\"_blank\" rel=\"noopener\">This page</a> makes the 12 month contract abundantly clear. <a href=\"https://www.findmespot.com/en/index.php?cid=130\" target=\"_blank\" rel=\"noopener\">This one</a> falls somewhere in the middle.</p>\n","site":{"data":{}},"excerpt":"<p>Two months ago I purchased a GPS device and associated service plan from <a href=\"https://www.findmespot.com/en/\" target=\"_blank\" rel=\"noopener\">SPOT</a>. Today, upon trying to cancel the service, the customer service representative informed me that I had accidentally enrolled myself into a 1 year, $250 contract and that I was unable to cancel. He told me that if I blocked the monthly charges against my credit card that they would report the debt to a collections agency. I was initially upset but soon realized it was a great opportunity to talk about ethics in software engineering.</p>","more":"<h2 id=\"SPOT’s-Marketing-Materials\"><a href=\"#SPOT’s-Marketing-Materials\" class=\"headerlink\" title=\"SPOT’s Marketing Materials\"></a>SPOT’s Marketing Materials</h2><p>The representative told me to look at their website where he claimed it would be very clear that I was signing up for a contract service. When I Googled “spot service plan”, the first link I clicked on directed me to these marketing materials:</p>\n<p><img src=\"/images/spot-marketing-material.png\" alt=\"Spot Marketing Website\"></p>\n<p>If you look at the image above, it appears as if several deliberate decisions have been made to disguise the total cost of the month-to-month arrangement.</p>\n<ol>\n<li>The font of the month-to-month price is large, bold, and colorful. It’s designed to stand out</li>\n<li>The 12 month contractual stipulation, on the other hand, is written in unnecessarily small font</li>\n<li>The contractual stipulation is low contrast and visually underwhelming, particularly when juxtaposed against the big, bright, and bold “monthly cost” header</li>\n<li>The terms of the contract are visually separated from the price</li>\n</ol>\n<p>None of this could be chalked up to accident, except perhaps point 3. Ultimately, this page’s content is designed to mislead the consumer, hurting them for the business’s gain.<sup><a href=\"#footnote1\">1</a></sup></p>\n<h2 id=\"Software-Ethics-and-Mainstream-Media\"><a href=\"#Software-Ethics-and-Mainstream-Media\" class=\"headerlink\" title=\"Software Ethics and Mainstream Media\"></a>Software Ethics and Mainstream Media</h2><p>The software industry is rife with ethics scandals, and they are rarely cut and dry. Some examples</p>\n<ol>\n<li><a href=\"https://techcrunch.com/2018/09/07/a-dozen-popular-iphone-apps-caught-quietly-sending-user-locations-to-monetization-firms/\" target=\"_blank\" rel=\"noopener\">Dozens of iPhone applications selling user location data</a></li>\n<li><a href=\"https://en.wikipedia.org/wiki/PRISM_(surveillance_program\" target=\"_blank\" rel=\"noopener\">United States surveillance software (PRISMA)</a></li>\n<li><a href=\"https://money.cnn.com/2018/06/01/technology/google-maven-contract/index.html\" target=\"_blank\" rel=\"noopener\">DOD’s Project Maven (drone imaging AI)</a></li>\n</ol>\n<p>Two arguments exist in each of these scenarios. iPhone application engineers might argue that they aren’t hurting consumers by selling their location information. Governments argue that they protect their citizens through surveillance software, even if that’s at the cost of citizen privacy. An engineer of that very software might believe that the code itself is not unethical, only improper use of it. A utilitarian might argue that software that facilitates accurate drone strikes is ethical if the cost of the deaths of its targets is outweighed by its net good. Ultimately, it’s often unclear what constitutes unethical. But it raises a good question: as software engineers, what ethical code should we live by?</p>\n<h2 id=\"Ethics-for-the-Average-Engineer\"><a href=\"#Ethics-for-the-Average-Engineer\" class=\"headerlink\" title=\"Ethics for the Average Engineer\"></a>Ethics for the Average Engineer</h2><p>It’s easy to get consumed in the minutia. The media tends to focus on ethics scandals that have immense gravity, either in the scope of the number of people they affect or in the magnitude with which they affect their targets. But the majority of software engineers aren’t writing software that necessitates answering the above questions. Most of us are writing simple e-commerce applications or iPhone apps – boring software.</p>\n<p>The case study with SPOT is interesting precisely because of how boring it is. It’s true to life, and it serves as a reminder that the average engineer also faces ethical dilemmas. And fortunately for us, these “ethical dilemmas” are sometimes pretty cut and dry, provided we have the awareness to recognize them and the courage to speak up. In the case with SPOT, I think most people would agree that making an effort to mislead the consumer is dishonest and thus unethical.</p>\n<h2 id=\"The-Takeaway\"><a href=\"#The-Takeaway\" class=\"headerlink\" title=\"The Takeaway\"></a>The Takeaway</h2><p>Just because you work on boring software does not mean that it can’t negatively impact your users in an unethical way. The first step towards protecting users is increased developer awareness. As a developer, it’s essential to ask how your software affects your users. If it might hurt them, step back and consider the the greater picture. If you think your code might manipulate or mislead your users, it’s time to speak up.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: I think it’s important to be fair here. The marketing material across the site is inconsistent and ranges in the clarity of its term of service. <a href=\"https://www.findmespot.com/en/index.php?cid=131\" target=\"_blank\" rel=\"noopener\">This page</a> makes the 12 month contract abundantly clear. <a href=\"https://www.findmespot.com/en/index.php?cid=130\" target=\"_blank\" rel=\"noopener\">This one</a> falls somewhere in the middle.</p>"},{"title":"Scraping the Web with Puppeteer: Lessons Learned","date":"2017-12-09T21:35:13.000Z","_content":"\nI'm currently contracted to create a web service using some data from a third party Angular application. I worked off a proof of concept codebase that used Chrome's new [Puppeteer](https://github.com/GoogleChrome/puppeteer) API to scrape this site. I strongly regret not starting from scratch.\n\n<!-- more -->\n\n## What is Puppeteer?\n\nPuppeteer is a Node API that allows you to control Google's headless Chrome browser. Imagine a version of your browser that can send and receive requests but has no GUI. It works in the background, performing actions as instructed by an API. This makes Puppeteer great for end to end testing a web application. You can truly simulate the user experience, typing where they type and clicking where they click. Another use case for Puppeteer is web scraping a single page web application. Let's explore how this might work.\n\n## A Simple Example\n\nFor any Puppeteer project, the first task is to create an instance of the headless browser.\n\n```js\nconst browser = await puppeteer.launch()\n\n// We will use this page instance and it's API frequently\nconst page = await this.browser.newPage();\n```\n\nAfter that's done, it's trivial to navigate to and begin interacting with a webpage. Let's suppose I want to fill out a login form and submit an authentication request to a website. In an ideal situation, it looks like this.\n\n```js\n// Navigate to the website\nawait page.goto(\"https://website/login\");\n\n// Provide the selector of an input box and the content to type\nawait page.type(\"input#username\", CREDENTIALS.username);\nawait page.type(\"input#password\", CREDENTIALS.password);\nawait page.click(\"button#login\"); // Click the login button\n\n// Wait until the screen changes and a node matching\n// the selector #logged-in-successfully appears,\n// at which point we know the login was successful\nawait page.waitForSelector(\"#logged-in-successfully\");\n```\n\nWe just successfully filled out a form, submitted an HTTP request containing our form data, and waited for the page to change upon successful login. This is where Puppeteer shines. Let's look at a more complicated example.\n\n## A More Complicated Example\n\nToday's web uses a mix of simple html driven forms as well as more complicated, javascript-driven forms, rich with functionality like autocomplete and dynamic dropdown menus. I'm sure you've used a calendar date picker. These components each need to be treated differently.\n\nHere is a modified version of some code I wrote for my client:\n\n```js\n// The form inputs I want to fill out\n// and their corresponding selectors\nconst fields = {\n  type: 'input[ng-model=\"type\"]',\n  origin: 'input[ng-model=\"origin\"]',\n  destination: 'input[ng-model=\"destination\"]',\n  date: 'input[ng-model=\"date\"]'\n};\n\nfunction search(searchParams) {\n  const page = await this.browser.newPage();\n  await page.goto(\"https://website/search\");\n\n  // We need to click a button to make the search form\n  // appear, but first make sure that button has rendered\n  await page.waitForSelector(\".new-search\");\n  await page.click(\".new-search\");\n\n  // Fill out the form\n  for (const field of Object.keys(fields)) {\n    if (searchParams[field]) {\n      const selector = fields[field];\n\n      // We want to make sure each DOM node is rendered\n      // before we try to do anything to it.\n      await page.waitForSelector(selector);\n\n      // Some inputs need to be focused first for page.type to work\n      // Might as well focus on all of them\n      await page.focus(selector);\n\n      // Some inputs have defaults that need to be\n      // erased before typing your own input\n      if (field === \"date\" || field === \"type\") {\n        // This is a helper function I wrote\n        await deleteInput(page, selector);\n      }\n\n      await page.type(selector, searchParams[field]);\n\n      // This field won't register the typed data\n      // until Enter is pressed.\n      // This is because the 'type' field is a dropdown\n      // where one of a specific set of inputs must be clicked.\n      if (field === \"type\") {\n        await page.keyboard.press(\"Enter\");\n      }\n    }\n  }\n}\n```\n\nThe first thing to notice is that the code is messy and full of weird exceptions. To make matters worse, it doesn't always work.\n\n## Brace Yourself for Flaky Behavior\n\nWorking with Puppeteer was an exercise in guesswork. Given the same inputs, Puppeteer did not always produce the same outputs<sup>[1](#footnote1)</sup>. This flaky behavior made the project unnecessarily challenging and required me to do additional engineering to increase reliability, which was frustrating considering the alternative.\n\n## Puppeteer Was Completely Unnecessary\n\nPuppeteer has a API that allows you to execute arbitrary code against the DOM. After scraping form results with this API and getting the same flaky behavior described above, I ditched the approach and started grabbing data from the HTTP response objects themselves. Below is a primitive version of some code I wrote to do this.\n\n```js\nwaitForUrl(page, urlPrefix) {\n  return new Promise(resolve => {\n    page.on(\"response\", res => {\n      if (!res.url.startsWith(urlPrefix)) {\n        return;\n      }\n      resolve(res.json());\n    };\n  });\n}\n```\n\nThe page passed into this function is the same page object created above by the Puppeteer API. Among other things, it is an event emitter that allows me to listen for any HTTP responses. I've essentially created a promise that resolves to the response body of a particular ajax request. This allowed me interact with the server API directly and removed the DOM from the data retrieval process, greatly reducing the chance for flaky behavior. But that begs the question, why use Puppeteer at all? Why not simply send http requests to the server API manually and ditch the complicated form submission code above That's how I should have started all along.\n\n## When is Puppeteer the Right Solution\n\nI can only think of a single scenario where using Puppeteer for scraping is superior to the alternative: if the information you want is generated using a combination of API data and javascript code. After all, you would have no other way to simulate the javascript code without rewriting it.\n\nIf, however, all you need is data from the server, go the simple route and hit the API with an HTTP library like [axios](https://github.com/axios/axios) or [request](https://github.com/request/request). If you are scraping a server side rendered application, you can combine one of the aforementioned tools with [Cheerio](https://github.com/cheeriojs/cheerio), giving you a far more user friendly DOM manipulation API than that offered my Puppeteer.\n\n#### Footnotes\n\n<a name=\"footnote1\">1</a>: You might be curious why Puppeteer exhibited flaky behavior. One issue that I ran into was animations. I might attempt to click a DOM node, but if the animation had not finished, the click would not register. In essence, it would appear as if the click had worked, but once the animation finished, the DOM would reset itself, undoing my click. I think this is simply how Angular's digest loop reacted to a click at an unexpected time. Unfortunately, Puppeteer provides no functionality to determine when an animation has finished (after all, how would it!). I tried a couple solutions. One entailed a sleep function to wait a couple hundred milliseconds for the animation to finish, but it simply exacerbated the flaky behavior. A second involved executing the click only once the DOM node had a particular class that indicated the animation had finished. At one point, I even tried to disable all animations across the website. All these solutions were half-baked.\n","source":"_posts/scraping-the-web-with-puppeteer-lessons-learned.md","raw":"---\ntitle: 'Scraping the Web with Puppeteer: Lessons Learned'\ncategories:\n  - [Javascript]\n  - [Web Scraping]\n  - [Failures]\ndate: 2017-12-09 15:35:13\n---\n\nI'm currently contracted to create a web service using some data from a third party Angular application. I worked off a proof of concept codebase that used Chrome's new [Puppeteer](https://github.com/GoogleChrome/puppeteer) API to scrape this site. I strongly regret not starting from scratch.\n\n<!-- more -->\n\n## What is Puppeteer?\n\nPuppeteer is a Node API that allows you to control Google's headless Chrome browser. Imagine a version of your browser that can send and receive requests but has no GUI. It works in the background, performing actions as instructed by an API. This makes Puppeteer great for end to end testing a web application. You can truly simulate the user experience, typing where they type and clicking where they click. Another use case for Puppeteer is web scraping a single page web application. Let's explore how this might work.\n\n## A Simple Example\n\nFor any Puppeteer project, the first task is to create an instance of the headless browser.\n\n```js\nconst browser = await puppeteer.launch()\n\n// We will use this page instance and it's API frequently\nconst page = await this.browser.newPage();\n```\n\nAfter that's done, it's trivial to navigate to and begin interacting with a webpage. Let's suppose I want to fill out a login form and submit an authentication request to a website. In an ideal situation, it looks like this.\n\n```js\n// Navigate to the website\nawait page.goto(\"https://website/login\");\n\n// Provide the selector of an input box and the content to type\nawait page.type(\"input#username\", CREDENTIALS.username);\nawait page.type(\"input#password\", CREDENTIALS.password);\nawait page.click(\"button#login\"); // Click the login button\n\n// Wait until the screen changes and a node matching\n// the selector #logged-in-successfully appears,\n// at which point we know the login was successful\nawait page.waitForSelector(\"#logged-in-successfully\");\n```\n\nWe just successfully filled out a form, submitted an HTTP request containing our form data, and waited for the page to change upon successful login. This is where Puppeteer shines. Let's look at a more complicated example.\n\n## A More Complicated Example\n\nToday's web uses a mix of simple html driven forms as well as more complicated, javascript-driven forms, rich with functionality like autocomplete and dynamic dropdown menus. I'm sure you've used a calendar date picker. These components each need to be treated differently.\n\nHere is a modified version of some code I wrote for my client:\n\n```js\n// The form inputs I want to fill out\n// and their corresponding selectors\nconst fields = {\n  type: 'input[ng-model=\"type\"]',\n  origin: 'input[ng-model=\"origin\"]',\n  destination: 'input[ng-model=\"destination\"]',\n  date: 'input[ng-model=\"date\"]'\n};\n\nfunction search(searchParams) {\n  const page = await this.browser.newPage();\n  await page.goto(\"https://website/search\");\n\n  // We need to click a button to make the search form\n  // appear, but first make sure that button has rendered\n  await page.waitForSelector(\".new-search\");\n  await page.click(\".new-search\");\n\n  // Fill out the form\n  for (const field of Object.keys(fields)) {\n    if (searchParams[field]) {\n      const selector = fields[field];\n\n      // We want to make sure each DOM node is rendered\n      // before we try to do anything to it.\n      await page.waitForSelector(selector);\n\n      // Some inputs need to be focused first for page.type to work\n      // Might as well focus on all of them\n      await page.focus(selector);\n\n      // Some inputs have defaults that need to be\n      // erased before typing your own input\n      if (field === \"date\" || field === \"type\") {\n        // This is a helper function I wrote\n        await deleteInput(page, selector);\n      }\n\n      await page.type(selector, searchParams[field]);\n\n      // This field won't register the typed data\n      // until Enter is pressed.\n      // This is because the 'type' field is a dropdown\n      // where one of a specific set of inputs must be clicked.\n      if (field === \"type\") {\n        await page.keyboard.press(\"Enter\");\n      }\n    }\n  }\n}\n```\n\nThe first thing to notice is that the code is messy and full of weird exceptions. To make matters worse, it doesn't always work.\n\n## Brace Yourself for Flaky Behavior\n\nWorking with Puppeteer was an exercise in guesswork. Given the same inputs, Puppeteer did not always produce the same outputs<sup>[1](#footnote1)</sup>. This flaky behavior made the project unnecessarily challenging and required me to do additional engineering to increase reliability, which was frustrating considering the alternative.\n\n## Puppeteer Was Completely Unnecessary\n\nPuppeteer has a API that allows you to execute arbitrary code against the DOM. After scraping form results with this API and getting the same flaky behavior described above, I ditched the approach and started grabbing data from the HTTP response objects themselves. Below is a primitive version of some code I wrote to do this.\n\n```js\nwaitForUrl(page, urlPrefix) {\n  return new Promise(resolve => {\n    page.on(\"response\", res => {\n      if (!res.url.startsWith(urlPrefix)) {\n        return;\n      }\n      resolve(res.json());\n    };\n  });\n}\n```\n\nThe page passed into this function is the same page object created above by the Puppeteer API. Among other things, it is an event emitter that allows me to listen for any HTTP responses. I've essentially created a promise that resolves to the response body of a particular ajax request. This allowed me interact with the server API directly and removed the DOM from the data retrieval process, greatly reducing the chance for flaky behavior. But that begs the question, why use Puppeteer at all? Why not simply send http requests to the server API manually and ditch the complicated form submission code above That's how I should have started all along.\n\n## When is Puppeteer the Right Solution\n\nI can only think of a single scenario where using Puppeteer for scraping is superior to the alternative: if the information you want is generated using a combination of API data and javascript code. After all, you would have no other way to simulate the javascript code without rewriting it.\n\nIf, however, all you need is data from the server, go the simple route and hit the API with an HTTP library like [axios](https://github.com/axios/axios) or [request](https://github.com/request/request). If you are scraping a server side rendered application, you can combine one of the aforementioned tools with [Cheerio](https://github.com/cheeriojs/cheerio), giving you a far more user friendly DOM manipulation API than that offered my Puppeteer.\n\n#### Footnotes\n\n<a name=\"footnote1\">1</a>: You might be curious why Puppeteer exhibited flaky behavior. One issue that I ran into was animations. I might attempt to click a DOM node, but if the animation had not finished, the click would not register. In essence, it would appear as if the click had worked, but once the animation finished, the DOM would reset itself, undoing my click. I think this is simply how Angular's digest loop reacted to a click at an unexpected time. Unfortunately, Puppeteer provides no functionality to determine when an animation has finished (after all, how would it!). I tried a couple solutions. One entailed a sleep function to wait a couple hundred milliseconds for the animation to finish, but it simply exacerbated the flaky behavior. A second involved executing the click only once the DOM node had a particular class that indicated the animation had finished. At one point, I even tried to disable all animations across the website. All these solutions were half-baked.\n","slug":"scraping-the-web-with-puppeteer-lessons-learned","published":1,"updated":"2018-09-30T20:52:45.834Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vnd000c67oz7uc0b6f1","content":"<p>I’m currently contracted to create a web service using some data from a third party Angular application. I worked off a proof of concept codebase that used Chrome’s new <a href=\"https://github.com/GoogleChrome/puppeteer\" target=\"_blank\" rel=\"noopener\">Puppeteer</a> API to scrape this site. I strongly regret not starting from scratch.</p>\n<a id=\"more\"></a>\n<h2 id=\"What-is-Puppeteer\"><a href=\"#What-is-Puppeteer\" class=\"headerlink\" title=\"What is Puppeteer?\"></a>What is Puppeteer?</h2><p>Puppeteer is a Node API that allows you to control Google’s headless Chrome browser. Imagine a version of your browser that can send and receive requests but has no GUI. It works in the background, performing actions as instructed by an API. This makes Puppeteer great for end to end testing a web application. You can truly simulate the user experience, typing where they type and clicking where they click. Another use case for Puppeteer is web scraping a single page web application. Let’s explore how this might work.</p>\n<h2 id=\"A-Simple-Example\"><a href=\"#A-Simple-Example\" class=\"headerlink\" title=\"A Simple Example\"></a>A Simple Example</h2><p>For any Puppeteer project, the first task is to create an instance of the headless browser.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> browser = <span class=\"keyword\">await</span> puppeteer.launch()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// We will use this page instance and it's API frequently</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> page = <span class=\"keyword\">await</span> <span class=\"keyword\">this</span>.browser.newPage();</span><br></pre></td></tr></table></figure>\n<p>After that’s done, it’s trivial to navigate to and begin interacting with a webpage. Let’s suppose I want to fill out a login form and submit an authentication request to a website. In an ideal situation, it looks like this.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Navigate to the website</span></span><br><span class=\"line\"><span class=\"keyword\">await</span> page.goto(<span class=\"string\">\"https://website/login\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Provide the selector of an input box and the content to type</span></span><br><span class=\"line\"><span class=\"keyword\">await</span> page.type(<span class=\"string\">\"input#username\"</span>, CREDENTIALS.username);</span><br><span class=\"line\"><span class=\"keyword\">await</span> page.type(<span class=\"string\">\"input#password\"</span>, CREDENTIALS.password);</span><br><span class=\"line\"><span class=\"keyword\">await</span> page.click(<span class=\"string\">\"button#login\"</span>); <span class=\"comment\">// Click the login button</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Wait until the screen changes and a node matching</span></span><br><span class=\"line\"><span class=\"comment\">// the selector #logged-in-successfully appears,</span></span><br><span class=\"line\"><span class=\"comment\">// at which point we know the login was successful</span></span><br><span class=\"line\"><span class=\"keyword\">await</span> page.waitForSelector(<span class=\"string\">\"#logged-in-successfully\"</span>);</span><br></pre></td></tr></table></figure>\n<p>We just successfully filled out a form, submitted an HTTP request containing our form data, and waited for the page to change upon successful login. This is where Puppeteer shines. Let’s look at a more complicated example.</p>\n<h2 id=\"A-More-Complicated-Example\"><a href=\"#A-More-Complicated-Example\" class=\"headerlink\" title=\"A More Complicated Example\"></a>A More Complicated Example</h2><p>Today’s web uses a mix of simple html driven forms as well as more complicated, javascript-driven forms, rich with functionality like autocomplete and dynamic dropdown menus. I’m sure you’ve used a calendar date picker. These components each need to be treated differently.</p>\n<p>Here is a modified version of some code I wrote for my client:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// The form inputs I want to fill out</span></span><br><span class=\"line\"><span class=\"comment\">// and their corresponding selectors</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> fields = &#123;</span><br><span class=\"line\">  type: <span class=\"string\">'input[ng-model=\"type\"]'</span>,</span><br><span class=\"line\">  origin: <span class=\"string\">'input[ng-model=\"origin\"]'</span>,</span><br><span class=\"line\">  destination: <span class=\"string\">'input[ng-model=\"destination\"]'</span>,</span><br><span class=\"line\">  date: <span class=\"string\">'input[ng-model=\"date\"]'</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span>(<span class=\"params\">searchParams</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> page = <span class=\"keyword\">await</span> <span class=\"keyword\">this</span>.browser.newPage();</span><br><span class=\"line\">  <span class=\"keyword\">await</span> page.goto(<span class=\"string\">\"https://website/search\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// We need to click a button to make the search form</span></span><br><span class=\"line\">  <span class=\"comment\">// appear, but first make sure that button has rendered</span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> page.waitForSelector(<span class=\"string\">\".new-search\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">await</span> page.click(<span class=\"string\">\".new-search\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Fill out the form</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> field <span class=\"keyword\">of</span> <span class=\"built_in\">Object</span>.keys(fields)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (searchParams[field]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> selector = fields[field];</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// We want to make sure each DOM node is rendered</span></span><br><span class=\"line\">      <span class=\"comment\">// before we try to do anything to it.</span></span><br><span class=\"line\">      <span class=\"keyword\">await</span> page.waitForSelector(selector);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Some inputs need to be focused first for page.type to work</span></span><br><span class=\"line\">      <span class=\"comment\">// Might as well focus on all of them</span></span><br><span class=\"line\">      <span class=\"keyword\">await</span> page.focus(selector);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Some inputs have defaults that need to be</span></span><br><span class=\"line\">      <span class=\"comment\">// erased before typing your own input</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (field === <span class=\"string\">\"date\"</span> || field === <span class=\"string\">\"type\"</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// This is a helper function I wrote</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> deleteInput(page, selector);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">await</span> page.type(selector, searchParams[field]);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// This field won't register the typed data</span></span><br><span class=\"line\">      <span class=\"comment\">// until Enter is pressed.</span></span><br><span class=\"line\">      <span class=\"comment\">// This is because the 'type' field is a dropdown</span></span><br><span class=\"line\">      <span class=\"comment\">// where one of a specific set of inputs must be clicked.</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (field === <span class=\"string\">\"type\"</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> page.keyboard.press(<span class=\"string\">\"Enter\"</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The first thing to notice is that the code is messy and full of weird exceptions. To make matters worse, it doesn’t always work.</p>\n<h2 id=\"Brace-Yourself-for-Flaky-Behavior\"><a href=\"#Brace-Yourself-for-Flaky-Behavior\" class=\"headerlink\" title=\"Brace Yourself for Flaky Behavior\"></a>Brace Yourself for Flaky Behavior</h2><p>Working with Puppeteer was an exercise in guesswork. Given the same inputs, Puppeteer did not always produce the same outputs<sup><a href=\"#footnote1\">1</a></sup>. This flaky behavior made the project unnecessarily challenging and required me to do additional engineering to increase reliability, which was frustrating considering the alternative.</p>\n<h2 id=\"Puppeteer-Was-Completely-Unnecessary\"><a href=\"#Puppeteer-Was-Completely-Unnecessary\" class=\"headerlink\" title=\"Puppeteer Was Completely Unnecessary\"></a>Puppeteer Was Completely Unnecessary</h2><p>Puppeteer has a API that allows you to execute arbitrary code against the DOM. After scraping form results with this API and getting the same flaky behavior described above, I ditched the approach and started grabbing data from the HTTP response objects themselves. Below is a primitive version of some code I wrote to do this.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">waitForUrl(page, urlPrefix) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">    page.on(<span class=\"string\">\"response\"</span>, res =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!res.url.startsWith(urlPrefix)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      resolve(res.json());</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The page passed into this function is the same page object created above by the Puppeteer API. Among other things, it is an event emitter that allows me to listen for any HTTP responses. I’ve essentially created a promise that resolves to the response body of a particular ajax request. This allowed me interact with the server API directly and removed the DOM from the data retrieval process, greatly reducing the chance for flaky behavior. But that begs the question, why use Puppeteer at all? Why not simply send http requests to the server API manually and ditch the complicated form submission code above That’s how I should have started all along.</p>\n<h2 id=\"When-is-Puppeteer-the-Right-Solution\"><a href=\"#When-is-Puppeteer-the-Right-Solution\" class=\"headerlink\" title=\"When is Puppeteer the Right Solution\"></a>When is Puppeteer the Right Solution</h2><p>I can only think of a single scenario where using Puppeteer for scraping is superior to the alternative: if the information you want is generated using a combination of API data and javascript code. After all, you would have no other way to simulate the javascript code without rewriting it.</p>\n<p>If, however, all you need is data from the server, go the simple route and hit the API with an HTTP library like <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener\">axios</a> or <a href=\"https://github.com/request/request\" target=\"_blank\" rel=\"noopener\">request</a>. If you are scraping a server side rendered application, you can combine one of the aforementioned tools with <a href=\"https://github.com/cheeriojs/cheerio\" target=\"_blank\" rel=\"noopener\">Cheerio</a>, giving you a far more user friendly DOM manipulation API than that offered my Puppeteer.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: You might be curious why Puppeteer exhibited flaky behavior. One issue that I ran into was animations. I might attempt to click a DOM node, but if the animation had not finished, the click would not register. In essence, it would appear as if the click had worked, but once the animation finished, the DOM would reset itself, undoing my click. I think this is simply how Angular’s digest loop reacted to a click at an unexpected time. Unfortunately, Puppeteer provides no functionality to determine when an animation has finished (after all, how would it!). I tried a couple solutions. One entailed a sleep function to wait a couple hundred milliseconds for the animation to finish, but it simply exacerbated the flaky behavior. A second involved executing the click only once the DOM node had a particular class that indicated the animation had finished. At one point, I even tried to disable all animations across the website. All these solutions were half-baked.</p>\n","site":{"data":{}},"excerpt":"<p>I’m currently contracted to create a web service using some data from a third party Angular application. I worked off a proof of concept codebase that used Chrome’s new <a href=\"https://github.com/GoogleChrome/puppeteer\" target=\"_blank\" rel=\"noopener\">Puppeteer</a> API to scrape this site. I strongly regret not starting from scratch.</p>","more":"<h2 id=\"What-is-Puppeteer\"><a href=\"#What-is-Puppeteer\" class=\"headerlink\" title=\"What is Puppeteer?\"></a>What is Puppeteer?</h2><p>Puppeteer is a Node API that allows you to control Google’s headless Chrome browser. Imagine a version of your browser that can send and receive requests but has no GUI. It works in the background, performing actions as instructed by an API. This makes Puppeteer great for end to end testing a web application. You can truly simulate the user experience, typing where they type and clicking where they click. Another use case for Puppeteer is web scraping a single page web application. Let’s explore how this might work.</p>\n<h2 id=\"A-Simple-Example\"><a href=\"#A-Simple-Example\" class=\"headerlink\" title=\"A Simple Example\"></a>A Simple Example</h2><p>For any Puppeteer project, the first task is to create an instance of the headless browser.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> browser = <span class=\"keyword\">await</span> puppeteer.launch()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// We will use this page instance and it's API frequently</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> page = <span class=\"keyword\">await</span> <span class=\"keyword\">this</span>.browser.newPage();</span><br></pre></td></tr></table></figure>\n<p>After that’s done, it’s trivial to navigate to and begin interacting with a webpage. Let’s suppose I want to fill out a login form and submit an authentication request to a website. In an ideal situation, it looks like this.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Navigate to the website</span></span><br><span class=\"line\"><span class=\"keyword\">await</span> page.goto(<span class=\"string\">\"https://website/login\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Provide the selector of an input box and the content to type</span></span><br><span class=\"line\"><span class=\"keyword\">await</span> page.type(<span class=\"string\">\"input#username\"</span>, CREDENTIALS.username);</span><br><span class=\"line\"><span class=\"keyword\">await</span> page.type(<span class=\"string\">\"input#password\"</span>, CREDENTIALS.password);</span><br><span class=\"line\"><span class=\"keyword\">await</span> page.click(<span class=\"string\">\"button#login\"</span>); <span class=\"comment\">// Click the login button</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Wait until the screen changes and a node matching</span></span><br><span class=\"line\"><span class=\"comment\">// the selector #logged-in-successfully appears,</span></span><br><span class=\"line\"><span class=\"comment\">// at which point we know the login was successful</span></span><br><span class=\"line\"><span class=\"keyword\">await</span> page.waitForSelector(<span class=\"string\">\"#logged-in-successfully\"</span>);</span><br></pre></td></tr></table></figure>\n<p>We just successfully filled out a form, submitted an HTTP request containing our form data, and waited for the page to change upon successful login. This is where Puppeteer shines. Let’s look at a more complicated example.</p>\n<h2 id=\"A-More-Complicated-Example\"><a href=\"#A-More-Complicated-Example\" class=\"headerlink\" title=\"A More Complicated Example\"></a>A More Complicated Example</h2><p>Today’s web uses a mix of simple html driven forms as well as more complicated, javascript-driven forms, rich with functionality like autocomplete and dynamic dropdown menus. I’m sure you’ve used a calendar date picker. These components each need to be treated differently.</p>\n<p>Here is a modified version of some code I wrote for my client:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// The form inputs I want to fill out</span></span><br><span class=\"line\"><span class=\"comment\">// and their corresponding selectors</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> fields = &#123;</span><br><span class=\"line\">  type: <span class=\"string\">'input[ng-model=\"type\"]'</span>,</span><br><span class=\"line\">  origin: <span class=\"string\">'input[ng-model=\"origin\"]'</span>,</span><br><span class=\"line\">  destination: <span class=\"string\">'input[ng-model=\"destination\"]'</span>,</span><br><span class=\"line\">  date: <span class=\"string\">'input[ng-model=\"date\"]'</span></span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span>(<span class=\"params\">searchParams</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> page = <span class=\"keyword\">await</span> <span class=\"keyword\">this</span>.browser.newPage();</span><br><span class=\"line\">  <span class=\"keyword\">await</span> page.goto(<span class=\"string\">\"https://website/search\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// We need to click a button to make the search form</span></span><br><span class=\"line\">  <span class=\"comment\">// appear, but first make sure that button has rendered</span></span><br><span class=\"line\">  <span class=\"keyword\">await</span> page.waitForSelector(<span class=\"string\">\".new-search\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">await</span> page.click(<span class=\"string\">\".new-search\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Fill out the form</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> field <span class=\"keyword\">of</span> <span class=\"built_in\">Object</span>.keys(fields)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (searchParams[field]) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> selector = fields[field];</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// We want to make sure each DOM node is rendered</span></span><br><span class=\"line\">      <span class=\"comment\">// before we try to do anything to it.</span></span><br><span class=\"line\">      <span class=\"keyword\">await</span> page.waitForSelector(selector);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Some inputs need to be focused first for page.type to work</span></span><br><span class=\"line\">      <span class=\"comment\">// Might as well focus on all of them</span></span><br><span class=\"line\">      <span class=\"keyword\">await</span> page.focus(selector);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// Some inputs have defaults that need to be</span></span><br><span class=\"line\">      <span class=\"comment\">// erased before typing your own input</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (field === <span class=\"string\">\"date\"</span> || field === <span class=\"string\">\"type\"</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// This is a helper function I wrote</span></span><br><span class=\"line\">        <span class=\"keyword\">await</span> deleteInput(page, selector);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">await</span> page.type(selector, searchParams[field]);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// This field won't register the typed data</span></span><br><span class=\"line\">      <span class=\"comment\">// until Enter is pressed.</span></span><br><span class=\"line\">      <span class=\"comment\">// This is because the 'type' field is a dropdown</span></span><br><span class=\"line\">      <span class=\"comment\">// where one of a specific set of inputs must be clicked.</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (field === <span class=\"string\">\"type\"</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">await</span> page.keyboard.press(<span class=\"string\">\"Enter\"</span>);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The first thing to notice is that the code is messy and full of weird exceptions. To make matters worse, it doesn’t always work.</p>\n<h2 id=\"Brace-Yourself-for-Flaky-Behavior\"><a href=\"#Brace-Yourself-for-Flaky-Behavior\" class=\"headerlink\" title=\"Brace Yourself for Flaky Behavior\"></a>Brace Yourself for Flaky Behavior</h2><p>Working with Puppeteer was an exercise in guesswork. Given the same inputs, Puppeteer did not always produce the same outputs<sup><a href=\"#footnote1\">1</a></sup>. This flaky behavior made the project unnecessarily challenging and required me to do additional engineering to increase reliability, which was frustrating considering the alternative.</p>\n<h2 id=\"Puppeteer-Was-Completely-Unnecessary\"><a href=\"#Puppeteer-Was-Completely-Unnecessary\" class=\"headerlink\" title=\"Puppeteer Was Completely Unnecessary\"></a>Puppeteer Was Completely Unnecessary</h2><p>Puppeteer has a API that allows you to execute arbitrary code against the DOM. After scraping form results with this API and getting the same flaky behavior described above, I ditched the approach and started grabbing data from the HTTP response objects themselves. Below is a primitive version of some code I wrote to do this.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">waitForUrl(page, urlPrefix) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"built_in\">Promise</span>(<span class=\"function\"><span class=\"params\">resolve</span> =&gt;</span> &#123;</span><br><span class=\"line\">    page.on(<span class=\"string\">\"response\"</span>, res =&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!res.url.startsWith(urlPrefix)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      resolve(res.json());</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The page passed into this function is the same page object created above by the Puppeteer API. Among other things, it is an event emitter that allows me to listen for any HTTP responses. I’ve essentially created a promise that resolves to the response body of a particular ajax request. This allowed me interact with the server API directly and removed the DOM from the data retrieval process, greatly reducing the chance for flaky behavior. But that begs the question, why use Puppeteer at all? Why not simply send http requests to the server API manually and ditch the complicated form submission code above That’s how I should have started all along.</p>\n<h2 id=\"When-is-Puppeteer-the-Right-Solution\"><a href=\"#When-is-Puppeteer-the-Right-Solution\" class=\"headerlink\" title=\"When is Puppeteer the Right Solution\"></a>When is Puppeteer the Right Solution</h2><p>I can only think of a single scenario where using Puppeteer for scraping is superior to the alternative: if the information you want is generated using a combination of API data and javascript code. After all, you would have no other way to simulate the javascript code without rewriting it.</p>\n<p>If, however, all you need is data from the server, go the simple route and hit the API with an HTTP library like <a href=\"https://github.com/axios/axios\" target=\"_blank\" rel=\"noopener\">axios</a> or <a href=\"https://github.com/request/request\" target=\"_blank\" rel=\"noopener\">request</a>. If you are scraping a server side rendered application, you can combine one of the aforementioned tools with <a href=\"https://github.com/cheeriojs/cheerio\" target=\"_blank\" rel=\"noopener\">Cheerio</a>, giving you a far more user friendly DOM manipulation API than that offered my Puppeteer.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: You might be curious why Puppeteer exhibited flaky behavior. One issue that I ran into was animations. I might attempt to click a DOM node, but if the animation had not finished, the click would not register. In essence, it would appear as if the click had worked, but once the animation finished, the DOM would reset itself, undoing my click. I think this is simply how Angular’s digest loop reacted to a click at an unexpected time. Unfortunately, Puppeteer provides no functionality to determine when an animation has finished (after all, how would it!). I tried a couple solutions. One entailed a sleep function to wait a couple hundred milliseconds for the animation to finish, but it simply exacerbated the flaky behavior. A second involved executing the click only once the DOM node had a particular class that indicated the animation had finished. At one point, I even tried to disable all animations across the website. All these solutions were half-baked.</p>"},{"title":"Regex And Automated Test Fuzzing","date":"2017-12-06T06:00:00.000Z","_content":"\n\nI posted my article [Build Your Own Regex Engine](https://nickdrane.com/build-your-own-regex/) on Reddit the other day, and one of the commenters claimed that the implementation should be trivial to break. Since I had already tested my program against a customized suite of tests, the remark got me thinking about how I could further increase my confidence in the correctness of my program. One extremely low cost however effective strategy for identifying faults in software is known as fuzzing.\n\n<!-- more -->\n\n## What is Fuzzing?\n\nFuzzing is a automated testing technique where a program is provided a series of invalid or randomly generated inputs. If we were testing an HTTP API, we might send randomized combinations of query parameters and ensure that our server always returns a 2xx status code. Since Javascript comes with a regular expression engine, my fuzzer asserts that given the same random input, both engine's return the same output.\n\n## Specifying the Grammar\n\nThe first step is to specify the grammar that our regex engine supports.\n\n```js\nconst lowercase = \"abcdefghijklmnopqrstuvwxyz\".split(\"\");\nconst uppercase = lowercase.map(letter => letter.toUpperCase());\nconst special = [\"?\", \"*\", \".\"];\nconst regexGrammar = special.concat(lowercase, uppercase);\n```\n\nYou might notice we skipped the `^` and `$` characters. More on these in a little bit.\n\n## Generated Valid Regular Expressions\n\nWe want to write a function `generateRegex` that will select `n` random characters from the `regexGrammar` and concatenate them together into a string. This string will be used to create a test regex.\n\nHere are three possible returns values of `generateRegex`:\n\n1. `.AnrQ?QNLQX.syBsOcJlbJZd`\n2. `.LkuZ?Ynj`\n3. `.UN?eiyddhXvyNj`\n\n```js\nfunction generateRegex(n) {\n  let regexString = new Array(n)\n    .fill(0)\n    .map(chooseOne)\n    .join(\"\");\n\n  return regexString;\n}\n\n// Pick one element randomly from the grammar and return it\nfunction chooseOne() {\n  return regexGrammar[Math.floor(Math.random() * regexGrammar.length)];\n}\n```\n\n## Removing Invalid Regex Strings\n\nMy regex engine only deals with a very small subset of available regex syntax, and furthermore, it does not contain any error handling. What happens if `generateRegex` returns the pattern `**` or `^*`? My regex engine was never designed to handle these inputs, though they are possible outputs of `generateRegex`. We need to make a choice about how to handle these expressions. Since the primary goal of my regex engine is accessibility and simplicity of implementation, I'm not about to begin supporting these edge cases. That means my fuzzer should not generate them either.\n\nOne solution to determine if a given regex string is valid is to specify my regex engine's allowable grammar in [BNF](https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form). BNF is a formal notation for specifying the syntax of a language. Given this BNF notation, I could ask another program if the randomly generated regex string can be created using my BNF specification. This sounds like a little more work than I want, however, since the invalid cases can simply be manually enumerated and filtered.\n\n```js\nfunction validRegex(regexString) {\n  return (\n    // None of the following sequences are properly\n    // defined by my regex engine\n    regexString.indexOf(\"**\") === -1 &&\n    regexString.indexOf(\"??\") === -1 &&\n    regexString.indexOf(\"*?\") === -1 &&\n    regexString.indexOf(\"?*\") === -1 &&\n    regexString.indexOf(\"^?\") === -1 &&\n    regexString.indexOf(\"^*\") === -1 &&\n    !regexString.startsWith(\"*\") &&\n    !regexString.startsWith(\"?\")\n  );\n}\n\nfunction generateRegex(n) {\n  let regexString = new Array(n)\n    .fill(0)\n    .map(chooseOne)\n    .join(\"\");\n\n  // If the generated string is valid, return it\n  if (validRegex(regexString)) {\n    return regexString;\n  // Otherwise generate a new string and return that\n  } else {\n    return generateRegexString(n);\n  }\n}\n```\n\nOne more modification to `generateRegex` is necessary to support `^` and `$`, and then we are basically done.\n\n```js\nfunction generateRegex(n) {\n  ...\n  // We need to ensure that '^' and '$' only go at the beginning\n  // and the end of the string, respectively.\n  // Give each a 10% probability of appearing in a string\n  if (Math.random() < 0.1) regexString = \"^\" + regexString;\n  if (Math.random() < 0.1) regexString = regexString + \"$\";\n  ...\n}\n```\n\n## Comparing Regex Implementations\n\nAll that is required now is to repeatedly invoke `generateRegex` a fixed number of times and then compare the output of the native JS implementation with the output of my implementation.\n\n```js\n// The corpus is the string of text we are matching the pattern against.\n// I used a segment of Gulliver's Travels from Project Gutenberg.\nfunction fuzzer(totalTests, corpus) {\n  const maxRegexLength = 50; // max will actually be 50 - 1\n  let testsRun = 0;\n  while (testsRun < totalTests) {\n    const regexLength = getRandomInt(1, maxRegexLength);\n    const regexString = generateRegexString(regexLength);\n    const testRegex = new RegExp(regexString);\n    try {\n      assert.equal(testRegex.test(corpus), myRegexEngine(regexString, corpus));\n    } catch (err) {\n      console.log(testRegex);\n    }\n    testsRun++;\n  }\n}\n\n// Thank you Mozzila :)\n// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random\nfunction getRandomInt(min, max) {\n  min = Math.ceil(min);\n  max = Math.floor(max);\n  return Math.floor(Math.random() * (max - min)) + min;\n}\n```\n\n## Results\n\nI ran my fuzzer for a couple million randomly generated cases and ended up learning two things about my regex engine.\n\n1. My implementation fails extraordinarily with longer texts. I knew recursion would be a problem for any practical regex implementation (at least without [tail calls](https://en.wikipedia.org/wiki/Tail_call)) and would cause stack overflows, but I didn't expect it to fail with texts that were only a couple thousand words. I think this is because I make liberal use of backtracking algorithms in `matchQuestion` and `matchStar`. Since I was forced to test with a relatively short input text, it makes sense to use multiple text inputs to increase the probability of discovering an error.\n\n2. My implementation treats the `.` character differently than the native implementation. In the RegExp implementation, `.` will not match various line terminators (`\\n`, `\\r`, `\\u2028` or `\\u2029`). My implementation does.\n\n## Conclusion\n\nThe biggest takeaway is that fuzzing is an simple and inexpensive way to enumerate enormous sets of inputs and identify bugs in your software. This fuzzer took less than an hour to write.\n\nBut remember, this fuzzer's blessing of a couple million input combinations __does not__ verify the correctness of my program. Not even close. A fuzzer is a tool to identify potential errors. Unless you enumerate all possible inputs (completely impossible in this case where they are infinite), you are not guaranteed your program is error free.","source":"_posts/regex-and-automated-test-fuzzing.md","raw":"---\ntitle: Regex And Automated Test Fuzzing\ncategories:\n  - [Regular Expressions]\n  - [Javascript]\n  - [Testing]\ndate: 2017-12-06\n---\n\n\nI posted my article [Build Your Own Regex Engine](https://nickdrane.com/build-your-own-regex/) on Reddit the other day, and one of the commenters claimed that the implementation should be trivial to break. Since I had already tested my program against a customized suite of tests, the remark got me thinking about how I could further increase my confidence in the correctness of my program. One extremely low cost however effective strategy for identifying faults in software is known as fuzzing.\n\n<!-- more -->\n\n## What is Fuzzing?\n\nFuzzing is a automated testing technique where a program is provided a series of invalid or randomly generated inputs. If we were testing an HTTP API, we might send randomized combinations of query parameters and ensure that our server always returns a 2xx status code. Since Javascript comes with a regular expression engine, my fuzzer asserts that given the same random input, both engine's return the same output.\n\n## Specifying the Grammar\n\nThe first step is to specify the grammar that our regex engine supports.\n\n```js\nconst lowercase = \"abcdefghijklmnopqrstuvwxyz\".split(\"\");\nconst uppercase = lowercase.map(letter => letter.toUpperCase());\nconst special = [\"?\", \"*\", \".\"];\nconst regexGrammar = special.concat(lowercase, uppercase);\n```\n\nYou might notice we skipped the `^` and `$` characters. More on these in a little bit.\n\n## Generated Valid Regular Expressions\n\nWe want to write a function `generateRegex` that will select `n` random characters from the `regexGrammar` and concatenate them together into a string. This string will be used to create a test regex.\n\nHere are three possible returns values of `generateRegex`:\n\n1. `.AnrQ?QNLQX.syBsOcJlbJZd`\n2. `.LkuZ?Ynj`\n3. `.UN?eiyddhXvyNj`\n\n```js\nfunction generateRegex(n) {\n  let regexString = new Array(n)\n    .fill(0)\n    .map(chooseOne)\n    .join(\"\");\n\n  return regexString;\n}\n\n// Pick one element randomly from the grammar and return it\nfunction chooseOne() {\n  return regexGrammar[Math.floor(Math.random() * regexGrammar.length)];\n}\n```\n\n## Removing Invalid Regex Strings\n\nMy regex engine only deals with a very small subset of available regex syntax, and furthermore, it does not contain any error handling. What happens if `generateRegex` returns the pattern `**` or `^*`? My regex engine was never designed to handle these inputs, though they are possible outputs of `generateRegex`. We need to make a choice about how to handle these expressions. Since the primary goal of my regex engine is accessibility and simplicity of implementation, I'm not about to begin supporting these edge cases. That means my fuzzer should not generate them either.\n\nOne solution to determine if a given regex string is valid is to specify my regex engine's allowable grammar in [BNF](https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form). BNF is a formal notation for specifying the syntax of a language. Given this BNF notation, I could ask another program if the randomly generated regex string can be created using my BNF specification. This sounds like a little more work than I want, however, since the invalid cases can simply be manually enumerated and filtered.\n\n```js\nfunction validRegex(regexString) {\n  return (\n    // None of the following sequences are properly\n    // defined by my regex engine\n    regexString.indexOf(\"**\") === -1 &&\n    regexString.indexOf(\"??\") === -1 &&\n    regexString.indexOf(\"*?\") === -1 &&\n    regexString.indexOf(\"?*\") === -1 &&\n    regexString.indexOf(\"^?\") === -1 &&\n    regexString.indexOf(\"^*\") === -1 &&\n    !regexString.startsWith(\"*\") &&\n    !regexString.startsWith(\"?\")\n  );\n}\n\nfunction generateRegex(n) {\n  let regexString = new Array(n)\n    .fill(0)\n    .map(chooseOne)\n    .join(\"\");\n\n  // If the generated string is valid, return it\n  if (validRegex(regexString)) {\n    return regexString;\n  // Otherwise generate a new string and return that\n  } else {\n    return generateRegexString(n);\n  }\n}\n```\n\nOne more modification to `generateRegex` is necessary to support `^` and `$`, and then we are basically done.\n\n```js\nfunction generateRegex(n) {\n  ...\n  // We need to ensure that '^' and '$' only go at the beginning\n  // and the end of the string, respectively.\n  // Give each a 10% probability of appearing in a string\n  if (Math.random() < 0.1) regexString = \"^\" + regexString;\n  if (Math.random() < 0.1) regexString = regexString + \"$\";\n  ...\n}\n```\n\n## Comparing Regex Implementations\n\nAll that is required now is to repeatedly invoke `generateRegex` a fixed number of times and then compare the output of the native JS implementation with the output of my implementation.\n\n```js\n// The corpus is the string of text we are matching the pattern against.\n// I used a segment of Gulliver's Travels from Project Gutenberg.\nfunction fuzzer(totalTests, corpus) {\n  const maxRegexLength = 50; // max will actually be 50 - 1\n  let testsRun = 0;\n  while (testsRun < totalTests) {\n    const regexLength = getRandomInt(1, maxRegexLength);\n    const regexString = generateRegexString(regexLength);\n    const testRegex = new RegExp(regexString);\n    try {\n      assert.equal(testRegex.test(corpus), myRegexEngine(regexString, corpus));\n    } catch (err) {\n      console.log(testRegex);\n    }\n    testsRun++;\n  }\n}\n\n// Thank you Mozzila :)\n// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random\nfunction getRandomInt(min, max) {\n  min = Math.ceil(min);\n  max = Math.floor(max);\n  return Math.floor(Math.random() * (max - min)) + min;\n}\n```\n\n## Results\n\nI ran my fuzzer for a couple million randomly generated cases and ended up learning two things about my regex engine.\n\n1. My implementation fails extraordinarily with longer texts. I knew recursion would be a problem for any practical regex implementation (at least without [tail calls](https://en.wikipedia.org/wiki/Tail_call)) and would cause stack overflows, but I didn't expect it to fail with texts that were only a couple thousand words. I think this is because I make liberal use of backtracking algorithms in `matchQuestion` and `matchStar`. Since I was forced to test with a relatively short input text, it makes sense to use multiple text inputs to increase the probability of discovering an error.\n\n2. My implementation treats the `.` character differently than the native implementation. In the RegExp implementation, `.` will not match various line terminators (`\\n`, `\\r`, `\\u2028` or `\\u2029`). My implementation does.\n\n## Conclusion\n\nThe biggest takeaway is that fuzzing is an simple and inexpensive way to enumerate enormous sets of inputs and identify bugs in your software. This fuzzer took less than an hour to write.\n\nBut remember, this fuzzer's blessing of a couple million input combinations __does not__ verify the correctness of my program. Not even close. A fuzzer is a tool to identify potential errors. Unless you enumerate all possible inputs (completely impossible in this case where they are infinite), you are not guaranteed your program is error free.","slug":"regex-and-automated-test-fuzzing","published":1,"updated":"2018-10-18T03:20:23.622Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vnd000d67ozqhdu43i1","content":"<p>I posted my article <a href=\"https://nickdrane.com/build-your-own-regex/\">Build Your Own Regex Engine</a> on Reddit the other day, and one of the commenters claimed that the implementation should be trivial to break. Since I had already tested my program against a customized suite of tests, the remark got me thinking about how I could further increase my confidence in the correctness of my program. One extremely low cost however effective strategy for identifying faults in software is known as fuzzing.</p>\n<a id=\"more\"></a>\n<h2 id=\"What-is-Fuzzing\"><a href=\"#What-is-Fuzzing\" class=\"headerlink\" title=\"What is Fuzzing?\"></a>What is Fuzzing?</h2><p>Fuzzing is a automated testing technique where a program is provided a series of invalid or randomly generated inputs. If we were testing an HTTP API, we might send randomized combinations of query parameters and ensure that our server always returns a 2xx status code. Since Javascript comes with a regular expression engine, my fuzzer asserts that given the same random input, both engine’s return the same output.</p>\n<h2 id=\"Specifying-the-Grammar\"><a href=\"#Specifying-the-Grammar\" class=\"headerlink\" title=\"Specifying the Grammar\"></a>Specifying the Grammar</h2><p>The first step is to specify the grammar that our regex engine supports.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> lowercase = <span class=\"string\">\"abcdefghijklmnopqrstuvwxyz\"</span>.split(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> uppercase = lowercase.map(<span class=\"function\"><span class=\"params\">letter</span> =&gt;</span> letter.toUpperCase());</span><br><span class=\"line\"><span class=\"keyword\">const</span> special = [<span class=\"string\">\"?\"</span>, <span class=\"string\">\"*\"</span>, <span class=\"string\">\".\"</span>];</span><br><span class=\"line\"><span class=\"keyword\">const</span> regexGrammar = special.concat(lowercase, uppercase);</span><br></pre></td></tr></table></figure>\n<p>You might notice we skipped the <code>^</code> and <code>$</code> characters. More on these in a little bit.</p>\n<h2 id=\"Generated-Valid-Regular-Expressions\"><a href=\"#Generated-Valid-Regular-Expressions\" class=\"headerlink\" title=\"Generated Valid Regular Expressions\"></a>Generated Valid Regular Expressions</h2><p>We want to write a function <code>generateRegex</code> that will select <code>n</code> random characters from the <code>regexGrammar</code> and concatenate them together into a string. This string will be used to create a test regex.</p>\n<p>Here are three possible returns values of <code>generateRegex</code>:</p>\n<ol>\n<li><code>.AnrQ?QNLQX.syBsOcJlbJZd</code></li>\n<li><code>.LkuZ?Ynj</code></li>\n<li><code>.UN?eiyddhXvyNj</code></li>\n</ol>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">generateRegex</span>(<span class=\"params\">n</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> regexString = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>(n)</span><br><span class=\"line\">    .fill(<span class=\"number\">0</span>)</span><br><span class=\"line\">    .map(chooseOne)</span><br><span class=\"line\">    .join(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> regexString;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Pick one element randomly from the grammar and return it</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">chooseOne</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> regexGrammar[<span class=\"built_in\">Math</span>.floor(<span class=\"built_in\">Math</span>.random() * regexGrammar.length)];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Removing-Invalid-Regex-Strings\"><a href=\"#Removing-Invalid-Regex-Strings\" class=\"headerlink\" title=\"Removing Invalid Regex Strings\"></a>Removing Invalid Regex Strings</h2><p>My regex engine only deals with a very small subset of available regex syntax, and furthermore, it does not contain any error handling. What happens if <code>generateRegex</code> returns the pattern <code>**</code> or <code>^*</code>? My regex engine was never designed to handle these inputs, though they are possible outputs of <code>generateRegex</code>. We need to make a choice about how to handle these expressions. Since the primary goal of my regex engine is accessibility and simplicity of implementation, I’m not about to begin supporting these edge cases. That means my fuzzer should not generate them either.</p>\n<p>One solution to determine if a given regex string is valid is to specify my regex engine’s allowable grammar in <a href=\"https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form\" target=\"_blank\" rel=\"noopener\">BNF</a>. BNF is a formal notation for specifying the syntax of a language. Given this BNF notation, I could ask another program if the randomly generated regex string can be created using my BNF specification. This sounds like a little more work than I want, however, since the invalid cases can simply be manually enumerated and filtered.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">validRegex</span>(<span class=\"params\">regexString</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (</span><br><span class=\"line\">    <span class=\"comment\">// None of the following sequences are properly</span></span><br><span class=\"line\">    <span class=\"comment\">// defined by my regex engine</span></span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"**\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"??\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"*?\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"?*\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"^?\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"^*\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    !regexString.startsWith(<span class=\"string\">\"*\"</span>) &amp;&amp;</span><br><span class=\"line\">    !regexString.startsWith(<span class=\"string\">\"?\"</span>)</span><br><span class=\"line\">  );</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">generateRegex</span>(<span class=\"params\">n</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> regexString = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>(n)</span><br><span class=\"line\">    .fill(<span class=\"number\">0</span>)</span><br><span class=\"line\">    .map(chooseOne)</span><br><span class=\"line\">    .join(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// If the generated string is valid, return it</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (validRegex(regexString)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> regexString;</span><br><span class=\"line\">  <span class=\"comment\">// Otherwise generate a new string and return that</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> generateRegexString(n);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>One more modification to <code>generateRegex</code> is necessary to support <code>^</code> and <code>$</code>, and then we are basically done.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">generateRegex</span>(<span class=\"params\">n</span>) </span>&#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"comment\">// We need to ensure that '^' and '$' only go at the beginning</span></span><br><span class=\"line\">  <span class=\"comment\">// and the end of the string, respectively.</span></span><br><span class=\"line\">  <span class=\"comment\">// Give each a 10% probability of appearing in a string</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">Math</span>.random() &lt; <span class=\"number\">0.1</span>) regexString = <span class=\"string\">\"^\"</span> + regexString;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">Math</span>.random() &lt; <span class=\"number\">0.1</span>) regexString = regexString + <span class=\"string\">\"$\"</span>;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Comparing-Regex-Implementations\"><a href=\"#Comparing-Regex-Implementations\" class=\"headerlink\" title=\"Comparing Regex Implementations\"></a>Comparing Regex Implementations</h2><p>All that is required now is to repeatedly invoke <code>generateRegex</code> a fixed number of times and then compare the output of the native JS implementation with the output of my implementation.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// The corpus is the string of text we are matching the pattern against.</span></span><br><span class=\"line\"><span class=\"comment\">// I used a segment of Gulliver's Travels from Project Gutenberg.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fuzzer</span>(<span class=\"params\">totalTests, corpus</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> maxRegexLength = <span class=\"number\">50</span>; <span class=\"comment\">// max will actually be 50 - 1</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> testsRun = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (testsRun &lt; totalTests) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> regexLength = getRandomInt(<span class=\"number\">1</span>, maxRegexLength);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> regexString = generateRegexString(regexLength);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> testRegex = <span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(regexString);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      assert.equal(testRegex.test(corpus), myRegexEngine(regexString, corpus));</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(testRegex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    testsRun++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Thank you Mozzila :)</span></span><br><span class=\"line\"><span class=\"comment\">// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRandomInt</span>(<span class=\"params\">min, max</span>) </span>&#123;</span><br><span class=\"line\">  min = <span class=\"built_in\">Math</span>.ceil(min);</span><br><span class=\"line\">  max = <span class=\"built_in\">Math</span>.floor(max);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">Math</span>.floor(<span class=\"built_in\">Math</span>.random() * (max - min)) + min;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Results\"><a href=\"#Results\" class=\"headerlink\" title=\"Results\"></a>Results</h2><p>I ran my fuzzer for a couple million randomly generated cases and ended up learning two things about my regex engine.</p>\n<ol>\n<li><p>My implementation fails extraordinarily with longer texts. I knew recursion would be a problem for any practical regex implementation (at least without <a href=\"https://en.wikipedia.org/wiki/Tail_call\" target=\"_blank\" rel=\"noopener\">tail calls</a>) and would cause stack overflows, but I didn’t expect it to fail with texts that were only a couple thousand words. I think this is because I make liberal use of backtracking algorithms in <code>matchQuestion</code> and <code>matchStar</code>. Since I was forced to test with a relatively short input text, it makes sense to use multiple text inputs to increase the probability of discovering an error.</p>\n</li>\n<li><p>My implementation treats the <code>.</code> character differently than the native implementation. In the RegExp implementation, <code>.</code> will not match various line terminators (<code>\\n</code>, <code>\\r</code>, <code>\\u2028</code> or <code>\\u2029</code>). My implementation does.</p>\n</li>\n</ol>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>The biggest takeaway is that fuzzing is an simple and inexpensive way to enumerate enormous sets of inputs and identify bugs in your software. This fuzzer took less than an hour to write.</p>\n<p>But remember, this fuzzer’s blessing of a couple million input combinations <strong>does not</strong> verify the correctness of my program. Not even close. A fuzzer is a tool to identify potential errors. Unless you enumerate all possible inputs (completely impossible in this case where they are infinite), you are not guaranteed your program is error free.</p>\n","site":{"data":{}},"excerpt":"<p>I posted my article <a href=\"https://nickdrane.com/build-your-own-regex/\">Build Your Own Regex Engine</a> on Reddit the other day, and one of the commenters claimed that the implementation should be trivial to break. Since I had already tested my program against a customized suite of tests, the remark got me thinking about how I could further increase my confidence in the correctness of my program. One extremely low cost however effective strategy for identifying faults in software is known as fuzzing.</p>","more":"<h2 id=\"What-is-Fuzzing\"><a href=\"#What-is-Fuzzing\" class=\"headerlink\" title=\"What is Fuzzing?\"></a>What is Fuzzing?</h2><p>Fuzzing is a automated testing technique where a program is provided a series of invalid or randomly generated inputs. If we were testing an HTTP API, we might send randomized combinations of query parameters and ensure that our server always returns a 2xx status code. Since Javascript comes with a regular expression engine, my fuzzer asserts that given the same random input, both engine’s return the same output.</p>\n<h2 id=\"Specifying-the-Grammar\"><a href=\"#Specifying-the-Grammar\" class=\"headerlink\" title=\"Specifying the Grammar\"></a>Specifying the Grammar</h2><p>The first step is to specify the grammar that our regex engine supports.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> lowercase = <span class=\"string\">\"abcdefghijklmnopqrstuvwxyz\"</span>.split(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> uppercase = lowercase.map(<span class=\"function\"><span class=\"params\">letter</span> =&gt;</span> letter.toUpperCase());</span><br><span class=\"line\"><span class=\"keyword\">const</span> special = [<span class=\"string\">\"?\"</span>, <span class=\"string\">\"*\"</span>, <span class=\"string\">\".\"</span>];</span><br><span class=\"line\"><span class=\"keyword\">const</span> regexGrammar = special.concat(lowercase, uppercase);</span><br></pre></td></tr></table></figure>\n<p>You might notice we skipped the <code>^</code> and <code>$</code> characters. More on these in a little bit.</p>\n<h2 id=\"Generated-Valid-Regular-Expressions\"><a href=\"#Generated-Valid-Regular-Expressions\" class=\"headerlink\" title=\"Generated Valid Regular Expressions\"></a>Generated Valid Regular Expressions</h2><p>We want to write a function <code>generateRegex</code> that will select <code>n</code> random characters from the <code>regexGrammar</code> and concatenate them together into a string. This string will be used to create a test regex.</p>\n<p>Here are three possible returns values of <code>generateRegex</code>:</p>\n<ol>\n<li><code>.AnrQ?QNLQX.syBsOcJlbJZd</code></li>\n<li><code>.LkuZ?Ynj</code></li>\n<li><code>.UN?eiyddhXvyNj</code></li>\n</ol>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">generateRegex</span>(<span class=\"params\">n</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> regexString = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>(n)</span><br><span class=\"line\">    .fill(<span class=\"number\">0</span>)</span><br><span class=\"line\">    .map(chooseOne)</span><br><span class=\"line\">    .join(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> regexString;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Pick one element randomly from the grammar and return it</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">chooseOne</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> regexGrammar[<span class=\"built_in\">Math</span>.floor(<span class=\"built_in\">Math</span>.random() * regexGrammar.length)];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Removing-Invalid-Regex-Strings\"><a href=\"#Removing-Invalid-Regex-Strings\" class=\"headerlink\" title=\"Removing Invalid Regex Strings\"></a>Removing Invalid Regex Strings</h2><p>My regex engine only deals with a very small subset of available regex syntax, and furthermore, it does not contain any error handling. What happens if <code>generateRegex</code> returns the pattern <code>**</code> or <code>^*</code>? My regex engine was never designed to handle these inputs, though they are possible outputs of <code>generateRegex</code>. We need to make a choice about how to handle these expressions. Since the primary goal of my regex engine is accessibility and simplicity of implementation, I’m not about to begin supporting these edge cases. That means my fuzzer should not generate them either.</p>\n<p>One solution to determine if a given regex string is valid is to specify my regex engine’s allowable grammar in <a href=\"https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form\" target=\"_blank\" rel=\"noopener\">BNF</a>. BNF is a formal notation for specifying the syntax of a language. Given this BNF notation, I could ask another program if the randomly generated regex string can be created using my BNF specification. This sounds like a little more work than I want, however, since the invalid cases can simply be manually enumerated and filtered.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">validRegex</span>(<span class=\"params\">regexString</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (</span><br><span class=\"line\">    <span class=\"comment\">// None of the following sequences are properly</span></span><br><span class=\"line\">    <span class=\"comment\">// defined by my regex engine</span></span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"**\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"??\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"*?\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"?*\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"^?\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    regexString.indexOf(<span class=\"string\">\"^*\"</span>) === <span class=\"number\">-1</span> &amp;&amp;</span><br><span class=\"line\">    !regexString.startsWith(<span class=\"string\">\"*\"</span>) &amp;&amp;</span><br><span class=\"line\">    !regexString.startsWith(<span class=\"string\">\"?\"</span>)</span><br><span class=\"line\">  );</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">generateRegex</span>(<span class=\"params\">n</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> regexString = <span class=\"keyword\">new</span> <span class=\"built_in\">Array</span>(n)</span><br><span class=\"line\">    .fill(<span class=\"number\">0</span>)</span><br><span class=\"line\">    .map(chooseOne)</span><br><span class=\"line\">    .join(<span class=\"string\">\"\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// If the generated string is valid, return it</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (validRegex(regexString)) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> regexString;</span><br><span class=\"line\">  <span class=\"comment\">// Otherwise generate a new string and return that</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> generateRegexString(n);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>One more modification to <code>generateRegex</code> is necessary to support <code>^</code> and <code>$</code>, and then we are basically done.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">generateRegex</span>(<span class=\"params\">n</span>) </span>&#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  <span class=\"comment\">// We need to ensure that '^' and '$' only go at the beginning</span></span><br><span class=\"line\">  <span class=\"comment\">// and the end of the string, respectively.</span></span><br><span class=\"line\">  <span class=\"comment\">// Give each a 10% probability of appearing in a string</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">Math</span>.random() &lt; <span class=\"number\">0.1</span>) regexString = <span class=\"string\">\"^\"</span> + regexString;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"built_in\">Math</span>.random() &lt; <span class=\"number\">0.1</span>) regexString = regexString + <span class=\"string\">\"$\"</span>;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Comparing-Regex-Implementations\"><a href=\"#Comparing-Regex-Implementations\" class=\"headerlink\" title=\"Comparing Regex Implementations\"></a>Comparing Regex Implementations</h2><p>All that is required now is to repeatedly invoke <code>generateRegex</code> a fixed number of times and then compare the output of the native JS implementation with the output of my implementation.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// The corpus is the string of text we are matching the pattern against.</span></span><br><span class=\"line\"><span class=\"comment\">// I used a segment of Gulliver's Travels from Project Gutenberg.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">fuzzer</span>(<span class=\"params\">totalTests, corpus</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> maxRegexLength = <span class=\"number\">50</span>; <span class=\"comment\">// max will actually be 50 - 1</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> testsRun = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (testsRun &lt; totalTests) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> regexLength = getRandomInt(<span class=\"number\">1</span>, maxRegexLength);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> regexString = generateRegexString(regexLength);</span><br><span class=\"line\">    <span class=\"keyword\">const</span> testRegex = <span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(regexString);</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      assert.equal(testRegex.test(corpus), myRegexEngine(regexString, corpus));</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">console</span>.log(testRegex);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    testsRun++;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Thank you Mozzila :)</span></span><br><span class=\"line\"><span class=\"comment\">// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRandomInt</span>(<span class=\"params\">min, max</span>) </span>&#123;</span><br><span class=\"line\">  min = <span class=\"built_in\">Math</span>.ceil(min);</span><br><span class=\"line\">  max = <span class=\"built_in\">Math</span>.floor(max);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"built_in\">Math</span>.floor(<span class=\"built_in\">Math</span>.random() * (max - min)) + min;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Results\"><a href=\"#Results\" class=\"headerlink\" title=\"Results\"></a>Results</h2><p>I ran my fuzzer for a couple million randomly generated cases and ended up learning two things about my regex engine.</p>\n<ol>\n<li><p>My implementation fails extraordinarily with longer texts. I knew recursion would be a problem for any practical regex implementation (at least without <a href=\"https://en.wikipedia.org/wiki/Tail_call\" target=\"_blank\" rel=\"noopener\">tail calls</a>) and would cause stack overflows, but I didn’t expect it to fail with texts that were only a couple thousand words. I think this is because I make liberal use of backtracking algorithms in <code>matchQuestion</code> and <code>matchStar</code>. Since I was forced to test with a relatively short input text, it makes sense to use multiple text inputs to increase the probability of discovering an error.</p>\n</li>\n<li><p>My implementation treats the <code>.</code> character differently than the native implementation. In the RegExp implementation, <code>.</code> will not match various line terminators (<code>\\n</code>, <code>\\r</code>, <code>\\u2028</code> or <code>\\u2029</code>). My implementation does.</p>\n</li>\n</ol>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>The biggest takeaway is that fuzzing is an simple and inexpensive way to enumerate enormous sets of inputs and identify bugs in your software. This fuzzer took less than an hour to write.</p>\n<p>But remember, this fuzzer’s blessing of a couple million input combinations <strong>does not</strong> verify the correctness of my program. Not even close. A fuzzer is a tool to identify potential errors. Unless you enumerate all possible inputs (completely impossible in this case where they are infinite), you are not guaranteed your program is error free.</p>"},{"title":"Optimizing Elasticsearch Score: How to Rank and Differentiate Similar Records","date":"2017-10-11T05:00:00.000Z","_content":"\nA client approached me with a puzzling problem:\n\nAt Fraight, we have an omnisearch interface backed by an Elasticsearch datastore. The interface allows users yo type a freetext query and get a list of database records sorted by relevancy. At it's core, this is a simple problem: if the user types in `Joe`, return all people whose name contains the word `Joe`. And indeed, returning all the `Joe's` in the system is trivial; the problem is that we worked hundreds, possibly even thousands of `Joes`. How do we identify the particular `Joe` that we care about?\n\n<!-- more -->\n\n## A Poor Solution\n\nWhen I worked at [Epic](https://www.epic.com/), we had a similar problem. We had a search interface that allowed us to look up patients. Unfortunately, our full names are not as unique as we like to believe, and a simple query for `Luke Smith` would surely bring the system to a halt. Epic solved this problem by providing additional fields. That's why (along with HIPPA reasons), when you call the doctor, they might ask for your birthdate or your address; this additional identifying information is used to pare down the search results. This solution is slow, cumbersome and was deemed wholly inadequate for us.\n\n## Fraight's Solution\n\nWe settled on two attributes that should influence the score of a particular record:\n\n1. How often we interact with an entity\n2. How recently we've interacted with an entity\n\nIt's important to know that most of the trucking organizations in our system have been worked with minimally. We needed a remove this noise from the search results. Phrased differently, if we regularly work with a particular `Great America Truckers` more than the other 1000 `Great America Truckers`, we want our partner to appear higher in the search results.\n\nSimilarly, if we have recently interacted with an organization, there's a good chance we will need to interact with them in the future. For example, if we've just initiated a conversation with a new business partner, there's a good chance we will continue interacting with them regularly in the near-term. It's important, however, to consider the time since our last interaction. If we interacted with someone yesterday or the day before, it's very important for them to be ranked higher than an organization we interacted with 10 days ago.\n\n## Getting the Data\n\nBoth of these solutions require populating our database with information regarding how recently we've interacted with particular entities. Fortunately, all of this can be done during the data ingestion phase when records are loaded in Elasticsearch. The only requirement is making sure to keep the information in Elasticsearch up to date with our PostgreSQL database\n\nThe one challenge with this solution is that it requires augmenting our documents with special data regarding total interactions and recency of interactions.  The huge advantage, however, is that it works seamlessly. We don't require there to be any special configuration when we begin working with a new partner.\n\n\n## Function Score Queries\n\nElasticsearch provides [function score queries](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html) that allow you to modify Elasticsearch's calculated score. Their documentation provides a really simple example explaining boost the relevancy of a document that has many `likes`:\n\n```JSON\nGET /_search\n{\n    \"query\": {\n        \"function_score\": {\n            \"field_value_factor\": {\n                \"field\": \"likes\",\n                \"factor\": 1.2,\n                \"modifier\": \"sqrt\",\n            }\n        }\n    }\n}\n```\n\nThis code says that every document's score will be `sqrt(1.2 * doc['likes'].value)`\n\nWe used a particular kind of Function Score Query known as a [Script Score](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score).\n\nWe wanted our ultimate score to be a function of three values: the score returned from elasticsearch, the days since our last interaction, and our total interactions. Initially, our function looked something like this\n\n`newscore` = _score * doc['interactions'] *\n\nWe found that Elasticsearch's relevancy score was being overwhelmed by parters with a high number of interactions, so much so that given a search term of `nick drane`, we might return `nick smith`, simply because we've worked with nick smith more.\n\nWe needed to place an upperbound of the potential contribution of the total interactions. After initially looking at [logistic functions](https://en.wikipedia.org/wiki/Logistic_function) and other overly complicated strategies, we settled on a simple step function. If the number of interactions is greater than 25, then we multiply Elasticsearch's relevancy score by 2, otherwise we multiply it 1.\n\nThe frequency contribution's function was similarly simple.\n\n\n(could be some density/decay function that looks at density of interactions over time)\n\n## challenges\n\nKeeping the extra attributes up to date\n\nWe did try to combine two guassian curves but couldn't get it working\n\n\n\nSometimes was built using a `query_string` query against the `_all` field. Sometimes the returned results were good, but most of the time they fell short.  Their problem was simple: how do we ensure that the\n\n\n\n\nhealth care\nselect based on recent claim\nselect based on scheduled appointment\nselect based on upcoming event\nspecify table to search","source":"_posts/optimizing-elasticsearch-score.md","raw":"---\ntitle: \"Optimizing Elasticsearch Score: How to Rank and Differentiate Similar Records\"\ndate: 2017-10-11\ncategories:\n  - [Elasticsearch]\n---\n\nA client approached me with a puzzling problem:\n\nAt Fraight, we have an omnisearch interface backed by an Elasticsearch datastore. The interface allows users yo type a freetext query and get a list of database records sorted by relevancy. At it's core, this is a simple problem: if the user types in `Joe`, return all people whose name contains the word `Joe`. And indeed, returning all the `Joe's` in the system is trivial; the problem is that we worked hundreds, possibly even thousands of `Joes`. How do we identify the particular `Joe` that we care about?\n\n<!-- more -->\n\n## A Poor Solution\n\nWhen I worked at [Epic](https://www.epic.com/), we had a similar problem. We had a search interface that allowed us to look up patients. Unfortunately, our full names are not as unique as we like to believe, and a simple query for `Luke Smith` would surely bring the system to a halt. Epic solved this problem by providing additional fields. That's why (along with HIPPA reasons), when you call the doctor, they might ask for your birthdate or your address; this additional identifying information is used to pare down the search results. This solution is slow, cumbersome and was deemed wholly inadequate for us.\n\n## Fraight's Solution\n\nWe settled on two attributes that should influence the score of a particular record:\n\n1. How often we interact with an entity\n2. How recently we've interacted with an entity\n\nIt's important to know that most of the trucking organizations in our system have been worked with minimally. We needed a remove this noise from the search results. Phrased differently, if we regularly work with a particular `Great America Truckers` more than the other 1000 `Great America Truckers`, we want our partner to appear higher in the search results.\n\nSimilarly, if we have recently interacted with an organization, there's a good chance we will need to interact with them in the future. For example, if we've just initiated a conversation with a new business partner, there's a good chance we will continue interacting with them regularly in the near-term. It's important, however, to consider the time since our last interaction. If we interacted with someone yesterday or the day before, it's very important for them to be ranked higher than an organization we interacted with 10 days ago.\n\n## Getting the Data\n\nBoth of these solutions require populating our database with information regarding how recently we've interacted with particular entities. Fortunately, all of this can be done during the data ingestion phase when records are loaded in Elasticsearch. The only requirement is making sure to keep the information in Elasticsearch up to date with our PostgreSQL database\n\nThe one challenge with this solution is that it requires augmenting our documents with special data regarding total interactions and recency of interactions.  The huge advantage, however, is that it works seamlessly. We don't require there to be any special configuration when we begin working with a new partner.\n\n\n## Function Score Queries\n\nElasticsearch provides [function score queries](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html) that allow you to modify Elasticsearch's calculated score. Their documentation provides a really simple example explaining boost the relevancy of a document that has many `likes`:\n\n```JSON\nGET /_search\n{\n    \"query\": {\n        \"function_score\": {\n            \"field_value_factor\": {\n                \"field\": \"likes\",\n                \"factor\": 1.2,\n                \"modifier\": \"sqrt\",\n            }\n        }\n    }\n}\n```\n\nThis code says that every document's score will be `sqrt(1.2 * doc['likes'].value)`\n\nWe used a particular kind of Function Score Query known as a [Script Score](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score).\n\nWe wanted our ultimate score to be a function of three values: the score returned from elasticsearch, the days since our last interaction, and our total interactions. Initially, our function looked something like this\n\n`newscore` = _score * doc['interactions'] *\n\nWe found that Elasticsearch's relevancy score was being overwhelmed by parters with a high number of interactions, so much so that given a search term of `nick drane`, we might return `nick smith`, simply because we've worked with nick smith more.\n\nWe needed to place an upperbound of the potential contribution of the total interactions. After initially looking at [logistic functions](https://en.wikipedia.org/wiki/Logistic_function) and other overly complicated strategies, we settled on a simple step function. If the number of interactions is greater than 25, then we multiply Elasticsearch's relevancy score by 2, otherwise we multiply it 1.\n\nThe frequency contribution's function was similarly simple.\n\n\n(could be some density/decay function that looks at density of interactions over time)\n\n## challenges\n\nKeeping the extra attributes up to date\n\nWe did try to combine two guassian curves but couldn't get it working\n\n\n\nSometimes was built using a `query_string` query against the `_all` field. Sometimes the returned results were good, but most of the time they fell short.  Their problem was simple: how do we ensure that the\n\n\n\n\nhealth care\nselect based on recent claim\nselect based on scheduled appointment\nselect based on upcoming event\nspecify table to search","slug":"optimizing-elasticsearch-score","published":1,"updated":"2018-10-12T03:21:08.438Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vne000e67ozvfhdng9t","content":"<p>A client approached me with a puzzling problem:</p>\n<p>At Fraight, we have an omnisearch interface backed by an Elasticsearch datastore. The interface allows users yo type a freetext query and get a list of database records sorted by relevancy. At it’s core, this is a simple problem: if the user types in <code>Joe</code>, return all people whose name contains the word <code>Joe</code>. And indeed, returning all the <code>Joe&#39;s</code> in the system is trivial; the problem is that we worked hundreds, possibly even thousands of <code>Joes</code>. How do we identify the particular <code>Joe</code> that we care about?</p>\n<a id=\"more\"></a>\n<h2 id=\"A-Poor-Solution\"><a href=\"#A-Poor-Solution\" class=\"headerlink\" title=\"A Poor Solution\"></a>A Poor Solution</h2><p>When I worked at <a href=\"https://www.epic.com/\" target=\"_blank\" rel=\"noopener\">Epic</a>, we had a similar problem. We had a search interface that allowed us to look up patients. Unfortunately, our full names are not as unique as we like to believe, and a simple query for <code>Luke Smith</code> would surely bring the system to a halt. Epic solved this problem by providing additional fields. That’s why (along with HIPPA reasons), when you call the doctor, they might ask for your birthdate or your address; this additional identifying information is used to pare down the search results. This solution is slow, cumbersome and was deemed wholly inadequate for us.</p>\n<h2 id=\"Fraight’s-Solution\"><a href=\"#Fraight’s-Solution\" class=\"headerlink\" title=\"Fraight’s Solution\"></a>Fraight’s Solution</h2><p>We settled on two attributes that should influence the score of a particular record:</p>\n<ol>\n<li>How often we interact with an entity</li>\n<li>How recently we’ve interacted with an entity</li>\n</ol>\n<p>It’s important to know that most of the trucking organizations in our system have been worked with minimally. We needed a remove this noise from the search results. Phrased differently, if we regularly work with a particular <code>Great America Truckers</code> more than the other 1000 <code>Great America Truckers</code>, we want our partner to appear higher in the search results.</p>\n<p>Similarly, if we have recently interacted with an organization, there’s a good chance we will need to interact with them in the future. For example, if we’ve just initiated a conversation with a new business partner, there’s a good chance we will continue interacting with them regularly in the near-term. It’s important, however, to consider the time since our last interaction. If we interacted with someone yesterday or the day before, it’s very important for them to be ranked higher than an organization we interacted with 10 days ago.</p>\n<h2 id=\"Getting-the-Data\"><a href=\"#Getting-the-Data\" class=\"headerlink\" title=\"Getting the Data\"></a>Getting the Data</h2><p>Both of these solutions require populating our database with information regarding how recently we’ve interacted with particular entities. Fortunately, all of this can be done during the data ingestion phase when records are loaded in Elasticsearch. The only requirement is making sure to keep the information in Elasticsearch up to date with our PostgreSQL database</p>\n<p>The one challenge with this solution is that it requires augmenting our documents with special data regarding total interactions and recency of interactions.  The huge advantage, however, is that it works seamlessly. We don’t require there to be any special configuration when we begin working with a new partner.</p>\n<h2 id=\"Function-Score-Queries\"><a href=\"#Function-Score-Queries\" class=\"headerlink\" title=\"Function Score Queries\"></a>Function Score Queries</h2><p>Elasticsearch provides <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html\" target=\"_blank\" rel=\"noopener\">function score queries</a> that allow you to modify Elasticsearch’s calculated score. Their documentation provides a really simple example explaining boost the relevancy of a document that has many <code>likes</code>:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"query\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"function_score\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"attr\">\"field_value_factor\"</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">\"field\"</span>: <span class=\"string\">\"likes\"</span>,</span><br><span class=\"line\">                <span class=\"attr\">\"factor\"</span>: <span class=\"number\">1.2</span>,</span><br><span class=\"line\">                <span class=\"attr\">\"modifier\"</span>: <span class=\"string\">\"sqrt\"</span>,</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>This code says that every document’s score will be <code>sqrt(1.2 * doc[&#39;likes&#39;].value)</code></p>\n<p>We used a particular kind of Function Score Query known as a <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score\" target=\"_blank\" rel=\"noopener\">Script Score</a>.</p>\n<p>We wanted our ultimate score to be a function of three values: the score returned from elasticsearch, the days since our last interaction, and our total interactions. Initially, our function looked something like this</p>\n<p><code>newscore</code> = _score <em> doc[‘interactions’] </em></p>\n<p>We found that Elasticsearch’s relevancy score was being overwhelmed by parters with a high number of interactions, so much so that given a search term of <code>nick drane</code>, we might return <code>nick smith</code>, simply because we’ve worked with nick smith more.</p>\n<p>We needed to place an upperbound of the potential contribution of the total interactions. After initially looking at <a href=\"https://en.wikipedia.org/wiki/Logistic_function\" target=\"_blank\" rel=\"noopener\">logistic functions</a> and other overly complicated strategies, we settled on a simple step function. If the number of interactions is greater than 25, then we multiply Elasticsearch’s relevancy score by 2, otherwise we multiply it 1.</p>\n<p>The frequency contribution’s function was similarly simple.</p>\n<p>(could be some density/decay function that looks at density of interactions over time)</p>\n<h2 id=\"challenges\"><a href=\"#challenges\" class=\"headerlink\" title=\"challenges\"></a>challenges</h2><p>Keeping the extra attributes up to date</p>\n<p>We did try to combine two guassian curves but couldn’t get it working</p>\n<p>Sometimes was built using a <code>query_string</code> query against the <code>_all</code> field. Sometimes the returned results were good, but most of the time they fell short.  Their problem was simple: how do we ensure that the</p>\n<p>health care<br>select based on recent claim<br>select based on scheduled appointment<br>select based on upcoming event<br>specify table to search</p>\n","site":{"data":{}},"excerpt":"<p>A client approached me with a puzzling problem:</p>\n<p>At Fraight, we have an omnisearch interface backed by an Elasticsearch datastore. The interface allows users yo type a freetext query and get a list of database records sorted by relevancy. At it’s core, this is a simple problem: if the user types in <code>Joe</code>, return all people whose name contains the word <code>Joe</code>. And indeed, returning all the <code>Joe&#39;s</code> in the system is trivial; the problem is that we worked hundreds, possibly even thousands of <code>Joes</code>. How do we identify the particular <code>Joe</code> that we care about?</p>","more":"<h2 id=\"A-Poor-Solution\"><a href=\"#A-Poor-Solution\" class=\"headerlink\" title=\"A Poor Solution\"></a>A Poor Solution</h2><p>When I worked at <a href=\"https://www.epic.com/\" target=\"_blank\" rel=\"noopener\">Epic</a>, we had a similar problem. We had a search interface that allowed us to look up patients. Unfortunately, our full names are not as unique as we like to believe, and a simple query for <code>Luke Smith</code> would surely bring the system to a halt. Epic solved this problem by providing additional fields. That’s why (along with HIPPA reasons), when you call the doctor, they might ask for your birthdate or your address; this additional identifying information is used to pare down the search results. This solution is slow, cumbersome and was deemed wholly inadequate for us.</p>\n<h2 id=\"Fraight’s-Solution\"><a href=\"#Fraight’s-Solution\" class=\"headerlink\" title=\"Fraight’s Solution\"></a>Fraight’s Solution</h2><p>We settled on two attributes that should influence the score of a particular record:</p>\n<ol>\n<li>How often we interact with an entity</li>\n<li>How recently we’ve interacted with an entity</li>\n</ol>\n<p>It’s important to know that most of the trucking organizations in our system have been worked with minimally. We needed a remove this noise from the search results. Phrased differently, if we regularly work with a particular <code>Great America Truckers</code> more than the other 1000 <code>Great America Truckers</code>, we want our partner to appear higher in the search results.</p>\n<p>Similarly, if we have recently interacted with an organization, there’s a good chance we will need to interact with them in the future. For example, if we’ve just initiated a conversation with a new business partner, there’s a good chance we will continue interacting with them regularly in the near-term. It’s important, however, to consider the time since our last interaction. If we interacted with someone yesterday or the day before, it’s very important for them to be ranked higher than an organization we interacted with 10 days ago.</p>\n<h2 id=\"Getting-the-Data\"><a href=\"#Getting-the-Data\" class=\"headerlink\" title=\"Getting the Data\"></a>Getting the Data</h2><p>Both of these solutions require populating our database with information regarding how recently we’ve interacted with particular entities. Fortunately, all of this can be done during the data ingestion phase when records are loaded in Elasticsearch. The only requirement is making sure to keep the information in Elasticsearch up to date with our PostgreSQL database</p>\n<p>The one challenge with this solution is that it requires augmenting our documents with special data regarding total interactions and recency of interactions.  The huge advantage, however, is that it works seamlessly. We don’t require there to be any special configuration when we begin working with a new partner.</p>\n<h2 id=\"Function-Score-Queries\"><a href=\"#Function-Score-Queries\" class=\"headerlink\" title=\"Function Score Queries\"></a>Function Score Queries</h2><p>Elasticsearch provides <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html\" target=\"_blank\" rel=\"noopener\">function score queries</a> that allow you to modify Elasticsearch’s calculated score. Their documentation provides a really simple example explaining boost the relevancy of a document that has many <code>likes</code>:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /_search</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">\"query\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">\"function_score\"</span>: &#123;</span><br><span class=\"line\">            <span class=\"attr\">\"field_value_factor\"</span>: &#123;</span><br><span class=\"line\">                <span class=\"attr\">\"field\"</span>: <span class=\"string\">\"likes\"</span>,</span><br><span class=\"line\">                <span class=\"attr\">\"factor\"</span>: <span class=\"number\">1.2</span>,</span><br><span class=\"line\">                <span class=\"attr\">\"modifier\"</span>: <span class=\"string\">\"sqrt\"</span>,</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>This code says that every document’s score will be <code>sqrt(1.2 * doc[&#39;likes&#39;].value)</code></p>\n<p>We used a particular kind of Function Score Query known as a <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score\" target=\"_blank\" rel=\"noopener\">Script Score</a>.</p>\n<p>We wanted our ultimate score to be a function of three values: the score returned from elasticsearch, the days since our last interaction, and our total interactions. Initially, our function looked something like this</p>\n<p><code>newscore</code> = _score <em> doc[‘interactions’] </em></p>\n<p>We found that Elasticsearch’s relevancy score was being overwhelmed by parters with a high number of interactions, so much so that given a search term of <code>nick drane</code>, we might return <code>nick smith</code>, simply because we’ve worked with nick smith more.</p>\n<p>We needed to place an upperbound of the potential contribution of the total interactions. After initially looking at <a href=\"https://en.wikipedia.org/wiki/Logistic_function\" target=\"_blank\" rel=\"noopener\">logistic functions</a> and other overly complicated strategies, we settled on a simple step function. If the number of interactions is greater than 25, then we multiply Elasticsearch’s relevancy score by 2, otherwise we multiply it 1.</p>\n<p>The frequency contribution’s function was similarly simple.</p>\n<p>(could be some density/decay function that looks at density of interactions over time)</p>\n<h2 id=\"challenges\"><a href=\"#challenges\" class=\"headerlink\" title=\"challenges\"></a>challenges</h2><p>Keeping the extra attributes up to date</p>\n<p>We did try to combine two guassian curves but couldn’t get it working</p>\n<p>Sometimes was built using a <code>query_string</code> query against the <code>_all</code> field. Sometimes the returned results were good, but most of the time they fell short.  Their problem was simple: how do we ensure that the</p>\n<p>health care<br>select based on recent claim<br>select based on scheduled appointment<br>select based on upcoming event<br>specify table to search</p>"},{"title":"You're Hiring Programmers Wrong: A Case for Interview Standardization","date":"2018-03-20T22:03:01.000Z","_content":"\nI've conducted about 100 technical interviews over the past 6 months for a software development recruiting company called [Triplebyte](https://triplebyte.com/iv/RrzqKKw/bp). I've also been doing consulting work, which has required me to take numerous technical interviews. It's interesting contrasting the experiences to identify what works and what doesn't.\n\nEvery Triplebyte interview begins with the candidate coding a short game. We have a series of steps, and each step precisely defines simple requirements for the program to handle. I can generally tell a couple minutes into the 2 hour interview whether the candidate will be successful. There are certainly outliers (as well as mechanisms to prevent bias), but in general, I can quickly ascertain how well a candidate stacks up technically. So then, it begs the question, why is it so hard to hire engineers? The answer is, most of us are doing it wrong.\n\n<!-- more -->\n\n## Interview Standardization\n\nAbout 12 months ago, while running [Fullstack Academy's](https://www.fullstackacademy.com/) Chicago campus, I was looking to hire a qualified instructor. Our interview consisted of live lecture as well as a mock 1-1 teaching session, where the candidate was required to guide me (playing the role of a struggling student) through a simple recursion problem. The latter exercise was almost always a better indicator of instructor fit than the former. The reason was simple: the latter exercise was assigned to the candidate whereas the lecture topic was their choice. This meant that every lecture topic was different and made lectures difficult to compare. In contrast, after having seen dozens of candidates attempt to teach me the same recursion problem, it was obvious who stood out.\n\nThe first mistake that companies make is that they fail to standardize the interview across candidates. As interviewers, it's tempting to say, \"let's have the candidate pair with us, that way we can see how they perform on real day-to-day challenges.\" Or another fault I've seen committed: give some candidates one problem and other candidates a different problem. This way a company can protect against its problems getting leaked online, right?\n\nThe issue is, as an interviewer, unless you have witnessed a dozen candidates attempt a given problem, it's very challenging to assess their abilities. It's easy to fall victim to the \"I solved it, why can't they\" bias. You need to compare candidates to each other to assess who did a good job and who didn't. Which brings me to my next point.\n\n## Objective Scoring\n\nYou need to compare candidates objectively, scoring them on every exercise across a variety of factors. There must be well-defined criteria to differentiate scores, and scoring should be done immediately upon completion of the exercise.\n\nSuppose our interviewer tasks the candidate to construct a simple web application. You assign a score of 1 through 4 to the following factors:\n\n1.  Productivity\n2.  Programming Style\n3.  Language/Framework Familiarity\n4.  Debugging Ability\n\nBeforehand, you would need to write a short description of what qualifies each score for each of the above factors. Then, during the interview, you will need a rubric to help you determine what score a candidate earns for each factor. Productivity can be measured exceptionally objectively if you have the candidate follow a prescribed series of steps to solve the programming challenge. For example, at Triplebyte, we literally tell them (loosely) what functions to write and in what order.\n\nAfter a week or two of interviewing a half dozen candidates, this scoring becomes critical and allows you avoid biases such as the [Serial-position effect](https://en.wikipedia.org/wiki/Serial-position_effect).\n\n## Culture Fit\n\nSurprisingly, a lot of this advice can also be applied to assessing culture fit. You can have the same person, ask the same questions, in the same order, using the same rubric to compare every answer. The risk is that you will inadvertently dehumanize the candidate, but it is possible to do this objective assessment such that the candidate is unaware of it. At the very least, you need to document your impression of the candidate immediately after the interview, lest you rely on your memory/feelings a week later when making a decision.\n\nYou could take this philosophy to the absurd, and it would certainly eliminate bias, though I personally believe there's a point of diminishing returns, at which you degrade the experience of the interviewee. Nevertheless, some standardization across interviews is critical to avoid implicit bias and identify good candidates, and I encourage every tech company to examine their interview process to assess their level of standardization.\n","source":"_posts/you're-hiring-programmers-wrong-a-case-for-interview-standardization.md","raw":"---\ntitle: \"You're Hiring Programmers Wrong: A Case for Interview Standardization\"\ncategories:\n  - [Technical Hiring]\ndate: 2018-03-20 17:03:01\n---\n\nI've conducted about 100 technical interviews over the past 6 months for a software development recruiting company called [Triplebyte](https://triplebyte.com/iv/RrzqKKw/bp). I've also been doing consulting work, which has required me to take numerous technical interviews. It's interesting contrasting the experiences to identify what works and what doesn't.\n\nEvery Triplebyte interview begins with the candidate coding a short game. We have a series of steps, and each step precisely defines simple requirements for the program to handle. I can generally tell a couple minutes into the 2 hour interview whether the candidate will be successful. There are certainly outliers (as well as mechanisms to prevent bias), but in general, I can quickly ascertain how well a candidate stacks up technically. So then, it begs the question, why is it so hard to hire engineers? The answer is, most of us are doing it wrong.\n\n<!-- more -->\n\n## Interview Standardization\n\nAbout 12 months ago, while running [Fullstack Academy's](https://www.fullstackacademy.com/) Chicago campus, I was looking to hire a qualified instructor. Our interview consisted of live lecture as well as a mock 1-1 teaching session, where the candidate was required to guide me (playing the role of a struggling student) through a simple recursion problem. The latter exercise was almost always a better indicator of instructor fit than the former. The reason was simple: the latter exercise was assigned to the candidate whereas the lecture topic was their choice. This meant that every lecture topic was different and made lectures difficult to compare. In contrast, after having seen dozens of candidates attempt to teach me the same recursion problem, it was obvious who stood out.\n\nThe first mistake that companies make is that they fail to standardize the interview across candidates. As interviewers, it's tempting to say, \"let's have the candidate pair with us, that way we can see how they perform on real day-to-day challenges.\" Or another fault I've seen committed: give some candidates one problem and other candidates a different problem. This way a company can protect against its problems getting leaked online, right?\n\nThe issue is, as an interviewer, unless you have witnessed a dozen candidates attempt a given problem, it's very challenging to assess their abilities. It's easy to fall victim to the \"I solved it, why can't they\" bias. You need to compare candidates to each other to assess who did a good job and who didn't. Which brings me to my next point.\n\n## Objective Scoring\n\nYou need to compare candidates objectively, scoring them on every exercise across a variety of factors. There must be well-defined criteria to differentiate scores, and scoring should be done immediately upon completion of the exercise.\n\nSuppose our interviewer tasks the candidate to construct a simple web application. You assign a score of 1 through 4 to the following factors:\n\n1.  Productivity\n2.  Programming Style\n3.  Language/Framework Familiarity\n4.  Debugging Ability\n\nBeforehand, you would need to write a short description of what qualifies each score for each of the above factors. Then, during the interview, you will need a rubric to help you determine what score a candidate earns for each factor. Productivity can be measured exceptionally objectively if you have the candidate follow a prescribed series of steps to solve the programming challenge. For example, at Triplebyte, we literally tell them (loosely) what functions to write and in what order.\n\nAfter a week or two of interviewing a half dozen candidates, this scoring becomes critical and allows you avoid biases such as the [Serial-position effect](https://en.wikipedia.org/wiki/Serial-position_effect).\n\n## Culture Fit\n\nSurprisingly, a lot of this advice can also be applied to assessing culture fit. You can have the same person, ask the same questions, in the same order, using the same rubric to compare every answer. The risk is that you will inadvertently dehumanize the candidate, but it is possible to do this objective assessment such that the candidate is unaware of it. At the very least, you need to document your impression of the candidate immediately after the interview, lest you rely on your memory/feelings a week later when making a decision.\n\nYou could take this philosophy to the absurd, and it would certainly eliminate bias, though I personally believe there's a point of diminishing returns, at which you degrade the experience of the interviewee. Nevertheless, some standardization across interviews is critical to avoid implicit bias and identify good candidates, and I encourage every tech company to examine their interview process to assess their level of standardization.\n","slug":"you're-hiring-programmers-wrong-a-case-for-interview-standardization","published":1,"updated":"2018-09-30T20:53:11.209Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vnf000f67oz2pzqn5ta","content":"<p>I’ve conducted about 100 technical interviews over the past 6 months for a software development recruiting company called <a href=\"https://triplebyte.com/iv/RrzqKKw/bp\" target=\"_blank\" rel=\"noopener\">Triplebyte</a>. I’ve also been doing consulting work, which has required me to take numerous technical interviews. It’s interesting contrasting the experiences to identify what works and what doesn’t.</p>\n<p>Every Triplebyte interview begins with the candidate coding a short game. We have a series of steps, and each step precisely defines simple requirements for the program to handle. I can generally tell a couple minutes into the 2 hour interview whether the candidate will be successful. There are certainly outliers (as well as mechanisms to prevent bias), but in general, I can quickly ascertain how well a candidate stacks up technically. So then, it begs the question, why is it so hard to hire engineers? The answer is, most of us are doing it wrong.</p>\n<a id=\"more\"></a>\n<h2 id=\"Interview-Standardization\"><a href=\"#Interview-Standardization\" class=\"headerlink\" title=\"Interview Standardization\"></a>Interview Standardization</h2><p>About 12 months ago, while running <a href=\"https://www.fullstackacademy.com/\" target=\"_blank\" rel=\"noopener\">Fullstack Academy’s</a> Chicago campus, I was looking to hire a qualified instructor. Our interview consisted of live lecture as well as a mock 1-1 teaching session, where the candidate was required to guide me (playing the role of a struggling student) through a simple recursion problem. The latter exercise was almost always a better indicator of instructor fit than the former. The reason was simple: the latter exercise was assigned to the candidate whereas the lecture topic was their choice. This meant that every lecture topic was different and made lectures difficult to compare. In contrast, after having seen dozens of candidates attempt to teach me the same recursion problem, it was obvious who stood out.</p>\n<p>The first mistake that companies make is that they fail to standardize the interview across candidates. As interviewers, it’s tempting to say, “let’s have the candidate pair with us, that way we can see how they perform on real day-to-day challenges.” Or another fault I’ve seen committed: give some candidates one problem and other candidates a different problem. This way a company can protect against its problems getting leaked online, right?</p>\n<p>The issue is, as an interviewer, unless you have witnessed a dozen candidates attempt a given problem, it’s very challenging to assess their abilities. It’s easy to fall victim to the “I solved it, why can’t they” bias. You need to compare candidates to each other to assess who did a good job and who didn’t. Which brings me to my next point.</p>\n<h2 id=\"Objective-Scoring\"><a href=\"#Objective-Scoring\" class=\"headerlink\" title=\"Objective Scoring\"></a>Objective Scoring</h2><p>You need to compare candidates objectively, scoring them on every exercise across a variety of factors. There must be well-defined criteria to differentiate scores, and scoring should be done immediately upon completion of the exercise.</p>\n<p>Suppose our interviewer tasks the candidate to construct a simple web application. You assign a score of 1 through 4 to the following factors:</p>\n<ol>\n<li>Productivity</li>\n<li>Programming Style</li>\n<li>Language/Framework Familiarity</li>\n<li>Debugging Ability</li>\n</ol>\n<p>Beforehand, you would need to write a short description of what qualifies each score for each of the above factors. Then, during the interview, you will need a rubric to help you determine what score a candidate earns for each factor. Productivity can be measured exceptionally objectively if you have the candidate follow a prescribed series of steps to solve the programming challenge. For example, at Triplebyte, we literally tell them (loosely) what functions to write and in what order.</p>\n<p>After a week or two of interviewing a half dozen candidates, this scoring becomes critical and allows you avoid biases such as the <a href=\"https://en.wikipedia.org/wiki/Serial-position_effect\" target=\"_blank\" rel=\"noopener\">Serial-position effect</a>.</p>\n<h2 id=\"Culture-Fit\"><a href=\"#Culture-Fit\" class=\"headerlink\" title=\"Culture Fit\"></a>Culture Fit</h2><p>Surprisingly, a lot of this advice can also be applied to assessing culture fit. You can have the same person, ask the same questions, in the same order, using the same rubric to compare every answer. The risk is that you will inadvertently dehumanize the candidate, but it is possible to do this objective assessment such that the candidate is unaware of it. At the very least, you need to document your impression of the candidate immediately after the interview, lest you rely on your memory/feelings a week later when making a decision.</p>\n<p>You could take this philosophy to the absurd, and it would certainly eliminate bias, though I personally believe there’s a point of diminishing returns, at which you degrade the experience of the interviewee. Nevertheless, some standardization across interviews is critical to avoid implicit bias and identify good candidates, and I encourage every tech company to examine their interview process to assess their level of standardization.</p>\n","site":{"data":{}},"excerpt":"<p>I’ve conducted about 100 technical interviews over the past 6 months for a software development recruiting company called <a href=\"https://triplebyte.com/iv/RrzqKKw/bp\" target=\"_blank\" rel=\"noopener\">Triplebyte</a>. I’ve also been doing consulting work, which has required me to take numerous technical interviews. It’s interesting contrasting the experiences to identify what works and what doesn’t.</p>\n<p>Every Triplebyte interview begins with the candidate coding a short game. We have a series of steps, and each step precisely defines simple requirements for the program to handle. I can generally tell a couple minutes into the 2 hour interview whether the candidate will be successful. There are certainly outliers (as well as mechanisms to prevent bias), but in general, I can quickly ascertain how well a candidate stacks up technically. So then, it begs the question, why is it so hard to hire engineers? The answer is, most of us are doing it wrong.</p>","more":"<h2 id=\"Interview-Standardization\"><a href=\"#Interview-Standardization\" class=\"headerlink\" title=\"Interview Standardization\"></a>Interview Standardization</h2><p>About 12 months ago, while running <a href=\"https://www.fullstackacademy.com/\" target=\"_blank\" rel=\"noopener\">Fullstack Academy’s</a> Chicago campus, I was looking to hire a qualified instructor. Our interview consisted of live lecture as well as a mock 1-1 teaching session, where the candidate was required to guide me (playing the role of a struggling student) through a simple recursion problem. The latter exercise was almost always a better indicator of instructor fit than the former. The reason was simple: the latter exercise was assigned to the candidate whereas the lecture topic was their choice. This meant that every lecture topic was different and made lectures difficult to compare. In contrast, after having seen dozens of candidates attempt to teach me the same recursion problem, it was obvious who stood out.</p>\n<p>The first mistake that companies make is that they fail to standardize the interview across candidates. As interviewers, it’s tempting to say, “let’s have the candidate pair with us, that way we can see how they perform on real day-to-day challenges.” Or another fault I’ve seen committed: give some candidates one problem and other candidates a different problem. This way a company can protect against its problems getting leaked online, right?</p>\n<p>The issue is, as an interviewer, unless you have witnessed a dozen candidates attempt a given problem, it’s very challenging to assess their abilities. It’s easy to fall victim to the “I solved it, why can’t they” bias. You need to compare candidates to each other to assess who did a good job and who didn’t. Which brings me to my next point.</p>\n<h2 id=\"Objective-Scoring\"><a href=\"#Objective-Scoring\" class=\"headerlink\" title=\"Objective Scoring\"></a>Objective Scoring</h2><p>You need to compare candidates objectively, scoring them on every exercise across a variety of factors. There must be well-defined criteria to differentiate scores, and scoring should be done immediately upon completion of the exercise.</p>\n<p>Suppose our interviewer tasks the candidate to construct a simple web application. You assign a score of 1 through 4 to the following factors:</p>\n<ol>\n<li>Productivity</li>\n<li>Programming Style</li>\n<li>Language/Framework Familiarity</li>\n<li>Debugging Ability</li>\n</ol>\n<p>Beforehand, you would need to write a short description of what qualifies each score for each of the above factors. Then, during the interview, you will need a rubric to help you determine what score a candidate earns for each factor. Productivity can be measured exceptionally objectively if you have the candidate follow a prescribed series of steps to solve the programming challenge. For example, at Triplebyte, we literally tell them (loosely) what functions to write and in what order.</p>\n<p>After a week or two of interviewing a half dozen candidates, this scoring becomes critical and allows you avoid biases such as the <a href=\"https://en.wikipedia.org/wiki/Serial-position_effect\" target=\"_blank\" rel=\"noopener\">Serial-position effect</a>.</p>\n<h2 id=\"Culture-Fit\"><a href=\"#Culture-Fit\" class=\"headerlink\" title=\"Culture Fit\"></a>Culture Fit</h2><p>Surprisingly, a lot of this advice can also be applied to assessing culture fit. You can have the same person, ask the same questions, in the same order, using the same rubric to compare every answer. The risk is that you will inadvertently dehumanize the candidate, but it is possible to do this objective assessment such that the candidate is unaware of it. At the very least, you need to document your impression of the candidate immediately after the interview, lest you rely on your memory/feelings a week later when making a decision.</p>\n<p>You could take this philosophy to the absurd, and it would certainly eliminate bias, though I personally believe there’s a point of diminishing returns, at which you degrade the experience of the interviewee. Nevertheless, some standardization across interviews is critical to avoid implicit bias and identify good candidates, and I encourage every tech company to examine their interview process to assess their level of standardization.</p>"},{"title":"Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL","date":"2018-10-18T05:00:00.000Z","_content":"\nI recently wanted to ingest a [line-delimited](https://en.wikipedia.org/wiki/JSON_streaming#Line-delimited_JSON) JSON file into [Postgres](https://www.postgresql.org/) for some quick data exploration. I was surprised when I couldn't find a simple solution that parsed and broke apart the JSON, loading each field into its own column. Here is my approach.\n\n<!-- more -->\n\n## Downloading 250000 Hacker News Comments\n\nLet's say we want to download all of the [Hacker News](https://news.ycombinator.com/) comments from the month of May. A line-delimited JSON file is available from [pushshift](https://files.pushshift.io/hackernews/HNI_2018-05.bz2). Fetching and decompressing the file is simple:\n\n```bash\ncurl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 | bzip2 -d\n```\n\nHere is what the dataset looks like:\n\n```JSON\n{\n  \"by\": \"criddell\",\n  \"id\": 16966059,\n  \"kids\": [\n    16966312,\n    16966776,\n    16969455,\n    16966323\n  ],\n  \"parent\": 16965363,\n  \"retrieved_on\": 1528401399,\n  \"text\": \"Yeah - there's always a HATEOAS comment somewhere and...\",\n  \"time\": 1525173078,\n  \"type\": \"comment\"\n}\n```\n\n## Formatting the Data\n\nYou might think that Postgres has a simple utility for loading line-delimited JSON. Like me, you'd be wrong. It's all the more surprising given that it has a [COPY](https://www.postgresql.org/docs/current/static/sql-copy.html) utility that's designed to load data from files. Unfortunately, that utility only supports `text`, `csv`, and `binary` formats.\n\nTransforming our data into a CSV is a breeze with [jq](https://stedolan.github.io/jq/). We can pipe the JSON stream into the following command to extract the `id`, `by`, `parent`, and `text` fields. You can customize the command to extract whatever fields you like.\n\n```bash\njq -r '[.id, .by, .parent, .text] | @csv'\n```\n\nThe `-r` option indicates that we would like a raw string output, as opposed to JSON formatted with quotes. The `[.id, .by, .parent, .text]` part produces an array containing the desired fields and the pipe into `@csv` specifies the format. All that's left is to load the data into Postgres.\n\n## Ingesting the Data\n\nAfter creating the database\n\n`createdb comment_db`\n\nand applying the schema\n\n```SQL\nCREATE TABLE comment (\n    id INTEGER PRIMARY KEY,\n    by VARCHAR,\n    parent INTEGER,\n    text TEXT\n);\n```\n\nwe can hydrate our comments into `comment_db` using [psql](https://www.postgresql.org/docs/current/static/app-psql.html)\n\n```bash\npsql comment_db -c \"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)\"\n```\n\nNote that the fields specified above need to be in the same order as the fields in the CSV stream generated by `jq`.\n\nHere is the final command\n\n```bash\ncurl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 \\\n  | bzip2 -d \\\n  | jq -r '[.id, .by, .parent, .text] | @csv' \\\n  | psql comment_db -c \"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)\"\n```\n\n## Supporting Referential Integrity\n\nYou will notice that despite the fact that the `comment.parent` refers to a comment id, we have omitted a foreign key constraint.\nThis omission is because our command does not control for the order in which comments are loaded. We would have received constraint errors if we specified the foreign key relationship.\n\nWe can overcome this obstacle by sorting our incoming comments by id.\n\n```bash\ncurl https://files.pushshift.io/hackernews/HNI_2018-05.bz2\n  | bzip2 -d\n  | jq -s -r 'sort_by(.id) | .[] | [.id, .by, .parent, .text] | @csv'\n```\n\nIf you have a primary key that doesn't serially increase - perhaps you're using a [natural key](https://en.wikipedia.org/wiki/Natural_key) or a UUID as your primary key - then you could also sort on a `created_at` timestamp\n\nIf you have data ingestion or PostgreSQL related problems, I do [consulting](/hire-me) work out of Chicago area.\n\n","source":"_posts/using-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres.md","raw":"---\ntitle: Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL\ndate: 2018-10-18\ncategories:\n  - [Command Line]\n  - [Postgres]\n---\n\nI recently wanted to ingest a [line-delimited](https://en.wikipedia.org/wiki/JSON_streaming#Line-delimited_JSON) JSON file into [Postgres](https://www.postgresql.org/) for some quick data exploration. I was surprised when I couldn't find a simple solution that parsed and broke apart the JSON, loading each field into its own column. Here is my approach.\n\n<!-- more -->\n\n## Downloading 250000 Hacker News Comments\n\nLet's say we want to download all of the [Hacker News](https://news.ycombinator.com/) comments from the month of May. A line-delimited JSON file is available from [pushshift](https://files.pushshift.io/hackernews/HNI_2018-05.bz2). Fetching and decompressing the file is simple:\n\n```bash\ncurl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 | bzip2 -d\n```\n\nHere is what the dataset looks like:\n\n```JSON\n{\n  \"by\": \"criddell\",\n  \"id\": 16966059,\n  \"kids\": [\n    16966312,\n    16966776,\n    16969455,\n    16966323\n  ],\n  \"parent\": 16965363,\n  \"retrieved_on\": 1528401399,\n  \"text\": \"Yeah - there's always a HATEOAS comment somewhere and...\",\n  \"time\": 1525173078,\n  \"type\": \"comment\"\n}\n```\n\n## Formatting the Data\n\nYou might think that Postgres has a simple utility for loading line-delimited JSON. Like me, you'd be wrong. It's all the more surprising given that it has a [COPY](https://www.postgresql.org/docs/current/static/sql-copy.html) utility that's designed to load data from files. Unfortunately, that utility only supports `text`, `csv`, and `binary` formats.\n\nTransforming our data into a CSV is a breeze with [jq](https://stedolan.github.io/jq/). We can pipe the JSON stream into the following command to extract the `id`, `by`, `parent`, and `text` fields. You can customize the command to extract whatever fields you like.\n\n```bash\njq -r '[.id, .by, .parent, .text] | @csv'\n```\n\nThe `-r` option indicates that we would like a raw string output, as opposed to JSON formatted with quotes. The `[.id, .by, .parent, .text]` part produces an array containing the desired fields and the pipe into `@csv` specifies the format. All that's left is to load the data into Postgres.\n\n## Ingesting the Data\n\nAfter creating the database\n\n`createdb comment_db`\n\nand applying the schema\n\n```SQL\nCREATE TABLE comment (\n    id INTEGER PRIMARY KEY,\n    by VARCHAR,\n    parent INTEGER,\n    text TEXT\n);\n```\n\nwe can hydrate our comments into `comment_db` using [psql](https://www.postgresql.org/docs/current/static/app-psql.html)\n\n```bash\npsql comment_db -c \"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)\"\n```\n\nNote that the fields specified above need to be in the same order as the fields in the CSV stream generated by `jq`.\n\nHere is the final command\n\n```bash\ncurl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 \\\n  | bzip2 -d \\\n  | jq -r '[.id, .by, .parent, .text] | @csv' \\\n  | psql comment_db -c \"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)\"\n```\n\n## Supporting Referential Integrity\n\nYou will notice that despite the fact that the `comment.parent` refers to a comment id, we have omitted a foreign key constraint.\nThis omission is because our command does not control for the order in which comments are loaded. We would have received constraint errors if we specified the foreign key relationship.\n\nWe can overcome this obstacle by sorting our incoming comments by id.\n\n```bash\ncurl https://files.pushshift.io/hackernews/HNI_2018-05.bz2\n  | bzip2 -d\n  | jq -s -r 'sort_by(.id) | .[] | [.id, .by, .parent, .text] | @csv'\n```\n\nIf you have a primary key that doesn't serially increase - perhaps you're using a [natural key](https://en.wikipedia.org/wiki/Natural_key) or a UUID as your primary key - then you could also sort on a `created_at` timestamp\n\nIf you have data ingestion or PostgreSQL related problems, I do [consulting](/hire-me) work out of Chicago area.\n\n","slug":"using-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres","published":1,"updated":"2018-10-20T03:32:00.071Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vnf000g67ozw503p2zb","content":"<p>I recently wanted to ingest a <a href=\"https://en.wikipedia.org/wiki/JSON_streaming#Line-delimited_JSON\" target=\"_blank\" rel=\"noopener\">line-delimited</a> JSON file into <a href=\"https://www.postgresql.org/\" target=\"_blank\" rel=\"noopener\">Postgres</a> for some quick data exploration. I was surprised when I couldn’t find a simple solution that parsed and broke apart the JSON, loading each field into its own column. Here is my approach.</p>\n<a id=\"more\"></a>\n<h2 id=\"Downloading-250000-Hacker-News-Comments\"><a href=\"#Downloading-250000-Hacker-News-Comments\" class=\"headerlink\" title=\"Downloading 250000 Hacker News Comments\"></a>Downloading 250000 Hacker News Comments</h2><p>Let’s say we want to download all of the <a href=\"https://news.ycombinator.com/\" target=\"_blank\" rel=\"noopener\">Hacker News</a> comments from the month of May. A line-delimited JSON file is available from <a href=\"https://files.pushshift.io/hackernews/HNI_2018-05.bz2\" target=\"_blank\" rel=\"noopener\">pushshift</a>. Fetching and decompressing the file is simple:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 | bzip2 -d</span><br></pre></td></tr></table></figure>\n<p>Here is what the dataset looks like:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"by\"</span>: <span class=\"string\">\"criddell\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"id\"</span>: <span class=\"number\">16966059</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"kids\"</span>: [</span><br><span class=\"line\">    <span class=\"number\">16966312</span>,</span><br><span class=\"line\">    <span class=\"number\">16966776</span>,</span><br><span class=\"line\">    <span class=\"number\">16969455</span>,</span><br><span class=\"line\">    <span class=\"number\">16966323</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">\"parent\"</span>: <span class=\"number\">16965363</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"retrieved_on\"</span>: <span class=\"number\">1528401399</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"text\"</span>: <span class=\"string\">\"Yeah - there's always a HATEOAS comment somewhere and...\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"time\"</span>: <span class=\"number\">1525173078</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"type\"</span>: <span class=\"string\">\"comment\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Formatting-the-Data\"><a href=\"#Formatting-the-Data\" class=\"headerlink\" title=\"Formatting the Data\"></a>Formatting the Data</h2><p>You might think that Postgres has a simple utility for loading line-delimited JSON. Like me, you’d be wrong. It’s all the more surprising given that it has a <a href=\"https://www.postgresql.org/docs/current/static/sql-copy.html\" target=\"_blank\" rel=\"noopener\">COPY</a> utility that’s designed to load data from files. Unfortunately, that utility only supports <code>text</code>, <code>csv</code>, and <code>binary</code> formats.</p>\n<p>Transforming our data into a CSV is a breeze with <a href=\"https://stedolan.github.io/jq/\" target=\"_blank\" rel=\"noopener\">jq</a>. We can pipe the JSON stream into the following command to extract the <code>id</code>, <code>by</code>, <code>parent</code>, and <code>text</code> fields. You can customize the command to extract whatever fields you like.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jq -r <span class=\"string\">'[.id, .by, .parent, .text] | @csv'</span></span><br></pre></td></tr></table></figure>\n<p>The <code>-r</code> option indicates that we would like a raw string output, as opposed to JSON formatted with quotes. The <code>[.id, .by, .parent, .text]</code> part produces an array containing the desired fields and the pipe into <code>@csv</code> specifies the format. All that’s left is to load the data into Postgres.</p>\n<h2 id=\"Ingesting-the-Data\"><a href=\"#Ingesting-the-Data\" class=\"headerlink\" title=\"Ingesting the Data\"></a>Ingesting the Data</h2><p>After creating the database</p>\n<p><code>createdb comment_db</code></p>\n<p>and applying the schema</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> <span class=\"keyword\">comment</span> (</span><br><span class=\"line\">    <span class=\"keyword\">id</span> <span class=\"built_in\">INTEGER</span> PRIMARY <span class=\"keyword\">KEY</span>,</span><br><span class=\"line\">    <span class=\"keyword\">by</span> <span class=\"built_in\">VARCHAR</span>,</span><br><span class=\"line\">    <span class=\"keyword\">parent</span> <span class=\"built_in\">INTEGER</span>,</span><br><span class=\"line\">    <span class=\"built_in\">text</span> <span class=\"built_in\">TEXT</span></span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n<p>we can hydrate our comments into <code>comment_db</code> using <a href=\"https://www.postgresql.org/docs/current/static/app-psql.html\" target=\"_blank\" rel=\"noopener\">psql</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">psql comment_db -c <span class=\"string\">\"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)\"</span></span><br></pre></td></tr></table></figure>\n<p>Note that the fields specified above need to be in the same order as the fields in the CSV stream generated by <code>jq</code>.</p>\n<p>Here is the final command</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 \\</span><br><span class=\"line\">  | bzip2 -d \\</span><br><span class=\"line\">  | jq -r <span class=\"string\">'[.id, .by, .parent, .text] | @csv'</span> \\</span><br><span class=\"line\">  | psql comment_db -c <span class=\"string\">\"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)\"</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Supporting-Referential-Integrity\"><a href=\"#Supporting-Referential-Integrity\" class=\"headerlink\" title=\"Supporting Referential Integrity\"></a>Supporting Referential Integrity</h2><p>You will notice that despite the fact that the <code>comment.parent</code> refers to a comment id, we have omitted a foreign key constraint.<br>This omission is because our command does not control for the order in which comments are loaded. We would have received constraint errors if we specified the foreign key relationship.</p>\n<p>We can overcome this obstacle by sorting our incoming comments by id.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://files.pushshift.io/hackernews/HNI_2018-05.bz2</span><br><span class=\"line\">  | bzip2 -d</span><br><span class=\"line\">  | jq -s -r <span class=\"string\">'sort_by(.id) | .[] | [.id, .by, .parent, .text] | @csv'</span></span><br></pre></td></tr></table></figure>\n<p>If you have a primary key that doesn’t serially increase - perhaps you’re using a <a href=\"https://en.wikipedia.org/wiki/Natural_key\" target=\"_blank\" rel=\"noopener\">natural key</a> or a UUID as your primary key - then you could also sort on a <code>created_at</code> timestamp</p>\n<p>If you have data ingestion or PostgreSQL related problems, I do <a href=\"/hire-me\">consulting</a> work out of Chicago area.</p>\n","site":{"data":{}},"excerpt":"<p>I recently wanted to ingest a <a href=\"https://en.wikipedia.org/wiki/JSON_streaming#Line-delimited_JSON\" target=\"_blank\" rel=\"noopener\">line-delimited</a> JSON file into <a href=\"https://www.postgresql.org/\" target=\"_blank\" rel=\"noopener\">Postgres</a> for some quick data exploration. I was surprised when I couldn’t find a simple solution that parsed and broke apart the JSON, loading each field into its own column. Here is my approach.</p>","more":"<h2 id=\"Downloading-250000-Hacker-News-Comments\"><a href=\"#Downloading-250000-Hacker-News-Comments\" class=\"headerlink\" title=\"Downloading 250000 Hacker News Comments\"></a>Downloading 250000 Hacker News Comments</h2><p>Let’s say we want to download all of the <a href=\"https://news.ycombinator.com/\" target=\"_blank\" rel=\"noopener\">Hacker News</a> comments from the month of May. A line-delimited JSON file is available from <a href=\"https://files.pushshift.io/hackernews/HNI_2018-05.bz2\" target=\"_blank\" rel=\"noopener\">pushshift</a>. Fetching and decompressing the file is simple:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 | bzip2 -d</span><br></pre></td></tr></table></figure>\n<p>Here is what the dataset looks like:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">\"by\"</span>: <span class=\"string\">\"criddell\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"id\"</span>: <span class=\"number\">16966059</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"kids\"</span>: [</span><br><span class=\"line\">    <span class=\"number\">16966312</span>,</span><br><span class=\"line\">    <span class=\"number\">16966776</span>,</span><br><span class=\"line\">    <span class=\"number\">16969455</span>,</span><br><span class=\"line\">    <span class=\"number\">16966323</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"attr\">\"parent\"</span>: <span class=\"number\">16965363</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"retrieved_on\"</span>: <span class=\"number\">1528401399</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"text\"</span>: <span class=\"string\">\"Yeah - there's always a HATEOAS comment somewhere and...\"</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"time\"</span>: <span class=\"number\">1525173078</span>,</span><br><span class=\"line\">  <span class=\"attr\">\"type\"</span>: <span class=\"string\">\"comment\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Formatting-the-Data\"><a href=\"#Formatting-the-Data\" class=\"headerlink\" title=\"Formatting the Data\"></a>Formatting the Data</h2><p>You might think that Postgres has a simple utility for loading line-delimited JSON. Like me, you’d be wrong. It’s all the more surprising given that it has a <a href=\"https://www.postgresql.org/docs/current/static/sql-copy.html\" target=\"_blank\" rel=\"noopener\">COPY</a> utility that’s designed to load data from files. Unfortunately, that utility only supports <code>text</code>, <code>csv</code>, and <code>binary</code> formats.</p>\n<p>Transforming our data into a CSV is a breeze with <a href=\"https://stedolan.github.io/jq/\" target=\"_blank\" rel=\"noopener\">jq</a>. We can pipe the JSON stream into the following command to extract the <code>id</code>, <code>by</code>, <code>parent</code>, and <code>text</code> fields. You can customize the command to extract whatever fields you like.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jq -r <span class=\"string\">'[.id, .by, .parent, .text] | @csv'</span></span><br></pre></td></tr></table></figure>\n<p>The <code>-r</code> option indicates that we would like a raw string output, as opposed to JSON formatted with quotes. The <code>[.id, .by, .parent, .text]</code> part produces an array containing the desired fields and the pipe into <code>@csv</code> specifies the format. All that’s left is to load the data into Postgres.</p>\n<h2 id=\"Ingesting-the-Data\"><a href=\"#Ingesting-the-Data\" class=\"headerlink\" title=\"Ingesting the Data\"></a>Ingesting the Data</h2><p>After creating the database</p>\n<p><code>createdb comment_db</code></p>\n<p>and applying the schema</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">TABLE</span> <span class=\"keyword\">comment</span> (</span><br><span class=\"line\">    <span class=\"keyword\">id</span> <span class=\"built_in\">INTEGER</span> PRIMARY <span class=\"keyword\">KEY</span>,</span><br><span class=\"line\">    <span class=\"keyword\">by</span> <span class=\"built_in\">VARCHAR</span>,</span><br><span class=\"line\">    <span class=\"keyword\">parent</span> <span class=\"built_in\">INTEGER</span>,</span><br><span class=\"line\">    <span class=\"built_in\">text</span> <span class=\"built_in\">TEXT</span></span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n<p>we can hydrate our comments into <code>comment_db</code> using <a href=\"https://www.postgresql.org/docs/current/static/app-psql.html\" target=\"_blank\" rel=\"noopener\">psql</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">psql comment_db -c <span class=\"string\">\"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)\"</span></span><br></pre></td></tr></table></figure>\n<p>Note that the fields specified above need to be in the same order as the fields in the CSV stream generated by <code>jq</code>.</p>\n<p>Here is the final command</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://files.pushshift.io/hackernews/HNI_2018-05.bz2 \\</span><br><span class=\"line\">  | bzip2 -d \\</span><br><span class=\"line\">  | jq -r <span class=\"string\">'[.id, .by, .parent, .text] | @csv'</span> \\</span><br><span class=\"line\">  | psql comment_db -c <span class=\"string\">\"COPY comment (id, by, parent, text) FROM STDIN WITH (FORMAT CSV)\"</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Supporting-Referential-Integrity\"><a href=\"#Supporting-Referential-Integrity\" class=\"headerlink\" title=\"Supporting Referential Integrity\"></a>Supporting Referential Integrity</h2><p>You will notice that despite the fact that the <code>comment.parent</code> refers to a comment id, we have omitted a foreign key constraint.<br>This omission is because our command does not control for the order in which comments are loaded. We would have received constraint errors if we specified the foreign key relationship.</p>\n<p>We can overcome this obstacle by sorting our incoming comments by id.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://files.pushshift.io/hackernews/HNI_2018-05.bz2</span><br><span class=\"line\">  | bzip2 -d</span><br><span class=\"line\">  | jq -s -r <span class=\"string\">'sort_by(.id) | .[] | [.id, .by, .parent, .text] | @csv'</span></span><br></pre></td></tr></table></figure>\n<p>If you have a primary key that doesn’t serially increase - perhaps you’re using a <a href=\"https://en.wikipedia.org/wiki/Natural_key\" target=\"_blank\" rel=\"noopener\">natural key</a> or a UUID as your primary key - then you could also sort on a <code>created_at</code> timestamp</p>\n<p>If you have data ingestion or PostgreSQL related problems, I do <a href=\"/hire-me\">consulting</a> work out of Chicago area.</p>"},{"title":"Build Your Own Nested Query String Encoder/Decoder","date":"2018-04-13T20:17:00.000Z","_content":"\nThe other day at work, one of my colleagues was frustrated that he was unable to encode nested objects in a query string and still maintain a readable URL. I went home that night and coded up a simple solution to this problem, and I thought I'd share it here today. This [Github repo](https://github.com/nadrane/querystring-encoder) contains specs and the solution code.\n\n<!-- more -->\n\n## Motivation\n\nToday, in the Node.js ecosystem, numerous modules exist to encode query strings, but they generally have one of two flaws:\n\n1.  They do not permit the encoding of nested objects.\n\n2.  They can encode nested objects, but they delimit nesting using unsafe URL characters, yielding an operation and a result that look like this <sup>[1](#footnote1)</sup>:\n\n```js\nencode({\n  a: { b: 'c' }\n});\n>>>`a%5Bb%5D=c`\n```\n\n## The Problem in Detail\n\nNode.js provides a [`querystring`](https://nodejs.org/api/querystring.html) module to encode objects to query strings. The only problem is that conforms to an official specification that doesn't allow nested objects. Unfortunately, this specification does not allow for enough flexibility when creating a RESTful API.\n\nFor example, suppose the client wants to filter a collection of cars by make and model. The route might look like this:\n\n`/api/cars?make=honda&model=civic`\n\nThis URI makes it reasonably clear that we want to filter cars by their make and model.\n\nWhat if we wanted to do something more complicated. What if we wanted to filter cars and order them by price?\n\n`/api/cars?order=price&make=honda&model=civic`\n\nIt's no longer clear which query parameters describe the ordering and which describe the filter. Ideally, we want the url to look like this:\n\n`/api/cars?order=price&filter.make=honda&filter.model=civic`\n\nIf we were to represent the query string of the above URI as a Javascript object, it would probably look like this:\n\n```js\n{\n    order: \"price\",\n    filter: {\n        make: \"honda\",\n        model: \"civic\"\n    }\n}\n```\n\nAnd then we quickly run into our problem. We need to encode the object above into\n\n`order=price&filter.make=honda&filter.model=civic`\n\nbut Node.js's [`querystring`](https://nodejs.org/api/querystring.html) can't encode nested objects.\n\n## Existing Modules Supporting Nested Querystrings\n\nBy default, the [qs](https://www.npmjs.com/package/qs) module creates ugly urls when it encodes nested query strings. If we encode our object above, we get\n\n`order=price&filter[make]=honda&filter[model]=civic`\n\nThe `[` and `]` characters are both considered unsafe in a URL and are required to be escaped. The URL becomes unreadable after this percent encoding operation.\n\n`order=price&filter%5Bmake%5D=honda&filter%5Bmodel%5D=civic`\n\nFortunately, the `.` is not considered unsafe and does not need to be escaped, making it the perfect character to express object nesting.\n\n## The Solution\n\nThe solution is broken down into two parts. The first is _encoding_ a nested object into a query string. The second part is _decoding_ a query string back into a nested object.\n\n### Encoding<sup>[2](#footnote2)</sup>\n\n#### Just Nested Objects\n\nLet's write some code to encode\n\n```js\n{\n  filter: {\n    make: \"honda\";\n    model: \"civic\";\n  }\n}\n```\n\ninto the query string `filter.make=honda&filter.model=civic`\n\n```js\nconst { escape } = require(\"querystring\");\n\nfunction encode(queryObj, nesting = \"\") {\n  let queryString = \"\";\n\n  const pairs = Object.entries(queryObj).map(([key, val]) => {\n    // Handle the nested, recursive case, where the value to encode is an object itself\n    if (typeof val === \"object\") {\n      return encode(val, nesting + `${key}.`);\n    } else {\n      // Handle base case, where the value to encode is simply a string.\n      return [nesting + key, val].map(escape).join(\"=\");\n    }\n  });\n  return pairs.join(\"&\");\n}\n```\n\nNotice that we use the [escape](https://nodejs.org/api/querystring.html#querystring_querystring_escape_str) function provided in Node.js core to percent encode specific characters.\n\n#### Encoding Arrays as Values\n\nIf we want to add support to encode an object with array values, like the following:\n\n```js\n{\n    name: \"nick\",\n    hobbies: [\"cooking\", \"coding\"]\n}\n```\n\nthen we only need to add another base case to our function\n\n```js\nfunction encode(queryObj, nesting = \"\") {\n  let queryString = \"\";\n\n  const pairs = Object.entries(queryObj).map(([key, val]) => {\n    // Handle a second base case where the value to encode is an array\n    if (Array.isArray(val)) {\n      return val.map(subVal => [nesting + key, subVal].map(escape).join(\"=\")).join(\"&\");\n    } else if (typeof val === \"object\") {\n      return encode(val, nesting + `${key}.`);\n    } else {\n      return [nesting + key, val].map(escape).join(\"=\");\n    }\n  });\n  return pairs.join(\"&\");\n}\n```\n\n### Decoding\n\nAn encoding function is not very useful unless you can decode the encoded string back to it's original form.\n\n#### Just Nested Objects\n\nWe want to write a function that will decode `filter.make=honda&filter.model=civic` back into a nested object\n\n```js\n{\n  filter: {\n    make: \"honda\";\n    model: \"civic\";\n  }\n}\n```\n\nThe code to do this is fairly straightforward if we use a [Lodash](https://lodash.com/docs) utility called [set](https://lodash.com/docs/4.17.5#set) that allows us to set an arbitrarily nested key in an object.\n\n```js\nconst set = require(\"lodash.set\");\n\nfunction decode(queryString) {\n  const queryStringPieces = queryString.split(\"&\");\n  const decodedQueryString = {};\n\n  for (const piece of queryStringPieces) {\n    let [key, value] = piece.split(\"=\");\n    value = value || \"\"; // If a value is not defined, it should be decoded as an empty string\n    set(decodedQueryString, key, value);\n  }\n  return decodedQueryString;\n}\n```\n\n#### Decoding Arrays as Values\n\nIf we want to add support to decode arrays like we did above, then we need to do a little additional work. Fortunately, two additional [Lodash](https://lodash.com/docs) utilities, [has](https://lodash.com/docs/4.17.5#has) and [get](https://lodash.com/docs/4.17.5#get), allow us to check for the existence of a nested key and to get the value associated with a nested key, respectively, greatly simplifying our problem.\n\n```js\nconst set = require(\"lodash.set\");\nconst has = require(\"lodash.has\");\nconst get = require(\"lodash.get\");\n\nfunction decode(queryString) {\n  const queryStringPieces = queryString.split(\"&\");\n  const decodedQueryString = {};\n\n  for (const piece of queryStringPieces) {\n    let [key, value] = piece.split(\"=\");\n    value = value || \"\";\n    if (has(decodedQueryString, key)) {\n      const currentValueForKey = get(decodedQueryString, key);\n      if (!Array.isArray(currentValueForKey)) {\n        set(decodedQueryString, key, [currentValueForKey, value]);\n      } else {\n        currentValueForKey.push(value);\n      }\n    } else {\n      set(decodedQueryString, key, value);\n    }\n  }\n  return decodedQueryString;\n}\n```\n\n## Conclusion\n\nAnd that's it! The whole thing, encoding and decoding, only takes ~40 lines of code. Perhaps next time you encounter something that feels a little too fundamental to code yourself, you won't hesitate to write some code if you can't find a sufficient open source package.\n\n#### Footnotes\n\n<a name=\"footnote1\">1</a>: This example is straight from the [qs](https://www.npmjs.com/package/qs) documentation. Incidentally, qs provides an option to encode using a url safe character, which would result in readable urls, but this is not the default.\n\n<a name=\"footnote2\">2</a>: It's worth noting that you might not want to use this code in production. I've written the code in a functional style for clarity and conciseness. If you have a high read volume, given that this code might potentially run on a significant portion of GET requests, it should probably be written in an imperative style that doesn't disregard performance. Even more importantly, this code does not protect against potential attackers who might try to create an arbitrarily deeply nested object or might include an unwieldy number of query parameters.\n","source":"_posts/build-your-own-nested-query-string-encoder.md","raw":"---\ntitle: \"Build Your Own Nested Query String Encoder/Decoder\"\ncategories:\n  - [Javascript]\n  - [Recursion]\n  - [Web]\n  - [Build Your Own]\ndate: 2018-04-13 15:17:00\n---\n\nThe other day at work, one of my colleagues was frustrated that he was unable to encode nested objects in a query string and still maintain a readable URL. I went home that night and coded up a simple solution to this problem, and I thought I'd share it here today. This [Github repo](https://github.com/nadrane/querystring-encoder) contains specs and the solution code.\n\n<!-- more -->\n\n## Motivation\n\nToday, in the Node.js ecosystem, numerous modules exist to encode query strings, but they generally have one of two flaws:\n\n1.  They do not permit the encoding of nested objects.\n\n2.  They can encode nested objects, but they delimit nesting using unsafe URL characters, yielding an operation and a result that look like this <sup>[1](#footnote1)</sup>:\n\n```js\nencode({\n  a: { b: 'c' }\n});\n>>>`a%5Bb%5D=c`\n```\n\n## The Problem in Detail\n\nNode.js provides a [`querystring`](https://nodejs.org/api/querystring.html) module to encode objects to query strings. The only problem is that conforms to an official specification that doesn't allow nested objects. Unfortunately, this specification does not allow for enough flexibility when creating a RESTful API.\n\nFor example, suppose the client wants to filter a collection of cars by make and model. The route might look like this:\n\n`/api/cars?make=honda&model=civic`\n\nThis URI makes it reasonably clear that we want to filter cars by their make and model.\n\nWhat if we wanted to do something more complicated. What if we wanted to filter cars and order them by price?\n\n`/api/cars?order=price&make=honda&model=civic`\n\nIt's no longer clear which query parameters describe the ordering and which describe the filter. Ideally, we want the url to look like this:\n\n`/api/cars?order=price&filter.make=honda&filter.model=civic`\n\nIf we were to represent the query string of the above URI as a Javascript object, it would probably look like this:\n\n```js\n{\n    order: \"price\",\n    filter: {\n        make: \"honda\",\n        model: \"civic\"\n    }\n}\n```\n\nAnd then we quickly run into our problem. We need to encode the object above into\n\n`order=price&filter.make=honda&filter.model=civic`\n\nbut Node.js's [`querystring`](https://nodejs.org/api/querystring.html) can't encode nested objects.\n\n## Existing Modules Supporting Nested Querystrings\n\nBy default, the [qs](https://www.npmjs.com/package/qs) module creates ugly urls when it encodes nested query strings. If we encode our object above, we get\n\n`order=price&filter[make]=honda&filter[model]=civic`\n\nThe `[` and `]` characters are both considered unsafe in a URL and are required to be escaped. The URL becomes unreadable after this percent encoding operation.\n\n`order=price&filter%5Bmake%5D=honda&filter%5Bmodel%5D=civic`\n\nFortunately, the `.` is not considered unsafe and does not need to be escaped, making it the perfect character to express object nesting.\n\n## The Solution\n\nThe solution is broken down into two parts. The first is _encoding_ a nested object into a query string. The second part is _decoding_ a query string back into a nested object.\n\n### Encoding<sup>[2](#footnote2)</sup>\n\n#### Just Nested Objects\n\nLet's write some code to encode\n\n```js\n{\n  filter: {\n    make: \"honda\";\n    model: \"civic\";\n  }\n}\n```\n\ninto the query string `filter.make=honda&filter.model=civic`\n\n```js\nconst { escape } = require(\"querystring\");\n\nfunction encode(queryObj, nesting = \"\") {\n  let queryString = \"\";\n\n  const pairs = Object.entries(queryObj).map(([key, val]) => {\n    // Handle the nested, recursive case, where the value to encode is an object itself\n    if (typeof val === \"object\") {\n      return encode(val, nesting + `${key}.`);\n    } else {\n      // Handle base case, where the value to encode is simply a string.\n      return [nesting + key, val].map(escape).join(\"=\");\n    }\n  });\n  return pairs.join(\"&\");\n}\n```\n\nNotice that we use the [escape](https://nodejs.org/api/querystring.html#querystring_querystring_escape_str) function provided in Node.js core to percent encode specific characters.\n\n#### Encoding Arrays as Values\n\nIf we want to add support to encode an object with array values, like the following:\n\n```js\n{\n    name: \"nick\",\n    hobbies: [\"cooking\", \"coding\"]\n}\n```\n\nthen we only need to add another base case to our function\n\n```js\nfunction encode(queryObj, nesting = \"\") {\n  let queryString = \"\";\n\n  const pairs = Object.entries(queryObj).map(([key, val]) => {\n    // Handle a second base case where the value to encode is an array\n    if (Array.isArray(val)) {\n      return val.map(subVal => [nesting + key, subVal].map(escape).join(\"=\")).join(\"&\");\n    } else if (typeof val === \"object\") {\n      return encode(val, nesting + `${key}.`);\n    } else {\n      return [nesting + key, val].map(escape).join(\"=\");\n    }\n  });\n  return pairs.join(\"&\");\n}\n```\n\n### Decoding\n\nAn encoding function is not very useful unless you can decode the encoded string back to it's original form.\n\n#### Just Nested Objects\n\nWe want to write a function that will decode `filter.make=honda&filter.model=civic` back into a nested object\n\n```js\n{\n  filter: {\n    make: \"honda\";\n    model: \"civic\";\n  }\n}\n```\n\nThe code to do this is fairly straightforward if we use a [Lodash](https://lodash.com/docs) utility called [set](https://lodash.com/docs/4.17.5#set) that allows us to set an arbitrarily nested key in an object.\n\n```js\nconst set = require(\"lodash.set\");\n\nfunction decode(queryString) {\n  const queryStringPieces = queryString.split(\"&\");\n  const decodedQueryString = {};\n\n  for (const piece of queryStringPieces) {\n    let [key, value] = piece.split(\"=\");\n    value = value || \"\"; // If a value is not defined, it should be decoded as an empty string\n    set(decodedQueryString, key, value);\n  }\n  return decodedQueryString;\n}\n```\n\n#### Decoding Arrays as Values\n\nIf we want to add support to decode arrays like we did above, then we need to do a little additional work. Fortunately, two additional [Lodash](https://lodash.com/docs) utilities, [has](https://lodash.com/docs/4.17.5#has) and [get](https://lodash.com/docs/4.17.5#get), allow us to check for the existence of a nested key and to get the value associated with a nested key, respectively, greatly simplifying our problem.\n\n```js\nconst set = require(\"lodash.set\");\nconst has = require(\"lodash.has\");\nconst get = require(\"lodash.get\");\n\nfunction decode(queryString) {\n  const queryStringPieces = queryString.split(\"&\");\n  const decodedQueryString = {};\n\n  for (const piece of queryStringPieces) {\n    let [key, value] = piece.split(\"=\");\n    value = value || \"\";\n    if (has(decodedQueryString, key)) {\n      const currentValueForKey = get(decodedQueryString, key);\n      if (!Array.isArray(currentValueForKey)) {\n        set(decodedQueryString, key, [currentValueForKey, value]);\n      } else {\n        currentValueForKey.push(value);\n      }\n    } else {\n      set(decodedQueryString, key, value);\n    }\n  }\n  return decodedQueryString;\n}\n```\n\n## Conclusion\n\nAnd that's it! The whole thing, encoding and decoding, only takes ~40 lines of code. Perhaps next time you encounter something that feels a little too fundamental to code yourself, you won't hesitate to write some code if you can't find a sufficient open source package.\n\n#### Footnotes\n\n<a name=\"footnote1\">1</a>: This example is straight from the [qs](https://www.npmjs.com/package/qs) documentation. Incidentally, qs provides an option to encode using a url safe character, which would result in readable urls, but this is not the default.\n\n<a name=\"footnote2\">2</a>: It's worth noting that you might not want to use this code in production. I've written the code in a functional style for clarity and conciseness. If you have a high read volume, given that this code might potentially run on a significant portion of GET requests, it should probably be written in an imperative style that doesn't disregard performance. Even more importantly, this code does not protect against potential attackers who might try to create an arbitrarily deeply nested object or might include an unwieldy number of query parameters.\n","slug":"build-your-own-nested-query-string-encoder","published":1,"updated":"2018-09-30T21:05:29.859Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vnq000i67ozm1edvlyi","content":"<p>The other day at work, one of my colleagues was frustrated that he was unable to encode nested objects in a query string and still maintain a readable URL. I went home that night and coded up a simple solution to this problem, and I thought I’d share it here today. This <a href=\"https://github.com/nadrane/querystring-encoder\" target=\"_blank\" rel=\"noopener\">Github repo</a> contains specs and the solution code.</p>\n<a id=\"more\"></a>\n<h2 id=\"Motivation\"><a href=\"#Motivation\" class=\"headerlink\" title=\"Motivation\"></a>Motivation</h2><p>Today, in the Node.js ecosystem, numerous modules exist to encode query strings, but they generally have one of two flaws:</p>\n<ol>\n<li><p>They do not permit the encoding of nested objects.</p>\n</li>\n<li><p>They can encode nested objects, but they delimit nesting using unsafe URL characters, yielding an operation and a result that look like this <sup><a href=\"#footnote1\">1</a></sup>:</p>\n</li>\n</ol>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">encode(&#123;</span><br><span class=\"line\">  a: &#123; <span class=\"attr\">b</span>: <span class=\"string\">'c'</span> &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&gt;&gt;&gt;<span class=\"string\">`a%5Bb%5D=c`</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"The-Problem-in-Detail\"><a href=\"#The-Problem-in-Detail\" class=\"headerlink\" title=\"The Problem in Detail\"></a>The Problem in Detail</h2><p>Node.js provides a <a href=\"https://nodejs.org/api/querystring.html\" target=\"_blank\" rel=\"noopener\"><code>querystring</code></a> module to encode objects to query strings. The only problem is that conforms to an official specification that doesn’t allow nested objects. Unfortunately, this specification does not allow for enough flexibility when creating a RESTful API.</p>\n<p>For example, suppose the client wants to filter a collection of cars by make and model. The route might look like this:</p>\n<p><code>/api/cars?make=honda&amp;model=civic</code></p>\n<p>This URI makes it reasonably clear that we want to filter cars by their make and model.</p>\n<p>What if we wanted to do something more complicated. What if we wanted to filter cars and order them by price?</p>\n<p><code>/api/cars?order=price&amp;make=honda&amp;model=civic</code></p>\n<p>It’s no longer clear which query parameters describe the ordering and which describe the filter. Ideally, we want the url to look like this:</p>\n<p><code>/api/cars?order=price&amp;filter.make=honda&amp;filter.model=civic</code></p>\n<p>If we were to represent the query string of the above URI as a Javascript object, it would probably look like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    order: <span class=\"string\">\"price\"</span>,</span><br><span class=\"line\">    filter: &#123;</span><br><span class=\"line\">        make: <span class=\"string\">\"honda\"</span>,</span><br><span class=\"line\">        model: <span class=\"string\">\"civic\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>And then we quickly run into our problem. We need to encode the object above into</p>\n<p><code>order=price&amp;filter.make=honda&amp;filter.model=civic</code></p>\n<p>but Node.js’s <a href=\"https://nodejs.org/api/querystring.html\" target=\"_blank\" rel=\"noopener\"><code>querystring</code></a> can’t encode nested objects.</p>\n<h2 id=\"Existing-Modules-Supporting-Nested-Querystrings\"><a href=\"#Existing-Modules-Supporting-Nested-Querystrings\" class=\"headerlink\" title=\"Existing Modules Supporting Nested Querystrings\"></a>Existing Modules Supporting Nested Querystrings</h2><p>By default, the <a href=\"https://www.npmjs.com/package/qs\" target=\"_blank\" rel=\"noopener\">qs</a> module creates ugly urls when it encodes nested query strings. If we encode our object above, we get</p>\n<p><code>order=price&amp;filter[make]=honda&amp;filter[model]=civic</code></p>\n<p>The <code>[</code> and <code>]</code> characters are both considered unsafe in a URL and are required to be escaped. The URL becomes unreadable after this percent encoding operation.</p>\n<p><code>order=price&amp;filter%5Bmake%5D=honda&amp;filter%5Bmodel%5D=civic</code></p>\n<p>Fortunately, the <code>.</code> is not considered unsafe and does not need to be escaped, making it the perfect character to express object nesting.</p>\n<h2 id=\"The-Solution\"><a href=\"#The-Solution\" class=\"headerlink\" title=\"The Solution\"></a>The Solution</h2><p>The solution is broken down into two parts. The first is <em>encoding</em> a nested object into a query string. The second part is <em>decoding</em> a query string back into a nested object.</p>\n<h3 id=\"Encoding2\"><a href=\"#Encoding2\" class=\"headerlink\" title=\"Encoding2\"></a>Encoding<sup><a href=\"#footnote2\">2</a></sup></h3><h4 id=\"Just-Nested-Objects\"><a href=\"#Just-Nested-Objects\" class=\"headerlink\" title=\"Just Nested Objects\"></a>Just Nested Objects</h4><p>Let’s write some code to encode</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  filter: &#123;</span><br><span class=\"line\">    make: <span class=\"string\">\"honda\"</span>;</span><br><span class=\"line\">    model: <span class=\"string\">\"civic\"</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>into the query string <code>filter.make=honda&amp;filter.model=civic</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> &#123; <span class=\"built_in\">escape</span> &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">\"querystring\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">encode</span>(<span class=\"params\">queryObj, nesting = <span class=\"string\">\"\"</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> queryString = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> pairs = <span class=\"built_in\">Object</span>.entries(queryObj).map(<span class=\"function\">(<span class=\"params\">[key, val]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Handle the nested, recursive case, where the value to encode is an object itself</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> val === <span class=\"string\">\"object\"</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> encode(val, nesting + <span class=\"string\">`<span class=\"subst\">$&#123;key&#125;</span>.`</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// Handle base case, where the value to encode is simply a string.</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> [nesting + key, val].map(<span class=\"built_in\">escape</span>).join(<span class=\"string\">\"=\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> pairs.join(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Notice that we use the <a href=\"https://nodejs.org/api/querystring.html#querystring_querystring_escape_str\" target=\"_blank\" rel=\"noopener\">escape</a> function provided in Node.js core to percent encode specific characters.</p>\n<h4 id=\"Encoding-Arrays-as-Values\"><a href=\"#Encoding-Arrays-as-Values\" class=\"headerlink\" title=\"Encoding Arrays as Values\"></a>Encoding Arrays as Values</h4><p>If we want to add support to encode an object with array values, like the following:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    name: <span class=\"string\">\"nick\"</span>,</span><br><span class=\"line\">    hobbies: [<span class=\"string\">\"cooking\"</span>, <span class=\"string\">\"coding\"</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>then we only need to add another base case to our function</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">encode</span>(<span class=\"params\">queryObj, nesting = <span class=\"string\">\"\"</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> queryString = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> pairs = <span class=\"built_in\">Object</span>.entries(queryObj).map(<span class=\"function\">(<span class=\"params\">[key, val]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Handle a second base case where the value to encode is an array</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">Array</span>.isArray(val)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> val.map(<span class=\"function\"><span class=\"params\">subVal</span> =&gt;</span> [nesting + key, subVal].map(<span class=\"built_in\">escape</span>).join(<span class=\"string\">\"=\"</span>)).join(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> val === <span class=\"string\">\"object\"</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> encode(val, nesting + <span class=\"string\">`<span class=\"subst\">$&#123;key&#125;</span>.`</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> [nesting + key, val].map(<span class=\"built_in\">escape</span>).join(<span class=\"string\">\"=\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> pairs.join(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Decoding\"><a href=\"#Decoding\" class=\"headerlink\" title=\"Decoding\"></a>Decoding</h3><p>An encoding function is not very useful unless you can decode the encoded string back to it’s original form.</p>\n<h4 id=\"Just-Nested-Objects-1\"><a href=\"#Just-Nested-Objects-1\" class=\"headerlink\" title=\"Just Nested Objects\"></a>Just Nested Objects</h4><p>We want to write a function that will decode <code>filter.make=honda&amp;filter.model=civic</code> back into a nested object</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  filter: &#123;</span><br><span class=\"line\">    make: <span class=\"string\">\"honda\"</span>;</span><br><span class=\"line\">    model: <span class=\"string\">\"civic\"</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The code to do this is fairly straightforward if we use a <a href=\"https://lodash.com/docs\" target=\"_blank\" rel=\"noopener\">Lodash</a> utility called <a href=\"https://lodash.com/docs/4.17.5#set\" target=\"_blank\" rel=\"noopener\">set</a> that allows us to set an arbitrarily nested key in an object.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> set = <span class=\"built_in\">require</span>(<span class=\"string\">\"lodash.set\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">decode</span>(<span class=\"params\">queryString</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> queryStringPieces = queryString.split(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> decodedQueryString = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> piece <span class=\"keyword\">of</span> queryStringPieces) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> [key, value] = piece.split(<span class=\"string\">\"=\"</span>);</span><br><span class=\"line\">    value = value || <span class=\"string\">\"\"</span>; <span class=\"comment\">// If a value is not defined, it should be decoded as an empty string</span></span><br><span class=\"line\">    set(decodedQueryString, key, value);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> decodedQueryString;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Decoding-Arrays-as-Values\"><a href=\"#Decoding-Arrays-as-Values\" class=\"headerlink\" title=\"Decoding Arrays as Values\"></a>Decoding Arrays as Values</h4><p>If we want to add support to decode arrays like we did above, then we need to do a little additional work. Fortunately, two additional <a href=\"https://lodash.com/docs\" target=\"_blank\" rel=\"noopener\">Lodash</a> utilities, <a href=\"https://lodash.com/docs/4.17.5#has\" target=\"_blank\" rel=\"noopener\">has</a> and <a href=\"https://lodash.com/docs/4.17.5#get\" target=\"_blank\" rel=\"noopener\">get</a>, allow us to check for the existence of a nested key and to get the value associated with a nested key, respectively, greatly simplifying our problem.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> set = <span class=\"built_in\">require</span>(<span class=\"string\">\"lodash.set\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> has = <span class=\"built_in\">require</span>(<span class=\"string\">\"lodash.has\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> get = <span class=\"built_in\">require</span>(<span class=\"string\">\"lodash.get\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">decode</span>(<span class=\"params\">queryString</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> queryStringPieces = queryString.split(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> decodedQueryString = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> piece <span class=\"keyword\">of</span> queryStringPieces) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> [key, value] = piece.split(<span class=\"string\">\"=\"</span>);</span><br><span class=\"line\">    value = value || <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (has(decodedQueryString, key)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> currentValueForKey = get(decodedQueryString, key);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!<span class=\"built_in\">Array</span>.isArray(currentValueForKey)) &#123;</span><br><span class=\"line\">        set(decodedQueryString, key, [currentValueForKey, value]);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        currentValueForKey.push(value);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      set(decodedQueryString, key, value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> decodedQueryString;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>And that’s it! The whole thing, encoding and decoding, only takes ~40 lines of code. Perhaps next time you encounter something that feels a little too fundamental to code yourself, you won’t hesitate to write some code if you can’t find a sufficient open source package.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: This example is straight from the <a href=\"https://www.npmjs.com/package/qs\" target=\"_blank\" rel=\"noopener\">qs</a> documentation. Incidentally, qs provides an option to encode using a url safe character, which would result in readable urls, but this is not the default.</p>\n<p><a name=\"footnote2\">2</a>: It’s worth noting that you might not want to use this code in production. I’ve written the code in a functional style for clarity and conciseness. If you have a high read volume, given that this code might potentially run on a significant portion of GET requests, it should probably be written in an imperative style that doesn’t disregard performance. Even more importantly, this code does not protect against potential attackers who might try to create an arbitrarily deeply nested object or might include an unwieldy number of query parameters.</p>\n","site":{"data":{}},"excerpt":"<p>The other day at work, one of my colleagues was frustrated that he was unable to encode nested objects in a query string and still maintain a readable URL. I went home that night and coded up a simple solution to this problem, and I thought I’d share it here today. This <a href=\"https://github.com/nadrane/querystring-encoder\" target=\"_blank\" rel=\"noopener\">Github repo</a> contains specs and the solution code.</p>","more":"<h2 id=\"Motivation\"><a href=\"#Motivation\" class=\"headerlink\" title=\"Motivation\"></a>Motivation</h2><p>Today, in the Node.js ecosystem, numerous modules exist to encode query strings, but they generally have one of two flaws:</p>\n<ol>\n<li><p>They do not permit the encoding of nested objects.</p>\n</li>\n<li><p>They can encode nested objects, but they delimit nesting using unsafe URL characters, yielding an operation and a result that look like this <sup><a href=\"#footnote1\">1</a></sup>:</p>\n</li>\n</ol>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">encode(&#123;</span><br><span class=\"line\">  a: &#123; <span class=\"attr\">b</span>: <span class=\"string\">'c'</span> &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&gt;&gt;&gt;<span class=\"string\">`a%5Bb%5D=c`</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"The-Problem-in-Detail\"><a href=\"#The-Problem-in-Detail\" class=\"headerlink\" title=\"The Problem in Detail\"></a>The Problem in Detail</h2><p>Node.js provides a <a href=\"https://nodejs.org/api/querystring.html\" target=\"_blank\" rel=\"noopener\"><code>querystring</code></a> module to encode objects to query strings. The only problem is that conforms to an official specification that doesn’t allow nested objects. Unfortunately, this specification does not allow for enough flexibility when creating a RESTful API.</p>\n<p>For example, suppose the client wants to filter a collection of cars by make and model. The route might look like this:</p>\n<p><code>/api/cars?make=honda&amp;model=civic</code></p>\n<p>This URI makes it reasonably clear that we want to filter cars by their make and model.</p>\n<p>What if we wanted to do something more complicated. What if we wanted to filter cars and order them by price?</p>\n<p><code>/api/cars?order=price&amp;make=honda&amp;model=civic</code></p>\n<p>It’s no longer clear which query parameters describe the ordering and which describe the filter. Ideally, we want the url to look like this:</p>\n<p><code>/api/cars?order=price&amp;filter.make=honda&amp;filter.model=civic</code></p>\n<p>If we were to represent the query string of the above URI as a Javascript object, it would probably look like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    order: <span class=\"string\">\"price\"</span>,</span><br><span class=\"line\">    filter: &#123;</span><br><span class=\"line\">        make: <span class=\"string\">\"honda\"</span>,</span><br><span class=\"line\">        model: <span class=\"string\">\"civic\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>And then we quickly run into our problem. We need to encode the object above into</p>\n<p><code>order=price&amp;filter.make=honda&amp;filter.model=civic</code></p>\n<p>but Node.js’s <a href=\"https://nodejs.org/api/querystring.html\" target=\"_blank\" rel=\"noopener\"><code>querystring</code></a> can’t encode nested objects.</p>\n<h2 id=\"Existing-Modules-Supporting-Nested-Querystrings\"><a href=\"#Existing-Modules-Supporting-Nested-Querystrings\" class=\"headerlink\" title=\"Existing Modules Supporting Nested Querystrings\"></a>Existing Modules Supporting Nested Querystrings</h2><p>By default, the <a href=\"https://www.npmjs.com/package/qs\" target=\"_blank\" rel=\"noopener\">qs</a> module creates ugly urls when it encodes nested query strings. If we encode our object above, we get</p>\n<p><code>order=price&amp;filter[make]=honda&amp;filter[model]=civic</code></p>\n<p>The <code>[</code> and <code>]</code> characters are both considered unsafe in a URL and are required to be escaped. The URL becomes unreadable after this percent encoding operation.</p>\n<p><code>order=price&amp;filter%5Bmake%5D=honda&amp;filter%5Bmodel%5D=civic</code></p>\n<p>Fortunately, the <code>.</code> is not considered unsafe and does not need to be escaped, making it the perfect character to express object nesting.</p>\n<h2 id=\"The-Solution\"><a href=\"#The-Solution\" class=\"headerlink\" title=\"The Solution\"></a>The Solution</h2><p>The solution is broken down into two parts. The first is <em>encoding</em> a nested object into a query string. The second part is <em>decoding</em> a query string back into a nested object.</p>\n<h3 id=\"Encoding2\"><a href=\"#Encoding2\" class=\"headerlink\" title=\"Encoding2\"></a>Encoding<sup><a href=\"#footnote2\">2</a></sup></h3><h4 id=\"Just-Nested-Objects\"><a href=\"#Just-Nested-Objects\" class=\"headerlink\" title=\"Just Nested Objects\"></a>Just Nested Objects</h4><p>Let’s write some code to encode</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  filter: &#123;</span><br><span class=\"line\">    make: <span class=\"string\">\"honda\"</span>;</span><br><span class=\"line\">    model: <span class=\"string\">\"civic\"</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>into the query string <code>filter.make=honda&amp;filter.model=civic</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> &#123; <span class=\"built_in\">escape</span> &#125; = <span class=\"built_in\">require</span>(<span class=\"string\">\"querystring\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">encode</span>(<span class=\"params\">queryObj, nesting = <span class=\"string\">\"\"</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> queryString = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> pairs = <span class=\"built_in\">Object</span>.entries(queryObj).map(<span class=\"function\">(<span class=\"params\">[key, val]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Handle the nested, recursive case, where the value to encode is an object itself</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> val === <span class=\"string\">\"object\"</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> encode(val, nesting + <span class=\"string\">`<span class=\"subst\">$&#123;key&#125;</span>.`</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// Handle base case, where the value to encode is simply a string.</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> [nesting + key, val].map(<span class=\"built_in\">escape</span>).join(<span class=\"string\">\"=\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> pairs.join(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Notice that we use the <a href=\"https://nodejs.org/api/querystring.html#querystring_querystring_escape_str\" target=\"_blank\" rel=\"noopener\">escape</a> function provided in Node.js core to percent encode specific characters.</p>\n<h4 id=\"Encoding-Arrays-as-Values\"><a href=\"#Encoding-Arrays-as-Values\" class=\"headerlink\" title=\"Encoding Arrays as Values\"></a>Encoding Arrays as Values</h4><p>If we want to add support to encode an object with array values, like the following:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    name: <span class=\"string\">\"nick\"</span>,</span><br><span class=\"line\">    hobbies: [<span class=\"string\">\"cooking\"</span>, <span class=\"string\">\"coding\"</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>then we only need to add another base case to our function</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">encode</span>(<span class=\"params\">queryObj, nesting = <span class=\"string\">\"\"</span></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> queryString = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> pairs = <span class=\"built_in\">Object</span>.entries(queryObj).map(<span class=\"function\">(<span class=\"params\">[key, val]</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Handle a second base case where the value to encode is an array</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">Array</span>.isArray(val)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> val.map(<span class=\"function\"><span class=\"params\">subVal</span> =&gt;</span> [nesting + key, subVal].map(<span class=\"built_in\">escape</span>).join(<span class=\"string\">\"=\"</span>)).join(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> val === <span class=\"string\">\"object\"</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> encode(val, nesting + <span class=\"string\">`<span class=\"subst\">$&#123;key&#125;</span>.`</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> [nesting + key, val].map(<span class=\"built_in\">escape</span>).join(<span class=\"string\">\"=\"</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> pairs.join(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Decoding\"><a href=\"#Decoding\" class=\"headerlink\" title=\"Decoding\"></a>Decoding</h3><p>An encoding function is not very useful unless you can decode the encoded string back to it’s original form.</p>\n<h4 id=\"Just-Nested-Objects-1\"><a href=\"#Just-Nested-Objects-1\" class=\"headerlink\" title=\"Just Nested Objects\"></a>Just Nested Objects</h4><p>We want to write a function that will decode <code>filter.make=honda&amp;filter.model=civic</code> back into a nested object</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  filter: &#123;</span><br><span class=\"line\">    make: <span class=\"string\">\"honda\"</span>;</span><br><span class=\"line\">    model: <span class=\"string\">\"civic\"</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The code to do this is fairly straightforward if we use a <a href=\"https://lodash.com/docs\" target=\"_blank\" rel=\"noopener\">Lodash</a> utility called <a href=\"https://lodash.com/docs/4.17.5#set\" target=\"_blank\" rel=\"noopener\">set</a> that allows us to set an arbitrarily nested key in an object.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> set = <span class=\"built_in\">require</span>(<span class=\"string\">\"lodash.set\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">decode</span>(<span class=\"params\">queryString</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> queryStringPieces = queryString.split(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> decodedQueryString = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> piece <span class=\"keyword\">of</span> queryStringPieces) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> [key, value] = piece.split(<span class=\"string\">\"=\"</span>);</span><br><span class=\"line\">    value = value || <span class=\"string\">\"\"</span>; <span class=\"comment\">// If a value is not defined, it should be decoded as an empty string</span></span><br><span class=\"line\">    set(decodedQueryString, key, value);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> decodedQueryString;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"Decoding-Arrays-as-Values\"><a href=\"#Decoding-Arrays-as-Values\" class=\"headerlink\" title=\"Decoding Arrays as Values\"></a>Decoding Arrays as Values</h4><p>If we want to add support to decode arrays like we did above, then we need to do a little additional work. Fortunately, two additional <a href=\"https://lodash.com/docs\" target=\"_blank\" rel=\"noopener\">Lodash</a> utilities, <a href=\"https://lodash.com/docs/4.17.5#has\" target=\"_blank\" rel=\"noopener\">has</a> and <a href=\"https://lodash.com/docs/4.17.5#get\" target=\"_blank\" rel=\"noopener\">get</a>, allow us to check for the existence of a nested key and to get the value associated with a nested key, respectively, greatly simplifying our problem.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> set = <span class=\"built_in\">require</span>(<span class=\"string\">\"lodash.set\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> has = <span class=\"built_in\">require</span>(<span class=\"string\">\"lodash.has\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> get = <span class=\"built_in\">require</span>(<span class=\"string\">\"lodash.get\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">decode</span>(<span class=\"params\">queryString</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> queryStringPieces = queryString.split(<span class=\"string\">\"&amp;\"</span>);</span><br><span class=\"line\">  <span class=\"keyword\">const</span> decodedQueryString = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> piece <span class=\"keyword\">of</span> queryStringPieces) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> [key, value] = piece.split(<span class=\"string\">\"=\"</span>);</span><br><span class=\"line\">    value = value || <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (has(decodedQueryString, key)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> currentValueForKey = get(decodedQueryString, key);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!<span class=\"built_in\">Array</span>.isArray(currentValueForKey)) &#123;</span><br><span class=\"line\">        set(decodedQueryString, key, [currentValueForKey, value]);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        currentValueForKey.push(value);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      set(decodedQueryString, key, value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> decodedQueryString;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>And that’s it! The whole thing, encoding and decoding, only takes ~40 lines of code. Perhaps next time you encounter something that feels a little too fundamental to code yourself, you won’t hesitate to write some code if you can’t find a sufficient open source package.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: This example is straight from the <a href=\"https://www.npmjs.com/package/qs\" target=\"_blank\" rel=\"noopener\">qs</a> documentation. Incidentally, qs provides an option to encode using a url safe character, which would result in readable urls, but this is not the default.</p>\n<p><a name=\"footnote2\">2</a>: It’s worth noting that you might not want to use this code in production. I’ve written the code in a functional style for clarity and conciseness. If you have a high read volume, given that this code might potentially run on a significant portion of GET requests, it should probably be written in an imperative style that doesn’t disregard performance. Even more importantly, this code does not protect against potential attackers who might try to create an arbitrarily deeply nested object or might include an unwieldy number of query parameters.</p>"},{"title":"Build a Regex Engine in Less than 40 Lines of Code","date":"2017-11-28T17:36:04.000Z","_content":"\nI stumbled upon an [article](https://www.cs.princeton.edu/courses/archive/spr09/cos333/beautiful.html) the other day where Rob Pike implements a rudimentary regular expression engine in c. I converted his code to Javascript and added test specs so that someone can self-guide themselves through the creation of the regex engine. The specs and solution can be found in this [GitHub repository](https://github.com/nadrane/build-your-own-regex). This blog post walks through my solution.\n\n<!-- more -->\n\n## The Problem\n\nOur regex engine will support the following syntax:\n\n| Syntax | Meaning | Example | matches |\n|--------|---------|---------|---------|\n| a | Matches the specified character literal | q | q |\n| * | Matches 0 or more of the previous character | a* | \"\", a, aa, aaa  |\n| ? | Matches 0 or 1 of the previous character | a? | \"\", a |\n| . | Matches any character literal | . | a, b, c, d, e ... |\n| ^ | Matches the start of a string | ^c | c, ca, caa, cbb ... |\n| $ | Matches the end of a string | a$ | ba, baaa, qwerta ... |\n\nThe goal is to provide a syntax robust enough to match a large portion of regex use cases with minimal code.\n\n## Matching One Character\n\nThe first step is to write a function that takes in a one character pattern and a one character text string and returns a boolean indicating if they match. A pattern of `.` is considered a wildcard and matches against any character literal.\n\nHere are some examples\n\n`matchOne('a', 'a')` -> `true`\n`matchOne('.', 'z')` -> `true`\n`matchOne('', 'h')`  -> `true`\n`matchOne('a', 'b')` -> `false`\n`matchOne('p', '')`  -> `false`\n\n\n```js\nfunction matchOne(pattern, text) {\n  if (!pattern) return true // Any text matches an empty pattern\n  if (!text) return false   // If the pattern is defined but the text is empty, there cannot be a match\n  if (pattern === \".\") return true // Any inputted text matches the wildcard\n  return pattern === text\n}\n```\n\n## Matching Same Length Strings\n\nNow we want to add support for patterns and text strings of greater length. For now, let's only consider a pattern/text pair of the same length. I happen to know that the solution lends itself very naturally to recursion, so we will use it here. We are going to want to repeatedly invoke `matchOne` on successive pairs of characters from the pattern/text combination.\n\n```js\nfunction match(pattern, text) {\n  if (pattern === \"\") return true  // Our base case - if the pattern is empty, any inputted text is a match\n  else return matchOne(pattern[0], text[0]) && match(pattern.slice(1), text.slice(1))\n}\n```\n\nThe above code advances character by character across the the pattern/text pair. It first compares `pattern[0]` to `text[0]` and then `pattern[1]` to `text[1]` and continues comparing `pattern[i]` to `text[i]` until `i === pattern.length - 1`. If they ever don't match, then we know that the pattern cannot match the text.\n\nLet's take an example. Suppose we invoke `match('a.c', 'abc')`, which returns `matchOne('a', 'a') && match('.c', 'bc')`.\n\nIf we continue evaluating these functions, we get `matchOne('a', 'a') && matchOne('.', 'b') && matchOne('c', 'c') && match(\"\", \"\")`, which is just equal to `true && true && true && true`, So we have a match!\n\n## The $ Character\n\nLet's add support for the special pattern character `$` that allows us to match the end of a string. The solution simply requires adding an additional base case to the match function.\n\n```js\nfunction match(pattern, text) {\n  if (pattern === \"\") return true\n  if (pattern === \"$\" && text === \"\") return true\n  else return matchOne(pattern[0], text[0]) && match(pattern.slice(1), text.slice(1))\n}\n```\n\n## The ^ Character\n\nLet's add support for the special pattern character `^` that allows us to match the beginning of a string. I'm going to introduce a new function called `search`.\n\n```js\nfunction search(pattern, text) {\n  if (pattern[0] === \"^\") {\n    return match(pattern.slice(1), text)\n  }\n}\n```\n\nThis function will be the new entry point to our code. Up till this point, we were only matching patterns that began at the beginning of the text. We are simply making that more clear now by forcing the user to preface the pattern with a `^`. But how do we support patterns that appear anywhere within the text?\n\n## Matches Starting Anywhere\n\nCurrently, the following return `true`\n\n`search(\"^abc\", \"abc\")`\n`search(\"^abcd\", \"abcd\")`\n\nBut `search(\"bc\", \"abcd\")` will just return `undefined`. We want it to return `true`\n\nIf the user does not specify that the pattern matches the beginning of the text, then we want to search for that pattern at every possible starting point within the text. We will default to this behavior if the pattern does not begin with `^`<sup>[1](#footnote1)</sup>.\n\n```js\nfunction search(pattern, text) {\n  if (pattern[0] === \"^\") {\n    return match(pattern.slice(1), text)\n  } else {\n    // This code will run match(pattern, text.slice(index)) on every index of the text.\n    // This means that we test the pattern against every starting point of the text.\n    return text.split(\"\").some((_, index) => {\n      return match(pattern, text.slice(index))\n    })\n  }\n}\n```\n\n## The ? Character\n\nWe want to be able to match 0 to 1 of the character before `?`.\n\nHere are some examples\n\n`search(\"ab?c\", \"ac\")`    -> `true`\n`search(\"ab?c\", \"abc\")`   -> `true`\n`search(\"a?b?c?\", \"abc\")` -> `true`\n`search(\"a?b?c?\", \"\")`    -> `true`\n\nThe first step is to modify `match` to detect when a `?` character is present and then delegate to the `matchQuestion` function, which we will define shortly.\n\n```js\nfunction match(pattern, text) {\n  if (pattern === \"\") {\n    return true\n  } else if (pattern === \"$\" && text === \"\") {\n    return true\n  // Notice that we are looking at pattern[1] instead of pattern[0].\n  // pattern[0] is the character to match 0 or 1 of.\n  } else if (pattern[1] === \"?\") {\n    return matchQuestion(pattern, text)\n  } else {\n    return matchOne(pattern[0], text[0]) && match(pattern.slice(1), text.slice(1))\n  }\n}\n```\n\n`matchQuestion` needs to handle two cases:\n1. Where the character before the `?` is not matched but the text matches the remainder of the pattern (everything after the `?`).\n2. Where the character before the `?` is matched and the rest of the text (minus the 1 matched character) matches the remainder of the pattern.\n\nIf either of these cases is truthy, then `matchQuestion` can return `true`.\n\nLet's consider the first case. How do we check if the text matches everything in the pattern except the `_?` syntax? In order words, how do we check if the character before the `?` appears 0 times? We strip 2 characters off the pattern (the first character is the one before the `?` and the second is the `?` itself) and invoke the match function.\n\n```js\nfunction matchQuestion(pattern, text) {\n  return match(pattern.slice(2), text);\n}\n```\n\nThe second case is a little more challenging, but just like before, it reuses functions we've already written\n\n```js\nfunction matchQuestion(pattern, text) {\n  if (matchOne(pattern[0], text[0]) && match(pattern.slice(2), text.slice(1))) {\n    return true;\n  } else {\n    return match(pattern.slice(2), text);\n  }\n}\n```\n\nIf the `text[0]` matches `pattern[0]`, and the rest of the text (minus the part that is matched by `matchOne`) matches the remainder of the pattern, then we are golden. Note that we could rewrite the code like this:\n\n```js\nfunction matchQuestion(pattern, text) {\n  return (matchOne(pattern[0], text[0]) && match(pattern.slice(2), text.slice(1))) || match(pattern.slice(2), text);\n}\n```\n\nThe one thing I like about this latter approach is that the boolean OR makes it explicitly clear that there are two cases, either of which may be true.\n\n## The * Character\n\nWe want to be able to match the character before the `*` 0 or more times.\n\nAll of these should return `true`.\n\n`search(\"a*\", \"\")`\n`search(\"a*\", \"aaaaaaa\")`\n`search(\"a*b\", \"aaaaaaab\")`\n\nSimilar to what we did when supporting `?`, we wan to delegate to a `matchStar` function within our `match` function\n\n```js\nfunction match(pattern, text) {\n  if (pattern === \"\") {\n    return true\n  } else if (pattern === \"$\" && text === \"\") {\n    return true\n  } else if (pattern[1] === \"?\") {\n    return matchQuestion(pattern, text)\n  } else if (pattern[1] === \"*\") {\n    return matchStar(pattern, text)\n  } else {\n    return matchOne(pattern[0], text[0]) && match(pattern.slice(1), text.slice(1))\n  }\n}\n```\n\n`matchStar`, like `matchQuestion`, also needs to handle two cases:\n1. Where the character before the `*` is not matched but the text matches the remainder of the pattern (everything after the `*`).\n2. Where the character before the `*` is matched one or more times and the rest of the text matches the remainder of the pattern.\n\nSince there are two cases that both result in a match (0 matches OR more matches), we know that `matchStar` can be implemented with a boolean OR. Furthermore, case 1 for `matchStar` is exactly the same as it was for `matchQuestion` and can be implemented identically using `match(pattern.slice(2), text)`. That means we only need to formulate an expression that satisfies case 2.\n\n```js\nfunction matchStar(pattern, text) {\n  return (matchOne(pattern[0], text[0]) && match(pattern, text.slice(1))) || match(pattern.slice(2), text);\n}\n```\n\n## Refactoring\n\nWe can now go back and cleverly simplify `search` using a trick I learned in Peter Norvig's [class](https://www.udacity.com/course/design-of-computer-programs--cs212).\n\n```js\nfunction search(pattern, text) {\n  if (pattern[0] === \"^\") {\n    return match(pattern.slice(1), text)\n  } else {\n    return match(\".*\" + pattern, text)\n  }\n}\n```\n\nWe use the `*` character itself to allow for the pattern to appear anywhere in the string. The prepended `.*` says that any number of any character can appear before the pattern we wish to match.\n\n## Conclusion\n\nIt's remarkable how simple and elegant the code for such a sophisticated and generalized program can be. The full source is available in this [GitHub repository](https://github.com/nadrane/build-your-own-regex)\n\nHere is a [follow up article](https://nickdrane.com/regex-and-automated-test-fuzzing/) where I fuzz test the regex engine.\n\n\n#### Footnotes\n<a name=\"footnote1\">1</a>: There is a small bug in this code that I'm choosing to ignore. We don't account for the case that text is an empty string. Currently when `text === ''`, `text.split(\"\")` will return `[]` and will not appropriately call `match`.","source":"_posts/build-your-own-regex.md","raw":"---\ntitle: Build a Regex Engine in Less than 40 Lines of Code\ndate: 2017-11-28 11:36:04\ncategories:\n  - [Regular Expressions]\n  - [Javascript]\n  - [Recursion]\n  - [Build Your Own]\n---\n\nI stumbled upon an [article](https://www.cs.princeton.edu/courses/archive/spr09/cos333/beautiful.html) the other day where Rob Pike implements a rudimentary regular expression engine in c. I converted his code to Javascript and added test specs so that someone can self-guide themselves through the creation of the regex engine. The specs and solution can be found in this [GitHub repository](https://github.com/nadrane/build-your-own-regex). This blog post walks through my solution.\n\n<!-- more -->\n\n## The Problem\n\nOur regex engine will support the following syntax:\n\n| Syntax | Meaning | Example | matches |\n|--------|---------|---------|---------|\n| a | Matches the specified character literal | q | q |\n| * | Matches 0 or more of the previous character | a* | \"\", a, aa, aaa  |\n| ? | Matches 0 or 1 of the previous character | a? | \"\", a |\n| . | Matches any character literal | . | a, b, c, d, e ... |\n| ^ | Matches the start of a string | ^c | c, ca, caa, cbb ... |\n| $ | Matches the end of a string | a$ | ba, baaa, qwerta ... |\n\nThe goal is to provide a syntax robust enough to match a large portion of regex use cases with minimal code.\n\n## Matching One Character\n\nThe first step is to write a function that takes in a one character pattern and a one character text string and returns a boolean indicating if they match. A pattern of `.` is considered a wildcard and matches against any character literal.\n\nHere are some examples\n\n`matchOne('a', 'a')` -> `true`\n`matchOne('.', 'z')` -> `true`\n`matchOne('', 'h')`  -> `true`\n`matchOne('a', 'b')` -> `false`\n`matchOne('p', '')`  -> `false`\n\n\n```js\nfunction matchOne(pattern, text) {\n  if (!pattern) return true // Any text matches an empty pattern\n  if (!text) return false   // If the pattern is defined but the text is empty, there cannot be a match\n  if (pattern === \".\") return true // Any inputted text matches the wildcard\n  return pattern === text\n}\n```\n\n## Matching Same Length Strings\n\nNow we want to add support for patterns and text strings of greater length. For now, let's only consider a pattern/text pair of the same length. I happen to know that the solution lends itself very naturally to recursion, so we will use it here. We are going to want to repeatedly invoke `matchOne` on successive pairs of characters from the pattern/text combination.\n\n```js\nfunction match(pattern, text) {\n  if (pattern === \"\") return true  // Our base case - if the pattern is empty, any inputted text is a match\n  else return matchOne(pattern[0], text[0]) && match(pattern.slice(1), text.slice(1))\n}\n```\n\nThe above code advances character by character across the the pattern/text pair. It first compares `pattern[0]` to `text[0]` and then `pattern[1]` to `text[1]` and continues comparing `pattern[i]` to `text[i]` until `i === pattern.length - 1`. If they ever don't match, then we know that the pattern cannot match the text.\n\nLet's take an example. Suppose we invoke `match('a.c', 'abc')`, which returns `matchOne('a', 'a') && match('.c', 'bc')`.\n\nIf we continue evaluating these functions, we get `matchOne('a', 'a') && matchOne('.', 'b') && matchOne('c', 'c') && match(\"\", \"\")`, which is just equal to `true && true && true && true`, So we have a match!\n\n## The $ Character\n\nLet's add support for the special pattern character `$` that allows us to match the end of a string. The solution simply requires adding an additional base case to the match function.\n\n```js\nfunction match(pattern, text) {\n  if (pattern === \"\") return true\n  if (pattern === \"$\" && text === \"\") return true\n  else return matchOne(pattern[0], text[0]) && match(pattern.slice(1), text.slice(1))\n}\n```\n\n## The ^ Character\n\nLet's add support for the special pattern character `^` that allows us to match the beginning of a string. I'm going to introduce a new function called `search`.\n\n```js\nfunction search(pattern, text) {\n  if (pattern[0] === \"^\") {\n    return match(pattern.slice(1), text)\n  }\n}\n```\n\nThis function will be the new entry point to our code. Up till this point, we were only matching patterns that began at the beginning of the text. We are simply making that more clear now by forcing the user to preface the pattern with a `^`. But how do we support patterns that appear anywhere within the text?\n\n## Matches Starting Anywhere\n\nCurrently, the following return `true`\n\n`search(\"^abc\", \"abc\")`\n`search(\"^abcd\", \"abcd\")`\n\nBut `search(\"bc\", \"abcd\")` will just return `undefined`. We want it to return `true`\n\nIf the user does not specify that the pattern matches the beginning of the text, then we want to search for that pattern at every possible starting point within the text. We will default to this behavior if the pattern does not begin with `^`<sup>[1](#footnote1)</sup>.\n\n```js\nfunction search(pattern, text) {\n  if (pattern[0] === \"^\") {\n    return match(pattern.slice(1), text)\n  } else {\n    // This code will run match(pattern, text.slice(index)) on every index of the text.\n    // This means that we test the pattern against every starting point of the text.\n    return text.split(\"\").some((_, index) => {\n      return match(pattern, text.slice(index))\n    })\n  }\n}\n```\n\n## The ? Character\n\nWe want to be able to match 0 to 1 of the character before `?`.\n\nHere are some examples\n\n`search(\"ab?c\", \"ac\")`    -> `true`\n`search(\"ab?c\", \"abc\")`   -> `true`\n`search(\"a?b?c?\", \"abc\")` -> `true`\n`search(\"a?b?c?\", \"\")`    -> `true`\n\nThe first step is to modify `match` to detect when a `?` character is present and then delegate to the `matchQuestion` function, which we will define shortly.\n\n```js\nfunction match(pattern, text) {\n  if (pattern === \"\") {\n    return true\n  } else if (pattern === \"$\" && text === \"\") {\n    return true\n  // Notice that we are looking at pattern[1] instead of pattern[0].\n  // pattern[0] is the character to match 0 or 1 of.\n  } else if (pattern[1] === \"?\") {\n    return matchQuestion(pattern, text)\n  } else {\n    return matchOne(pattern[0], text[0]) && match(pattern.slice(1), text.slice(1))\n  }\n}\n```\n\n`matchQuestion` needs to handle two cases:\n1. Where the character before the `?` is not matched but the text matches the remainder of the pattern (everything after the `?`).\n2. Where the character before the `?` is matched and the rest of the text (minus the 1 matched character) matches the remainder of the pattern.\n\nIf either of these cases is truthy, then `matchQuestion` can return `true`.\n\nLet's consider the first case. How do we check if the text matches everything in the pattern except the `_?` syntax? In order words, how do we check if the character before the `?` appears 0 times? We strip 2 characters off the pattern (the first character is the one before the `?` and the second is the `?` itself) and invoke the match function.\n\n```js\nfunction matchQuestion(pattern, text) {\n  return match(pattern.slice(2), text);\n}\n```\n\nThe second case is a little more challenging, but just like before, it reuses functions we've already written\n\n```js\nfunction matchQuestion(pattern, text) {\n  if (matchOne(pattern[0], text[0]) && match(pattern.slice(2), text.slice(1))) {\n    return true;\n  } else {\n    return match(pattern.slice(2), text);\n  }\n}\n```\n\nIf the `text[0]` matches `pattern[0]`, and the rest of the text (minus the part that is matched by `matchOne`) matches the remainder of the pattern, then we are golden. Note that we could rewrite the code like this:\n\n```js\nfunction matchQuestion(pattern, text) {\n  return (matchOne(pattern[0], text[0]) && match(pattern.slice(2), text.slice(1))) || match(pattern.slice(2), text);\n}\n```\n\nThe one thing I like about this latter approach is that the boolean OR makes it explicitly clear that there are two cases, either of which may be true.\n\n## The * Character\n\nWe want to be able to match the character before the `*` 0 or more times.\n\nAll of these should return `true`.\n\n`search(\"a*\", \"\")`\n`search(\"a*\", \"aaaaaaa\")`\n`search(\"a*b\", \"aaaaaaab\")`\n\nSimilar to what we did when supporting `?`, we wan to delegate to a `matchStar` function within our `match` function\n\n```js\nfunction match(pattern, text) {\n  if (pattern === \"\") {\n    return true\n  } else if (pattern === \"$\" && text === \"\") {\n    return true\n  } else if (pattern[1] === \"?\") {\n    return matchQuestion(pattern, text)\n  } else if (pattern[1] === \"*\") {\n    return matchStar(pattern, text)\n  } else {\n    return matchOne(pattern[0], text[0]) && match(pattern.slice(1), text.slice(1))\n  }\n}\n```\n\n`matchStar`, like `matchQuestion`, also needs to handle two cases:\n1. Where the character before the `*` is not matched but the text matches the remainder of the pattern (everything after the `*`).\n2. Where the character before the `*` is matched one or more times and the rest of the text matches the remainder of the pattern.\n\nSince there are two cases that both result in a match (0 matches OR more matches), we know that `matchStar` can be implemented with a boolean OR. Furthermore, case 1 for `matchStar` is exactly the same as it was for `matchQuestion` and can be implemented identically using `match(pattern.slice(2), text)`. That means we only need to formulate an expression that satisfies case 2.\n\n```js\nfunction matchStar(pattern, text) {\n  return (matchOne(pattern[0], text[0]) && match(pattern, text.slice(1))) || match(pattern.slice(2), text);\n}\n```\n\n## Refactoring\n\nWe can now go back and cleverly simplify `search` using a trick I learned in Peter Norvig's [class](https://www.udacity.com/course/design-of-computer-programs--cs212).\n\n```js\nfunction search(pattern, text) {\n  if (pattern[0] === \"^\") {\n    return match(pattern.slice(1), text)\n  } else {\n    return match(\".*\" + pattern, text)\n  }\n}\n```\n\nWe use the `*` character itself to allow for the pattern to appear anywhere in the string. The prepended `.*` says that any number of any character can appear before the pattern we wish to match.\n\n## Conclusion\n\nIt's remarkable how simple and elegant the code for such a sophisticated and generalized program can be. The full source is available in this [GitHub repository](https://github.com/nadrane/build-your-own-regex)\n\nHere is a [follow up article](https://nickdrane.com/regex-and-automated-test-fuzzing/) where I fuzz test the regex engine.\n\n\n#### Footnotes\n<a name=\"footnote1\">1</a>: There is a small bug in this code that I'm choosing to ignore. We don't account for the case that text is an empty string. Currently when `text === ''`, `text.split(\"\")` will return `[]` and will not appropriately call `match`.","slug":"build-your-own-regex","published":1,"updated":"2018-10-18T03:20:23.620Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vnr000j67oza5lnzuzt","content":"<p>I stumbled upon an <a href=\"https://www.cs.princeton.edu/courses/archive/spr09/cos333/beautiful.html\" target=\"_blank\" rel=\"noopener\">article</a> the other day where Rob Pike implements a rudimentary regular expression engine in c. I converted his code to Javascript and added test specs so that someone can self-guide themselves through the creation of the regex engine. The specs and solution can be found in this <a href=\"https://github.com/nadrane/build-your-own-regex\" target=\"_blank\" rel=\"noopener\">GitHub repository</a>. This blog post walks through my solution.</p>\n<a id=\"more\"></a>\n<h2 id=\"The-Problem\"><a href=\"#The-Problem\" class=\"headerlink\" title=\"The Problem\"></a>The Problem</h2><p>Our regex engine will support the following syntax:</p>\n<table>\n<thead>\n<tr>\n<th>Syntax</th>\n<th>Meaning</th>\n<th>Example</th>\n<th>matches</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>a</td>\n<td>Matches the specified character literal</td>\n<td>q</td>\n<td>q</td>\n</tr>\n<tr>\n<td>*</td>\n<td>Matches 0 or more of the previous character</td>\n<td>a*</td>\n<td>“”, a, aa, aaa</td>\n</tr>\n<tr>\n<td>?</td>\n<td>Matches 0 or 1 of the previous character</td>\n<td>a?</td>\n<td>“”, a</td>\n</tr>\n<tr>\n<td>.</td>\n<td>Matches any character literal</td>\n<td>.</td>\n<td>a, b, c, d, e …</td>\n</tr>\n<tr>\n<td>^</td>\n<td>Matches the start of a string</td>\n<td>^c</td>\n<td>c, ca, caa, cbb …</td>\n</tr>\n<tr>\n<td>$</td>\n<td>Matches the end of a string</td>\n<td>a$</td>\n<td>ba, baaa, qwerta …</td>\n</tr>\n</tbody>\n</table>\n<p>The goal is to provide a syntax robust enough to match a large portion of regex use cases with minimal code.</p>\n<h2 id=\"Matching-One-Character\"><a href=\"#Matching-One-Character\" class=\"headerlink\" title=\"Matching One Character\"></a>Matching One Character</h2><p>The first step is to write a function that takes in a one character pattern and a one character text string and returns a boolean indicating if they match. A pattern of <code>.</code> is considered a wildcard and matches against any character literal.</p>\n<p>Here are some examples</p>\n<p><code>matchOne(&#39;a&#39;, &#39;a&#39;)</code> -&gt; <code>true</code><br><code>matchOne(&#39;.&#39;, &#39;z&#39;)</code> -&gt; <code>true</code><br><code>matchOne(&#39;&#39;, &#39;h&#39;)</code>  -&gt; <code>true</code><br><code>matchOne(&#39;a&#39;, &#39;b&#39;)</code> -&gt; <code>false</code><br><code>matchOne(&#39;p&#39;, &#39;&#39;)</code>  -&gt; <code>false</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchOne</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!pattern) <span class=\"keyword\">return</span> <span class=\"literal\">true</span> <span class=\"comment\">// Any text matches an empty pattern</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!text) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>   <span class=\"comment\">// If the pattern is defined but the text is empty, there cannot be a match</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\".\"</span>) <span class=\"keyword\">return</span> <span class=\"literal\">true</span> <span class=\"comment\">// Any inputted text matches the wildcard</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> pattern === text</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Matching-Same-Length-Strings\"><a href=\"#Matching-Same-Length-Strings\" class=\"headerlink\" title=\"Matching Same Length Strings\"></a>Matching Same Length Strings</h2><p>Now we want to add support for patterns and text strings of greater length. For now, let’s only consider a pattern/text pair of the same length. I happen to know that the solution lends itself very naturally to recursion, so we will use it here. We are going to want to repeatedly invoke <code>matchOne</code> on successive pairs of characters from the pattern/text combination.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">match</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"\"</span>) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>  <span class=\"comment\">// Our base case - if the pattern is empty, any inputted text is a match</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">return</span> matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">1</span>), text.slice(<span class=\"number\">1</span>))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The above code advances character by character across the the pattern/text pair. It first compares <code>pattern[0]</code> to <code>text[0]</code> and then <code>pattern[1]</code> to <code>text[1]</code> and continues comparing <code>pattern[i]</code> to <code>text[i]</code> until <code>i === pattern.length - 1</code>. If they ever don’t match, then we know that the pattern cannot match the text.</p>\n<p>Let’s take an example. Suppose we invoke <code>match(&#39;a.c&#39;, &#39;abc&#39;)</code>, which returns <code>matchOne(&#39;a&#39;, &#39;a&#39;) &amp;&amp; match(&#39;.c&#39;, &#39;bc&#39;)</code>.</p>\n<p>If we continue evaluating these functions, we get <code>matchOne(&#39;a&#39;, &#39;a&#39;) &amp;&amp; matchOne(&#39;.&#39;, &#39;b&#39;) &amp;&amp; matchOne(&#39;c&#39;, &#39;c&#39;) &amp;&amp; match(&quot;&quot;, &quot;&quot;)</code>, which is just equal to <code>true &amp;&amp; true &amp;&amp; true &amp;&amp; true</code>, So we have a match!</p>\n<h2 id=\"The-Character\"><a href=\"#The-Character\" class=\"headerlink\" title=\"The $ Character\"></a>The $ Character</h2><p>Let’s add support for the special pattern character <code>$</code> that allows us to match the end of a string. The solution simply requires adding an additional base case to the match function.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">match</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"\"</span>) <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"$\"</span> &amp;&amp; text === <span class=\"string\">\"\"</span>) <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">return</span> matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">1</span>), text.slice(<span class=\"number\">1</span>))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"The-Character-1\"><a href=\"#The-Character-1\" class=\"headerlink\" title=\"The ^ Character\"></a>The ^ Character</h2><p>Let’s add support for the special pattern character <code>^</code> that allows us to match the beginning of a string. I’m going to introduce a new function called <code>search</code>.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern[<span class=\"number\">0</span>] === <span class=\"string\">\"^\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">1</span>), text)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>This function will be the new entry point to our code. Up till this point, we were only matching patterns that began at the beginning of the text. We are simply making that more clear now by forcing the user to preface the pattern with a <code>^</code>. But how do we support patterns that appear anywhere within the text?</p>\n<h2 id=\"Matches-Starting-Anywhere\"><a href=\"#Matches-Starting-Anywhere\" class=\"headerlink\" title=\"Matches Starting Anywhere\"></a>Matches Starting Anywhere</h2><p>Currently, the following return <code>true</code></p>\n<p><code>search(&quot;^abc&quot;, &quot;abc&quot;)</code><br><code>search(&quot;^abcd&quot;, &quot;abcd&quot;)</code></p>\n<p>But <code>search(&quot;bc&quot;, &quot;abcd&quot;)</code> will just return <code>undefined</code>. We want it to return <code>true</code></p>\n<p>If the user does not specify that the pattern matches the beginning of the text, then we want to search for that pattern at every possible starting point within the text. We will default to this behavior if the pattern does not begin with <code>^</code><sup><a href=\"#footnote1\">1</a></sup>.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern[<span class=\"number\">0</span>] === <span class=\"string\">\"^\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">1</span>), text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// This code will run match(pattern, text.slice(index)) on every index of the text.</span></span><br><span class=\"line\">    <span class=\"comment\">// This means that we test the pattern against every starting point of the text.</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> text.split(<span class=\"string\">\"\"</span>).some(<span class=\"function\">(<span class=\"params\">_, index</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> match(pattern, text.slice(index))</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"The-Character-2\"><a href=\"#The-Character-2\" class=\"headerlink\" title=\"The ? Character\"></a>The ? Character</h2><p>We want to be able to match 0 to 1 of the character before <code>?</code>.</p>\n<p>Here are some examples</p>\n<p><code>search(&quot;ab?c&quot;, &quot;ac&quot;)</code>    -&gt; <code>true</code><br><code>search(&quot;ab?c&quot;, &quot;abc&quot;)</code>   -&gt; <code>true</code><br><code>search(&quot;a?b?c?&quot;, &quot;abc&quot;)</code> -&gt; <code>true</code><br><code>search(&quot;a?b?c?&quot;, &quot;&quot;)</code>    -&gt; <code>true</code></p>\n<p>The first step is to modify <code>match</code> to detect when a <code>?</code> character is present and then delegate to the <code>matchQuestion</code> function, which we will define shortly.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">match</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"$\"</span> &amp;&amp; text === <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\">// Notice that we are looking at pattern[1] instead of pattern[0].</span></span><br><span class=\"line\">  <span class=\"comment\">// pattern[0] is the character to match 0 or 1 of.</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern[<span class=\"number\">1</span>] === <span class=\"string\">\"?\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchQuestion(pattern, text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">1</span>), text.slice(<span class=\"number\">1</span>))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>matchQuestion</code> needs to handle two cases:</p>\n<ol>\n<li>Where the character before the <code>?</code> is not matched but the text matches the remainder of the pattern (everything after the <code>?</code>).</li>\n<li>Where the character before the <code>?</code> is matched and the rest of the text (minus the 1 matched character) matches the remainder of the pattern.</li>\n</ol>\n<p>If either of these cases is truthy, then <code>matchQuestion</code> can return <code>true</code>.</p>\n<p>Let’s consider the first case. How do we check if the text matches everything in the pattern except the <code>_?</code> syntax? In order words, how do we check if the character before the <code>?</code> appears 0 times? We strip 2 characters off the pattern (the first character is the one before the <code>?</code> and the second is the <code>?</code> itself) and invoke the match function.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchQuestion</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">2</span>), text);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The second case is a little more challenging, but just like before, it reuses functions we’ve already written</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchQuestion</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">2</span>), text.slice(<span class=\"number\">1</span>))) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">2</span>), text);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>If the <code>text[0]</code> matches <code>pattern[0]</code>, and the rest of the text (minus the part that is matched by <code>matchOne</code>) matches the remainder of the pattern, then we are golden. Note that we could rewrite the code like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchQuestion</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">2</span>), text.slice(<span class=\"number\">1</span>))) || match(pattern.slice(<span class=\"number\">2</span>), text);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The one thing I like about this latter approach is that the boolean OR makes it explicitly clear that there are two cases, either of which may be true.</p>\n<h2 id=\"The-Character-3\"><a href=\"#The-Character-3\" class=\"headerlink\" title=\"The * Character\"></a>The * Character</h2><p>We want to be able to match the character before the <code>*</code> 0 or more times.</p>\n<p>All of these should return <code>true</code>.</p>\n<p><code>search(&quot;a*&quot;, &quot;&quot;)</code><br><code>search(&quot;a*&quot;, &quot;aaaaaaa&quot;)</code><br><code>search(&quot;a*b&quot;, &quot;aaaaaaab&quot;)</code></p>\n<p>Similar to what we did when supporting <code>?</code>, we wan to delegate to a <code>matchStar</code> function within our <code>match</code> function</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">match</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"$\"</span> &amp;&amp; text === <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern[<span class=\"number\">1</span>] === <span class=\"string\">\"?\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchQuestion(pattern, text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern[<span class=\"number\">1</span>] === <span class=\"string\">\"*\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchStar(pattern, text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">1</span>), text.slice(<span class=\"number\">1</span>))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>matchStar</code>, like <code>matchQuestion</code>, also needs to handle two cases:</p>\n<ol>\n<li>Where the character before the <code>*</code> is not matched but the text matches the remainder of the pattern (everything after the <code>*</code>).</li>\n<li>Where the character before the <code>*</code> is matched one or more times and the rest of the text matches the remainder of the pattern.</li>\n</ol>\n<p>Since there are two cases that both result in a match (0 matches OR more matches), we know that <code>matchStar</code> can be implemented with a boolean OR. Furthermore, case 1 for <code>matchStar</code> is exactly the same as it was for <code>matchQuestion</code> and can be implemented identically using <code>match(pattern.slice(2), text)</code>. That means we only need to formulate an expression that satisfies case 2.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchStar</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern, text.slice(<span class=\"number\">1</span>))) || match(pattern.slice(<span class=\"number\">2</span>), text);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Refactoring\"><a href=\"#Refactoring\" class=\"headerlink\" title=\"Refactoring\"></a>Refactoring</h2><p>We can now go back and cleverly simplify <code>search</code> using a trick I learned in Peter Norvig’s <a href=\"https://www.udacity.com/course/design-of-computer-programs--cs212\" target=\"_blank\" rel=\"noopener\">class</a>.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern[<span class=\"number\">0</span>] === <span class=\"string\">\"^\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">1</span>), text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(<span class=\"string\">\".*\"</span> + pattern, text)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We use the <code>*</code> character itself to allow for the pattern to appear anywhere in the string. The prepended <code>.*</code> says that any number of any character can appear before the pattern we wish to match.</p>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>It’s remarkable how simple and elegant the code for such a sophisticated and generalized program can be. The full source is available in this <a href=\"https://github.com/nadrane/build-your-own-regex\" target=\"_blank\" rel=\"noopener\">GitHub repository</a></p>\n<p>Here is a <a href=\"https://nickdrane.com/regex-and-automated-test-fuzzing/\">follow up article</a> where I fuzz test the regex engine.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: There is a small bug in this code that I’m choosing to ignore. We don’t account for the case that text is an empty string. Currently when <code>text === &#39;&#39;</code>, <code>text.split(&quot;&quot;)</code> will return <code>[]</code> and will not appropriately call <code>match</code>.</p>\n","site":{"data":{}},"excerpt":"<p>I stumbled upon an <a href=\"https://www.cs.princeton.edu/courses/archive/spr09/cos333/beautiful.html\" target=\"_blank\" rel=\"noopener\">article</a> the other day where Rob Pike implements a rudimentary regular expression engine in c. I converted his code to Javascript and added test specs so that someone can self-guide themselves through the creation of the regex engine. The specs and solution can be found in this <a href=\"https://github.com/nadrane/build-your-own-regex\" target=\"_blank\" rel=\"noopener\">GitHub repository</a>. This blog post walks through my solution.</p>","more":"<h2 id=\"The-Problem\"><a href=\"#The-Problem\" class=\"headerlink\" title=\"The Problem\"></a>The Problem</h2><p>Our regex engine will support the following syntax:</p>\n<table>\n<thead>\n<tr>\n<th>Syntax</th>\n<th>Meaning</th>\n<th>Example</th>\n<th>matches</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>a</td>\n<td>Matches the specified character literal</td>\n<td>q</td>\n<td>q</td>\n</tr>\n<tr>\n<td>*</td>\n<td>Matches 0 or more of the previous character</td>\n<td>a*</td>\n<td>“”, a, aa, aaa</td>\n</tr>\n<tr>\n<td>?</td>\n<td>Matches 0 or 1 of the previous character</td>\n<td>a?</td>\n<td>“”, a</td>\n</tr>\n<tr>\n<td>.</td>\n<td>Matches any character literal</td>\n<td>.</td>\n<td>a, b, c, d, e …</td>\n</tr>\n<tr>\n<td>^</td>\n<td>Matches the start of a string</td>\n<td>^c</td>\n<td>c, ca, caa, cbb …</td>\n</tr>\n<tr>\n<td>$</td>\n<td>Matches the end of a string</td>\n<td>a$</td>\n<td>ba, baaa, qwerta …</td>\n</tr>\n</tbody>\n</table>\n<p>The goal is to provide a syntax robust enough to match a large portion of regex use cases with minimal code.</p>\n<h2 id=\"Matching-One-Character\"><a href=\"#Matching-One-Character\" class=\"headerlink\" title=\"Matching One Character\"></a>Matching One Character</h2><p>The first step is to write a function that takes in a one character pattern and a one character text string and returns a boolean indicating if they match. A pattern of <code>.</code> is considered a wildcard and matches against any character literal.</p>\n<p>Here are some examples</p>\n<p><code>matchOne(&#39;a&#39;, &#39;a&#39;)</code> -&gt; <code>true</code><br><code>matchOne(&#39;.&#39;, &#39;z&#39;)</code> -&gt; <code>true</code><br><code>matchOne(&#39;&#39;, &#39;h&#39;)</code>  -&gt; <code>true</code><br><code>matchOne(&#39;a&#39;, &#39;b&#39;)</code> -&gt; <code>false</code><br><code>matchOne(&#39;p&#39;, &#39;&#39;)</code>  -&gt; <code>false</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchOne</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!pattern) <span class=\"keyword\">return</span> <span class=\"literal\">true</span> <span class=\"comment\">// Any text matches an empty pattern</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!text) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>   <span class=\"comment\">// If the pattern is defined but the text is empty, there cannot be a match</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\".\"</span>) <span class=\"keyword\">return</span> <span class=\"literal\">true</span> <span class=\"comment\">// Any inputted text matches the wildcard</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> pattern === text</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Matching-Same-Length-Strings\"><a href=\"#Matching-Same-Length-Strings\" class=\"headerlink\" title=\"Matching Same Length Strings\"></a>Matching Same Length Strings</h2><p>Now we want to add support for patterns and text strings of greater length. For now, let’s only consider a pattern/text pair of the same length. I happen to know that the solution lends itself very naturally to recursion, so we will use it here. We are going to want to repeatedly invoke <code>matchOne</code> on successive pairs of characters from the pattern/text combination.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">match</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"\"</span>) <span class=\"keyword\">return</span> <span class=\"literal\">true</span>  <span class=\"comment\">// Our base case - if the pattern is empty, any inputted text is a match</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">return</span> matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">1</span>), text.slice(<span class=\"number\">1</span>))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The above code advances character by character across the the pattern/text pair. It first compares <code>pattern[0]</code> to <code>text[0]</code> and then <code>pattern[1]</code> to <code>text[1]</code> and continues comparing <code>pattern[i]</code> to <code>text[i]</code> until <code>i === pattern.length - 1</code>. If they ever don’t match, then we know that the pattern cannot match the text.</p>\n<p>Let’s take an example. Suppose we invoke <code>match(&#39;a.c&#39;, &#39;abc&#39;)</code>, which returns <code>matchOne(&#39;a&#39;, &#39;a&#39;) &amp;&amp; match(&#39;.c&#39;, &#39;bc&#39;)</code>.</p>\n<p>If we continue evaluating these functions, we get <code>matchOne(&#39;a&#39;, &#39;a&#39;) &amp;&amp; matchOne(&#39;.&#39;, &#39;b&#39;) &amp;&amp; matchOne(&#39;c&#39;, &#39;c&#39;) &amp;&amp; match(&quot;&quot;, &quot;&quot;)</code>, which is just equal to <code>true &amp;&amp; true &amp;&amp; true &amp;&amp; true</code>, So we have a match!</p>\n<h2 id=\"The-Character\"><a href=\"#The-Character\" class=\"headerlink\" title=\"The $ Character\"></a>The $ Character</h2><p>Let’s add support for the special pattern character <code>$</code> that allows us to match the end of a string. The solution simply requires adding an additional base case to the match function.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">match</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"\"</span>) <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"$\"</span> &amp;&amp; text === <span class=\"string\">\"\"</span>) <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">return</span> matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">1</span>), text.slice(<span class=\"number\">1</span>))</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"The-Character-1\"><a href=\"#The-Character-1\" class=\"headerlink\" title=\"The ^ Character\"></a>The ^ Character</h2><p>Let’s add support for the special pattern character <code>^</code> that allows us to match the beginning of a string. I’m going to introduce a new function called <code>search</code>.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern[<span class=\"number\">0</span>] === <span class=\"string\">\"^\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">1</span>), text)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>This function will be the new entry point to our code. Up till this point, we were only matching patterns that began at the beginning of the text. We are simply making that more clear now by forcing the user to preface the pattern with a <code>^</code>. But how do we support patterns that appear anywhere within the text?</p>\n<h2 id=\"Matches-Starting-Anywhere\"><a href=\"#Matches-Starting-Anywhere\" class=\"headerlink\" title=\"Matches Starting Anywhere\"></a>Matches Starting Anywhere</h2><p>Currently, the following return <code>true</code></p>\n<p><code>search(&quot;^abc&quot;, &quot;abc&quot;)</code><br><code>search(&quot;^abcd&quot;, &quot;abcd&quot;)</code></p>\n<p>But <code>search(&quot;bc&quot;, &quot;abcd&quot;)</code> will just return <code>undefined</code>. We want it to return <code>true</code></p>\n<p>If the user does not specify that the pattern matches the beginning of the text, then we want to search for that pattern at every possible starting point within the text. We will default to this behavior if the pattern does not begin with <code>^</code><sup><a href=\"#footnote1\">1</a></sup>.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern[<span class=\"number\">0</span>] === <span class=\"string\">\"^\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">1</span>), text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// This code will run match(pattern, text.slice(index)) on every index of the text.</span></span><br><span class=\"line\">    <span class=\"comment\">// This means that we test the pattern against every starting point of the text.</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> text.split(<span class=\"string\">\"\"</span>).some(<span class=\"function\">(<span class=\"params\">_, index</span>) =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> match(pattern, text.slice(index))</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"The-Character-2\"><a href=\"#The-Character-2\" class=\"headerlink\" title=\"The ? Character\"></a>The ? Character</h2><p>We want to be able to match 0 to 1 of the character before <code>?</code>.</p>\n<p>Here are some examples</p>\n<p><code>search(&quot;ab?c&quot;, &quot;ac&quot;)</code>    -&gt; <code>true</code><br><code>search(&quot;ab?c&quot;, &quot;abc&quot;)</code>   -&gt; <code>true</code><br><code>search(&quot;a?b?c?&quot;, &quot;abc&quot;)</code> -&gt; <code>true</code><br><code>search(&quot;a?b?c?&quot;, &quot;&quot;)</code>    -&gt; <code>true</code></p>\n<p>The first step is to modify <code>match</code> to detect when a <code>?</code> character is present and then delegate to the <code>matchQuestion</code> function, which we will define shortly.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">match</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"$\"</span> &amp;&amp; text === <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\">// Notice that we are looking at pattern[1] instead of pattern[0].</span></span><br><span class=\"line\">  <span class=\"comment\">// pattern[0] is the character to match 0 or 1 of.</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern[<span class=\"number\">1</span>] === <span class=\"string\">\"?\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchQuestion(pattern, text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">1</span>), text.slice(<span class=\"number\">1</span>))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>matchQuestion</code> needs to handle two cases:</p>\n<ol>\n<li>Where the character before the <code>?</code> is not matched but the text matches the remainder of the pattern (everything after the <code>?</code>).</li>\n<li>Where the character before the <code>?</code> is matched and the rest of the text (minus the 1 matched character) matches the remainder of the pattern.</li>\n</ol>\n<p>If either of these cases is truthy, then <code>matchQuestion</code> can return <code>true</code>.</p>\n<p>Let’s consider the first case. How do we check if the text matches everything in the pattern except the <code>_?</code> syntax? In order words, how do we check if the character before the <code>?</code> appears 0 times? We strip 2 characters off the pattern (the first character is the one before the <code>?</code> and the second is the <code>?</code> itself) and invoke the match function.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchQuestion</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">2</span>), text);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The second case is a little more challenging, but just like before, it reuses functions we’ve already written</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchQuestion</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">2</span>), text.slice(<span class=\"number\">1</span>))) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">2</span>), text);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>If the <code>text[0]</code> matches <code>pattern[0]</code>, and the rest of the text (minus the part that is matched by <code>matchOne</code>) matches the remainder of the pattern, then we are golden. Note that we could rewrite the code like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchQuestion</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">2</span>), text.slice(<span class=\"number\">1</span>))) || match(pattern.slice(<span class=\"number\">2</span>), text);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The one thing I like about this latter approach is that the boolean OR makes it explicitly clear that there are two cases, either of which may be true.</p>\n<h2 id=\"The-Character-3\"><a href=\"#The-Character-3\" class=\"headerlink\" title=\"The * Character\"></a>The * Character</h2><p>We want to be able to match the character before the <code>*</code> 0 or more times.</p>\n<p>All of these should return <code>true</code>.</p>\n<p><code>search(&quot;a*&quot;, &quot;&quot;)</code><br><code>search(&quot;a*&quot;, &quot;aaaaaaa&quot;)</code><br><code>search(&quot;a*b&quot;, &quot;aaaaaaab&quot;)</code></p>\n<p>Similar to what we did when supporting <code>?</code>, we wan to delegate to a <code>matchStar</code> function within our <code>match</code> function</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">match</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern === <span class=\"string\">\"$\"</span> &amp;&amp; text === <span class=\"string\">\"\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern[<span class=\"number\">1</span>] === <span class=\"string\">\"?\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchQuestion(pattern, text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (pattern[<span class=\"number\">1</span>] === <span class=\"string\">\"*\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchStar(pattern, text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern.slice(<span class=\"number\">1</span>), text.slice(<span class=\"number\">1</span>))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>matchStar</code>, like <code>matchQuestion</code>, also needs to handle two cases:</p>\n<ol>\n<li>Where the character before the <code>*</code> is not matched but the text matches the remainder of the pattern (everything after the <code>*</code>).</li>\n<li>Where the character before the <code>*</code> is matched one or more times and the rest of the text matches the remainder of the pattern.</li>\n</ol>\n<p>Since there are two cases that both result in a match (0 matches OR more matches), we know that <code>matchStar</code> can be implemented with a boolean OR. Furthermore, case 1 for <code>matchStar</code> is exactly the same as it was for <code>matchQuestion</code> and can be implemented identically using <code>match(pattern.slice(2), text)</code>. That means we only need to formulate an expression that satisfies case 2.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">matchStar</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (matchOne(pattern[<span class=\"number\">0</span>], text[<span class=\"number\">0</span>]) &amp;&amp; match(pattern, text.slice(<span class=\"number\">1</span>))) || match(pattern.slice(<span class=\"number\">2</span>), text);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Refactoring\"><a href=\"#Refactoring\" class=\"headerlink\" title=\"Refactoring\"></a>Refactoring</h2><p>We can now go back and cleverly simplify <code>search</code> using a trick I learned in Peter Norvig’s <a href=\"https://www.udacity.com/course/design-of-computer-programs--cs212\" target=\"_blank\" rel=\"noopener\">class</a>.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">search</span>(<span class=\"params\">pattern, text</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pattern[<span class=\"number\">0</span>] === <span class=\"string\">\"^\"</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(pattern.slice(<span class=\"number\">1</span>), text)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> match(<span class=\"string\">\".*\"</span> + pattern, text)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We use the <code>*</code> character itself to allow for the pattern to appear anywhere in the string. The prepended <code>.*</code> says that any number of any character can appear before the pattern we wish to match.</p>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>It’s remarkable how simple and elegant the code for such a sophisticated and generalized program can be. The full source is available in this <a href=\"https://github.com/nadrane/build-your-own-regex\" target=\"_blank\" rel=\"noopener\">GitHub repository</a></p>\n<p>Here is a <a href=\"https://nickdrane.com/regex-and-automated-test-fuzzing/\">follow up article</a> where I fuzz test the regex engine.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: There is a small bug in this code that I’m choosing to ignore. We don’t account for the case that text is an empty string. Currently when <code>text === &#39;&#39;</code>, <code>text.split(&quot;&quot;)</code> will return <code>[]</code> and will not appropriately call <code>match</code>.</p>"},{"title":"The Hidden Costs of PostgreSQL's JSONB Datatype","date":"2018-09-30T05:00:00.000Z","_content":"\n[Postgres](https://www.postgresql.org/) introduced the [JSONB](https://www.postgresql.org/docs/current/static/datatype-json.html) type in version 9.4 with considerable excitement. JSONB promised to marry a favorite relational database with the noSQL world, permitting data to be stored in the database as JSON without the need for re-parsing whenever a field is accessed. Moreover, the binary storage format permits indexing and complex queries against the stored JSON blobs. This data format embodies the flexible schema and was readily adopted at [Fraight](https://fraight.ai/).\n\n<!-- more -->\n\n## Background\n\nAt Fraight, we've built a centralized communication platform that collates all inbound/outbound communications between our brokerage company and thousands of trucking partners. One of our main objectives is to build a system that parses and automatically responds to inbound text messages, emails, and faxes. We knew we would eventually need the nitty-gritty details of these messages, so we captured the data by dumping entire http response bodies into a JSONB column named `meta` in our database’s `message` table.\n\nIn an ideal world, the third party API responses we collected would have been broken down into discrete chunks and stored in separate columns, but our approach was a pragmatic design decision. We knew it wasn't worth the engineering effort to try to understand the multitude of fields we receive from a half-dozen APIs, particularly when we had no idea at the time how we might use this information. But we did know it was valuable. And since we wanted it to be queryable, we chose JSONB over it's more inert and sometimes more size efficient cousin, the JSON datatype.\n\n## Discovery\n\nFraight’s CTO approached me the other day and explained that query performance over the `message` table had deteriorated. He elaborated that the queries were only slow when the `meta` column was included in the result set. We had previously experienced slowdown in the `message` table when entire email attachment bodies were getting serialized and stored in the `meta` column, and I suspected that the root cause of our current performance problem was in a similar vein. A quick [query](#footnote1) revealed that our `meta` column was often quite large.\n\nThe average size of the `meta` column was 3.7 kb. That might not seem large, but for our 100,000 row table, that meant 400mb of (mostly unused) metadata. At the high end of the spectrum, some messages were up to 17mb in size. The precise details of why this dataset slows down queries are a bit esoteric<sup>[2](#footnote2)</sup>, but it was clear that we were storing too much information. You can read more about how Postgres stores large data values using [TOAST](https://www.postgresql.org/docs/current/static/storage-toast.html) and [how I validated this was a problem](#footnote3).\n\n\n## Further Complications\n\nThe first queries against the `meta` column were for very simple tasks like showing the raw contents of an email to a user, perhaps in the case where message content extraction failed. Over time we began using specific fields to drive business logic, and our application code started to expect that `meta`'s JSON would adhere to a specific shape. Any proposed solution would likely necessitate changes to this application code.\n\nSo the problem was twofold:\n\n1. We needed to extract the actual metadata (as opposed to fields that drove business logic) from the `meta` column and place it in a location where it would not affect query performance over the `message` table.\n\n2. We wanted to make the metadata less easily accessible. We recognized that making it accessible through the ORM made it ripe for misuse. We wanted to give it an alternative API that would lessen a developer's likeliness to rely on its structure.\n\n## Solutioning\n\nWe looked at several solutions. Below are the three we considered most seriously:\n\n1. Use the ORM to omit the `meta` column from all queries unless specifically included. Since we unnecessarily perform `select *` <sup>[4](#footnote4)</sup> queries over the `message` table, this strategy, despite its messiness, would increase the performance in most cases (with the occasional slow query when metadata was actually required) and would in theory be simple to implement. It wouldn't, however, resolve our initial design shortcut.\n\n2. Keep the `meta` column as-is but extract specific keys to [S3](https://aws.amazon.com/s3/). In general, greater than 99% of the size of any given column's `meta` field was from a single key. For example, many of the emails we capture include large attachments. Other times message bodies retain long, historical email chains. By extracting these problematic fields and uploading them to S3, the database would only need to store a reference to the S3 content. Then, upon request, the server could generate a [pre-signed URL](https://docs.aws.amazon.com/AmazonS3/latest/dev//ShareObjectPreSignedURL.html), allowing the client to download large files directly from S3.\n\n3. Create a separate `metadata` table in Postgres. It would have a foreign key back to the original table where the metadata belonged. This solution solves the `select *` problem described above and offers an additional advantage: since the `meta` column pattern exists on more than just the `message` table, it offers a unified strategy for storing metadata.\n\nOur instinct was to go with #1 — the most simple and straightforward solution — and omit the `meta` column from most queries. Unfortunately, bugs in our ORM made it impossible to omit columns across joins without the occasional crash. We needed an alternate approach.\n\nThis hiccup left the choice between S3 and a separate Postgres table. We agreed that pre-signed S3 URLs offered an ideal long-term alternative but ultimately chose a separate Postgres table for the same reason that we wanted to choose option #1: minimal risk and complexity. Our team is exceptionally experienced with Postgres, and we knew we could hit the ground running. S3, in contrast, had more unknowns, and given how rarely we access most of this metadata today, the value it would add over Postgres was tenuous at best.\n\n\nIn addition to migrating metadata to its own table, we took a couple additional steps:\n\n1. We extracted the handful of regularly used fields from the metadata and migrated them into their own columns in the `message` table. This meant that we didn't need to retrieve large, megabyte sized blobs whenever we wanted a single field<sup>[5](#footnote5)</sup>. As an added advantage, we regained simple access to database [constraints](https://www.postgresql.org/docs/current/static/ddl-constraints.html).\n\n2. When we created the new `metadata` table in Postgres, we made sure not to define a relationship between it and its related tables at the ORM layer, only the database layer. This makes it far more difficult for a developer to hobble performance by absentmindedly joining large metadata into queries. We introduced an API for accessing the metadata instead. The added advantage of this API is that we can now change the underlying implementation to use S3 (or anything else) in the future, without modifying dependent application code.\n\n\nMy name is Nick Drane. I do [consulting](/hire-me) work in the Chicago area and am always looking for new opportunities.\n\n#### Footnotes\n\n<a name=\"footnote1\">1</a>: I used the following query:\n\n```sql\nSELECT avg(octet_length(m.\"meta\"::text))\nFROM message as m\n```\n\n<a name=\"footnote2\">2</a>: I should clarify that performance measurements were done with a local Postgres installation where network congestion/throughput is not a relevant factor.\n\n<a name=\"footnote3\">3</a>:\nI verified that the `meta` column was toasting with a little help from the [Postgres docs](https://www.postgresql.org/docs/10/static/disk-usage.html):\n\n```sql\nSELECT relname, relpages, relpages * 8191 / (1024 * 1024) as size\nFROM pg_class,\n     (SELECT reltoastrelid\n      FROM pg_class\n      WHERE relname = 'message') AS ss\nWHERE oid = ss.reltoastrelid OR\n      oid = (SELECT indexrelid\n             FROM pg_index\n             WHERE indrelid = ss.reltoastrelid)\n```\n\nFor specifically the `message` table, this query returns the number of disk pages in the toast table and their total size in megabytes.\n\n| table       | disk pages | size (mb) |\n|-------------|------------|-----------|\n| toast\ttable | 17731      | 139       |\n| toast index | 209        | 1         |\n\n\n<a name=\"footnote4\">4</a>: We were not literally doing any `select *` queries. Our ORM's message model did, however, specify all of the columns of the `message` table. In retrospect, this was probably our biggest mistake. It meant that a call to `Message.find`, which is used all over the place, retrieved all columns on the `message` table, unless specifically directed otherwise. Usually, for a RESTful API, this is an acceptable performance tradeoff, but it didn't hold true in this circumstance.\n\n<a name=\"footnote5\">5</a>: As I write this, I wonder if it wouldn't have been possible to leverage indexes to only retrieve specific pieces of the `meta` field. I wonder if our ORM provides any support for firstclass fields that are subfields of another field.\n","source":"_posts/hidden-costs-of-postgresql-jsonb.md","raw":"---\ntitle: The Hidden Costs of PostgreSQL's JSONB Datatype\ndate: 2018-09-30\ncategories:\n  - [Postgres]\n  - [Architecture]\n---\n\n[Postgres](https://www.postgresql.org/) introduced the [JSONB](https://www.postgresql.org/docs/current/static/datatype-json.html) type in version 9.4 with considerable excitement. JSONB promised to marry a favorite relational database with the noSQL world, permitting data to be stored in the database as JSON without the need for re-parsing whenever a field is accessed. Moreover, the binary storage format permits indexing and complex queries against the stored JSON blobs. This data format embodies the flexible schema and was readily adopted at [Fraight](https://fraight.ai/).\n\n<!-- more -->\n\n## Background\n\nAt Fraight, we've built a centralized communication platform that collates all inbound/outbound communications between our brokerage company and thousands of trucking partners. One of our main objectives is to build a system that parses and automatically responds to inbound text messages, emails, and faxes. We knew we would eventually need the nitty-gritty details of these messages, so we captured the data by dumping entire http response bodies into a JSONB column named `meta` in our database’s `message` table.\n\nIn an ideal world, the third party API responses we collected would have been broken down into discrete chunks and stored in separate columns, but our approach was a pragmatic design decision. We knew it wasn't worth the engineering effort to try to understand the multitude of fields we receive from a half-dozen APIs, particularly when we had no idea at the time how we might use this information. But we did know it was valuable. And since we wanted it to be queryable, we chose JSONB over it's more inert and sometimes more size efficient cousin, the JSON datatype.\n\n## Discovery\n\nFraight’s CTO approached me the other day and explained that query performance over the `message` table had deteriorated. He elaborated that the queries were only slow when the `meta` column was included in the result set. We had previously experienced slowdown in the `message` table when entire email attachment bodies were getting serialized and stored in the `meta` column, and I suspected that the root cause of our current performance problem was in a similar vein. A quick [query](#footnote1) revealed that our `meta` column was often quite large.\n\nThe average size of the `meta` column was 3.7 kb. That might not seem large, but for our 100,000 row table, that meant 400mb of (mostly unused) metadata. At the high end of the spectrum, some messages were up to 17mb in size. The precise details of why this dataset slows down queries are a bit esoteric<sup>[2](#footnote2)</sup>, but it was clear that we were storing too much information. You can read more about how Postgres stores large data values using [TOAST](https://www.postgresql.org/docs/current/static/storage-toast.html) and [how I validated this was a problem](#footnote3).\n\n\n## Further Complications\n\nThe first queries against the `meta` column were for very simple tasks like showing the raw contents of an email to a user, perhaps in the case where message content extraction failed. Over time we began using specific fields to drive business logic, and our application code started to expect that `meta`'s JSON would adhere to a specific shape. Any proposed solution would likely necessitate changes to this application code.\n\nSo the problem was twofold:\n\n1. We needed to extract the actual metadata (as opposed to fields that drove business logic) from the `meta` column and place it in a location where it would not affect query performance over the `message` table.\n\n2. We wanted to make the metadata less easily accessible. We recognized that making it accessible through the ORM made it ripe for misuse. We wanted to give it an alternative API that would lessen a developer's likeliness to rely on its structure.\n\n## Solutioning\n\nWe looked at several solutions. Below are the three we considered most seriously:\n\n1. Use the ORM to omit the `meta` column from all queries unless specifically included. Since we unnecessarily perform `select *` <sup>[4](#footnote4)</sup> queries over the `message` table, this strategy, despite its messiness, would increase the performance in most cases (with the occasional slow query when metadata was actually required) and would in theory be simple to implement. It wouldn't, however, resolve our initial design shortcut.\n\n2. Keep the `meta` column as-is but extract specific keys to [S3](https://aws.amazon.com/s3/). In general, greater than 99% of the size of any given column's `meta` field was from a single key. For example, many of the emails we capture include large attachments. Other times message bodies retain long, historical email chains. By extracting these problematic fields and uploading them to S3, the database would only need to store a reference to the S3 content. Then, upon request, the server could generate a [pre-signed URL](https://docs.aws.amazon.com/AmazonS3/latest/dev//ShareObjectPreSignedURL.html), allowing the client to download large files directly from S3.\n\n3. Create a separate `metadata` table in Postgres. It would have a foreign key back to the original table where the metadata belonged. This solution solves the `select *` problem described above and offers an additional advantage: since the `meta` column pattern exists on more than just the `message` table, it offers a unified strategy for storing metadata.\n\nOur instinct was to go with #1 — the most simple and straightforward solution — and omit the `meta` column from most queries. Unfortunately, bugs in our ORM made it impossible to omit columns across joins without the occasional crash. We needed an alternate approach.\n\nThis hiccup left the choice between S3 and a separate Postgres table. We agreed that pre-signed S3 URLs offered an ideal long-term alternative but ultimately chose a separate Postgres table for the same reason that we wanted to choose option #1: minimal risk and complexity. Our team is exceptionally experienced with Postgres, and we knew we could hit the ground running. S3, in contrast, had more unknowns, and given how rarely we access most of this metadata today, the value it would add over Postgres was tenuous at best.\n\n\nIn addition to migrating metadata to its own table, we took a couple additional steps:\n\n1. We extracted the handful of regularly used fields from the metadata and migrated them into their own columns in the `message` table. This meant that we didn't need to retrieve large, megabyte sized blobs whenever we wanted a single field<sup>[5](#footnote5)</sup>. As an added advantage, we regained simple access to database [constraints](https://www.postgresql.org/docs/current/static/ddl-constraints.html).\n\n2. When we created the new `metadata` table in Postgres, we made sure not to define a relationship between it and its related tables at the ORM layer, only the database layer. This makes it far more difficult for a developer to hobble performance by absentmindedly joining large metadata into queries. We introduced an API for accessing the metadata instead. The added advantage of this API is that we can now change the underlying implementation to use S3 (or anything else) in the future, without modifying dependent application code.\n\n\nMy name is Nick Drane. I do [consulting](/hire-me) work in the Chicago area and am always looking for new opportunities.\n\n#### Footnotes\n\n<a name=\"footnote1\">1</a>: I used the following query:\n\n```sql\nSELECT avg(octet_length(m.\"meta\"::text))\nFROM message as m\n```\n\n<a name=\"footnote2\">2</a>: I should clarify that performance measurements were done with a local Postgres installation where network congestion/throughput is not a relevant factor.\n\n<a name=\"footnote3\">3</a>:\nI verified that the `meta` column was toasting with a little help from the [Postgres docs](https://www.postgresql.org/docs/10/static/disk-usage.html):\n\n```sql\nSELECT relname, relpages, relpages * 8191 / (1024 * 1024) as size\nFROM pg_class,\n     (SELECT reltoastrelid\n      FROM pg_class\n      WHERE relname = 'message') AS ss\nWHERE oid = ss.reltoastrelid OR\n      oid = (SELECT indexrelid\n             FROM pg_index\n             WHERE indrelid = ss.reltoastrelid)\n```\n\nFor specifically the `message` table, this query returns the number of disk pages in the toast table and their total size in megabytes.\n\n| table       | disk pages | size (mb) |\n|-------------|------------|-----------|\n| toast\ttable | 17731      | 139       |\n| toast index | 209        | 1         |\n\n\n<a name=\"footnote4\">4</a>: We were not literally doing any `select *` queries. Our ORM's message model did, however, specify all of the columns of the `message` table. In retrospect, this was probably our biggest mistake. It meant that a call to `Message.find`, which is used all over the place, retrieved all columns on the `message` table, unless specifically directed otherwise. Usually, for a RESTful API, this is an acceptable performance tradeoff, but it didn't hold true in this circumstance.\n\n<a name=\"footnote5\">5</a>: As I write this, I wonder if it wouldn't have been possible to leverage indexes to only retrieve specific pieces of the `meta` field. I wonder if our ORM provides any support for firstclass fields that are subfields of another field.\n","slug":"hidden-costs-of-postgresql-jsonb","published":1,"updated":"2018-10-19T03:26:37.843Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vns000k67ozcj7nd6rv","content":"<p><a href=\"https://www.postgresql.org/\" target=\"_blank\" rel=\"noopener\">Postgres</a> introduced the <a href=\"https://www.postgresql.org/docs/current/static/datatype-json.html\" target=\"_blank\" rel=\"noopener\">JSONB</a> type in version 9.4 with considerable excitement. JSONB promised to marry a favorite relational database with the noSQL world, permitting data to be stored in the database as JSON without the need for re-parsing whenever a field is accessed. Moreover, the binary storage format permits indexing and complex queries against the stored JSON blobs. This data format embodies the flexible schema and was readily adopted at <a href=\"https://fraight.ai/\" target=\"_blank\" rel=\"noopener\">Fraight</a>.</p>\n<a id=\"more\"></a>\n<h2 id=\"Background\"><a href=\"#Background\" class=\"headerlink\" title=\"Background\"></a>Background</h2><p>At Fraight, we’ve built a centralized communication platform that collates all inbound/outbound communications between our brokerage company and thousands of trucking partners. One of our main objectives is to build a system that parses and automatically responds to inbound text messages, emails, and faxes. We knew we would eventually need the nitty-gritty details of these messages, so we captured the data by dumping entire http response bodies into a JSONB column named <code>meta</code> in our database’s <code>message</code> table.</p>\n<p>In an ideal world, the third party API responses we collected would have been broken down into discrete chunks and stored in separate columns, but our approach was a pragmatic design decision. We knew it wasn’t worth the engineering effort to try to understand the multitude of fields we receive from a half-dozen APIs, particularly when we had no idea at the time how we might use this information. But we did know it was valuable. And since we wanted it to be queryable, we chose JSONB over it’s more inert and sometimes more size efficient cousin, the JSON datatype.</p>\n<h2 id=\"Discovery\"><a href=\"#Discovery\" class=\"headerlink\" title=\"Discovery\"></a>Discovery</h2><p>Fraight’s CTO approached me the other day and explained that query performance over the <code>message</code> table had deteriorated. He elaborated that the queries were only slow when the <code>meta</code> column was included in the result set. We had previously experienced slowdown in the <code>message</code> table when entire email attachment bodies were getting serialized and stored in the <code>meta</code> column, and I suspected that the root cause of our current performance problem was in a similar vein. A quick <a href=\"#footnote1\">query</a> revealed that our <code>meta</code> column was often quite large.</p>\n<p>The average size of the <code>meta</code> column was 3.7 kb. That might not seem large, but for our 100,000 row table, that meant 400mb of (mostly unused) metadata. At the high end of the spectrum, some messages were up to 17mb in size. The precise details of why this dataset slows down queries are a bit esoteric<sup><a href=\"#footnote2\">2</a></sup>, but it was clear that we were storing too much information. You can read more about how Postgres stores large data values using <a href=\"https://www.postgresql.org/docs/current/static/storage-toast.html\" target=\"_blank\" rel=\"noopener\">TOAST</a> and <a href=\"#footnote3\">how I validated this was a problem</a>.</p>\n<h2 id=\"Further-Complications\"><a href=\"#Further-Complications\" class=\"headerlink\" title=\"Further Complications\"></a>Further Complications</h2><p>The first queries against the <code>meta</code> column were for very simple tasks like showing the raw contents of an email to a user, perhaps in the case where message content extraction failed. Over time we began using specific fields to drive business logic, and our application code started to expect that <code>meta</code>‘s JSON would adhere to a specific shape. Any proposed solution would likely necessitate changes to this application code.</p>\n<p>So the problem was twofold:</p>\n<ol>\n<li><p>We needed to extract the actual metadata (as opposed to fields that drove business logic) from the <code>meta</code> column and place it in a location where it would not affect query performance over the <code>message</code> table.</p>\n</li>\n<li><p>We wanted to make the metadata less easily accessible. We recognized that making it accessible through the ORM made it ripe for misuse. We wanted to give it an alternative API that would lessen a developer’s likeliness to rely on its structure.</p>\n</li>\n</ol>\n<h2 id=\"Solutioning\"><a href=\"#Solutioning\" class=\"headerlink\" title=\"Solutioning\"></a>Solutioning</h2><p>We looked at several solutions. Below are the three we considered most seriously:</p>\n<ol>\n<li><p>Use the ORM to omit the <code>meta</code> column from all queries unless specifically included. Since we unnecessarily perform <code>select *</code> <sup><a href=\"#footnote4\">4</a></sup> queries over the <code>message</code> table, this strategy, despite its messiness, would increase the performance in most cases (with the occasional slow query when metadata was actually required) and would in theory be simple to implement. It wouldn’t, however, resolve our initial design shortcut.</p>\n</li>\n<li><p>Keep the <code>meta</code> column as-is but extract specific keys to <a href=\"https://aws.amazon.com/s3/\" target=\"_blank\" rel=\"noopener\">S3</a>. In general, greater than 99% of the size of any given column’s <code>meta</code> field was from a single key. For example, many of the emails we capture include large attachments. Other times message bodies retain long, historical email chains. By extracting these problematic fields and uploading them to S3, the database would only need to store a reference to the S3 content. Then, upon request, the server could generate a <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev//ShareObjectPreSignedURL.html\" target=\"_blank\" rel=\"noopener\">pre-signed URL</a>, allowing the client to download large files directly from S3.</p>\n</li>\n<li><p>Create a separate <code>metadata</code> table in Postgres. It would have a foreign key back to the original table where the metadata belonged. This solution solves the <code>select *</code> problem described above and offers an additional advantage: since the <code>meta</code> column pattern exists on more than just the <code>message</code> table, it offers a unified strategy for storing metadata.</p>\n</li>\n</ol>\n<p>Our instinct was to go with #1 — the most simple and straightforward solution — and omit the <code>meta</code> column from most queries. Unfortunately, bugs in our ORM made it impossible to omit columns across joins without the occasional crash. We needed an alternate approach.</p>\n<p>This hiccup left the choice between S3 and a separate Postgres table. We agreed that pre-signed S3 URLs offered an ideal long-term alternative but ultimately chose a separate Postgres table for the same reason that we wanted to choose option #1: minimal risk and complexity. Our team is exceptionally experienced with Postgres, and we knew we could hit the ground running. S3, in contrast, had more unknowns, and given how rarely we access most of this metadata today, the value it would add over Postgres was tenuous at best.</p>\n<p>In addition to migrating metadata to its own table, we took a couple additional steps:</p>\n<ol>\n<li><p>We extracted the handful of regularly used fields from the metadata and migrated them into their own columns in the <code>message</code> table. This meant that we didn’t need to retrieve large, megabyte sized blobs whenever we wanted a single field<sup><a href=\"#footnote5\">5</a></sup>. As an added advantage, we regained simple access to database <a href=\"https://www.postgresql.org/docs/current/static/ddl-constraints.html\" target=\"_blank\" rel=\"noopener\">constraints</a>.</p>\n</li>\n<li><p>When we created the new <code>metadata</code> table in Postgres, we made sure not to define a relationship between it and its related tables at the ORM layer, only the database layer. This makes it far more difficult for a developer to hobble performance by absentmindedly joining large metadata into queries. We introduced an API for accessing the metadata instead. The added advantage of this API is that we can now change the underlying implementation to use S3 (or anything else) in the future, without modifying dependent application code.</p>\n</li>\n</ol>\n<p>My name is Nick Drane. I do <a href=\"/hire-me\">consulting</a> work in the Chicago area and am always looking for new opportunities.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: I used the following query:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">avg</span>(<span class=\"keyword\">octet_length</span>(m.<span class=\"string\">\"meta\"</span>::<span class=\"built_in\">text</span>))</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> message <span class=\"keyword\">as</span> m</span><br></pre></td></tr></table></figure>\n<p><a name=\"footnote2\">2</a>: I should clarify that performance measurements were done with a local Postgres installation where network congestion/throughput is not a relevant factor.</p>\n<p><a name=\"footnote3\">3</a>:<br>I verified that the <code>meta</code> column was toasting with a little help from the <a href=\"https://www.postgresql.org/docs/10/static/disk-usage.html\" target=\"_blank\" rel=\"noopener\">Postgres docs</a>:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> relname, relpages, relpages * <span class=\"number\">8191</span> / (<span class=\"number\">1024</span> * <span class=\"number\">1024</span>) <span class=\"keyword\">as</span> <span class=\"keyword\">size</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> pg_class,</span><br><span class=\"line\">     (<span class=\"keyword\">SELECT</span> reltoastrelid</span><br><span class=\"line\">      <span class=\"keyword\">FROM</span> pg_class</span><br><span class=\"line\">      <span class=\"keyword\">WHERE</span> relname = <span class=\"string\">'message'</span>) <span class=\"keyword\">AS</span> ss</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"keyword\">oid</span> = ss.reltoastrelid <span class=\"keyword\">OR</span></span><br><span class=\"line\">      <span class=\"keyword\">oid</span> = (<span class=\"keyword\">SELECT</span> indexrelid</span><br><span class=\"line\">             <span class=\"keyword\">FROM</span> pg_index</span><br><span class=\"line\">             <span class=\"keyword\">WHERE</span> indrelid = ss.reltoastrelid)</span><br></pre></td></tr></table></figure>\n<p>For specifically the <code>message</code> table, this query returns the number of disk pages in the toast table and their total size in megabytes.</p>\n<table>\n<thead>\n<tr>\n<th>table</th>\n<th>disk pages</th>\n<th>size (mb)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>toast    table</td>\n<td>17731</td>\n<td>139</td>\n</tr>\n<tr>\n<td>toast index</td>\n<td>209</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p><a name=\"footnote4\">4</a>: We were not literally doing any <code>select *</code> queries. Our ORM’s message model did, however, specify all of the columns of the <code>message</code> table. In retrospect, this was probably our biggest mistake. It meant that a call to <code>Message.find</code>, which is used all over the place, retrieved all columns on the <code>message</code> table, unless specifically directed otherwise. Usually, for a RESTful API, this is an acceptable performance tradeoff, but it didn’t hold true in this circumstance.</p>\n<p><a name=\"footnote5\">5</a>: As I write this, I wonder if it wouldn’t have been possible to leverage indexes to only retrieve specific pieces of the <code>meta</code> field. I wonder if our ORM provides any support for firstclass fields that are subfields of another field.</p>\n","site":{"data":{}},"excerpt":"<p><a href=\"https://www.postgresql.org/\" target=\"_blank\" rel=\"noopener\">Postgres</a> introduced the <a href=\"https://www.postgresql.org/docs/current/static/datatype-json.html\" target=\"_blank\" rel=\"noopener\">JSONB</a> type in version 9.4 with considerable excitement. JSONB promised to marry a favorite relational database with the noSQL world, permitting data to be stored in the database as JSON without the need for re-parsing whenever a field is accessed. Moreover, the binary storage format permits indexing and complex queries against the stored JSON blobs. This data format embodies the flexible schema and was readily adopted at <a href=\"https://fraight.ai/\" target=\"_blank\" rel=\"noopener\">Fraight</a>.</p>","more":"<h2 id=\"Background\"><a href=\"#Background\" class=\"headerlink\" title=\"Background\"></a>Background</h2><p>At Fraight, we’ve built a centralized communication platform that collates all inbound/outbound communications between our brokerage company and thousands of trucking partners. One of our main objectives is to build a system that parses and automatically responds to inbound text messages, emails, and faxes. We knew we would eventually need the nitty-gritty details of these messages, so we captured the data by dumping entire http response bodies into a JSONB column named <code>meta</code> in our database’s <code>message</code> table.</p>\n<p>In an ideal world, the third party API responses we collected would have been broken down into discrete chunks and stored in separate columns, but our approach was a pragmatic design decision. We knew it wasn’t worth the engineering effort to try to understand the multitude of fields we receive from a half-dozen APIs, particularly when we had no idea at the time how we might use this information. But we did know it was valuable. And since we wanted it to be queryable, we chose JSONB over it’s more inert and sometimes more size efficient cousin, the JSON datatype.</p>\n<h2 id=\"Discovery\"><a href=\"#Discovery\" class=\"headerlink\" title=\"Discovery\"></a>Discovery</h2><p>Fraight’s CTO approached me the other day and explained that query performance over the <code>message</code> table had deteriorated. He elaborated that the queries were only slow when the <code>meta</code> column was included in the result set. We had previously experienced slowdown in the <code>message</code> table when entire email attachment bodies were getting serialized and stored in the <code>meta</code> column, and I suspected that the root cause of our current performance problem was in a similar vein. A quick <a href=\"#footnote1\">query</a> revealed that our <code>meta</code> column was often quite large.</p>\n<p>The average size of the <code>meta</code> column was 3.7 kb. That might not seem large, but for our 100,000 row table, that meant 400mb of (mostly unused) metadata. At the high end of the spectrum, some messages were up to 17mb in size. The precise details of why this dataset slows down queries are a bit esoteric<sup><a href=\"#footnote2\">2</a></sup>, but it was clear that we were storing too much information. You can read more about how Postgres stores large data values using <a href=\"https://www.postgresql.org/docs/current/static/storage-toast.html\" target=\"_blank\" rel=\"noopener\">TOAST</a> and <a href=\"#footnote3\">how I validated this was a problem</a>.</p>\n<h2 id=\"Further-Complications\"><a href=\"#Further-Complications\" class=\"headerlink\" title=\"Further Complications\"></a>Further Complications</h2><p>The first queries against the <code>meta</code> column were for very simple tasks like showing the raw contents of an email to a user, perhaps in the case where message content extraction failed. Over time we began using specific fields to drive business logic, and our application code started to expect that <code>meta</code>‘s JSON would adhere to a specific shape. Any proposed solution would likely necessitate changes to this application code.</p>\n<p>So the problem was twofold:</p>\n<ol>\n<li><p>We needed to extract the actual metadata (as opposed to fields that drove business logic) from the <code>meta</code> column and place it in a location where it would not affect query performance over the <code>message</code> table.</p>\n</li>\n<li><p>We wanted to make the metadata less easily accessible. We recognized that making it accessible through the ORM made it ripe for misuse. We wanted to give it an alternative API that would lessen a developer’s likeliness to rely on its structure.</p>\n</li>\n</ol>\n<h2 id=\"Solutioning\"><a href=\"#Solutioning\" class=\"headerlink\" title=\"Solutioning\"></a>Solutioning</h2><p>We looked at several solutions. Below are the three we considered most seriously:</p>\n<ol>\n<li><p>Use the ORM to omit the <code>meta</code> column from all queries unless specifically included. Since we unnecessarily perform <code>select *</code> <sup><a href=\"#footnote4\">4</a></sup> queries over the <code>message</code> table, this strategy, despite its messiness, would increase the performance in most cases (with the occasional slow query when metadata was actually required) and would in theory be simple to implement. It wouldn’t, however, resolve our initial design shortcut.</p>\n</li>\n<li><p>Keep the <code>meta</code> column as-is but extract specific keys to <a href=\"https://aws.amazon.com/s3/\" target=\"_blank\" rel=\"noopener\">S3</a>. In general, greater than 99% of the size of any given column’s <code>meta</code> field was from a single key. For example, many of the emails we capture include large attachments. Other times message bodies retain long, historical email chains. By extracting these problematic fields and uploading them to S3, the database would only need to store a reference to the S3 content. Then, upon request, the server could generate a <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev//ShareObjectPreSignedURL.html\" target=\"_blank\" rel=\"noopener\">pre-signed URL</a>, allowing the client to download large files directly from S3.</p>\n</li>\n<li><p>Create a separate <code>metadata</code> table in Postgres. It would have a foreign key back to the original table where the metadata belonged. This solution solves the <code>select *</code> problem described above and offers an additional advantage: since the <code>meta</code> column pattern exists on more than just the <code>message</code> table, it offers a unified strategy for storing metadata.</p>\n</li>\n</ol>\n<p>Our instinct was to go with #1 — the most simple and straightforward solution — and omit the <code>meta</code> column from most queries. Unfortunately, bugs in our ORM made it impossible to omit columns across joins without the occasional crash. We needed an alternate approach.</p>\n<p>This hiccup left the choice between S3 and a separate Postgres table. We agreed that pre-signed S3 URLs offered an ideal long-term alternative but ultimately chose a separate Postgres table for the same reason that we wanted to choose option #1: minimal risk and complexity. Our team is exceptionally experienced with Postgres, and we knew we could hit the ground running. S3, in contrast, had more unknowns, and given how rarely we access most of this metadata today, the value it would add over Postgres was tenuous at best.</p>\n<p>In addition to migrating metadata to its own table, we took a couple additional steps:</p>\n<ol>\n<li><p>We extracted the handful of regularly used fields from the metadata and migrated them into their own columns in the <code>message</code> table. This meant that we didn’t need to retrieve large, megabyte sized blobs whenever we wanted a single field<sup><a href=\"#footnote5\">5</a></sup>. As an added advantage, we regained simple access to database <a href=\"https://www.postgresql.org/docs/current/static/ddl-constraints.html\" target=\"_blank\" rel=\"noopener\">constraints</a>.</p>\n</li>\n<li><p>When we created the new <code>metadata</code> table in Postgres, we made sure not to define a relationship between it and its related tables at the ORM layer, only the database layer. This makes it far more difficult for a developer to hobble performance by absentmindedly joining large metadata into queries. We introduced an API for accessing the metadata instead. The added advantage of this API is that we can now change the underlying implementation to use S3 (or anything else) in the future, without modifying dependent application code.</p>\n</li>\n</ol>\n<p>My name is Nick Drane. I do <a href=\"/hire-me\">consulting</a> work in the Chicago area and am always looking for new opportunities.</p>\n<h4 id=\"Footnotes\"><a href=\"#Footnotes\" class=\"headerlink\" title=\"Footnotes\"></a>Footnotes</h4><p><a name=\"footnote1\">1</a>: I used the following query:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"keyword\">avg</span>(<span class=\"keyword\">octet_length</span>(m.<span class=\"string\">\"meta\"</span>::<span class=\"built_in\">text</span>))</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> message <span class=\"keyword\">as</span> m</span><br></pre></td></tr></table></figure>\n<p><a name=\"footnote2\">2</a>: I should clarify that performance measurements were done with a local Postgres installation where network congestion/throughput is not a relevant factor.</p>\n<p><a name=\"footnote3\">3</a>:<br>I verified that the <code>meta</code> column was toasting with a little help from the <a href=\"https://www.postgresql.org/docs/10/static/disk-usage.html\" target=\"_blank\" rel=\"noopener\">Postgres docs</a>:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> relname, relpages, relpages * <span class=\"number\">8191</span> / (<span class=\"number\">1024</span> * <span class=\"number\">1024</span>) <span class=\"keyword\">as</span> <span class=\"keyword\">size</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> pg_class,</span><br><span class=\"line\">     (<span class=\"keyword\">SELECT</span> reltoastrelid</span><br><span class=\"line\">      <span class=\"keyword\">FROM</span> pg_class</span><br><span class=\"line\">      <span class=\"keyword\">WHERE</span> relname = <span class=\"string\">'message'</span>) <span class=\"keyword\">AS</span> ss</span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> <span class=\"keyword\">oid</span> = ss.reltoastrelid <span class=\"keyword\">OR</span></span><br><span class=\"line\">      <span class=\"keyword\">oid</span> = (<span class=\"keyword\">SELECT</span> indexrelid</span><br><span class=\"line\">             <span class=\"keyword\">FROM</span> pg_index</span><br><span class=\"line\">             <span class=\"keyword\">WHERE</span> indrelid = ss.reltoastrelid)</span><br></pre></td></tr></table></figure>\n<p>For specifically the <code>message</code> table, this query returns the number of disk pages in the toast table and their total size in megabytes.</p>\n<table>\n<thead>\n<tr>\n<th>table</th>\n<th>disk pages</th>\n<th>size (mb)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>toast    table</td>\n<td>17731</td>\n<td>139</td>\n</tr>\n<tr>\n<td>toast index</td>\n<td>209</td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n<p><a name=\"footnote4\">4</a>: We were not literally doing any <code>select *</code> queries. Our ORM’s message model did, however, specify all of the columns of the <code>message</code> table. In retrospect, this was probably our biggest mistake. It meant that a call to <code>Message.find</code>, which is used all over the place, retrieved all columns on the <code>message</code> table, unless specifically directed otherwise. Usually, for a RESTful API, this is an acceptable performance tradeoff, but it didn’t hold true in this circumstance.</p>\n<p><a name=\"footnote5\">5</a>: As I write this, I wonder if it wouldn’t have been possible to leverage indexes to only retrieve specific pieces of the <code>meta</code> field. I wonder if our ORM provides any support for firstclass fields that are subfields of another field.</p>"},{"title":"Using Reduce","date":"2017-09-28T15:36:30.000Z","_content":"\nMy first introduction to functional programming was a couple years ago when I read through the famous [SICP](https://mitpress.mit.edu/sicp/full-text/book/book.html). As someone who had up to this point worked with mostly in object oriented and imperative languages, I had rarely seen `map`, `fitler`, and `reduce` before that time. The purpose of the former two felt obvious; the latter one not so much. This blog post is geared for someone who knows how `reduce` works but feels like they struggle to use it practically.\n\n<!-- more -->\n\n## Reduce Basics\n_Feel free to skip this section if you understand the basics of reduce_\n\n[Reduce](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce?v=a) is known as a higher order function (HOF). A HOF is defined as a function that either takes in or returns another function.\n\nReduce takes two parameters: the first is a function, and the second is known as the initial accumulator. We will invoke this function over every element of an array. The ultimate goal is to transform the array into something new.\n\nSuppose we want to take an array of characters and concatenate them into a single string. In this example, the first argument we pass reduce is a HOF that will operate over every character. The HOF takes two arguments: the first is the accumulator and is the value that we ultimately want to assemble, and the second is a particular element of the array.\n\nLet's simulate what happens when we run a solution to the problem of concatenating strings.\n\n```js\nconst arrToConcat = ['a', 'b', 'c', 'd'];\narrToConcat.reduce(function(resultantString, nextCharacter) {\n  return resultantString + nextCharacter;\n}, \"\")  // initial accumulator. This is the second argument to reduce!\n```\n\nYou can use the below table to help guide yourself along\n\n| invocation # | resultantString | nextCharacter | return value\n|:------------:|:---------------:|:-------------:|:-----------:|\n| 1 |  \"\" | 'a' | 'a'\n| 2 |  \"a\" | 'b' | 'ab'\n| 3 |  \"ab\" | 'c' | 'abc'\n| 4 |  \"abc\" | 'd' | 'abcd'\n\nWe will ultimately call our HOF 4 times, passing in each of the 4 elements in the initial array.\n\nThe first time we invoke the HOF, the first argument is always the initial accumulator. Notice the `\"\"` passed into reduce above. The second argument is `'a'` because that's the first element in our array. We return 'a', and this return value is the `resultantString` that is passed as an argument to the second invocation of our HOF, along with the next element of the array, `'b'`. The process continues. `'ab'` is returned from the HOF's second invocation, and `'ab'` and `'c'` are passed into the third invocation of the HOF. Ultimately, `reduce` returns `'abcd'`.\n\nWe built up the result step by step through a series of concatenation steps. Every call to the HOF will return a string with one additional character added to the previous accumulator.\n\n## Know Your Return Type\nI think one of the reasons `map` and `filter` are easier than `reduce` is because they always return an array. That's not the case for `reduce`. `reduce` is ultimately designed to transform one type into another.\n\nWhen you begin writing a `reduce` statement, your first question to yourself should be \"What type am I returning?\". Here's a hint, it's probably one of the following: `String`, `Number`, `Object`, `Array`. Once you know what type you will return you can begin writing your reduce statement. I say this because the initial accumulator (reduce's second argument) can easily be determined by what type you expect `reduce` to return. Here is a table to guide your decision.\n\n| return type | initial accumulator |\n|:-----------:|:--------------------:|\n| string |  \"\" |\n| number | 0 |\n| object | {} |\n| array | [] |\n\n**Notice that the initial accumulator and the return type are always the same!**\n\n_You probably won't want return an array from a reduce function very often because chances are you could have more simply used a combination of `map`, `filter`, and/or some other function instead._\n\n## Summing Odd Numbers\n\nSo let's say we want to reduce over a set of numbers and return the sum of all the odd numbers. Since we are returning a `number`, we can use the above table to determine that the starting accumulator should be 0. That gives us a pretty decent starting point!\n\n```js\nconst arrToSum = [1, 2, 3, 4, 5];\narrToSum.reduce(function(currentSum, nextNumber) {\n\n}, 0)  // This is the second argument to reduce!\n```\n\nNow we just need to complete the guts of the function such that it increments the sum when the `nextNumber` is odd. If `nextNumber` is even, it should return `currentSum` unchanged.\n\n```js\nconst arrToSum = [1, 2, 3, 4, 5];\narrToSum.reduce(function(currentSum, nextNumber) {\n  // nextNumber is odd\n  if (nextNumber % 2 === 1) {\n    return currentSum + nextNumber\n  // nextNumber is even\n  } else {\n    return currentSum\n  }\n}, 0)\n```\n\nOne interesting thing to note about the above code is that EVERY code path (every if-else block) returns something. This is a very common theme throughout the functional programming paradigm and holds true when writing reduce's higher order function. In general it's a decent litmus test to establish if you've made a bug somewhere. **More specifically, if every code path does not return something, and if that something is not the same type as your accumulator, you probably have a bug.**\n\n## Frequency Counter\n\nLet's do something a little different. Suppose I have an array of words, and I want to count how many times each word appears in the array. We can represent this information using an object that maps words in the array to a number indicating their frequency of occurrence.\n\n```js\n// We will input something like this\n['luke', 'anakin', 'chewy', 'luke', 'chewy', 'princess', 'leia', 'chewy'] ->\n\n// And output something like this\n{\n  luke: 2,\n  anakin: 1,\n  princess: 1,\n  chewy: 3,\n  leia: 1\n}\n```\n\nConsulting the table above, we know that the starting accumulator needs to be an empty object. This means that each iteration over the array returns an object as well.\n\n```js\nconst frequencyArray = ['luke', 'anakin', 'chewy', 'luke', 'chewy', 'princess', 'leia', 'chewy'];\nfrequencyArray.reduce(function(resultantObject, nextWord) {\n\n}, {})\n```\n\nEvery step of the higher order function needs to examine the next word and determine if it has been seen before. If it has not, then we need to add an entry to the accumulator and return it. If it has, then we need to increment the existing entry inside the accumulator object and return it.\n\n```js\nfrequencyArray.reduce(function(resultantObject, nextWord) {\n  // If the word is not in the object\n  if (!resultantObject.hasOwnProperty(nextWord)) {\n    resultantObject[nextWord] = 1 //Set it to 1 since we have seen the word before\n    return resultantObject\n  } else {\n    // Otherwise increment the counter for that word inside the resulting object\n    resultantObject[nextWord]++\n    return resultantObject\n  }\n}, {})\n```\n\nJust like the first example, every code path returns the type of the accumulator.\n\n## Merging Objects\nLet's end with something a little more complicated.\n\nSuppose we want to implement a merge function to combines several objects into a single object. We're going to implement something really similar to [Object.assign](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign). Here are some examples.\n\n```js\nmerge([ { a: 4, b: 3 }, { c:10 } ]) --> { a: 4, b: 3, c: 10 }\n\nmerge([ { a: 4, b: 3 }, { c:4 }, {f: 7} ]) --> { a: 4, b: 3, c: 4, f: 7}\n\n// Duplicate keys take the value of the latter object\nmerge([ { a: 4, b: 3 }, { c:4 }, {a: 7} ]) --> { a: 7, b: 3, c: 4}\n```\n\nWe know that the return value from this operation is an object, so that will be our starting accumulator. Every iteration of the array will produce a new object that contains the merging of the previous accumulator and the next object.\n\n```js\n// This merge function will take in two objects and output a new object\n// containing both the keys and values from the two input objects.\nfunction mergeTwo(obj1, obj2) {\n  const newObj = {}\n  for (let key in obj1) {\n    newObj[key] = obj1[key]\n  }\n  for (let key in obj2) {\n    newObj[key] = obj2[key]\n  }\n  return newObj\n}\n\nfunction merge(arr) {\n  return arr.reduce(function(resultantObj, nextObj) {\n    return mergeTwo(resultantObj, nextObj)\n  }, {})\n}\n```\n\n## Summary\n\nTo summarize\n\n1. Always start by asking what the type of your output is. The type of your accumulator will follow by using the mapping table.\n3. The logic inside your higher order function should assemble your resulting accumulator piecemeal. Since the return value of the previous iteration is the input to the next iteration, every code path must return a value\n3. Furthermore, unless you want a horrible experience, every code path MUST return a value whose type is the same as that of your initial accumulator.\n\n\n## Conclusion\nAt the end of the day, just about everything you can do with reduce can be done with some combination of `map` and `fitler` and perhaps another [functional method](https://lodash.com/docs/4.17.4]). And the alternative solution is almost always simpler and more readable. So, in practice, you probably don't want to use `reduce` that often. With that said, `reduce` is a building block on which every other functional method can be built, and we will explore this unique trait in my next blog post.","source":"_posts/using-reduce.md","raw":"---\ntitle: Using Reduce\ndate: 2017-09-28 10:36:30\ncategories: Functional Programming\n---\n\nMy first introduction to functional programming was a couple years ago when I read through the famous [SICP](https://mitpress.mit.edu/sicp/full-text/book/book.html). As someone who had up to this point worked with mostly in object oriented and imperative languages, I had rarely seen `map`, `fitler`, and `reduce` before that time. The purpose of the former two felt obvious; the latter one not so much. This blog post is geared for someone who knows how `reduce` works but feels like they struggle to use it practically.\n\n<!-- more -->\n\n## Reduce Basics\n_Feel free to skip this section if you understand the basics of reduce_\n\n[Reduce](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce?v=a) is known as a higher order function (HOF). A HOF is defined as a function that either takes in or returns another function.\n\nReduce takes two parameters: the first is a function, and the second is known as the initial accumulator. We will invoke this function over every element of an array. The ultimate goal is to transform the array into something new.\n\nSuppose we want to take an array of characters and concatenate them into a single string. In this example, the first argument we pass reduce is a HOF that will operate over every character. The HOF takes two arguments: the first is the accumulator and is the value that we ultimately want to assemble, and the second is a particular element of the array.\n\nLet's simulate what happens when we run a solution to the problem of concatenating strings.\n\n```js\nconst arrToConcat = ['a', 'b', 'c', 'd'];\narrToConcat.reduce(function(resultantString, nextCharacter) {\n  return resultantString + nextCharacter;\n}, \"\")  // initial accumulator. This is the second argument to reduce!\n```\n\nYou can use the below table to help guide yourself along\n\n| invocation # | resultantString | nextCharacter | return value\n|:------------:|:---------------:|:-------------:|:-----------:|\n| 1 |  \"\" | 'a' | 'a'\n| 2 |  \"a\" | 'b' | 'ab'\n| 3 |  \"ab\" | 'c' | 'abc'\n| 4 |  \"abc\" | 'd' | 'abcd'\n\nWe will ultimately call our HOF 4 times, passing in each of the 4 elements in the initial array.\n\nThe first time we invoke the HOF, the first argument is always the initial accumulator. Notice the `\"\"` passed into reduce above. The second argument is `'a'` because that's the first element in our array. We return 'a', and this return value is the `resultantString` that is passed as an argument to the second invocation of our HOF, along with the next element of the array, `'b'`. The process continues. `'ab'` is returned from the HOF's second invocation, and `'ab'` and `'c'` are passed into the third invocation of the HOF. Ultimately, `reduce` returns `'abcd'`.\n\nWe built up the result step by step through a series of concatenation steps. Every call to the HOF will return a string with one additional character added to the previous accumulator.\n\n## Know Your Return Type\nI think one of the reasons `map` and `filter` are easier than `reduce` is because they always return an array. That's not the case for `reduce`. `reduce` is ultimately designed to transform one type into another.\n\nWhen you begin writing a `reduce` statement, your first question to yourself should be \"What type am I returning?\". Here's a hint, it's probably one of the following: `String`, `Number`, `Object`, `Array`. Once you know what type you will return you can begin writing your reduce statement. I say this because the initial accumulator (reduce's second argument) can easily be determined by what type you expect `reduce` to return. Here is a table to guide your decision.\n\n| return type | initial accumulator |\n|:-----------:|:--------------------:|\n| string |  \"\" |\n| number | 0 |\n| object | {} |\n| array | [] |\n\n**Notice that the initial accumulator and the return type are always the same!**\n\n_You probably won't want return an array from a reduce function very often because chances are you could have more simply used a combination of `map`, `filter`, and/or some other function instead._\n\n## Summing Odd Numbers\n\nSo let's say we want to reduce over a set of numbers and return the sum of all the odd numbers. Since we are returning a `number`, we can use the above table to determine that the starting accumulator should be 0. That gives us a pretty decent starting point!\n\n```js\nconst arrToSum = [1, 2, 3, 4, 5];\narrToSum.reduce(function(currentSum, nextNumber) {\n\n}, 0)  // This is the second argument to reduce!\n```\n\nNow we just need to complete the guts of the function such that it increments the sum when the `nextNumber` is odd. If `nextNumber` is even, it should return `currentSum` unchanged.\n\n```js\nconst arrToSum = [1, 2, 3, 4, 5];\narrToSum.reduce(function(currentSum, nextNumber) {\n  // nextNumber is odd\n  if (nextNumber % 2 === 1) {\n    return currentSum + nextNumber\n  // nextNumber is even\n  } else {\n    return currentSum\n  }\n}, 0)\n```\n\nOne interesting thing to note about the above code is that EVERY code path (every if-else block) returns something. This is a very common theme throughout the functional programming paradigm and holds true when writing reduce's higher order function. In general it's a decent litmus test to establish if you've made a bug somewhere. **More specifically, if every code path does not return something, and if that something is not the same type as your accumulator, you probably have a bug.**\n\n## Frequency Counter\n\nLet's do something a little different. Suppose I have an array of words, and I want to count how many times each word appears in the array. We can represent this information using an object that maps words in the array to a number indicating their frequency of occurrence.\n\n```js\n// We will input something like this\n['luke', 'anakin', 'chewy', 'luke', 'chewy', 'princess', 'leia', 'chewy'] ->\n\n// And output something like this\n{\n  luke: 2,\n  anakin: 1,\n  princess: 1,\n  chewy: 3,\n  leia: 1\n}\n```\n\nConsulting the table above, we know that the starting accumulator needs to be an empty object. This means that each iteration over the array returns an object as well.\n\n```js\nconst frequencyArray = ['luke', 'anakin', 'chewy', 'luke', 'chewy', 'princess', 'leia', 'chewy'];\nfrequencyArray.reduce(function(resultantObject, nextWord) {\n\n}, {})\n```\n\nEvery step of the higher order function needs to examine the next word and determine if it has been seen before. If it has not, then we need to add an entry to the accumulator and return it. If it has, then we need to increment the existing entry inside the accumulator object and return it.\n\n```js\nfrequencyArray.reduce(function(resultantObject, nextWord) {\n  // If the word is not in the object\n  if (!resultantObject.hasOwnProperty(nextWord)) {\n    resultantObject[nextWord] = 1 //Set it to 1 since we have seen the word before\n    return resultantObject\n  } else {\n    // Otherwise increment the counter for that word inside the resulting object\n    resultantObject[nextWord]++\n    return resultantObject\n  }\n}, {})\n```\n\nJust like the first example, every code path returns the type of the accumulator.\n\n## Merging Objects\nLet's end with something a little more complicated.\n\nSuppose we want to implement a merge function to combines several objects into a single object. We're going to implement something really similar to [Object.assign](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign). Here are some examples.\n\n```js\nmerge([ { a: 4, b: 3 }, { c:10 } ]) --> { a: 4, b: 3, c: 10 }\n\nmerge([ { a: 4, b: 3 }, { c:4 }, {f: 7} ]) --> { a: 4, b: 3, c: 4, f: 7}\n\n// Duplicate keys take the value of the latter object\nmerge([ { a: 4, b: 3 }, { c:4 }, {a: 7} ]) --> { a: 7, b: 3, c: 4}\n```\n\nWe know that the return value from this operation is an object, so that will be our starting accumulator. Every iteration of the array will produce a new object that contains the merging of the previous accumulator and the next object.\n\n```js\n// This merge function will take in two objects and output a new object\n// containing both the keys and values from the two input objects.\nfunction mergeTwo(obj1, obj2) {\n  const newObj = {}\n  for (let key in obj1) {\n    newObj[key] = obj1[key]\n  }\n  for (let key in obj2) {\n    newObj[key] = obj2[key]\n  }\n  return newObj\n}\n\nfunction merge(arr) {\n  return arr.reduce(function(resultantObj, nextObj) {\n    return mergeTwo(resultantObj, nextObj)\n  }, {})\n}\n```\n\n## Summary\n\nTo summarize\n\n1. Always start by asking what the type of your output is. The type of your accumulator will follow by using the mapping table.\n3. The logic inside your higher order function should assemble your resulting accumulator piecemeal. Since the return value of the previous iteration is the input to the next iteration, every code path must return a value\n3. Furthermore, unless you want a horrible experience, every code path MUST return a value whose type is the same as that of your initial accumulator.\n\n\n## Conclusion\nAt the end of the day, just about everything you can do with reduce can be done with some combination of `map` and `fitler` and perhaps another [functional method](https://lodash.com/docs/4.17.4]). And the alternative solution is almost always simpler and more readable. So, in practice, you probably don't want to use `reduce` that often. With that said, `reduce` is a building block on which every other functional method can be built, and we will explore this unique trait in my next blog post.","slug":"using-reduce","published":1,"updated":"2018-09-30T20:52:54.462Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vnt000m67ozrtqu3scq","content":"<p>My first introduction to functional programming was a couple years ago when I read through the famous <a href=\"https://mitpress.mit.edu/sicp/full-text/book/book.html\" target=\"_blank\" rel=\"noopener\">SICP</a>. As someone who had up to this point worked with mostly in object oriented and imperative languages, I had rarely seen <code>map</code>, <code>fitler</code>, and <code>reduce</code> before that time. The purpose of the former two felt obvious; the latter one not so much. This blog post is geared for someone who knows how <code>reduce</code> works but feels like they struggle to use it practically.</p>\n<a id=\"more\"></a>\n<h2 id=\"Reduce-Basics\"><a href=\"#Reduce-Basics\" class=\"headerlink\" title=\"Reduce Basics\"></a>Reduce Basics</h2><p><em>Feel free to skip this section if you understand the basics of reduce</em></p>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce?v=a\" target=\"_blank\" rel=\"noopener\">Reduce</a> is known as a higher order function (HOF). A HOF is defined as a function that either takes in or returns another function.</p>\n<p>Reduce takes two parameters: the first is a function, and the second is known as the initial accumulator. We will invoke this function over every element of an array. The ultimate goal is to transform the array into something new.</p>\n<p>Suppose we want to take an array of characters and concatenate them into a single string. In this example, the first argument we pass reduce is a HOF that will operate over every character. The HOF takes two arguments: the first is the accumulator and is the value that we ultimately want to assemble, and the second is a particular element of the array.</p>\n<p>Let’s simulate what happens when we run a solution to the problem of concatenating strings.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> arrToConcat = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>, <span class=\"string\">'c'</span>, <span class=\"string\">'d'</span>];</span><br><span class=\"line\">arrToConcat.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resultantString, nextCharacter</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> resultantString + nextCharacter;</span><br><span class=\"line\">&#125;, <span class=\"string\">\"\"</span>)  <span class=\"comment\">// initial accumulator. This is the second argument to reduce!</span></span><br></pre></td></tr></table></figure>\n<p>You can use the below table to help guide yourself along</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">invocation #</th>\n<th style=\"text-align:center\">resultantString</th>\n<th style=\"text-align:center\">nextCharacter</th>\n<th style=\"text-align:center\">return value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">1</td>\n<td style=\"text-align:center\">“”</td>\n<td style=\"text-align:center\">‘a’</td>\n<td style=\"text-align:center\">‘a’</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">2</td>\n<td style=\"text-align:center\">“a”</td>\n<td style=\"text-align:center\">‘b’</td>\n<td style=\"text-align:center\">‘ab’</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">3</td>\n<td style=\"text-align:center\">“ab”</td>\n<td style=\"text-align:center\">‘c’</td>\n<td style=\"text-align:center\">‘abc’</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">4</td>\n<td style=\"text-align:center\">“abc”</td>\n<td style=\"text-align:center\">‘d’</td>\n<td style=\"text-align:center\">‘abcd’</td>\n</tr>\n</tbody>\n</table>\n<p>We will ultimately call our HOF 4 times, passing in each of the 4 elements in the initial array.</p>\n<p>The first time we invoke the HOF, the first argument is always the initial accumulator. Notice the <code>&quot;&quot;</code> passed into reduce above. The second argument is <code>&#39;a&#39;</code> because that’s the first element in our array. We return ‘a’, and this return value is the <code>resultantString</code> that is passed as an argument to the second invocation of our HOF, along with the next element of the array, <code>&#39;b&#39;</code>. The process continues. <code>&#39;ab&#39;</code> is returned from the HOF’s second invocation, and <code>&#39;ab&#39;</code> and <code>&#39;c&#39;</code> are passed into the third invocation of the HOF. Ultimately, <code>reduce</code> returns <code>&#39;abcd&#39;</code>.</p>\n<p>We built up the result step by step through a series of concatenation steps. Every call to the HOF will return a string with one additional character added to the previous accumulator.</p>\n<h2 id=\"Know-Your-Return-Type\"><a href=\"#Know-Your-Return-Type\" class=\"headerlink\" title=\"Know Your Return Type\"></a>Know Your Return Type</h2><p>I think one of the reasons <code>map</code> and <code>filter</code> are easier than <code>reduce</code> is because they always return an array. That’s not the case for <code>reduce</code>. <code>reduce</code> is ultimately designed to transform one type into another.</p>\n<p>When you begin writing a <code>reduce</code> statement, your first question to yourself should be “What type am I returning?”. Here’s a hint, it’s probably one of the following: <code>String</code>, <code>Number</code>, <code>Object</code>, <code>Array</code>. Once you know what type you will return you can begin writing your reduce statement. I say this because the initial accumulator (reduce’s second argument) can easily be determined by what type you expect <code>reduce</code> to return. Here is a table to guide your decision.</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">return type</th>\n<th style=\"text-align:center\">initial accumulator</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">string</td>\n<td style=\"text-align:center\">“”</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">number</td>\n<td style=\"text-align:center\">0</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">object</td>\n<td style=\"text-align:center\">{}</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">array</td>\n<td style=\"text-align:center\">[]</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Notice that the initial accumulator and the return type are always the same!</strong></p>\n<p><em>You probably won’t want return an array from a reduce function very often because chances are you could have more simply used a combination of <code>map</code>, <code>filter</code>, and/or some other function instead.</em></p>\n<h2 id=\"Summing-Odd-Numbers\"><a href=\"#Summing-Odd-Numbers\" class=\"headerlink\" title=\"Summing Odd Numbers\"></a>Summing Odd Numbers</h2><p>So let’s say we want to reduce over a set of numbers and return the sum of all the odd numbers. Since we are returning a <code>number</code>, we can use the above table to determine that the starting accumulator should be 0. That gives us a pretty decent starting point!</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> arrToSum = [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span>, <span class=\"number\">5</span>];</span><br><span class=\"line\">arrToSum.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">currentSum, nextNumber</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;, <span class=\"number\">0</span>)  <span class=\"comment\">// This is the second argument to reduce!</span></span><br></pre></td></tr></table></figure>\n<p>Now we just need to complete the guts of the function such that it increments the sum when the <code>nextNumber</code> is odd. If <code>nextNumber</code> is even, it should return <code>currentSum</code> unchanged.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> arrToSum = [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span>, <span class=\"number\">5</span>];</span><br><span class=\"line\">arrToSum.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">currentSum, nextNumber</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// nextNumber is odd</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (nextNumber % <span class=\"number\">2</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> currentSum + nextNumber</span><br><span class=\"line\">  <span class=\"comment\">// nextNumber is even</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> currentSum</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;, <span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure>\n<p>One interesting thing to note about the above code is that EVERY code path (every if-else block) returns something. This is a very common theme throughout the functional programming paradigm and holds true when writing reduce’s higher order function. In general it’s a decent litmus test to establish if you’ve made a bug somewhere. <strong>More specifically, if every code path does not return something, and if that something is not the same type as your accumulator, you probably have a bug.</strong></p>\n<h2 id=\"Frequency-Counter\"><a href=\"#Frequency-Counter\" class=\"headerlink\" title=\"Frequency Counter\"></a>Frequency Counter</h2><p>Let’s do something a little different. Suppose I have an array of words, and I want to count how many times each word appears in the array. We can represent this information using an object that maps words in the array to a number indicating their frequency of occurrence.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// We will input something like this</span></span><br><span class=\"line\">[<span class=\"string\">'luke'</span>, <span class=\"string\">'anakin'</span>, <span class=\"string\">'chewy'</span>, <span class=\"string\">'luke'</span>, <span class=\"string\">'chewy'</span>, <span class=\"string\">'princess'</span>, <span class=\"string\">'leia'</span>, <span class=\"string\">'chewy'</span>] -&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// And output something like this</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  luke: <span class=\"number\">2</span>,</span><br><span class=\"line\">  anakin: <span class=\"number\">1</span>,</span><br><span class=\"line\">  princess: <span class=\"number\">1</span>,</span><br><span class=\"line\">  chewy: <span class=\"number\">3</span>,</span><br><span class=\"line\">  leia: <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Consulting the table above, we know that the starting accumulator needs to be an empty object. This means that each iteration over the array returns an object as well.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> frequencyArray = [<span class=\"string\">'luke'</span>, <span class=\"string\">'anakin'</span>, <span class=\"string\">'chewy'</span>, <span class=\"string\">'luke'</span>, <span class=\"string\">'chewy'</span>, <span class=\"string\">'princess'</span>, <span class=\"string\">'leia'</span>, <span class=\"string\">'chewy'</span>];</span><br><span class=\"line\">frequencyArray.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resultantObject, nextWord</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;, &#123;&#125;)</span><br></pre></td></tr></table></figure>\n<p>Every step of the higher order function needs to examine the next word and determine if it has been seen before. If it has not, then we need to add an entry to the accumulator and return it. If it has, then we need to increment the existing entry inside the accumulator object and return it.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">frequencyArray.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resultantObject, nextWord</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// If the word is not in the object</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!resultantObject.hasOwnProperty(nextWord)) &#123;</span><br><span class=\"line\">    resultantObject[nextWord] = <span class=\"number\">1</span> <span class=\"comment\">//Set it to 1 since we have seen the word before</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> resultantObject</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Otherwise increment the counter for that word inside the resulting object</span></span><br><span class=\"line\">    resultantObject[nextWord]++</span><br><span class=\"line\">    <span class=\"keyword\">return</span> resultantObject</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;, &#123;&#125;)</span><br></pre></td></tr></table></figure>\n<p>Just like the first example, every code path returns the type of the accumulator.</p>\n<h2 id=\"Merging-Objects\"><a href=\"#Merging-Objects\" class=\"headerlink\" title=\"Merging Objects\"></a>Merging Objects</h2><p>Let’s end with something a little more complicated.</p>\n<p>Suppose we want to implement a merge function to combines several objects into a single object. We’re going to implement something really similar to <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\" target=\"_blank\" rel=\"noopener\">Object.assign</a>. Here are some examples.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">merge([ &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span> &#125;, &#123; <span class=\"attr\">c</span>:<span class=\"number\">10</span> &#125; ]) --&gt; &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span>, <span class=\"attr\">c</span>: <span class=\"number\">10</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">merge([ &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span> &#125;, &#123; <span class=\"attr\">c</span>:<span class=\"number\">4</span> &#125;, &#123;<span class=\"attr\">f</span>: <span class=\"number\">7</span>&#125; ]) --&gt; &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span>, <span class=\"attr\">c</span>: <span class=\"number\">4</span>, <span class=\"attr\">f</span>: <span class=\"number\">7</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Duplicate keys take the value of the latter object</span></span><br><span class=\"line\">merge([ &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span> &#125;, &#123; <span class=\"attr\">c</span>:<span class=\"number\">4</span> &#125;, &#123;<span class=\"attr\">a</span>: <span class=\"number\">7</span>&#125; ]) --&gt; &#123; <span class=\"attr\">a</span>: <span class=\"number\">7</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span>, <span class=\"attr\">c</span>: <span class=\"number\">4</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>We know that the return value from this operation is an object, so that will be our starting accumulator. Every iteration of the array will produce a new object that contains the merging of the previous accumulator and the next object.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This merge function will take in two objects and output a new object</span></span><br><span class=\"line\"><span class=\"comment\">// containing both the keys and values from the two input objects.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mergeTwo</span>(<span class=\"params\">obj1, obj2</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> newObj = &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> key <span class=\"keyword\">in</span> obj1) &#123;</span><br><span class=\"line\">    newObj[key] = obj1[key]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> key <span class=\"keyword\">in</span> obj2) &#123;</span><br><span class=\"line\">    newObj[key] = obj2[key]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> newObj</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">merge</span>(<span class=\"params\">arr</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> arr.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resultantObj, nextObj</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mergeTwo(resultantObj, nextObj)</span><br><span class=\"line\">  &#125;, &#123;&#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Summary\"><a href=\"#Summary\" class=\"headerlink\" title=\"Summary\"></a>Summary</h2><p>To summarize</p>\n<ol>\n<li>Always start by asking what the type of your output is. The type of your accumulator will follow by using the mapping table.</li>\n<li>The logic inside your higher order function should assemble your resulting accumulator piecemeal. Since the return value of the previous iteration is the input to the next iteration, every code path must return a value</li>\n<li>Furthermore, unless you want a horrible experience, every code path MUST return a value whose type is the same as that of your initial accumulator.</li>\n</ol>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>At the end of the day, just about everything you can do with reduce can be done with some combination of <code>map</code> and <code>fitler</code> and perhaps another <a href=\"https://lodash.com/docs/4.17.4]\" target=\"_blank\" rel=\"noopener\">functional method</a>. And the alternative solution is almost always simpler and more readable. So, in practice, you probably don’t want to use <code>reduce</code> that often. With that said, <code>reduce</code> is a building block on which every other functional method can be built, and we will explore this unique trait in my next blog post.</p>\n","site":{"data":{}},"excerpt":"<p>My first introduction to functional programming was a couple years ago when I read through the famous <a href=\"https://mitpress.mit.edu/sicp/full-text/book/book.html\" target=\"_blank\" rel=\"noopener\">SICP</a>. As someone who had up to this point worked with mostly in object oriented and imperative languages, I had rarely seen <code>map</code>, <code>fitler</code>, and <code>reduce</code> before that time. The purpose of the former two felt obvious; the latter one not so much. This blog post is geared for someone who knows how <code>reduce</code> works but feels like they struggle to use it practically.</p>","more":"<h2 id=\"Reduce-Basics\"><a href=\"#Reduce-Basics\" class=\"headerlink\" title=\"Reduce Basics\"></a>Reduce Basics</h2><p><em>Feel free to skip this section if you understand the basics of reduce</em></p>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce?v=a\" target=\"_blank\" rel=\"noopener\">Reduce</a> is known as a higher order function (HOF). A HOF is defined as a function that either takes in or returns another function.</p>\n<p>Reduce takes two parameters: the first is a function, and the second is known as the initial accumulator. We will invoke this function over every element of an array. The ultimate goal is to transform the array into something new.</p>\n<p>Suppose we want to take an array of characters and concatenate them into a single string. In this example, the first argument we pass reduce is a HOF that will operate over every character. The HOF takes two arguments: the first is the accumulator and is the value that we ultimately want to assemble, and the second is a particular element of the array.</p>\n<p>Let’s simulate what happens when we run a solution to the problem of concatenating strings.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> arrToConcat = [<span class=\"string\">'a'</span>, <span class=\"string\">'b'</span>, <span class=\"string\">'c'</span>, <span class=\"string\">'d'</span>];</span><br><span class=\"line\">arrToConcat.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resultantString, nextCharacter</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> resultantString + nextCharacter;</span><br><span class=\"line\">&#125;, <span class=\"string\">\"\"</span>)  <span class=\"comment\">// initial accumulator. This is the second argument to reduce!</span></span><br></pre></td></tr></table></figure>\n<p>You can use the below table to help guide yourself along</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">invocation #</th>\n<th style=\"text-align:center\">resultantString</th>\n<th style=\"text-align:center\">nextCharacter</th>\n<th style=\"text-align:center\">return value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">1</td>\n<td style=\"text-align:center\">“”</td>\n<td style=\"text-align:center\">‘a’</td>\n<td style=\"text-align:center\">‘a’</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">2</td>\n<td style=\"text-align:center\">“a”</td>\n<td style=\"text-align:center\">‘b’</td>\n<td style=\"text-align:center\">‘ab’</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">3</td>\n<td style=\"text-align:center\">“ab”</td>\n<td style=\"text-align:center\">‘c’</td>\n<td style=\"text-align:center\">‘abc’</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">4</td>\n<td style=\"text-align:center\">“abc”</td>\n<td style=\"text-align:center\">‘d’</td>\n<td style=\"text-align:center\">‘abcd’</td>\n</tr>\n</tbody>\n</table>\n<p>We will ultimately call our HOF 4 times, passing in each of the 4 elements in the initial array.</p>\n<p>The first time we invoke the HOF, the first argument is always the initial accumulator. Notice the <code>&quot;&quot;</code> passed into reduce above. The second argument is <code>&#39;a&#39;</code> because that’s the first element in our array. We return ‘a’, and this return value is the <code>resultantString</code> that is passed as an argument to the second invocation of our HOF, along with the next element of the array, <code>&#39;b&#39;</code>. The process continues. <code>&#39;ab&#39;</code> is returned from the HOF’s second invocation, and <code>&#39;ab&#39;</code> and <code>&#39;c&#39;</code> are passed into the third invocation of the HOF. Ultimately, <code>reduce</code> returns <code>&#39;abcd&#39;</code>.</p>\n<p>We built up the result step by step through a series of concatenation steps. Every call to the HOF will return a string with one additional character added to the previous accumulator.</p>\n<h2 id=\"Know-Your-Return-Type\"><a href=\"#Know-Your-Return-Type\" class=\"headerlink\" title=\"Know Your Return Type\"></a>Know Your Return Type</h2><p>I think one of the reasons <code>map</code> and <code>filter</code> are easier than <code>reduce</code> is because they always return an array. That’s not the case for <code>reduce</code>. <code>reduce</code> is ultimately designed to transform one type into another.</p>\n<p>When you begin writing a <code>reduce</code> statement, your first question to yourself should be “What type am I returning?”. Here’s a hint, it’s probably one of the following: <code>String</code>, <code>Number</code>, <code>Object</code>, <code>Array</code>. Once you know what type you will return you can begin writing your reduce statement. I say this because the initial accumulator (reduce’s second argument) can easily be determined by what type you expect <code>reduce</code> to return. Here is a table to guide your decision.</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">return type</th>\n<th style=\"text-align:center\">initial accumulator</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">string</td>\n<td style=\"text-align:center\">“”</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">number</td>\n<td style=\"text-align:center\">0</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">object</td>\n<td style=\"text-align:center\">{}</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">array</td>\n<td style=\"text-align:center\">[]</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Notice that the initial accumulator and the return type are always the same!</strong></p>\n<p><em>You probably won’t want return an array from a reduce function very often because chances are you could have more simply used a combination of <code>map</code>, <code>filter</code>, and/or some other function instead.</em></p>\n<h2 id=\"Summing-Odd-Numbers\"><a href=\"#Summing-Odd-Numbers\" class=\"headerlink\" title=\"Summing Odd Numbers\"></a>Summing Odd Numbers</h2><p>So let’s say we want to reduce over a set of numbers and return the sum of all the odd numbers. Since we are returning a <code>number</code>, we can use the above table to determine that the starting accumulator should be 0. That gives us a pretty decent starting point!</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> arrToSum = [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span>, <span class=\"number\">5</span>];</span><br><span class=\"line\">arrToSum.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">currentSum, nextNumber</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;, <span class=\"number\">0</span>)  <span class=\"comment\">// This is the second argument to reduce!</span></span><br></pre></td></tr></table></figure>\n<p>Now we just need to complete the guts of the function such that it increments the sum when the <code>nextNumber</code> is odd. If <code>nextNumber</code> is even, it should return <code>currentSum</code> unchanged.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> arrToSum = [<span class=\"number\">1</span>, <span class=\"number\">2</span>, <span class=\"number\">3</span>, <span class=\"number\">4</span>, <span class=\"number\">5</span>];</span><br><span class=\"line\">arrToSum.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">currentSum, nextNumber</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// nextNumber is odd</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (nextNumber % <span class=\"number\">2</span> === <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> currentSum + nextNumber</span><br><span class=\"line\">  <span class=\"comment\">// nextNumber is even</span></span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> currentSum</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;, <span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure>\n<p>One interesting thing to note about the above code is that EVERY code path (every if-else block) returns something. This is a very common theme throughout the functional programming paradigm and holds true when writing reduce’s higher order function. In general it’s a decent litmus test to establish if you’ve made a bug somewhere. <strong>More specifically, if every code path does not return something, and if that something is not the same type as your accumulator, you probably have a bug.</strong></p>\n<h2 id=\"Frequency-Counter\"><a href=\"#Frequency-Counter\" class=\"headerlink\" title=\"Frequency Counter\"></a>Frequency Counter</h2><p>Let’s do something a little different. Suppose I have an array of words, and I want to count how many times each word appears in the array. We can represent this information using an object that maps words in the array to a number indicating their frequency of occurrence.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// We will input something like this</span></span><br><span class=\"line\">[<span class=\"string\">'luke'</span>, <span class=\"string\">'anakin'</span>, <span class=\"string\">'chewy'</span>, <span class=\"string\">'luke'</span>, <span class=\"string\">'chewy'</span>, <span class=\"string\">'princess'</span>, <span class=\"string\">'leia'</span>, <span class=\"string\">'chewy'</span>] -&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// And output something like this</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  luke: <span class=\"number\">2</span>,</span><br><span class=\"line\">  anakin: <span class=\"number\">1</span>,</span><br><span class=\"line\">  princess: <span class=\"number\">1</span>,</span><br><span class=\"line\">  chewy: <span class=\"number\">3</span>,</span><br><span class=\"line\">  leia: <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Consulting the table above, we know that the starting accumulator needs to be an empty object. This means that each iteration over the array returns an object as well.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> frequencyArray = [<span class=\"string\">'luke'</span>, <span class=\"string\">'anakin'</span>, <span class=\"string\">'chewy'</span>, <span class=\"string\">'luke'</span>, <span class=\"string\">'chewy'</span>, <span class=\"string\">'princess'</span>, <span class=\"string\">'leia'</span>, <span class=\"string\">'chewy'</span>];</span><br><span class=\"line\">frequencyArray.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resultantObject, nextWord</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;, &#123;&#125;)</span><br></pre></td></tr></table></figure>\n<p>Every step of the higher order function needs to examine the next word and determine if it has been seen before. If it has not, then we need to add an entry to the accumulator and return it. If it has, then we need to increment the existing entry inside the accumulator object and return it.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">frequencyArray.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resultantObject, nextWord</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// If the word is not in the object</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!resultantObject.hasOwnProperty(nextWord)) &#123;</span><br><span class=\"line\">    resultantObject[nextWord] = <span class=\"number\">1</span> <span class=\"comment\">//Set it to 1 since we have seen the word before</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> resultantObject</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Otherwise increment the counter for that word inside the resulting object</span></span><br><span class=\"line\">    resultantObject[nextWord]++</span><br><span class=\"line\">    <span class=\"keyword\">return</span> resultantObject</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;, &#123;&#125;)</span><br></pre></td></tr></table></figure>\n<p>Just like the first example, every code path returns the type of the accumulator.</p>\n<h2 id=\"Merging-Objects\"><a href=\"#Merging-Objects\" class=\"headerlink\" title=\"Merging Objects\"></a>Merging Objects</h2><p>Let’s end with something a little more complicated.</p>\n<p>Suppose we want to implement a merge function to combines several objects into a single object. We’re going to implement something really similar to <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\" target=\"_blank\" rel=\"noopener\">Object.assign</a>. Here are some examples.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">merge([ &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span> &#125;, &#123; <span class=\"attr\">c</span>:<span class=\"number\">10</span> &#125; ]) --&gt; &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span>, <span class=\"attr\">c</span>: <span class=\"number\">10</span> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">merge([ &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span> &#125;, &#123; <span class=\"attr\">c</span>:<span class=\"number\">4</span> &#125;, &#123;<span class=\"attr\">f</span>: <span class=\"number\">7</span>&#125; ]) --&gt; &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span>, <span class=\"attr\">c</span>: <span class=\"number\">4</span>, <span class=\"attr\">f</span>: <span class=\"number\">7</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Duplicate keys take the value of the latter object</span></span><br><span class=\"line\">merge([ &#123; <span class=\"attr\">a</span>: <span class=\"number\">4</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span> &#125;, &#123; <span class=\"attr\">c</span>:<span class=\"number\">4</span> &#125;, &#123;<span class=\"attr\">a</span>: <span class=\"number\">7</span>&#125; ]) --&gt; &#123; <span class=\"attr\">a</span>: <span class=\"number\">7</span>, <span class=\"attr\">b</span>: <span class=\"number\">3</span>, <span class=\"attr\">c</span>: <span class=\"number\">4</span>&#125;</span><br></pre></td></tr></table></figure>\n<p>We know that the return value from this operation is an object, so that will be our starting accumulator. Every iteration of the array will produce a new object that contains the merging of the previous accumulator and the next object.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// This merge function will take in two objects and output a new object</span></span><br><span class=\"line\"><span class=\"comment\">// containing both the keys and values from the two input objects.</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mergeTwo</span>(<span class=\"params\">obj1, obj2</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> newObj = &#123;&#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> key <span class=\"keyword\">in</span> obj1) &#123;</span><br><span class=\"line\">    newObj[key] = obj1[key]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> key <span class=\"keyword\">in</span> obj2) &#123;</span><br><span class=\"line\">    newObj[key] = obj2[key]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> newObj</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">merge</span>(<span class=\"params\">arr</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> arr.reduce(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">resultantObj, nextObj</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> mergeTwo(resultantObj, nextObj)</span><br><span class=\"line\">  &#125;, &#123;&#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Summary\"><a href=\"#Summary\" class=\"headerlink\" title=\"Summary\"></a>Summary</h2><p>To summarize</p>\n<ol>\n<li>Always start by asking what the type of your output is. The type of your accumulator will follow by using the mapping table.</li>\n<li>The logic inside your higher order function should assemble your resulting accumulator piecemeal. Since the return value of the previous iteration is the input to the next iteration, every code path must return a value</li>\n<li>Furthermore, unless you want a horrible experience, every code path MUST return a value whose type is the same as that of your initial accumulator.</li>\n</ol>\n<h2 id=\"Conclusion\"><a href=\"#Conclusion\" class=\"headerlink\" title=\"Conclusion\"></a>Conclusion</h2><p>At the end of the day, just about everything you can do with reduce can be done with some combination of <code>map</code> and <code>fitler</code> and perhaps another <a href=\"https://lodash.com/docs/4.17.4]\" target=\"_blank\" rel=\"noopener\">functional method</a>. And the alternative solution is almost always simpler and more readable. So, in practice, you probably don’t want to use <code>reduce</code> that often. With that said, <code>reduce</code> is a building block on which every other functional method can be built, and we will explore this unique trait in my next blog post.</p>"},{"title":"Write Your Own React-Redux Connect","date":"2017-09-29T18:14:18.000Z","_content":"\n_My inspiration for this blog post came from [this video](https://www.youtube.com/watch?v=VJ38wSFbM3A) where Dan Abramov walks through the source code to react-redux_\n\nAs frontend web developers, it's not uncommon that we follow well-specified patterns - often blindly. The frontend landscape is changing rapidly, and sometimes there isn't time to investigate why we use a specific pattern; we just know we should.\n\nOne widely used pattern in [react-redux](https://github.com/reactjs/react-redux) applications looks like this\n\n```js\nconnect(mapStateToProps, mapDispatchToProps)(MyComponent)\n```\n\nI'll assume you know how to implement this pattern, but why do we use it and how does it work under the hood?\n\n<!-- more -->\n\n# Why Do we Need React-Redux?\nReact and Redux are two completely independent tools that have nothing to do with each other. React is a tool for creating user interfaces in the browser. Redux is a tool for managing state. Either tool can be used without the other. We often use them together because they both solve separate but very important and closely related problems. The purpose of react-redux is to get these two tools to talk.\n\nBut first, what would we do without react-redux? How would React and Redux talk?\n\n# How to Integrate React and Redux Without react-redux\nMore precisely, how do we ensure that a React component re-renders when the Redux store changes? The answer lies in Redux's [subscribe](http://redux.js.org/docs/api/Store.html#subscribe) API.\n\n```js\nimport store from './store'\nimport { Component } from 'react'\n\nclass MyComponent extends Component {\n  constructor() {\n    super();\n    // One solution is to make each component\n    // store the entirety of the redux state.\n    this.state = { storeState: store.getState() };\n  }\n\n  componentDidMount() {\n    // Callbacks passed to store.subscribe will be\n    // invoked every time the store's state changes.\n    // Our callback can get the state of the\n    // store and add it to the component's local state.\n    this.unsubscribe = store.subscribe(() => {\n      this.setState({ storeState: store.getState() });\n    });\n  }\n\n  // We need to make sure that we don't accidentally\n  // subscribe to the store multiple times in the case\n  // where a component mounts, unmounts, and then mounts a second time.\n  // Fortunately, Redux makes this easy by returning\n  // an unsubscribe function when store.subscribe is invoked.\n  componentWillUnmount() {\n    this.unsubscribe();\n  }\n}\n```\n\nIf we insert the above boilerplate into every one of our React component's, then every component could have access to the store and would be informed through a subscription the moment the store's state changes. This configuration has three  flaws.\n\n1. The boilerplate of subscribing and unsubscribing to the store is highly error prone and unnecessarily verbose.\n2. All of our React component's are dependent upon knowledge of the Redux store. This is a complete failure of [separation of concerns](https://en.wikipedia.org/wiki/Separation_of_concerns).\n3. Every component is dependent upon the entirety of the store's state tree. This means that whenever an action is dispatched, `setState` is called on every mounted component, causing each one to re-render, regardless of whether its render function depends on the store state that changed. Woah! Let that sink in for a moment.\n\nLet's write a rudimentary implementation of connect that resolves the first problem.\n\n# Understanding The Syntax of Connect\nTypically, we invoke `connect` like this:\n\n```js\nconnect(mapStateToProps, mapDispatchToProps)(WrappedComponent);\n```\n\n`connect` takes in two functions as arguments and returns a function. Yes, you heard me, `connect` returns a function, not a component. Suppose I invoke `connect` and neglect to pass in a component.\n\n```js\nconst connectFunc = connect(mapStateToProps, mapDispatchToProps);\nconst connctedComponent = connectFunc(WrappedComponent);\n```\n\n `connect` will return to me a function. It's that function that takes in my component (`connect` is implemented this way as opposed to simply taking in 3 arguments to support decorator syntax. The Dan Abramov video I linked above explains this.)\n\nThus, the very first few lines of `connect` must look like this:\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n\n  };\n}\n```\n\n# Higher Order Components\n\nAnd what does the function we returned above do? This function is implemented as a [higher order component](https://reactjs.org/docs/higher-order-components.html) (HOC). A HOC is a function that takes in a component as a parameter and returns a new component. The new component is generally a modified or augmented version of the original component.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    // We are returning a brand new component.\n    // Note that this new component does\n    // not inherit from WrappedComponent.\n    return class WrapperComponent extends Component {\n      // All we are doing is returning a new component\n      // that renders our original component.\n      render() {\n        // Notice that we need to pass WrappedComponent\n        // WrapperComponent's props.\n        // If we didn't do this, then WrappedComponent\n        // would never have access to any props.\n        return <WrappedComponent {...this.props} />;\n      }\n    };\n  };\n}\n```\n\nIf we were to run the above `connect` function on a component, the connected component would behave identically to original component. Furthermore, we could nest `connect` as many times as we want\n\n```js\nconnect(null, null)(connect(null, null)(App))\n```\n\nand still never distort the behavior of the original component. Our current implementation is effectively [idempotent](https://stackoverflow.com/questions/1077412/what-is-an-idempotent-operation).\n\n# Eliminating Boilerplate\n\nOur next step is to eliminate some of the boilerplate code. We don't want to have to subscribe to the store every time we create a new component, so let's have our new `connect` function do it instead.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        // Since the whole point of this HOC is to get WrappedComponent\n        // access to the store, we need to pass that state down as props.\n        const storeState = this.state.storeState;\n        return <WrappedComponent {...this.props} {...storeState} />;\n      }\n    };\n  };\n}\n```\n\nWe just made huge progress! Now, whenever we invoke\n\n```js\nconnect(null, null)(MyComponent)\n```\n\nwe get a component that is subscribed to state changes on the store, and this state will be passed down to our component as props.\n\n# Implementing Support for mapStateToProps\n\nOur connected components still all depend on the entirety of the store's state tree. Look up above, the entire state is passed down as props to every connected component. To reiterate, this means that if any piece of the store's state is updated, our component will re-render.\n\nThis is where `mapStateToProps` comes to the rescue. `mapStateToProps` takes as its argument the store's state, and it allows us to return the particular pieces of the store's state that a component depends on. It then passes that state as props to our component instead.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        // Now, instead of passing down all of the store state,\n        // we only pass down the subset of state return from\n        // mapStateToProps\n        const storeProps = mapStateToProps(this.state.storeState);\n        return <WrappedComponent {...this.props} {...storeProps} />;\n      }\n    };\n  };\n}\n```\n\nAll we did was insert a call to `mapStateToProps`, allowing us to make each connected component dependent upon only the state it cares about, as defined by the return value of `mapStateToProps`. `mapStateToProps` is a wonderful form of explicit documentation, clearly stating the slices of the state tree each component depends on. Unfortunately, our change does not fix the efficiency problems noted above. More on that below.\n\n# mapStateToProps and ownProps\n\nAn astute reader might note that `mapStateToProps` actually takes two arguments: the first is a copy of the store's state, and the second are the props that are originally passed down to `WrapperComponent`. `react-redux` does not pass these down to the wrapped component by default as we do in the example immediately above. Let's modify our implementation to mirror `react-redux`.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        const newProps = mapStateToProps(this.state.storeState, this.props);\n        return <WrappedComponent {...newProps} />;\n      }\n    };\n  };\n}\n```\n\nNow the implementer of `mapStateToProps` can choose which of `WrapperComponent`'s props it would like to keep and which it would like to disregard.\n\n# What's the Point of mapDispatchToProps?\n\n`mapDispatchToProps` is designed to eliminate React's dependency upon Redux. If we were to use the above implementation of `connect`, every component that dispatch's an action must import `store.dispatch`, and the implementation would look like this:\n\n```js\nimport store from \"./store\";\nimport { Component } from \"react\";\nimport { updateThing } from \"./store/actions\";\n\nclass ExampleComponent extends Component {\n  handleChange(e) {\n    store.dispatch(updateThing(e.target));\n  }\n}\n```\n\nThe above component 'knows' that it is part of a Redux application because it is explicitly referencing the store to dispatch actions. But we should always try to minimize the interaction of different pieces of architecture, esspecially when they have no need to interact. Ultimately, React components should not been intertwined with Redux code!\n\n## Implementing Support for mapDispatchToProps\n\n`connect` resolves this problem for us by injecting the `store.dispatch` dependency into `mapDispatchToProps`, allowing us to explicitly define functions that dispatch actions without requiring that our [presentation components](https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0) have a dependency on the store. Just as the return value of `mapStateToProps` is passed down to `WrappedComponent`, the return value of `mapDispatchToProps` will be passed down as well.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        // Now we merge the results from mapStateToProps\n        // and mapDispatchToProps and pass everything down\n        const newProps = Object.assign(\n          {},\n          mapStateToProps(this.state.storeState, this.props),\n          // If you aren't intimately familiar with the this keyword,\n          // it's okay if you don't understand why we use bind here\n          mapDispatchToProps(store.dispatch.bind(this))\n        );\n        return <WrappedComponent {...newProps} />;\n      }\n    };\n  };\n}\n```\n\n\n# More Efficiency Issues - Hello shouldComponentUpdate\n\nWe never actually fixed any of the performance issues noted above. The crux of the problem is that every time the store updates, `WrapperComponent` re-renders (because of its Redux store subscription that calls `setState`) and that means `WrappedComponent` re-renders. This [re-rendering](/leveraging-immutability-in-react) happens despite the fact that `WrappedComponent`'s props might be unchanged between two invocations of `setState`. In fact, this scenario is highly probable and will occur whenever a piece of state in the store changes that your component does not depend on (aka, a piece of store state not returned from from `mapStateToProps`).\n\nReact has a handy lifecycle method called [`shouldComponentUpdate`](https://reactjs.org/docs/react-component.html#shouldcomponentupdate) that allows us to return a boolean that indicates whether a component should re-render. In essence, if we implement this method on `WrapperComponent` and it returns `false`, then React will not re-render `WrapperComponent`. And it follows that `WrappedComponent` won't re-render either.\n\nSo, in the above scenario, when `WrapperComponent` calls `setState`, React first calls the `shouldComponentUpdate` method to see if a re-render should actually happen. Let's implement it below.\n\n```js\n// Just a simple shallow equality function\nimport shallowEqual from \"shallow-equal/objects\"\n\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      shouldComponentUpdate() {\n        // If the props to WrapperComponent do not change\n        // between setState calls, then we don't need to re-render.\n        // On the previous re-render, we cached the results of\n        // mapStateToProps. That's what this.oldProps is.\n        const newProps = mapStateToProps(this.state.storeState, this.props);\n        return !shallowEqual(newProps, this.oldProps);\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        // We need to hang onto the previous result of\n        // mapStateToProps to use the next time\n        // shouldComponentUpdate runs\n        this.oldProps = mapStateToProps(this.state.storeState, this.props)\n        const newProps = Object.assign(\n          {},\n          this.oldProps,\n          mapDispatchToProps(store.dispatch.bind(this))\n        );\n        return <WrappedComponent {...newProps} />;\n      }\n    };\n  };\n}\n```\nI've created a demo [here](https://codesandbox.io/s/o43p70k66). Open the console and prove to yourself that `shouldComponentUpdate` is doing its job.\n\n_I should note that this is not exactly what react-redux does because of edge cases, but the concept is still the same._\n\nNow our wrapper and wrapped components will only re-render when the props returned from `mapStateToProps` change! This is a huge performance gain. This implementation of `connect` explains why adherence to [immutability is so important](http://redux.js.org/docs/faq/ReactRedux.html#react-not-rerendering) in redux's reducers. If you fail to respect immutability, the shallow comparison in the `shouldComponentUpdate` in `WrapperComponent` will likely return `false`, causing your connected component to not re-render when it should.\n\n# Wrapping up\n\nReact-redux's `connect` method is remarkably simple and only performs a handful of operations.\n\n1. It manages our component's subscription to the store so that our component can update when the store updates.\n2. It allows us to explicitly define the slice of state our component is dependent upon using `mapStateToProps`.\n3. It gives our component access to `store.dispatch` without requiring a direct dependency on the store.\n4. It defines `shouldComponentUpdate`, ensuring that our components only re-render when the store state they depend on changes.\n\nI hope you found this article helpful. Please feel free to email me and reach out if you have questions. I put a [gist](https://gist.github.com/nadrane/5221c64c421efe421bda9fdaab167dc2) online containing the same code as the demo.","source":"_posts/write-your-own-redux-connect.md","raw":"---\ntitle: Write Your Own React-Redux Connect\ndate: 2017-09-29 13:14:18\ncategories:\n  - [React]\n  - [Redux]\n  - [Build Your Own]\n---\n\n_My inspiration for this blog post came from [this video](https://www.youtube.com/watch?v=VJ38wSFbM3A) where Dan Abramov walks through the source code to react-redux_\n\nAs frontend web developers, it's not uncommon that we follow well-specified patterns - often blindly. The frontend landscape is changing rapidly, and sometimes there isn't time to investigate why we use a specific pattern; we just know we should.\n\nOne widely used pattern in [react-redux](https://github.com/reactjs/react-redux) applications looks like this\n\n```js\nconnect(mapStateToProps, mapDispatchToProps)(MyComponent)\n```\n\nI'll assume you know how to implement this pattern, but why do we use it and how does it work under the hood?\n\n<!-- more -->\n\n# Why Do we Need React-Redux?\nReact and Redux are two completely independent tools that have nothing to do with each other. React is a tool for creating user interfaces in the browser. Redux is a tool for managing state. Either tool can be used without the other. We often use them together because they both solve separate but very important and closely related problems. The purpose of react-redux is to get these two tools to talk.\n\nBut first, what would we do without react-redux? How would React and Redux talk?\n\n# How to Integrate React and Redux Without react-redux\nMore precisely, how do we ensure that a React component re-renders when the Redux store changes? The answer lies in Redux's [subscribe](http://redux.js.org/docs/api/Store.html#subscribe) API.\n\n```js\nimport store from './store'\nimport { Component } from 'react'\n\nclass MyComponent extends Component {\n  constructor() {\n    super();\n    // One solution is to make each component\n    // store the entirety of the redux state.\n    this.state = { storeState: store.getState() };\n  }\n\n  componentDidMount() {\n    // Callbacks passed to store.subscribe will be\n    // invoked every time the store's state changes.\n    // Our callback can get the state of the\n    // store and add it to the component's local state.\n    this.unsubscribe = store.subscribe(() => {\n      this.setState({ storeState: store.getState() });\n    });\n  }\n\n  // We need to make sure that we don't accidentally\n  // subscribe to the store multiple times in the case\n  // where a component mounts, unmounts, and then mounts a second time.\n  // Fortunately, Redux makes this easy by returning\n  // an unsubscribe function when store.subscribe is invoked.\n  componentWillUnmount() {\n    this.unsubscribe();\n  }\n}\n```\n\nIf we insert the above boilerplate into every one of our React component's, then every component could have access to the store and would be informed through a subscription the moment the store's state changes. This configuration has three  flaws.\n\n1. The boilerplate of subscribing and unsubscribing to the store is highly error prone and unnecessarily verbose.\n2. All of our React component's are dependent upon knowledge of the Redux store. This is a complete failure of [separation of concerns](https://en.wikipedia.org/wiki/Separation_of_concerns).\n3. Every component is dependent upon the entirety of the store's state tree. This means that whenever an action is dispatched, `setState` is called on every mounted component, causing each one to re-render, regardless of whether its render function depends on the store state that changed. Woah! Let that sink in for a moment.\n\nLet's write a rudimentary implementation of connect that resolves the first problem.\n\n# Understanding The Syntax of Connect\nTypically, we invoke `connect` like this:\n\n```js\nconnect(mapStateToProps, mapDispatchToProps)(WrappedComponent);\n```\n\n`connect` takes in two functions as arguments and returns a function. Yes, you heard me, `connect` returns a function, not a component. Suppose I invoke `connect` and neglect to pass in a component.\n\n```js\nconst connectFunc = connect(mapStateToProps, mapDispatchToProps);\nconst connctedComponent = connectFunc(WrappedComponent);\n```\n\n `connect` will return to me a function. It's that function that takes in my component (`connect` is implemented this way as opposed to simply taking in 3 arguments to support decorator syntax. The Dan Abramov video I linked above explains this.)\n\nThus, the very first few lines of `connect` must look like this:\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n\n  };\n}\n```\n\n# Higher Order Components\n\nAnd what does the function we returned above do? This function is implemented as a [higher order component](https://reactjs.org/docs/higher-order-components.html) (HOC). A HOC is a function that takes in a component as a parameter and returns a new component. The new component is generally a modified or augmented version of the original component.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    // We are returning a brand new component.\n    // Note that this new component does\n    // not inherit from WrappedComponent.\n    return class WrapperComponent extends Component {\n      // All we are doing is returning a new component\n      // that renders our original component.\n      render() {\n        // Notice that we need to pass WrappedComponent\n        // WrapperComponent's props.\n        // If we didn't do this, then WrappedComponent\n        // would never have access to any props.\n        return <WrappedComponent {...this.props} />;\n      }\n    };\n  };\n}\n```\n\nIf we were to run the above `connect` function on a component, the connected component would behave identically to original component. Furthermore, we could nest `connect` as many times as we want\n\n```js\nconnect(null, null)(connect(null, null)(App))\n```\n\nand still never distort the behavior of the original component. Our current implementation is effectively [idempotent](https://stackoverflow.com/questions/1077412/what-is-an-idempotent-operation).\n\n# Eliminating Boilerplate\n\nOur next step is to eliminate some of the boilerplate code. We don't want to have to subscribe to the store every time we create a new component, so let's have our new `connect` function do it instead.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        // Since the whole point of this HOC is to get WrappedComponent\n        // access to the store, we need to pass that state down as props.\n        const storeState = this.state.storeState;\n        return <WrappedComponent {...this.props} {...storeState} />;\n      }\n    };\n  };\n}\n```\n\nWe just made huge progress! Now, whenever we invoke\n\n```js\nconnect(null, null)(MyComponent)\n```\n\nwe get a component that is subscribed to state changes on the store, and this state will be passed down to our component as props.\n\n# Implementing Support for mapStateToProps\n\nOur connected components still all depend on the entirety of the store's state tree. Look up above, the entire state is passed down as props to every connected component. To reiterate, this means that if any piece of the store's state is updated, our component will re-render.\n\nThis is where `mapStateToProps` comes to the rescue. `mapStateToProps` takes as its argument the store's state, and it allows us to return the particular pieces of the store's state that a component depends on. It then passes that state as props to our component instead.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        // Now, instead of passing down all of the store state,\n        // we only pass down the subset of state return from\n        // mapStateToProps\n        const storeProps = mapStateToProps(this.state.storeState);\n        return <WrappedComponent {...this.props} {...storeProps} />;\n      }\n    };\n  };\n}\n```\n\nAll we did was insert a call to `mapStateToProps`, allowing us to make each connected component dependent upon only the state it cares about, as defined by the return value of `mapStateToProps`. `mapStateToProps` is a wonderful form of explicit documentation, clearly stating the slices of the state tree each component depends on. Unfortunately, our change does not fix the efficiency problems noted above. More on that below.\n\n# mapStateToProps and ownProps\n\nAn astute reader might note that `mapStateToProps` actually takes two arguments: the first is a copy of the store's state, and the second are the props that are originally passed down to `WrapperComponent`. `react-redux` does not pass these down to the wrapped component by default as we do in the example immediately above. Let's modify our implementation to mirror `react-redux`.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        const newProps = mapStateToProps(this.state.storeState, this.props);\n        return <WrappedComponent {...newProps} />;\n      }\n    };\n  };\n}\n```\n\nNow the implementer of `mapStateToProps` can choose which of `WrapperComponent`'s props it would like to keep and which it would like to disregard.\n\n# What's the Point of mapDispatchToProps?\n\n`mapDispatchToProps` is designed to eliminate React's dependency upon Redux. If we were to use the above implementation of `connect`, every component that dispatch's an action must import `store.dispatch`, and the implementation would look like this:\n\n```js\nimport store from \"./store\";\nimport { Component } from \"react\";\nimport { updateThing } from \"./store/actions\";\n\nclass ExampleComponent extends Component {\n  handleChange(e) {\n    store.dispatch(updateThing(e.target));\n  }\n}\n```\n\nThe above component 'knows' that it is part of a Redux application because it is explicitly referencing the store to dispatch actions. But we should always try to minimize the interaction of different pieces of architecture, esspecially when they have no need to interact. Ultimately, React components should not been intertwined with Redux code!\n\n## Implementing Support for mapDispatchToProps\n\n`connect` resolves this problem for us by injecting the `store.dispatch` dependency into `mapDispatchToProps`, allowing us to explicitly define functions that dispatch actions without requiring that our [presentation components](https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0) have a dependency on the store. Just as the return value of `mapStateToProps` is passed down to `WrappedComponent`, the return value of `mapDispatchToProps` will be passed down as well.\n\n```js\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        // Now we merge the results from mapStateToProps\n        // and mapDispatchToProps and pass everything down\n        const newProps = Object.assign(\n          {},\n          mapStateToProps(this.state.storeState, this.props),\n          // If you aren't intimately familiar with the this keyword,\n          // it's okay if you don't understand why we use bind here\n          mapDispatchToProps(store.dispatch.bind(this))\n        );\n        return <WrappedComponent {...newProps} />;\n      }\n    };\n  };\n}\n```\n\n\n# More Efficiency Issues - Hello shouldComponentUpdate\n\nWe never actually fixed any of the performance issues noted above. The crux of the problem is that every time the store updates, `WrapperComponent` re-renders (because of its Redux store subscription that calls `setState`) and that means `WrappedComponent` re-renders. This [re-rendering](/leveraging-immutability-in-react) happens despite the fact that `WrappedComponent`'s props might be unchanged between two invocations of `setState`. In fact, this scenario is highly probable and will occur whenever a piece of state in the store changes that your component does not depend on (aka, a piece of store state not returned from from `mapStateToProps`).\n\nReact has a handy lifecycle method called [`shouldComponentUpdate`](https://reactjs.org/docs/react-component.html#shouldcomponentupdate) that allows us to return a boolean that indicates whether a component should re-render. In essence, if we implement this method on `WrapperComponent` and it returns `false`, then React will not re-render `WrapperComponent`. And it follows that `WrappedComponent` won't re-render either.\n\nSo, in the above scenario, when `WrapperComponent` calls `setState`, React first calls the `shouldComponentUpdate` method to see if a re-render should actually happen. Let's implement it below.\n\n```js\n// Just a simple shallow equality function\nimport shallowEqual from \"shallow-equal/objects\"\n\nfunction connect(mapStateToProps, mapDispatchToProps) {\n  return function(WrappedComponent) {\n    return class WrapperComponent extends Component {\n      constructor() {\n        super();\n        this.state = { storeState: store.getState() };\n      }\n\n      shouldComponentUpdate() {\n        // If the props to WrapperComponent do not change\n        // between setState calls, then we don't need to re-render.\n        // On the previous re-render, we cached the results of\n        // mapStateToProps. That's what this.oldProps is.\n        const newProps = mapStateToProps(this.state.storeState, this.props);\n        return !shallowEqual(newProps, this.oldProps);\n      }\n\n      componentDidMount() {\n        this.unsubscribe = store.subscribe(() => {\n          this.setState({ storeState: store.getState() });\n        });\n      }\n\n      componentWillUnmount() {\n        this.unsubscribe();\n      }\n\n      render() {\n        // We need to hang onto the previous result of\n        // mapStateToProps to use the next time\n        // shouldComponentUpdate runs\n        this.oldProps = mapStateToProps(this.state.storeState, this.props)\n        const newProps = Object.assign(\n          {},\n          this.oldProps,\n          mapDispatchToProps(store.dispatch.bind(this))\n        );\n        return <WrappedComponent {...newProps} />;\n      }\n    };\n  };\n}\n```\nI've created a demo [here](https://codesandbox.io/s/o43p70k66). Open the console and prove to yourself that `shouldComponentUpdate` is doing its job.\n\n_I should note that this is not exactly what react-redux does because of edge cases, but the concept is still the same._\n\nNow our wrapper and wrapped components will only re-render when the props returned from `mapStateToProps` change! This is a huge performance gain. This implementation of `connect` explains why adherence to [immutability is so important](http://redux.js.org/docs/faq/ReactRedux.html#react-not-rerendering) in redux's reducers. If you fail to respect immutability, the shallow comparison in the `shouldComponentUpdate` in `WrapperComponent` will likely return `false`, causing your connected component to not re-render when it should.\n\n# Wrapping up\n\nReact-redux's `connect` method is remarkably simple and only performs a handful of operations.\n\n1. It manages our component's subscription to the store so that our component can update when the store updates.\n2. It allows us to explicitly define the slice of state our component is dependent upon using `mapStateToProps`.\n3. It gives our component access to `store.dispatch` without requiring a direct dependency on the store.\n4. It defines `shouldComponentUpdate`, ensuring that our components only re-render when the store state they depend on changes.\n\nI hope you found this article helpful. Please feel free to email me and reach out if you have questions. I put a [gist](https://gist.github.com/nadrane/5221c64c421efe421bda9fdaab167dc2) online containing the same code as the demo.","slug":"write-your-own-redux-connect","published":1,"updated":"2018-09-30T20:53:07.513Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjngw0vny000x67ozl2q2mmgk","content":"<p><em>My inspiration for this blog post came from <a href=\"https://www.youtube.com/watch?v=VJ38wSFbM3A\" target=\"_blank\" rel=\"noopener\">this video</a> where Dan Abramov walks through the source code to react-redux</em></p>\n<p>As frontend web developers, it’s not uncommon that we follow well-specified patterns - often blindly. The frontend landscape is changing rapidly, and sometimes there isn’t time to investigate why we use a specific pattern; we just know we should.</p>\n<p>One widely used pattern in <a href=\"https://github.com/reactjs/react-redux\" target=\"_blank\" rel=\"noopener\">react-redux</a> applications looks like this</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connect(mapStateToProps, mapDispatchToProps)(MyComponent)</span><br></pre></td></tr></table></figure>\n<p>I’ll assume you know how to implement this pattern, but why do we use it and how does it work under the hood?</p>\n<a id=\"more\"></a>\n<h1 id=\"Why-Do-we-Need-React-Redux\"><a href=\"#Why-Do-we-Need-React-Redux\" class=\"headerlink\" title=\"Why Do we Need React-Redux?\"></a>Why Do we Need React-Redux?</h1><p>React and Redux are two completely independent tools that have nothing to do with each other. React is a tool for creating user interfaces in the browser. Redux is a tool for managing state. Either tool can be used without the other. We often use them together because they both solve separate but very important and closely related problems. The purpose of react-redux is to get these two tools to talk.</p>\n<p>But first, what would we do without react-redux? How would React and Redux talk?</p>\n<h1 id=\"How-to-Integrate-React-and-Redux-Without-react-redux\"><a href=\"#How-to-Integrate-React-and-Redux-Without-react-redux\" class=\"headerlink\" title=\"How to Integrate React and Redux Without react-redux\"></a>How to Integrate React and Redux Without react-redux</h1><p>More precisely, how do we ensure that a React component re-renders when the Redux store changes? The answer lies in Redux’s <a href=\"http://redux.js.org/docs/api/Store.html#subscribe\" target=\"_blank\" rel=\"noopener\">subscribe</a> API.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> store <span class=\"keyword\">from</span> <span class=\"string\">'./store'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; Component &#125; <span class=\"keyword\">from</span> <span class=\"string\">'react'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>();</span><br><span class=\"line\">    <span class=\"comment\">// One solution is to make each component</span></span><br><span class=\"line\">    <span class=\"comment\">// store the entirety of the redux state.</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  componentDidMount() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Callbacks passed to store.subscribe will be</span></span><br><span class=\"line\">    <span class=\"comment\">// invoked every time the store's state changes.</span></span><br><span class=\"line\">    <span class=\"comment\">// Our callback can get the state of the</span></span><br><span class=\"line\">    <span class=\"comment\">// store and add it to the component's local state.</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// We need to make sure that we don't accidentally</span></span><br><span class=\"line\">  <span class=\"comment\">// subscribe to the store multiple times in the case</span></span><br><span class=\"line\">  <span class=\"comment\">// where a component mounts, unmounts, and then mounts a second time.</span></span><br><span class=\"line\">  <span class=\"comment\">// Fortunately, Redux makes this easy by returning</span></span><br><span class=\"line\">  <span class=\"comment\">// an unsubscribe function when store.subscribe is invoked.</span></span><br><span class=\"line\">  componentWillUnmount() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>If we insert the above boilerplate into every one of our React component’s, then every component could have access to the store and would be informed through a subscription the moment the store’s state changes. This configuration has three  flaws.</p>\n<ol>\n<li>The boilerplate of subscribing and unsubscribing to the store is highly error prone and unnecessarily verbose.</li>\n<li>All of our React component’s are dependent upon knowledge of the Redux store. This is a complete failure of <a href=\"https://en.wikipedia.org/wiki/Separation_of_concerns\" target=\"_blank\" rel=\"noopener\">separation of concerns</a>.</li>\n<li>Every component is dependent upon the entirety of the store’s state tree. This means that whenever an action is dispatched, <code>setState</code> is called on every mounted component, causing each one to re-render, regardless of whether its render function depends on the store state that changed. Woah! Let that sink in for a moment.</li>\n</ol>\n<p>Let’s write a rudimentary implementation of connect that resolves the first problem.</p>\n<h1 id=\"Understanding-The-Syntax-of-Connect\"><a href=\"#Understanding-The-Syntax-of-Connect\" class=\"headerlink\" title=\"Understanding The Syntax of Connect\"></a>Understanding The Syntax of Connect</h1><p>Typically, we invoke <code>connect</code> like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connect(mapStateToProps, mapDispatchToProps)(WrappedComponent);</span><br></pre></td></tr></table></figure>\n<p><code>connect</code> takes in two functions as arguments and returns a function. Yes, you heard me, <code>connect</code> returns a function, not a component. Suppose I invoke <code>connect</code> and neglect to pass in a component.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> connectFunc = connect(mapStateToProps, mapDispatchToProps);</span><br><span class=\"line\"><span class=\"keyword\">const</span> connctedComponent = connectFunc(WrappedComponent);</span><br></pre></td></tr></table></figure>\n<p> <code>connect</code> will return to me a function. It’s that function that takes in my component (<code>connect</code> is implemented this way as opposed to simply taking in 3 arguments to support decorator syntax. The Dan Abramov video I linked above explains this.)</p>\n<p>Thus, the very first few lines of <code>connect</code> must look like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"Higher-Order-Components\"><a href=\"#Higher-Order-Components\" class=\"headerlink\" title=\"Higher Order Components\"></a>Higher Order Components</h1><p>And what does the function we returned above do? This function is implemented as a <a href=\"https://reactjs.org/docs/higher-order-components.html\" target=\"_blank\" rel=\"noopener\">higher order component</a> (HOC). A HOC is a function that takes in a component as a parameter and returns a new component. The new component is generally a modified or augmented version of the original component.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// We are returning a brand new component.</span></span><br><span class=\"line\">    <span class=\"comment\">// Note that this new component does</span></span><br><span class=\"line\">    <span class=\"comment\">// not inherit from WrappedComponent.</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// All we are doing is returning a new component</span></span><br><span class=\"line\">      <span class=\"comment\">// that renders our original component.</span></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Notice that we need to pass WrappedComponent</span></span><br><span class=\"line\">        <span class=\"comment\">// WrapperComponent's props.</span></span><br><span class=\"line\">        <span class=\"comment\">// If we didn't do this, then WrappedComponent</span></span><br><span class=\"line\">        <span class=\"comment\">// would never have access to any props.</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...this.props&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>If we were to run the above <code>connect</code> function on a component, the connected component would behave identically to original component. Furthermore, we could nest <code>connect</code> as many times as we want</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connect(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>)(connect(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>)(App))</span><br></pre></td></tr></table></figure>\n<p>and still never distort the behavior of the original component. Our current implementation is effectively <a href=\"https://stackoverflow.com/questions/1077412/what-is-an-idempotent-operation\" target=\"_blank\" rel=\"noopener\">idempotent</a>.</p>\n<h1 id=\"Eliminating-Boilerplate\"><a href=\"#Eliminating-Boilerplate\" class=\"headerlink\" title=\"Eliminating Boilerplate\"></a>Eliminating Boilerplate</h1><p>Our next step is to eliminate some of the boilerplate code. We don’t want to have to subscribe to the store every time we create a new component, so let’s have our new <code>connect</code> function do it instead.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Since the whole point of this HOC is to get WrappedComponent</span></span><br><span class=\"line\">        <span class=\"comment\">// access to the store, we need to pass that state down as props.</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> storeState = <span class=\"keyword\">this</span>.state.storeState;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...this.props&#125; &#123;...storeState&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We just made huge progress! Now, whenever we invoke</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connect(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>)(MyComponent)</span><br></pre></td></tr></table></figure>\n<p>we get a component that is subscribed to state changes on the store, and this state will be passed down to our component as props.</p>\n<h1 id=\"Implementing-Support-for-mapStateToProps\"><a href=\"#Implementing-Support-for-mapStateToProps\" class=\"headerlink\" title=\"Implementing Support for mapStateToProps\"></a>Implementing Support for mapStateToProps</h1><p>Our connected components still all depend on the entirety of the store’s state tree. Look up above, the entire state is passed down as props to every connected component. To reiterate, this means that if any piece of the store’s state is updated, our component will re-render.</p>\n<p>This is where <code>mapStateToProps</code> comes to the rescue. <code>mapStateToProps</code> takes as its argument the store’s state, and it allows us to return the particular pieces of the store’s state that a component depends on. It then passes that state as props to our component instead.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Now, instead of passing down all of the store state,</span></span><br><span class=\"line\">        <span class=\"comment\">// we only pass down the subset of state return from</span></span><br><span class=\"line\">        <span class=\"comment\">// mapStateToProps</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> storeProps = mapStateToProps(<span class=\"keyword\">this</span>.state.storeState);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...this.props&#125; &#123;...storeProps&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>All we did was insert a call to <code>mapStateToProps</code>, allowing us to make each connected component dependent upon only the state it cares about, as defined by the return value of <code>mapStateToProps</code>. <code>mapStateToProps</code> is a wonderful form of explicit documentation, clearly stating the slices of the state tree each component depends on. Unfortunately, our change does not fix the efficiency problems noted above. More on that below.</p>\n<h1 id=\"mapStateToProps-and-ownProps\"><a href=\"#mapStateToProps-and-ownProps\" class=\"headerlink\" title=\"mapStateToProps and ownProps\"></a>mapStateToProps and ownProps</h1><p>An astute reader might note that <code>mapStateToProps</code> actually takes two arguments: the first is a copy of the store’s state, and the second are the props that are originally passed down to <code>WrapperComponent</code>. <code>react-redux</code> does not pass these down to the wrapped component by default as we do in the example immediately above. Let’s modify our implementation to mirror <code>react-redux</code>.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> newProps = mapStateToProps(<span class=\"keyword\">this</span>.state.storeState, <span class=\"keyword\">this</span>.props);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...newProps&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Now the implementer of <code>mapStateToProps</code> can choose which of <code>WrapperComponent</code>‘s props it would like to keep and which it would like to disregard.</p>\n<h1 id=\"What’s-the-Point-of-mapDispatchToProps\"><a href=\"#What’s-the-Point-of-mapDispatchToProps\" class=\"headerlink\" title=\"What’s the Point of mapDispatchToProps?\"></a>What’s the Point of mapDispatchToProps?</h1><p><code>mapDispatchToProps</code> is designed to eliminate React’s dependency upon Redux. If we were to use the above implementation of <code>connect</code>, every component that dispatch’s an action must import <code>store.dispatch</code>, and the implementation would look like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> store <span class=\"keyword\">from</span> <span class=\"string\">\"./store\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; Component &#125; <span class=\"keyword\">from</span> <span class=\"string\">\"react\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; updateThing &#125; <span class=\"keyword\">from</span> <span class=\"string\">\"./store/actions\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExampleComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">  handleChange(e) &#123;</span><br><span class=\"line\">    store.dispatch(updateThing(e.target));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The above component ‘knows’ that it is part of a Redux application because it is explicitly referencing the store to dispatch actions. But we should always try to minimize the interaction of different pieces of architecture, esspecially when they have no need to interact. Ultimately, React components should not been intertwined with Redux code!</p>\n<h2 id=\"Implementing-Support-for-mapDispatchToProps\"><a href=\"#Implementing-Support-for-mapDispatchToProps\" class=\"headerlink\" title=\"Implementing Support for mapDispatchToProps\"></a>Implementing Support for mapDispatchToProps</h2><p><code>connect</code> resolves this problem for us by injecting the <code>store.dispatch</code> dependency into <code>mapDispatchToProps</code>, allowing us to explicitly define functions that dispatch actions without requiring that our <a href=\"https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0\" target=\"_blank\" rel=\"noopener\">presentation components</a> have a dependency on the store. Just as the return value of <code>mapStateToProps</code> is passed down to <code>WrappedComponent</code>, the return value of <code>mapDispatchToProps</code> will be passed down as well.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Now we merge the results from mapStateToProps</span></span><br><span class=\"line\">        <span class=\"comment\">// and mapDispatchToProps and pass everything down</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> newProps = <span class=\"built_in\">Object</span>.assign(</span><br><span class=\"line\">          &#123;&#125;,</span><br><span class=\"line\">          mapStateToProps(<span class=\"keyword\">this</span>.state.storeState, <span class=\"keyword\">this</span>.props),</span><br><span class=\"line\">          <span class=\"comment\">// If you aren't intimately familiar with the this keyword,</span></span><br><span class=\"line\">          <span class=\"comment\">// it's okay if you don't understand why we use bind here</span></span><br><span class=\"line\">          mapDispatchToProps(store.dispatch.bind(<span class=\"keyword\">this</span>))</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...newProps&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"More-Efficiency-Issues-Hello-shouldComponentUpdate\"><a href=\"#More-Efficiency-Issues-Hello-shouldComponentUpdate\" class=\"headerlink\" title=\"More Efficiency Issues - Hello shouldComponentUpdate\"></a>More Efficiency Issues - Hello shouldComponentUpdate</h1><p>We never actually fixed any of the performance issues noted above. The crux of the problem is that every time the store updates, <code>WrapperComponent</code> re-renders (because of its Redux store subscription that calls <code>setState</code>) and that means <code>WrappedComponent</code> re-renders. This <a href=\"/leveraging-immutability-in-react\">re-rendering</a> happens despite the fact that <code>WrappedComponent</code>‘s props might be unchanged between two invocations of <code>setState</code>. In fact, this scenario is highly probable and will occur whenever a piece of state in the store changes that your component does not depend on (aka, a piece of store state not returned from from <code>mapStateToProps</code>).</p>\n<p>React has a handy lifecycle method called <a href=\"https://reactjs.org/docs/react-component.html#shouldcomponentupdate\" target=\"_blank\" rel=\"noopener\"><code>shouldComponentUpdate</code></a> that allows us to return a boolean that indicates whether a component should re-render. In essence, if we implement this method on <code>WrapperComponent</code> and it returns <code>false</code>, then React will not re-render <code>WrapperComponent</code>. And it follows that <code>WrappedComponent</code> won’t re-render either.</p>\n<p>So, in the above scenario, when <code>WrapperComponent</code> calls <code>setState</code>, React first calls the <code>shouldComponentUpdate</code> method to see if a re-render should actually happen. Let’s implement it below.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Just a simple shallow equality function</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> shallowEqual <span class=\"keyword\">from</span> <span class=\"string\">\"shallow-equal/objects\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      shouldComponentUpdate() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// If the props to WrapperComponent do not change</span></span><br><span class=\"line\">        <span class=\"comment\">// between setState calls, then we don't need to re-render.</span></span><br><span class=\"line\">        <span class=\"comment\">// On the previous re-render, we cached the results of</span></span><br><span class=\"line\">        <span class=\"comment\">// mapStateToProps. That's what this.oldProps is.</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> newProps = mapStateToProps(<span class=\"keyword\">this</span>.state.storeState, <span class=\"keyword\">this</span>.props);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> !shallowEqual(newProps, <span class=\"keyword\">this</span>.oldProps);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We need to hang onto the previous result of</span></span><br><span class=\"line\">        <span class=\"comment\">// mapStateToProps to use the next time</span></span><br><span class=\"line\">        <span class=\"comment\">// shouldComponentUpdate runs</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.oldProps = mapStateToProps(<span class=\"keyword\">this</span>.state.storeState, <span class=\"keyword\">this</span>.props)</span><br><span class=\"line\">        <span class=\"keyword\">const</span> newProps = <span class=\"built_in\">Object</span>.assign(</span><br><span class=\"line\">          &#123;&#125;,</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.oldProps,</span><br><span class=\"line\">          mapDispatchToProps(store.dispatch.bind(<span class=\"keyword\">this</span>))</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...newProps&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>I’ve created a demo <a href=\"https://codesandbox.io/s/o43p70k66\" target=\"_blank\" rel=\"noopener\">here</a>. Open the console and prove to yourself that <code>shouldComponentUpdate</code> is doing its job.</p>\n<p><em>I should note that this is not exactly what react-redux does because of edge cases, but the concept is still the same.</em></p>\n<p>Now our wrapper and wrapped components will only re-render when the props returned from <code>mapStateToProps</code> change! This is a huge performance gain. This implementation of <code>connect</code> explains why adherence to <a href=\"http://redux.js.org/docs/faq/ReactRedux.html#react-not-rerendering\" target=\"_blank\" rel=\"noopener\">immutability is so important</a> in redux’s reducers. If you fail to respect immutability, the shallow comparison in the <code>shouldComponentUpdate</code> in <code>WrapperComponent</code> will likely return <code>false</code>, causing your connected component to not re-render when it should.</p>\n<h1 id=\"Wrapping-up\"><a href=\"#Wrapping-up\" class=\"headerlink\" title=\"Wrapping up\"></a>Wrapping up</h1><p>React-redux’s <code>connect</code> method is remarkably simple and only performs a handful of operations.</p>\n<ol>\n<li>It manages our component’s subscription to the store so that our component can update when the store updates.</li>\n<li>It allows us to explicitly define the slice of state our component is dependent upon using <code>mapStateToProps</code>.</li>\n<li>It gives our component access to <code>store.dispatch</code> without requiring a direct dependency on the store.</li>\n<li>It defines <code>shouldComponentUpdate</code>, ensuring that our components only re-render when the store state they depend on changes.</li>\n</ol>\n<p>I hope you found this article helpful. Please feel free to email me and reach out if you have questions. I put a <a href=\"https://gist.github.com/nadrane/5221c64c421efe421bda9fdaab167dc2\" target=\"_blank\" rel=\"noopener\">gist</a> online containing the same code as the demo.</p>\n","site":{"data":{}},"excerpt":"<p><em>My inspiration for this blog post came from <a href=\"https://www.youtube.com/watch?v=VJ38wSFbM3A\" target=\"_blank\" rel=\"noopener\">this video</a> where Dan Abramov walks through the source code to react-redux</em></p>\n<p>As frontend web developers, it’s not uncommon that we follow well-specified patterns - often blindly. The frontend landscape is changing rapidly, and sometimes there isn’t time to investigate why we use a specific pattern; we just know we should.</p>\n<p>One widely used pattern in <a href=\"https://github.com/reactjs/react-redux\" target=\"_blank\" rel=\"noopener\">react-redux</a> applications looks like this</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connect(mapStateToProps, mapDispatchToProps)(MyComponent)</span><br></pre></td></tr></table></figure>\n<p>I’ll assume you know how to implement this pattern, but why do we use it and how does it work under the hood?</p>","more":"<h1 id=\"Why-Do-we-Need-React-Redux\"><a href=\"#Why-Do-we-Need-React-Redux\" class=\"headerlink\" title=\"Why Do we Need React-Redux?\"></a>Why Do we Need React-Redux?</h1><p>React and Redux are two completely independent tools that have nothing to do with each other. React is a tool for creating user interfaces in the browser. Redux is a tool for managing state. Either tool can be used without the other. We often use them together because they both solve separate but very important and closely related problems. The purpose of react-redux is to get these two tools to talk.</p>\n<p>But first, what would we do without react-redux? How would React and Redux talk?</p>\n<h1 id=\"How-to-Integrate-React-and-Redux-Without-react-redux\"><a href=\"#How-to-Integrate-React-and-Redux-Without-react-redux\" class=\"headerlink\" title=\"How to Integrate React and Redux Without react-redux\"></a>How to Integrate React and Redux Without react-redux</h1><p>More precisely, how do we ensure that a React component re-renders when the Redux store changes? The answer lies in Redux’s <a href=\"http://redux.js.org/docs/api/Store.html#subscribe\" target=\"_blank\" rel=\"noopener\">subscribe</a> API.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> store <span class=\"keyword\">from</span> <span class=\"string\">'./store'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; Component &#125; <span class=\"keyword\">from</span> <span class=\"string\">'react'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">super</span>();</span><br><span class=\"line\">    <span class=\"comment\">// One solution is to make each component</span></span><br><span class=\"line\">    <span class=\"comment\">// store the entirety of the redux state.</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  componentDidMount() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Callbacks passed to store.subscribe will be</span></span><br><span class=\"line\">    <span class=\"comment\">// invoked every time the store's state changes.</span></span><br><span class=\"line\">    <span class=\"comment\">// Our callback can get the state of the</span></span><br><span class=\"line\">    <span class=\"comment\">// store and add it to the component's local state.</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// We need to make sure that we don't accidentally</span></span><br><span class=\"line\">  <span class=\"comment\">// subscribe to the store multiple times in the case</span></span><br><span class=\"line\">  <span class=\"comment\">// where a component mounts, unmounts, and then mounts a second time.</span></span><br><span class=\"line\">  <span class=\"comment\">// Fortunately, Redux makes this easy by returning</span></span><br><span class=\"line\">  <span class=\"comment\">// an unsubscribe function when store.subscribe is invoked.</span></span><br><span class=\"line\">  componentWillUnmount() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>If we insert the above boilerplate into every one of our React component’s, then every component could have access to the store and would be informed through a subscription the moment the store’s state changes. This configuration has three  flaws.</p>\n<ol>\n<li>The boilerplate of subscribing and unsubscribing to the store is highly error prone and unnecessarily verbose.</li>\n<li>All of our React component’s are dependent upon knowledge of the Redux store. This is a complete failure of <a href=\"https://en.wikipedia.org/wiki/Separation_of_concerns\" target=\"_blank\" rel=\"noopener\">separation of concerns</a>.</li>\n<li>Every component is dependent upon the entirety of the store’s state tree. This means that whenever an action is dispatched, <code>setState</code> is called on every mounted component, causing each one to re-render, regardless of whether its render function depends on the store state that changed. Woah! Let that sink in for a moment.</li>\n</ol>\n<p>Let’s write a rudimentary implementation of connect that resolves the first problem.</p>\n<h1 id=\"Understanding-The-Syntax-of-Connect\"><a href=\"#Understanding-The-Syntax-of-Connect\" class=\"headerlink\" title=\"Understanding The Syntax of Connect\"></a>Understanding The Syntax of Connect</h1><p>Typically, we invoke <code>connect</code> like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connect(mapStateToProps, mapDispatchToProps)(WrappedComponent);</span><br></pre></td></tr></table></figure>\n<p><code>connect</code> takes in two functions as arguments and returns a function. Yes, you heard me, <code>connect</code> returns a function, not a component. Suppose I invoke <code>connect</code> and neglect to pass in a component.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> connectFunc = connect(mapStateToProps, mapDispatchToProps);</span><br><span class=\"line\"><span class=\"keyword\">const</span> connctedComponent = connectFunc(WrappedComponent);</span><br></pre></td></tr></table></figure>\n<p> <code>connect</code> will return to me a function. It’s that function that takes in my component (<code>connect</code> is implemented this way as opposed to simply taking in 3 arguments to support decorator syntax. The Dan Abramov video I linked above explains this.)</p>\n<p>Thus, the very first few lines of <code>connect</code> must look like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"Higher-Order-Components\"><a href=\"#Higher-Order-Components\" class=\"headerlink\" title=\"Higher Order Components\"></a>Higher Order Components</h1><p>And what does the function we returned above do? This function is implemented as a <a href=\"https://reactjs.org/docs/higher-order-components.html\" target=\"_blank\" rel=\"noopener\">higher order component</a> (HOC). A HOC is a function that takes in a component as a parameter and returns a new component. The new component is generally a modified or augmented version of the original component.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// We are returning a brand new component.</span></span><br><span class=\"line\">    <span class=\"comment\">// Note that this new component does</span></span><br><span class=\"line\">    <span class=\"comment\">// not inherit from WrappedComponent.</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// All we are doing is returning a new component</span></span><br><span class=\"line\">      <span class=\"comment\">// that renders our original component.</span></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Notice that we need to pass WrappedComponent</span></span><br><span class=\"line\">        <span class=\"comment\">// WrapperComponent's props.</span></span><br><span class=\"line\">        <span class=\"comment\">// If we didn't do this, then WrappedComponent</span></span><br><span class=\"line\">        <span class=\"comment\">// would never have access to any props.</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...this.props&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>If we were to run the above <code>connect</code> function on a component, the connected component would behave identically to original component. Furthermore, we could nest <code>connect</code> as many times as we want</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connect(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>)(connect(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>)(App))</span><br></pre></td></tr></table></figure>\n<p>and still never distort the behavior of the original component. Our current implementation is effectively <a href=\"https://stackoverflow.com/questions/1077412/what-is-an-idempotent-operation\" target=\"_blank\" rel=\"noopener\">idempotent</a>.</p>\n<h1 id=\"Eliminating-Boilerplate\"><a href=\"#Eliminating-Boilerplate\" class=\"headerlink\" title=\"Eliminating Boilerplate\"></a>Eliminating Boilerplate</h1><p>Our next step is to eliminate some of the boilerplate code. We don’t want to have to subscribe to the store every time we create a new component, so let’s have our new <code>connect</code> function do it instead.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Since the whole point of this HOC is to get WrappedComponent</span></span><br><span class=\"line\">        <span class=\"comment\">// access to the store, we need to pass that state down as props.</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> storeState = <span class=\"keyword\">this</span>.state.storeState;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...this.props&#125; &#123;...storeState&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>We just made huge progress! Now, whenever we invoke</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">connect(<span class=\"literal\">null</span>, <span class=\"literal\">null</span>)(MyComponent)</span><br></pre></td></tr></table></figure>\n<p>we get a component that is subscribed to state changes on the store, and this state will be passed down to our component as props.</p>\n<h1 id=\"Implementing-Support-for-mapStateToProps\"><a href=\"#Implementing-Support-for-mapStateToProps\" class=\"headerlink\" title=\"Implementing Support for mapStateToProps\"></a>Implementing Support for mapStateToProps</h1><p>Our connected components still all depend on the entirety of the store’s state tree. Look up above, the entire state is passed down as props to every connected component. To reiterate, this means that if any piece of the store’s state is updated, our component will re-render.</p>\n<p>This is where <code>mapStateToProps</code> comes to the rescue. <code>mapStateToProps</code> takes as its argument the store’s state, and it allows us to return the particular pieces of the store’s state that a component depends on. It then passes that state as props to our component instead.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Now, instead of passing down all of the store state,</span></span><br><span class=\"line\">        <span class=\"comment\">// we only pass down the subset of state return from</span></span><br><span class=\"line\">        <span class=\"comment\">// mapStateToProps</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> storeProps = mapStateToProps(<span class=\"keyword\">this</span>.state.storeState);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...this.props&#125; &#123;...storeProps&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>All we did was insert a call to <code>mapStateToProps</code>, allowing us to make each connected component dependent upon only the state it cares about, as defined by the return value of <code>mapStateToProps</code>. <code>mapStateToProps</code> is a wonderful form of explicit documentation, clearly stating the slices of the state tree each component depends on. Unfortunately, our change does not fix the efficiency problems noted above. More on that below.</p>\n<h1 id=\"mapStateToProps-and-ownProps\"><a href=\"#mapStateToProps-and-ownProps\" class=\"headerlink\" title=\"mapStateToProps and ownProps\"></a>mapStateToProps and ownProps</h1><p>An astute reader might note that <code>mapStateToProps</code> actually takes two arguments: the first is a copy of the store’s state, and the second are the props that are originally passed down to <code>WrapperComponent</code>. <code>react-redux</code> does not pass these down to the wrapped component by default as we do in the example immediately above. Let’s modify our implementation to mirror <code>react-redux</code>.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> newProps = mapStateToProps(<span class=\"keyword\">this</span>.state.storeState, <span class=\"keyword\">this</span>.props);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...newProps&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Now the implementer of <code>mapStateToProps</code> can choose which of <code>WrapperComponent</code>‘s props it would like to keep and which it would like to disregard.</p>\n<h1 id=\"What’s-the-Point-of-mapDispatchToProps\"><a href=\"#What’s-the-Point-of-mapDispatchToProps\" class=\"headerlink\" title=\"What’s the Point of mapDispatchToProps?\"></a>What’s the Point of mapDispatchToProps?</h1><p><code>mapDispatchToProps</code> is designed to eliminate React’s dependency upon Redux. If we were to use the above implementation of <code>connect</code>, every component that dispatch’s an action must import <code>store.dispatch</code>, and the implementation would look like this:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> store <span class=\"keyword\">from</span> <span class=\"string\">\"./store\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; Component &#125; <span class=\"keyword\">from</span> <span class=\"string\">\"react\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; updateThing &#125; <span class=\"keyword\">from</span> <span class=\"string\">\"./store/actions\"</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExampleComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">  handleChange(e) &#123;</span><br><span class=\"line\">    store.dispatch(updateThing(e.target));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>The above component ‘knows’ that it is part of a Redux application because it is explicitly referencing the store to dispatch actions. But we should always try to minimize the interaction of different pieces of architecture, esspecially when they have no need to interact. Ultimately, React components should not been intertwined with Redux code!</p>\n<h2 id=\"Implementing-Support-for-mapDispatchToProps\"><a href=\"#Implementing-Support-for-mapDispatchToProps\" class=\"headerlink\" title=\"Implementing Support for mapDispatchToProps\"></a>Implementing Support for mapDispatchToProps</h2><p><code>connect</code> resolves this problem for us by injecting the <code>store.dispatch</code> dependency into <code>mapDispatchToProps</code>, allowing us to explicitly define functions that dispatch actions without requiring that our <a href=\"https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0\" target=\"_blank\" rel=\"noopener\">presentation components</a> have a dependency on the store. Just as the return value of <code>mapStateToProps</code> is passed down to <code>WrappedComponent</code>, the return value of <code>mapDispatchToProps</code> will be passed down as well.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Now we merge the results from mapStateToProps</span></span><br><span class=\"line\">        <span class=\"comment\">// and mapDispatchToProps and pass everything down</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> newProps = <span class=\"built_in\">Object</span>.assign(</span><br><span class=\"line\">          &#123;&#125;,</span><br><span class=\"line\">          mapStateToProps(<span class=\"keyword\">this</span>.state.storeState, <span class=\"keyword\">this</span>.props),</span><br><span class=\"line\">          <span class=\"comment\">// If you aren't intimately familiar with the this keyword,</span></span><br><span class=\"line\">          <span class=\"comment\">// it's okay if you don't understand why we use bind here</span></span><br><span class=\"line\">          mapDispatchToProps(store.dispatch.bind(<span class=\"keyword\">this</span>))</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...newProps&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"More-Efficiency-Issues-Hello-shouldComponentUpdate\"><a href=\"#More-Efficiency-Issues-Hello-shouldComponentUpdate\" class=\"headerlink\" title=\"More Efficiency Issues - Hello shouldComponentUpdate\"></a>More Efficiency Issues - Hello shouldComponentUpdate</h1><p>We never actually fixed any of the performance issues noted above. The crux of the problem is that every time the store updates, <code>WrapperComponent</code> re-renders (because of its Redux store subscription that calls <code>setState</code>) and that means <code>WrappedComponent</code> re-renders. This <a href=\"/leveraging-immutability-in-react\">re-rendering</a> happens despite the fact that <code>WrappedComponent</code>‘s props might be unchanged between two invocations of <code>setState</code>. In fact, this scenario is highly probable and will occur whenever a piece of state in the store changes that your component does not depend on (aka, a piece of store state not returned from from <code>mapStateToProps</code>).</p>\n<p>React has a handy lifecycle method called <a href=\"https://reactjs.org/docs/react-component.html#shouldcomponentupdate\" target=\"_blank\" rel=\"noopener\"><code>shouldComponentUpdate</code></a> that allows us to return a boolean that indicates whether a component should re-render. In essence, if we implement this method on <code>WrapperComponent</code> and it returns <code>false</code>, then React will not re-render <code>WrapperComponent</code>. And it follows that <code>WrappedComponent</code> won’t re-render either.</p>\n<p>So, in the above scenario, when <code>WrapperComponent</code> calls <code>setState</code>, React first calls the <code>shouldComponentUpdate</code> method to see if a re-render should actually happen. Let’s implement it below.</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Just a simple shallow equality function</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> shallowEqual <span class=\"keyword\">from</span> <span class=\"string\">\"shallow-equal/objects\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">connect</span>(<span class=\"params\">mapStateToProps, mapDispatchToProps</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">WrappedComponent</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WrapperComponent</span> <span class=\"keyword\">extends</span> <span class=\"title\">Component</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"keyword\">constructor</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.state = &#123; <span class=\"attr\">storeState</span>: store.getState() &#125;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      shouldComponentUpdate() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// If the props to WrapperComponent do not change</span></span><br><span class=\"line\">        <span class=\"comment\">// between setState calls, then we don't need to re-render.</span></span><br><span class=\"line\">        <span class=\"comment\">// On the previous re-render, we cached the results of</span></span><br><span class=\"line\">        <span class=\"comment\">// mapStateToProps. That's what this.oldProps is.</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> newProps = mapStateToProps(<span class=\"keyword\">this</span>.state.storeState, <span class=\"keyword\">this</span>.props);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> !shallowEqual(newProps, <span class=\"keyword\">this</span>.oldProps);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentDidMount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe = store.subscribe(<span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.setState(&#123; <span class=\"attr\">storeState</span>: store.getState() &#125;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      componentWillUnmount() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      render() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// We need to hang onto the previous result of</span></span><br><span class=\"line\">        <span class=\"comment\">// mapStateToProps to use the next time</span></span><br><span class=\"line\">        <span class=\"comment\">// shouldComponentUpdate runs</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.oldProps = mapStateToProps(<span class=\"keyword\">this</span>.state.storeState, <span class=\"keyword\">this</span>.props)</span><br><span class=\"line\">        <span class=\"keyword\">const</span> newProps = <span class=\"built_in\">Object</span>.assign(</span><br><span class=\"line\">          &#123;&#125;,</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.oldProps,</span><br><span class=\"line\">          mapDispatchToProps(store.dispatch.bind(<span class=\"keyword\">this</span>))</span><br><span class=\"line\">        );</span><br><span class=\"line\">        <span class=\"keyword\">return</span> &lt;WrappedComponent &#123;...newProps&#125; /&gt;;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>I’ve created a demo <a href=\"https://codesandbox.io/s/o43p70k66\" target=\"_blank\" rel=\"noopener\">here</a>. Open the console and prove to yourself that <code>shouldComponentUpdate</code> is doing its job.</p>\n<p><em>I should note that this is not exactly what react-redux does because of edge cases, but the concept is still the same.</em></p>\n<p>Now our wrapper and wrapped components will only re-render when the props returned from <code>mapStateToProps</code> change! This is a huge performance gain. This implementation of <code>connect</code> explains why adherence to <a href=\"http://redux.js.org/docs/faq/ReactRedux.html#react-not-rerendering\" target=\"_blank\" rel=\"noopener\">immutability is so important</a> in redux’s reducers. If you fail to respect immutability, the shallow comparison in the <code>shouldComponentUpdate</code> in <code>WrapperComponent</code> will likely return <code>false</code>, causing your connected component to not re-render when it should.</p>\n<h1 id=\"Wrapping-up\"><a href=\"#Wrapping-up\" class=\"headerlink\" title=\"Wrapping up\"></a>Wrapping up</h1><p>React-redux’s <code>connect</code> method is remarkably simple and only performs a handful of operations.</p>\n<ol>\n<li>It manages our component’s subscription to the store so that our component can update when the store updates.</li>\n<li>It allows us to explicitly define the slice of state our component is dependent upon using <code>mapStateToProps</code>.</li>\n<li>It gives our component access to <code>store.dispatch</code> without requiring a direct dependency on the store.</li>\n<li>It defines <code>shouldComponentUpdate</code>, ensuring that our components only re-render when the store state they depend on changes.</li>\n</ol>\n<p>I hope you found this article helpful. Please feel free to email me and reach out if you have questions. I put a <a href=\"https://gist.github.com/nadrane/5221c64c421efe421bda9fdaab167dc2\" target=\"_blank\" rel=\"noopener\">gist</a> online containing the same code as the demo.</p>"}],"PostAsset":[],"PostCategory":[{"post_id":"cjngw0vn8000967oz5tlogpwm","category_id":"cjngw0vnt000n67ozvoavwzei","_id":"cjngw0vny000w67ozgcyodsor"},{"post_id":"cjngw0vnc000b67ozp6j8pmf4","category_id":"cjngw0vnu000p67oz2ijk6evv","_id":"cjngw0vo0000y67ozl8a8s5z7"},{"post_id":"cjngw0vne000e67ozvfhdng9t","category_id":"cjngw0vnv000s67oz01p5vn6w","_id":"cjngw0vo0000z67ozzvp11hpe"},{"post_id":"cjngw0vnf000f67oz2pzqn5ta","category_id":"cjngw0vnv000t67oz3gdgp8aw","_id":"cjngw0vo0001167ozuor0vlvo"},{"post_id":"cjngw0vnf000g67ozw503p2zb","category_id":"cjngw0vnw000u67ozmy4j61we","_id":"cjngw0vo0001267ozkdx9h69f"},{"post_id":"cjngw0vnf000g67ozw503p2zb","category_id":"cjngw0vnt000n67ozvoavwzei","_id":"cjngw0vo1001467ozg1glws84"},{"post_id":"cjngw0vns000k67ozcj7nd6rv","category_id":"cjngw0vnt000n67ozvoavwzei","_id":"cjngw0vo1001567ozykdtxdv2"},{"post_id":"cjngw0vns000k67ozcj7nd6rv","category_id":"cjngw0vns000l67ozzxk2go6s","_id":"cjngw0vo1001767oz7tfbmfib"},{"post_id":"cjngw0vnt000m67ozrtqu3scq","category_id":"cjngw0vny000v67ozm41af976","_id":"cjngw0vo6001c67ozgiwaimrw"},{"post_id":"cjngw0vn2000267ozc7lqwrca","category_id":"cjngw0vnn000h67ozg84kysck","_id":"cjngw0vo6001e67oznsb3ob5y"},{"post_id":"cjngw0vn2000267ozc7lqwrca","category_id":"cjngw0vo0001067ozi20igrcb","_id":"cjngw0vo6001f67ozc40vrjer"},{"post_id":"cjngw0vn6000667ozwtqruv0k","category_id":"cjngw0vns000l67ozzxk2go6s","_id":"cjngw0vo7001h67ozii38yxq4"},{"post_id":"cjngw0vn6000667ozwtqruv0k","category_id":"cjngw0vo1001367oz6ktj27rm","_id":"cjngw0vo7001i67oz60a26qlv"},{"post_id":"cjngw0vn9000a67ozerhp5pa6","category_id":"cjngw0vnu000o67ozly48xn7u","_id":"cjngw0vo7001j67ozhd0ji68q"},{"post_id":"cjngw0vn9000a67ozerhp5pa6","category_id":"cjngw0vo1001667ozj5vusndi","_id":"cjngw0vo7001k67ozhw4e8faa"},{"post_id":"cjngw0vnd000d67ozqhdu43i1","category_id":"cjngw0vnv000r67ozxjp13ewn","_id":"cjngw0vo7001l67ozxyd7677z"},{"post_id":"cjngw0vnd000d67ozqhdu43i1","category_id":"cjngw0vnn000h67ozg84kysck","_id":"cjngw0vo7001m67ozp2yal4s3"},{"post_id":"cjngw0vnd000d67ozqhdu43i1","category_id":"cjngw0vo1001a67oz7587wvtd","_id":"cjngw0vo7001n67ozon0r9hyb"},{"post_id":"cjngw0vnd000c67oz7uc0b6f1","category_id":"cjngw0vnn000h67ozg84kysck","_id":"cjngw0vo7001o67ozts668ifz"},{"post_id":"cjngw0vnd000c67oz7uc0b6f1","category_id":"cjngw0vo1001867ozx49vie19","_id":"cjngw0vo7001p67oz5q1m89ft"},{"post_id":"cjngw0vnd000c67oz7uc0b6f1","category_id":"cjngw0vo1001367oz6ktj27rm","_id":"cjngw0vo7001q67ozk327nldc"},{"post_id":"cjngw0vnr000j67oza5lnzuzt","category_id":"cjngw0vnv000r67ozxjp13ewn","_id":"cjngw0vo7001r67oza4zxg639"},{"post_id":"cjngw0vnr000j67oza5lnzuzt","category_id":"cjngw0vnn000h67ozg84kysck","_id":"cjngw0vo7001s67ozwr3y6a9u"},{"post_id":"cjngw0vnr000j67oza5lnzuzt","category_id":"cjngw0vo1001967ozckvdpt4r","_id":"cjngw0vo8001t67oztkfl4kl8"},{"post_id":"cjngw0vnr000j67oza5lnzuzt","category_id":"cjngw0vo0001067ozi20igrcb","_id":"cjngw0vo8001u67ozzl1gz5hc"},{"post_id":"cjngw0vnq000i67ozm1edvlyi","category_id":"cjngw0vnn000h67ozg84kysck","_id":"cjngw0voa001v67ozbcl3t88s"},{"post_id":"cjngw0vnq000i67ozm1edvlyi","category_id":"cjngw0vo1001967ozckvdpt4r","_id":"cjngw0voa001w67ozv8lkwto9"},{"post_id":"cjngw0vnq000i67ozm1edvlyi","category_id":"cjngw0vo6001d67ozao5sm39f","_id":"cjngw0voa001x67oz8b521ttn"},{"post_id":"cjngw0vnq000i67ozm1edvlyi","category_id":"cjngw0vo0001067ozi20igrcb","_id":"cjngw0voa001y67oztzt5aczg"},{"post_id":"cjngw0vny000x67ozl2q2mmgk","category_id":"cjngw0vnu000o67ozly48xn7u","_id":"cjngw0voa001z67ozlqi8whe2"},{"post_id":"cjngw0vny000x67ozl2q2mmgk","category_id":"cjngw0vo6001g67ozyq4zpvnx","_id":"cjngw0voa002067ozs9aqg6j4"},{"post_id":"cjngw0vny000x67ozl2q2mmgk","category_id":"cjngw0vo0001067ozi20igrcb","_id":"cjngw0voa002167ozsmkagxlz"}],"PostTag":[],"Tag":[]}}