<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  
    <title>
      Optimizing Elasticsearch Score: How to Rank and Differentiate Similar Records › Nick Drane
    </title>
    
      <meta name="author" content="Nick Drane">
      
        
            <meta name="description" content="Nick Drane&#39;s blog about programming and modern web development, particularly Node.js and React.">
            
                  
                      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

                      
                        <meta property="og:title" content="Optimizing Elasticsearch Score: How to Rank and Differentiate Similar Records" />
                        
                          <meta property="og:site_name" content="Nick Drane" />

                          
                              <meta property="og:image" content="" />
                              
                                <meta name="google-site-verification" content="0iahwlYFOHM2sYjk4TF5_lP0DqzgOgkXnZcKV-Qci8A" />

                                <link href="/favicon.png" rel="icon">
                                <link rel="alternate" href="/atom.xml" title="Nick Drane"
                                  type="application/atom+xml">
                                <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
                                <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
                                <script async src="https://www.googletagmanager.com/gtag/js?id=UA-107252357-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-107252357-1');
</script>
</head>

<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">Nick Drane</a></h1>
  <nav id="main-nav">
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/hire-me">Hire Me</a></li>
      <li><a href="/projects">Projects</a></li>
      <li><a href="/archives">Archives</a></li>
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
  
    <div class="social">
      <ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnickdrane.com%2Foptimizing-elasticsearch-score%2F&quote=Optimizing%20Elasticsearch%20Score%3A%20How%20to%20Rank%20and%20Differentiate%20Similar%20Records" title="Share on Facebook" target="_blank"><img alt="Share on Facebook" src="/images/social/Facebook.png" /></a></li>
  <li><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnickdrane.com%2Foptimizing-elasticsearch-score%2F&text=Optimizing%20Elasticsearch%20Score%3A%20How%20to%20Rank%20and%20Differentiate%20Similar%20Records" target="_blank" title="Tweet"><img alt="Tweet" src="/images/social/Twitter.png" /></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fnickdrane.com%2Foptimizing-elasticsearch-score%2F&title=Optimizing%20Elasticsearch%20Score%3A%20How%20to%20Rank%20and%20Differentiate%20Similar%20Records" target="_blank" title="Share on LinkedIn"><img alt="Share on LinkedIn" src="/images/social/LinkedIn.png" /></a></li>
  <li><a href="mailto:?subject=Optimizing Elasticsearch Score: How to Rank and Differentiate Similar Records&body=Check this out: http://nickdrane.com/optimizing-elasticsearch-score/" target="_blank" title="Send email"><img alt="Send email" src="/images/social/Email.png" /></a></li>
</ul>
    </div class="social">
  
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title">Optimizing Elasticsearch Score: How to Rank and Differentiate Similar Records</h1>
  

      
        <time datetime="2017-10-11T05:00:00.000Z">2017-10-11</time>
      
    </header>
    <div class="entry">
      <p>A client approached me with a puzzling problem:</p>
<p>At Fraight, we have an omnisearch interface backed by an Elasticsearch datastore. The interface allows users yo type a freetext query and get a list of database records sorted by relevancy. At it’s core, this is a simple problem: if the user types in <code>Joe</code>, return all people whose name contains the word <code>Joe</code>. And indeed, returning all the <code>Joe&#39;s</code> in the system is trivial; the problem is that we worked hundreds, possibly even thousands of <code>Joes</code>. How do we identify the particular <code>Joe</code> that we care about?</p>
<a id="more"></a>
<h2 id="A-Poor-Solution"><a href="#A-Poor-Solution" class="headerlink" title="A Poor Solution"></a>A Poor Solution</h2><p>When I worked at <a href="https://www.epic.com/" target="_blank" rel="noopener">Epic</a>, we had a similar problem. We had a search interface that allowed us to look up patients. Unfortunately, our full names are not as unique as we like to believe, and a simple query for <code>Luke Smith</code> would surely bring the system to a halt. Epic solved this problem by providing additional fields. That’s why (along with HIPPA reasons), when you call the doctor, they might ask for your birthdate or your address; this additional identifying information is used to pare down the search results. This solution is slow, cumbersome and was deemed wholly inadequate for us.</p>
<h2 id="Fraight’s-Solution"><a href="#Fraight’s-Solution" class="headerlink" title="Fraight’s Solution"></a>Fraight’s Solution</h2><p>We settled on two attributes that should influence the score of a particular record:</p>
<ol>
<li>How often we interact with an entity</li>
<li>How recently we’ve interacted with an entity</li>
</ol>
<p>It’s important to know that most of the trucking organizations in our system have been worked with minimally. We needed a remove this noise from the search results. Phrased differently, if we regularly work with a particular <code>Great America Truckers</code> more than the other 1000 <code>Great America Truckers</code>, we want our partner to appear higher in the search results.</p>
<p>Similarly, if we have recently interacted with an organization, there’s a good chance we will need to interact with them in the future. For example, if we’ve just initiated a conversation with a new business partner, there’s a good chance we will continue interacting with them regularly in the near-term. It’s important, however, to consider the time since our last interaction. If we interacted with someone yesterday or the day before, it’s very important for them to be ranked higher than an organization we interacted with 10 days ago.</p>
<h2 id="Getting-the-Data"><a href="#Getting-the-Data" class="headerlink" title="Getting the Data"></a>Getting the Data</h2><p>Both of these solutions require populating our database with information regarding how recently we’ve interacted with particular entities. Fortunately, all of this can be done during the data ingestion phase when records are loaded in Elasticsearch. The only requirement is making sure to keep the information in Elasticsearch up to date with our PostgreSQL database</p>
<p>The one challenge with this solution is that it requires augmenting our documents with special data regarding total interactions and recency of interactions.  The huge advantage, however, is that it works seamlessly. We don’t require there to be any special configuration when we begin working with a new partner.</p>
<h2 id="Function-Score-Queries"><a href="#Function-Score-Queries" class="headerlink" title="Function Score Queries"></a>Function Score Queries</h2><p>Elasticsearch provides <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html" target="_blank" rel="noopener">function score queries</a> that allow you to modify Elasticsearch’s calculated score. Their documentation provides a really simple example explaining boost the relevancy of a document that has many <code>likes</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>: &#123;</span><br><span class="line">        <span class="attr">"function_score"</span>: &#123;</span><br><span class="line">            <span class="attr">"field_value_factor"</span>: &#123;</span><br><span class="line">                <span class="attr">"field"</span>: <span class="string">"likes"</span>,</span><br><span class="line">                <span class="attr">"factor"</span>: <span class="number">1.2</span>,</span><br><span class="line">                <span class="attr">"modifier"</span>: <span class="string">"sqrt"</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This code says that every document’s score will be <code>sqrt(1.2 * doc[&#39;likes&#39;].value)</code></p>
<p>We used a particular kind of Function Score Query known as a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html#function-script-score" target="_blank" rel="noopener">Script Score</a>.</p>
<p>We wanted our ultimate score to be a function of three values: the score returned from elasticsearch, the days since our last interaction, and our total interactions. Initially, our function looked something like this</p>
<p><code>newscore</code> = _score <em> doc[‘interactions’] </em></p>
<p>We found that Elasticsearch’s relevancy score was being overwhelmed by parters with a high number of interactions, so much so that given a search term of <code>nick drane</code>, we might return <code>nick smith</code>, simply because we’ve worked with nick smith more.</p>
<p>We needed to place an upperbound of the potential contribution of the total interactions. After initially looking at <a href="https://en.wikipedia.org/wiki/Logistic_function" target="_blank" rel="noopener">logistic functions</a> and other overly complicated strategies, we settled on a simple step function. If the number of interactions is greater than 25, then we multiply Elasticsearch’s relevancy score by 2, otherwise we multiply it 1.</p>
<p>The frequency contribution’s function was similarly simple.</p>
<p>(could be some density/decay function that looks at density of interactions over time)</p>
<h2 id="challenges"><a href="#challenges" class="headerlink" title="challenges"></a>challenges</h2><p>Keeping the extra attributes up to date</p>
<p>We did try to combine two guassian curves but couldn’t get it working</p>
<p>Sometimes was built using a <code>query_string</code> query against the <code>_all</code> field. Sometimes the returned results were good, but most of the time they fell short.  Their problem was simple: how do we ensure that the</p>
<p>health care<br>select based on recent claim<br>select based on scheduled appointment<br>select based on upcoming event<br>specify table to search</p>

    </div>
    <footer>
      <ul class="share-buttons">
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnickdrane.com%2Foptimizing-elasticsearch-score%2F&quote=Optimizing%20Elasticsearch%20Score%3A%20How%20to%20Rank%20and%20Differentiate%20Similar%20Records" title="Share on Facebook" target="_blank"><img alt="Share on Facebook" src="/images/social/Facebook.png" /></a></li>
  <li><a href="https://twitter.com/intent/tweet?url=http%3A%2F%2Fnickdrane.com%2Foptimizing-elasticsearch-score%2F&text=Optimizing%20Elasticsearch%20Score%3A%20How%20to%20Rank%20and%20Differentiate%20Similar%20Records" target="_blank" title="Tweet"><img alt="Tweet" src="/images/social/Twitter.png" /></a></li>
  <li><a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fnickdrane.com%2Foptimizing-elasticsearch-score%2F&title=Optimizing%20Elasticsearch%20Score%3A%20How%20to%20Rank%20and%20Differentiate%20Similar%20Records" target="_blank" title="Share on LinkedIn"><img alt="Share on LinkedIn" src="/images/social/LinkedIn.png" /></a></li>
  <li><a href="mailto:?subject=Optimizing Elasticsearch Score: How to Rank and Differentiate Similar Records&body=Check this out: http://nickdrane.com/optimizing-elasticsearch-score/" target="_blank" title="Send email"><img alt="Send email" src="/images/social/Email.png" /></a></li>
</ul>
      <div class="clearfix"></div>
    </footer>
  </div>
</article></div></div>
    <aside id="sidebar" class="alignright">  <div class="widget tag about">
  <ul class="entry">
    <div>
      <img class="about-photo" src="/images/about-photo.jpg" alt="photo of Nick Drane" />
    </div>
    <p class="about-photo-text"> Nick Drane's blog about programming, hacking, software, computer security, and compute science.</p>

  </ul>
</div>
  <div class="widget tag recent-posts">
  <h3 class="title">Most Popular Posts</h3>
  <ul class="entry">
    <li>
      <a href="/build-your-own-regex/">Build a Regex Engine in Less than 40 Lines of Code</a>
    </li>
    <li>
      <a href="/scraping-the-web-with-puppeteer-lessons-learned/">Scraping the Web with Puppeteer: Lessons Learned</a>
    </li>
    <li>
      <a href="/write-your-own-redux-connect/">Write Your Own React-Redux Connect</a>
    </li>
    <li>
      <a href="/build-your-own-nested-query-string-encoder/">Build Your Own Nested Query String Encoder/Decoder</a>
    </li>
  </ul>
</div>
  <div class="widget tag recent-posts">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/hidden-costs-of-postgresql-jsonb/">The Hidden Costs of PostgreSQL&#39;s JSONB Datatype</a>
      </li>
    
      <li>
        <a href="/using-jq-to-effortlessly-ingest-newline-delimited-JSON-into-postgres/">Using jq to Effortlessly Ingest Line-delimited JSON into PostgreSQL</a>
      </li>
    
      <li>
        <a href="/ethical-engineering-for-the-average-engineer/">Ethical Engineering for the Average Engineer</a>
      </li>
    
      <li>
        <a href="/build-your-own-nested-query-string-encoder/">Build Your Own Nested Query String Encoder/Decoder</a>
      </li>
    
      <li>
        <a href="/you&#39;re-hiring-programmers-wrong-a-case-for-interview-standardization/">You&#39;re Hiring Programmers Wrong: A Case for Interview Standardization</a>
      </li>
    
  </ul>
</div>
  
<div class="widget tag category">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Architecture/">Architecture</a><small>1</small></li>
  
    <li><a href="/categories/Build-Your-Own/">Build Your Own</a><small>3</small></li>
  
    <li><a href="/categories/Command-Line/">Command Line</a><small>1</small></li>
  
    <li><a href="/categories/Elasticsearch/">Elasticsearch</a><small>1</small></li>
  
    <li><a href="/categories/Failures/">Failures</a><small>1</small></li>
  
    <li><a href="/categories/Functional-Programming/">Functional Programming</a><small>1</small></li>
  
    <li><a href="/categories/Immutability/">Immutability</a><small>1</small></li>
  
    <li><a href="/categories/Javascript/">Javascript</a><small>4</small></li>
  
    <li><a href="/categories/Postgres/">Postgres</a><small>2</small></li>
  
    <li><a href="/categories/React/">React</a><small>2</small></li>
  
    <li><a href="/categories/Recursion/">Recursion</a><small>2</small></li>
  
    <li><a href="/categories/Redux/">Redux</a><small>1</small></li>
  
    <li><a href="/categories/Regular-Expressions/">Regular Expressions</a><small>2</small></li>
  
    <li><a href="/categories/Software-Ethics/">Software Ethics</a><small>1</small></li>
  
    <li><a href="/categories/Technical-Hiring/">Technical Hiring</a><small>1</small></li>
  
    <li><a href="/categories/Testing/">Testing</a><small>1</small></li>
  
    <li><a href="/categories/Web/">Web</a><small>1</small></li>
  
    <li><a href="/categories/Web-Scraping/">Web Scraping</a><small>1</small></li>
  
  </ul>
</div>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
    &copy; 2018 Nick Drane
  
</div>
<div class="clearfix"></div></footer>
</body>
</html>

