{"componentChunkName":"component---src-templates-article-js","path":"/a-performance-guide-to-gatsbyjs/","webpackCompilationHash":"17aab0c6c8bb8bde0f93","result":{"data":{"markdownRemark":{"html":"<p>In my article <a href=\"/hexo-vs-gatsbyjs-comparing-nodejs-static-site-generators\">comparing Gatsby to Hexo</a>, I talked about my experience switching writing this blog using <a href=\"https://hexo.io/\">Hexo</a> and then later using <a href=\"https://www.gatsbyjs.org/\">Gatsby</a>. In the process, the size of my initial page ballooned 5x.</p>\n<p>In retrospect, I did not fully understand the abstraction that Gatsby provides. Fortunately, if you follow a simple rule of thumb, you can avoid bloating your network requests and maintain an ultra-performant website.</p>\n<!-- more -->\n<h2>Process as Much Data with GraphQL as Possible</h2>\n<p>If you walk away learning nothing else, this is the most important point.</p>\n<p>When you build your website, Gatsby will effectively run all of the GraphQL queries needed to load each page and save the resulting JSON. When you visit a given page on your site, requests will be made for these JSON payloads, completely unmodified.</p>\n<p>I originally thought that <code class=\"language-text\">gatsby build</code> would combine my react components and GraphQL requests, transforming them into HTML, resulting in a website that sends strictly HTML over the wire. This is not the case (unless the client has Javascript disabled)! Here a small piece of the JSON payload for the homepage of my website:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 680px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5e32dfc5d836a1c723e2c61fff4e4061/54f11/json-payload.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.691373025516405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABV0lEQVQoz5VSa2/CMAzk//88kBhdA5TSpq81fdOGJr0lZhEwxodZsuzY51Piy4pzjiiK0LQd9LLA2fImfzRX1nrBJDWmSWElhABjDE3VmQ7BDLF+S+zcYh7PzlYu2ccMwVeAUITGzziVJ/KwDBGUAfVc/2z65yqiaPtHU28uzY3QsfsnH2t/jQM/GMCRgEmdgNcccRVTLLoC9aWm4WqoMMgBSitc1ZXiE2HKU3ifHrImo2FLZoftkPV+6jFeR7MvTcPWf+/WnolQSvnUtPt53ON/jAjHcURaZGiHFvXY0M3asaOn2dx62ZcQ5pnCRPtcMQiKZS9MTRBGzvIuyu64w+awAUsY9sUefu6D5Qxe6pE4do/WIyNG/CPILb/VsjbHrOb7DnnEsf3YIikT5KZpganZp7sdiTDdRJj1TMNOjBdRlFK0bAuSStLVp3kioPtzf4nw+tEXfAODEQShMyuGiAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/5e32dfc5d836a1c723e2c61fff4e4061/fb8f2/json-payload.webp 170w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/a7e55/json-payload.webp 340w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/4a434/json-payload.webp 680w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/18e42/json-payload.webp 1020w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/bdd6f/json-payload.webp 1360w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/7bdd9/json-payload.webp 1646w\"\n          sizes=\"(max-width: 680px) 100vw, 680px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/5e32dfc5d836a1c723e2c61fff4e4061/924ad/json-payload.png 170w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/6103d/json-payload.png 340w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/5e3e6/json-payload.png 680w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/89b07/json-payload.png 1020w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/2f8d2/json-payload.png 1360w,\n/static/5e32dfc5d836a1c723e2c61fff4e4061/54f11/json-payload.png 1646w\"\n          sizes=\"(max-width: 680px) 100vw, 680px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/5e32dfc5d836a1c723e2c61fff4e4061/5e3e6/json-payload.png\"\n          alt=\"JSON payload for the homepage website\"\n          title=\"JSON payload for the homepage website\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>So what does this mean for you?</p>\n<ol>\n<li>Do not request data that you don't need. This rule of thumb is obvious in a typical Single Page Application, but it applies here too. We want to minimize the size of our HTTP responses.</li>\n<li>If you can do <a href=\"https://www.gatsbyjs.org/docs/graphql-reference/\">filtering, sorting, or limiting in GraphQL</a>, do it there instead of at the application layer.</li>\n</ol>\n<p>The second points bears explanation. Here are two functionally equivalent chunks of code to grab the html of the 5 most recent posts.</p>\n<h2>Post-Processing GraphQL results with Javascript</h2>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  allMarkdownRemark <span class=\"token punctuation\">{</span>\n    edges <span class=\"token punctuation\">{</span>\n      node <span class=\"token punctuation\">{</span>\n        html\n        frontmatter <span class=\"token punctuation\">{</span>\n          date\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Assuming data is the result of the above GraphQL query</span>\n<span class=\"token keyword\">const</span> mostRecentPosts <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>allMarkdownRemark<span class=\"token punctuation\">.</span>edges\n  <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">edge</span> <span class=\"token operator\">=></span> edge<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// Sort each post by dates in reverse chronological order</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node1<span class=\"token punctuation\">,</span> node2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>node1<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> b <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>node2<span class=\"token punctuation\">.</span>frontmatter<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> a <span class=\"token operator\">></span> b <span class=\"token operator\">?</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token punctuation\">:</span> a <span class=\"token operator\">&lt;</span> b <span class=\"token operator\">?</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// Grab the 5 most recent ones</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Everything in GraphQL</h2>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token punctuation\">{</span>\n  allMarkdownRemark<span class=\"token punctuation\">(</span>\n    <span class=\"token attr-name\">limit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token attr-name\">sort</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token attr-name\">fields</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>frontmatter___date<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token attr-name\">order</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">DESC</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    edges <span class=\"token punctuation\">{</span>\n      node <span class=\"token punctuation\">{</span>\n        html\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I was initially uncomfortable with GraphQL and coded everything in the former style, making broad GraphQL queries and later performing additional processing using Javascript. This strategy has numerous problems.</p>\n<ol>\n<li>As I mentioned above, instead of grabbing the html of just 5 posts, we are grabbing it for every post. This translates directly into what is sent over the wire when someone loads the page, bloating the site. To compound the problem, the performance hit grows with every single post we add to our site.</li>\n<li>Not only am I grabbing more posts than I need, every post includes additional information. Notice in the second example that we don't need to query the date because sorting is handled by GraphQL.</li>\n<li>Lastly, the second example is so much more readable</li>\n</ol>\n<h2>Conclusion</h2>\n<p>Gatsby is a powerful static site generator, though it's not immediately obvious how your code influences the resulting site's performance. You can make great strides, however, if you always offload as much work onto GraphQL as possible.</p>","frontmatter":{"title":"One Simple Performance Tip to Optimize GatsbyJS Static Sites","date":"2018-12-13T00:00:00.000Z","url":"a-performance-guide-to-gatsbyjs"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"title":"One Simple Performance Tip to Optimize GatsbyJS Static Sites"}}}