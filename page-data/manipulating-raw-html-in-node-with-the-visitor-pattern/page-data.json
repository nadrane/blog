{"componentChunkName":"component---src-templates-article-js","path":"/manipulating-raw-html-in-node-with-the-visitor-pattern/","webpackCompilationHash":"efb0bb0915c91dac7b0a","result":{"data":{"markdownRemark":{"html":"<p>I recently wanted to add an id to every header tag in an HTML string. This sounds like an easy task right? A little jQuery and the problem is solved: <code class=\"language-text\">$(&quot;:header&quot;).attr(&quot;id&quot;, &quot;1&quot;)</code> is a rough solution.</p>\n<p>The catch is that this was in Node, not the browser. In most situations I would reach for <a href=\"https://cheerio.js.org/\">Cheerio</a>, which replicates the <a href=\"https://jquery.com/\">jQuery</a> API inside node, but I needed something lighter weight.</p>\n<p>This is a story of parsing, recursing, and modifying raw HTML without comfortable, declarative APIs. It's surprisingly approachable with the help of the <a href=\"https://en.wikipedia.org/wiki/Visitor_pattern\">Visitor pattern</a>.</p>\n<!-- more -->\n<h2>The Problem</h2>\n<p>My problem statement was quite simple: Add an id to every single header in an HTML string. I was able to assume that each header would only have a string of text as its child, so I took the text of that element and used it to construct each header's id.</p>\n<p>I translated</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h2</span><span class=\"token punctuation\">></span></span>Parsing HTML isn't so bad<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h2</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>into</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h2</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>parsing-html-is-not-so-bad<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Parsing HTML is not so bad<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h2</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h2>Representing HTML Using Fast HTML Parser</h2>\n<p>Before we can dive into parsing, we need to understand how HTML is represented when parsed. <a href=\"https://www.npmjs.com/package/node-html-parser\">Fast HTML Parser</a> can parse our HTML into a tree data structure composed of <code class=\"language-text\">HTMLElement</code>s and <code class=\"language-text\">TextNode</code>s. <code class=\"language-text\">HTMLElement</code>s represent your typical <code class=\"language-text\">div</code>, <code class=\"language-text\">span</code>, <code class=\"language-text\">h1</code> etc., and <code class=\"language-text\">TextNode</code>s represent the text inside an <code class=\"language-text\">HTMLELement</code>. For example, the previous HTML snippet would be represented like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">HTMLElement <span class=\"token punctuation\">{</span>\n  tagName<span class=\"token punctuation\">:</span> <span class=\"token string\">'div'</span><span class=\"token punctuation\">,</span>\n  childNodes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    HTMLElement <span class=\"token punctuation\">{</span>\n      childNodes<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> TextNode <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      tagName<span class=\"token punctuation\">:</span> <span class=\"token string\">'h2'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are two different ways to obtain this tree representation:</p>\n<ol>\n<li>Construct it by hand, using the <code class=\"language-text\">HTMLELement</code> and <code class=\"language-text\">TextNode</code> constructors</li>\n<li>Parse an existing HTML string using the <code class=\"language-text\">parse</code> API provided by Fast HTML Parser</li>\n</ol>\n<p>We will use both approaches in our solution.</p>\n<h2>Constructing the HTML Tree from Scratch</h2>\n<p>Let's construct the above HTML tree by hand:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> HTMLElement<span class=\"token punctuation\">,</span> TextNode <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node-html-parser\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Param 1 is the element tag name</span>\n<span class=\"token comment\">// Param 2 is an object that we will later use to</span>\n<span class=\"token comment\">// initialize the element id. It cannot be null</span>\n<span class=\"token keyword\">const</span> outerDiv <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> h2Element <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"h2\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Make h2Element a child of outerDiv</span>\nouterDiv<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>h2Element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// TextNode just takes in the text it contains</span>\n<span class=\"token keyword\">const</span> textNode <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Parsing HTML is not so bad\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Give the h2 element some text</span>\nh2Element<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>textNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The 2 main takeaways are</p>\n<ol>\n<li>The <code class=\"language-text\">HTMLElement</code> and <code class=\"language-text\">TextNode</code> constructors allow us to create nodes that can be combined to construct a tree.</li>\n<li><code class=\"language-text\">HTMLElement</code> has an <code class=\"language-text\">appendChild</code> function that can establish a parent-child relationship between any two nodes.</li>\n</ol>\n<p>If we wanted to include an <code class=\"language-text\">id</code> attribute, we only need a slight modification</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> HTMLElement<span class=\"token punctuation\">,</span> TextNode <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node-html-parser\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> outerDiv <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> h2Element <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">\"h2\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// Pass in an id</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"parsing-html-is-not-so-bad\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"id=parsing-html-is-not-so-bad\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nouterDiv<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>h2Element<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> textNode <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Parsing HTML is not so bad\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nh2Element<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>textNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The above code probably looks odd. The API, as far as I can tell, requires us to pass in the id attribute twice, once as an object and once in raw string form. It's not clear to me why the raw form isn't auto-generated.</p>\n<h2>Parsing and Recursing the HTML Tree</h2>\n<p>Let's now switch gears and instead obtain our tree data structure by using Fast HTML Parser built-in <code class=\"language-text\">parse</code> function.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> parse <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node-html-parser\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">parseAndVisitNodes</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">html</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> htmlRoot <span class=\"token operator\">=</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>htmlString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">htmlRoot</code> will be composed of <code class=\"language-text\">HTMLElement</code>s and <code class=\"language-text\">TextNode</code>s, just like the tree we we constructed by hand.</p>\n<p>In order to modify this tree, our first step is write a function that will <em>touch</em> every node in the HTML tree. We will use a standard <a href=\"https://medium.com/basecs/demystifying-depth-first-search-a7c14cccf056\">depth-first search</a> to accomplish this.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> parse <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node-html-parser\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">parseAndVisitNodes</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">html</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// This is our base case. If a node does not have any children,</span>\n  <span class=\"token comment\">// then there is nothing else to traverse on this path</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">.</span>childNodes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// Visit every child node of the root</span>\n  root<span class=\"token punctuation\">.</span>childNodes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Don't worry if you're unfamiliar with this depth first search; you won't need to understand it to grok the ultimate solution.</p>\n<p>Now that we can touch every node in the tree, we only need to go one small step further to execute a function on each node:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> parse <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node-html-parser\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">parseAndVisitNodes</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">html<span class=\"token punctuation\">,</span> func</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> htmlRoot <span class=\"token operator\">=</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span>htmlRoot<span class=\"token punctuation\">,</span> func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Notice we return the HTML as a string now</span>\n  <span class=\"token keyword\">return</span> htmlRoot<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">root<span class=\"token punctuation\">,</span> func</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">.</span>childNodes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  root<span class=\"token punctuation\">.</span>childNodes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Execute a function of the user's choice</span>\n    <span class=\"token comment\">// The child is an input to that function.</span>\n    <span class=\"token comment\">// The user inputs the function and can do anything they want!</span>\n    <span class=\"token function\">func</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">visit</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are 3 things worth noting:</p>\n<ol>\n<li>We pass in the parent (<code class=\"language-text\">root</code> above) as well as <code class=\"language-text\">child</code> into the user-defined function. Having the parent node of <code class=\"language-text\">child</code> is useful later.</li>\n<li>We do not appear to invoke <code class=\"language-text\">func</code> on our top-level node. The way we've written the code keeps it clean and incidentally works works perfectly since Fast HTML Parser wraps our root node in an additional node; effectively, all of our nodes are children of this top-level node. This oddity ensures the user-defined function is called even on the outermost node (or, if there are multiple outermost nodes, all are touched).</li>\n<li>We are now returning the resultant HTML as a string from <code class=\"language-text\">parseAndVisitNodes</code>. If our function were to modify the HTML tree, we want a way to access the results. We choose to return a string as opposed to the htmlRoot itself because it encapsulates the parsed HTML data structure; ideally, the caller of this function should not need to understand <code class=\"language-text\">HTMLELement</code>s.</li>\n</ol>\n<p>Let's put <code class=\"language-text\">parseAndVisitNodes</code> to use. Suppose a user wants to print the tag name of each child in the tree:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">printTagName</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>tagName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  &lt;div>\n    &lt;h1>My Blog&lt;/h1>\n  &lt;/div>\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// All we need to do is invoke parseAndVisitNodes</span>\n<span class=\"token comment\">// and pass in a function that operates on a child node</span>\n<span class=\"token function\">parseAndVisitNodes</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">,</span> printTagName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If you run this, you'll notice that the <code class=\"language-text\">TextNode</code>'s print <code class=\"language-text\">undefined</code>. That's to be expected. You might also notice that there are 3 text nodes, not 1. There is a <code class=\"language-text\">TextNode</code> between the opening <code class=\"language-text\">div</code> and opening <code class=\"language-text\">h1</code> and between the closing <code class=\"language-text\">h1</code> and closing <code class=\"language-text\">div</code>. These <code class=\"language-text\">TextNodes</code> contain new lines. The browser works the same way</p>\n<p>We just used a technique called the <a href=\"https://en.wikipedia.org/wiki/Visitor_pattern\">Visitor pattern</a>, dubbed by the way that we <em>visited</em> and executed a function on every node of the tree. This patterns flexibility should be readily apparent: We can add arbitrary functionality to operate over our HTML tree without needing to modify any underlying class itself.</p>\n<p>Let's showcase the raw power of this design pattern by re-addressing the original problem: Let's write a function to add an id to every header tag.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> HTMLElement<span class=\"token punctuation\">,</span> TextNode <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"node-html-parser\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">addHeaderIds</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child<span class=\"token punctuation\">,</span> parent</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// There are 6 types of header tags</span>\n  <span class=\"token keyword\">const</span> headerTags <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"h2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"h3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"h4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"h5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"h6\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Guard statement to check if this node is a header</span>\n  <span class=\"token comment\">// Ignore the node if it isn't</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>headerTags<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>tagName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// We are assuming the header has a single TextNode as a child</span>\n  <span class=\"token comment\">// We will use this nodes text to construct the header id</span>\n  <span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> child<span class=\"token punctuation\">.</span>childNodes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> text\n    <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Fast HTML Parser doesn't provide us a way to</span>\n  <span class=\"token comment\">// mutate a node directly.</span>\n  <span class=\"token comment\">// Instead, we need to create new nodes and</span>\n  <span class=\"token comment\">// swap them out with existing ones</span>\n\n  <span class=\"token comment\">// Create a new header tag with an id</span>\n  <span class=\"token keyword\">const</span> newNode <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HTMLElement</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>tagName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">id=\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Append a new TextNode (which looks identical to the old one) to our new header tag</span>\n  newNode<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TextNode</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Replace our new header with the old one</span>\n  parent<span class=\"token punctuation\">.</span><span class=\"token function\">exchangeChild</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> newNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If we run the above function on some HTML, we can see it in action:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  &lt;div>\n    &lt;h1>My Blog&lt;/h1>\n  &lt;/div>\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">parseAndVisitNodes</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">,</span> addHeaderIds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This outputs HTML that looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>my-blog<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>My Blog<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Now that you have <code class=\"language-text\">parseAndVisitNodes</code>, all you need to do is write an input function that utilizes the HTML data structure as you see fit. One challenge you might encounter is what happens when you want to modify a node in the middle of a large tree. In <code class=\"language-text\">addHeaderIds</code>, we simply copied the one underlying <code class=\"language-text\">TextNode</code> and appended it to our new header node, but this technique is obviously impractical for large, dynamic HTML trees. Fortunately, we can reuse existing parts of the tree, referencing certain child subtrees with multiple HTML tree data structures.</p>","frontmatter":{"title":"Manipulating Raw HTML in Node with the Visitor Pattern","date":"2019-09-02T00:00:00.000Z","url":"manipulating-raw-html-in-node-with-the-visitor-pattern"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"title":"Manipulating Raw HTML in Node with the Visitor Pattern"}}}